article,highlights,id,attack
"MysterySnail attacks with Windows zero-daysecurelist.com/mysterysnail-attacks-with-windows-zero-day/104509Executive SummaryIn late August and early September 2021, Kaspersky technologies detected attacks with the use of an elevation of privilege exploit on multiple Microsoft Windows servers. The exploit had numerous debug strings from an older, publicly known exploit for vulnerability CVE- 2016-3309, but closer analysis revealed that it was a zero-day. We discovered that it was using a previously unknown vulnerability in the Win32k driver and exploitation relies heavily on a technique to leak the base addresses of kernel modules. We promptly reported these findings to Microsoft. The information disclosure portion of the exploit chain was identified as not bypassing a security boundary, and was therefore not fixed. Microsoft assigned CVE- 2021-40449 to the use-after-free vulnerability in the Win32k kernel driver and it was patched on October 12, 2021, as a part of the October Patch Tuesday.Besides finding the zero-day in the wild, we analyzed the malware payload used along with the zero-day exploit, and found that variants of the malware were detected in widespread espionage campaigns against IT companies, military/defense contractors, and diplomatic entities.We are calling this cluster of activity MysterySnail. Code similarity and re-use of C2 infrastructure we discovered allowed us to connect these attacks with the actor known as IronHusky and Chinese-speaking APT activity dating back to 2012.1/7Elevation of privilege exploitThe discovered exploit is written to support the following Windows products:Microsoft Windows Vista Microsoft Windows 7 Microsoft Windows 8 Microsoft Windows 8.1 Microsoft Windows Server 2008 Microsoft Windows Server 2008 R2 Microsoft Windows Server 2012 Microsoft Windows Server 2012 R2 Microsoft Windows 10 (build 14393) Microsoft Windows Server 2016 (build 14393) Microsoft Windows 10 (build 17763) Microsoft Windows Server 2019 (build 17763)The list of supported products and supported Windows 10 build numbers, explicit declaration of server OSs and the fact that exploits were only discovered in attacks on servers, all lead us to believe the exploit was developed and advertised as a solution to elevate privileges on servers.CVE-2021-40449 is a use-after-free vulnerability in Win32k’s NtGdiResetDC function. As with many other Win32k vulnerabilities, the root cause of this vulnerability lies in the ability to set user-mode callbacks and execute unexpected API functions during execution of those callbacks. The CVE-2021-40449 is triggered when the function ResetDC is executed a second time for the same handle during execution of its own callback. The exploitation process for this vulnerability is as follows:1. A user-mode call to ResetDC executes syscall NtGdiResetDC and its inner functionGreResetDCInternal. This function gets a pointer to a PDC object, and then performs a call to function hdcOpenDCW.2. Function hdcOpenDCW performs a user-mode callback and it can be used to executeResetDC for the same handle a second time.3. If an exploit executes ResetDC during a callback, NtGdiResetDC andGreResetDCInternal are executed again for the same DC.4. If an exploit ignores all the callbacks during the second call to GreResetDCInternal, this function will be executed as intended. It will create a new DC and get rid of the old one (the PDC object is destroyed).5. In the callback, after the second ResetDC call has completed, the exploit can reclaim thefreed memory of the PDC object and finish the execution of the callback.6. After execution of the callback, function hdcOpenDCW returns to GreResetDCInternal, but the pointer retrieved in step (1) is now a dangling pointer – it points to the memory of the previously destroyed PDC object.2/77. In the late stage of GreResetDCInternal execution, a malformed PDC object can be usedto perform a call to an arbitrary kernel function with controlled parameters.In the discovered exploit attackers are able to achieve the desired state of memory with the use of GDI palette objects and use a single call to a kernel function to build a primitive for reading and writing kernel memory. This step is easily accomplished, because the exploit process is running with Medium IL and therefore it’s possible to use publicly known techniques to leak kernel addresses of currently loaded drivers/kernel modules. In our opinion, it would be preferable if the Medium IL processes had limited access to such functions as NtQuerySystemInformation or EnumDeviceDrivers.MysterySnail RATOur deep dive into the MysterySnail RAT family started with an analysis of a previously unknown remote shell-type Trojan that was intended to be executed by an elevation of privilege exploit. The sample which we analyzed was also uploaded to VT on August 10, 2021. The sample is very big – 8.29MB. One of the reasons for the file size is that it’s statically compiled with the OpenSSL library and contains unused code and data belonging to that library. But the main reason for its size is the presence of two very large functions that do nothing but waste processor clock cycles. These functions also “use” randomly generated strings that are also present in a binary.Random strings used by anti-analysis functionsWe assume these two functions are used as an AV-evasion technique for the purpose of anti- emulation. This theory is supported by the presence of other redundant logics and the presence of a relatively large number of exported functions while the real work is performed by only one of them.3/7Names of exported functions; the actual business logic is executed from function “GetInfo”The sample has two hardcoded URLs present in plain text – “www[.]disktest[.]com” and “www[.]runblerx[.]com”. They are put into class variables for intended use, but remain unused; the real C2 address is decoded by a single byte xor – “http[.]ddspadus[.]com”.The malware enumerates the values under the “Software\Microsoft\Windows\CurrentVersion\Internet Settings\ProxyServer” registry key and uses them to request tunneling through a proxy server in case it fails to connect to the C2 directly.The malware itself is not very sophisticated and has functionality similar to many other remote shells. But it still somehow stands out, with a relatively large number of implemented commands and extra capabilities like monitoring for inserted disk drives and the ability to act as a proxy.Inbound and outbound commands have the same binary-based format that is provided below. All communication is encrypted with SSL.Offset Description048Size of additional dataSession IDCommand ID0xCAdditional dataFormat of communication commands4/7Before receiving any commands, the malware gathers and sends general information about the victim machine. This information includes:Computer name Current OEM code-page/default identifier Windows product name Local IP address Logged-in user name Campaign nameOne interesting fact is that “Campaign name” by default is set to “windows”. This name gets overwritten, but it might indicate there are versions of the same RAT compiled for other platforms.In total, the RAT implements 20 commands. Their description and command IDs are provided in the table below.Command IDDescription1F4h1F5h1F6h1F7h1F8h1FAh1FBh1FFh202h205h208h209h20AhLaunch interactive cmd.exe shell. Before launch cmd.exe is copied to the temp folder with a different nameSpawn new processSpawn new process (console)Get existing disk drives and their type. This function also works in the background, checking for new drivesCreate (upload) new file. If a file exists, append data to itGet directory listKill arbitrary processDelete fileRead file. If the file is too big, async read operation can be stopped with cmd 20Ch.Re-connectSet sleep time (in ms)Shutdown network and exitExit5/720Bh20Ch217h21Bh21Ch21Eh21FhKill interactive shell (created with cmd 1F4h)Terminate file reading operation (started with cmd 202h)No operationOpen proxy’ed connection to provided host. Up to 50 simultaneous connections are supported.Send data to proxy’ed connectionClose all proxy connectionsClose requested proxy connectionList of commands supported by the RATThe analysis of the MysterySnail RAT helped us discover campaigns using other variants of the analyzed malware as well as study and document the code changes made to this tool over a six-month period. We provide more info about these variants and campaigns in our private report.With the help of Kaspersky Threat Attribution Engine (KTAE) and the discovery of early variants of MysterySnail RAT we were able to find direct code and functionality overlap with the malware attributed to the IronHusky actor. We were also able to discover the re-use of C2 addresses used in attacks by the Chinese-speaking APT as far back as 2012. This discovery links IronHusky to some of the older known activities.Kaspersky products detect the CVE-2021-40449 exploit and related malware with the verdicts:PDM:Exploit.Win32.Generic PDM:Trojan.Win32.Generic Trojan.Win64.Agent*Kaspersky products detected these attacks with the help of the Behavioral Detection Engine and the Exploit Prevention component. CVE-2021-40449 is the latest addition to the long list of zero-days discovered in the wild with the help of our technologies. We will continue to improve defenses for our users by enhancing technologies and working with third-party vendors to patch vulnerabilities, making the internet more secure for everyone.More information about these attacks and the actor behind them is available to customers of the Kaspersky Intelligence Reporting service. Contact: intelreports@kaspersky.com.Kaspersky would like to thank Microsoft for their prompt analysis of the report and patches.6/7IoCswww[.]disktest[.]com www[.]runblerx[.]com ","The PDF describes cyberattacks by a threat actor dubbed MysterySnail that exploited a new Windows zero-day vulnerability. The zero-day exploit elevates privileges on Windows servers by targeting a use-after-free flaw in the Win32k kernel driver. Kaspersky discovered attacks using this exploit in late August 2021 and promptly reported it to Microsoft. Microsoft assigned CVE-2021-40449 to the vulnerability and patched it in the October 2021 Patch Tuesday update. The exploit supports a wide range of Windows versions including Server 2008 through 2019. Kaspersky believes it was sold as a server privilege escalation exploit. The attacks delivered a remote access trojan dubbed MysterySnail RAT that gathers system info and can execute commands. The RAT has various anti-analysis features and tried to hide its C2 communications. Kaspersky connected these attacks to a Chinese-speaking advanced persistent threat actor called IronHusky. Evidence showed the group has been active since at least 2012, targeting IT companies, military contractors, and diplomatic entities. In summary, the PDF provides details on a new Windows zero-day exploit used by a sophisticated cyberespionage actor in attacks starting in August 2021. Kaspersky worked with Microsoft to patch the vulnerability used in the exploits. ",test_69,Windows; CVE-2021-40449; vulnerability; the Win32k driver; the exploit; use; execution; the re; ResetDC; function; addresses; kernel modules; MysterySnail; Trojan; the RAT; commands.
"Under Attack? Call (844) END.DDoSNew Poison Ivy Activity Targeting Myanmar, Asian  M E N U CountriesB y J a s o n J o n e s o n 0 4 / 2 6 / 2 0 1 6 . P o s t e d i n a d v a n c e d p e r s i s t e n t t h r e a t s , B a c k d o o r s , M a l w a r e .The infamous Remote Access Trojan (RAT) Poison Ivy (hereafter referred to as PIVY) has resurfaced recently, and exhibits some new behaviors. PIVY has been observed targeting a number of Asian countries for various purposes over the past year. Palo Alto Networks’ Unit 42 recently blogged about a new Poison Ivy variant targeting Hong Kong activists dubbed SPIVY that uses DLL sideloading and operates quite di erently from a variant recently observed by ASERT that has been active for at least the past 12 months.Technical DetailsThe PIVY variant that ASERT has observed has exhibited some newer behavior that we have not seen discussed previously. The samples drop a decoy doc – usually hinting clearly at the target, a DLL named ActiveUpdate.dll and the PIVY shellcode  le as Active.dat. The ActiveUpdate.dll and Active.dat  les are created in a directory that follows the format ActiveUpdate_ [0-9]{3}. The executable copies rundll32.exe to ActiveFlash.exe and then executes the new  le with the path to the DLL and installs itself for automatic startup via a .lnk in the Windows Startup folder. ESET identi ed these samples as “Win32/Korplug.I[F-I] variant“, possibly due to the appearance of the malware using DLL sideloading with rundll32 to load the dropped DLL and perform its malicious actions. This deployment tactic dates well into last year (and possibly before) using di erent executable names for the rundll32 copy and the base directory name, however this post will only cover a subset of the variant using “ActiveUpdate”.Illustration of execution process of one PIVY SampleThe compile times on these binaries also closely correlate to the times they were  rst observed in-the-wild and some samples contained timestamp-like entities in the various campaign IDs  elds in the malware con guration.The decrypted con guration appears to be slightly modi ed in such a way as to confuse some publicly available tools that parse the con guration data. The campaign ID is not fully null-padded – there is now one null-byte and a string of repeating “x” characters that will cause confusion for some scripts. Additionally, the C2s are no longer null-padded – each hostname ends with a null-byte that is then followed by a string that will look Command & Control (C2) server – the portions that start with “1” will change to 2 for the second C2, 3 for the third, etc. These values end up being present elsewhere in memory without the extra items and only small tweaks are needed to  x the parsing.The hostname webserver.servehttp[.]com is observed in a number of PIVY samples, some of which are covered in this post. Additionally, the IP resolved to by this hostname overlapped with  leshare.serveftp[.]com which was used in an earlier and seemingly unrelated PIVY sample.Decoy Document and Targeting InformationA number of PIVY samples were observed to be targeting Myanmar and several other countries in Asia. While the exact targets and delivery methods are not known to ASERT at this time, the documents and submission sources provide strong hints as to the motivations and potential targets of these exploitation campaigns. The sample on the sample was November 2, 2015, the apparent timestamp in the  lename appears to be referencing a report that was released on November 25, 2015 and it was  rst seen late evening in the US on November 24, 2015 which would equate to November 25 in Myanmar. The document was dropped as “STEP Democracy Year 1 Acheivements_25112015.docx” and was also dropped by SHA1 “Year1achievementsv2.docx“, but that sample uses a di erent communications password over the same set of C2s. The documents may be drafts of a  nal report released in December by the International Institute for Democracy and Electoral Assistance (IDEA), a part of the STEP Democracy initiative. The IDEA is “part of the European Union-funded project Support to Electoral Processes and Democracy (STEP Democracy)” whose goal is to support democracy worldwide. The IDEA has been working with Myanmar before and after their recent election to ensure “peaceful, transparent and credible elections.” Part of this work includes publishing reports and drafts such as those referenced above. In this case, the bait  le document metadata contains a company name of “IDEA” with an author of “Sophia” – possibly referencing a current member of the organization and a last edited date of November 20, 2015. The content of the document details a debate around the democratic elections in Myanmar. This timeline would put the targeting past the elections that occurred in early November, but appears to still be focused on individuals interested in democracy inside of Myanmar. The targeting of the post-election Myanmar appears to be following the same style as what was mentioned in the “Uncovering the Seven Pointed Dagger” paper by ASERT. In this case however it appears that threat actors began using references to the STEP organization to continue their likely spearphish tactic by leveraging content relevant to post-election Myanmar. A possible connection exists given that the C2 for these samples – jackhex.md5c[.]com – Seven Pointed Dagger exploitation campaign. A “LURK0” Gh0strat and another PIVY domain were also observed to have resolved to IPs contained within this range, making this subnet more suspicious from a targeted attack perspective.Dropped document referencing Myanmar’s democratic processA number of documents that appear to be economically focused were also observed recently and one of these samples also references Myanmar. This sample used a campaign ID of “mm20160405” and dropped a document named “Chairman’s Report of the 19th ASEAN Regional Forum Heads of Defence Universities, Colleges, Instiutions Meeting, Nay Pay Taw, Myanmar.doc” that references an Association of Southeast Asian Nations (ASEAN) meeting that took place in Myanmar in September of 2015. The timing of this sample is quite di erent from the earlier sample and seems to suggest at least a followup campaign due to the malware compilation timestamp of March 28, 2016, combined with an apparent timestamp value in the campaign ID of April 5, 2016 and the fact that the binary was  rst observed in the wild on April 11, 2016. The mutex speci ed in the con guration – 20150120 – is the same mutex used in the earlier sample that dropped a document referencing the STEP program, but this mutex is also used in many other PIVY samples that use the “ActiveUpdate” directory structure and is likely not useful for identifying the campaign or a relationship between samples outside of possibly sharing a similar version. The C2 used in this sample – admin.nslookupdns[.]com – sample discussed, ASERT has observed an overlap between many other malware families including Nitol, Gh0strat, and another PIVY sample that uses “ActiveUpdate“. This sample’s C2 domain is news.tibetgroupworks[.]com which provides an obvious suggestion at targeting dynamics, however no decoy documents were dropped and no further information was discovered to help support the targeting hypothesis.Dropped document referencing ASEAN meeting in MyanmarContinuing on with the theme of campaigns targeting ASEAN, sample “Robertus Subono-REGISTRATION_FORM_ASEAN_CMCoord2016.docx” that references an ASEAN Humanitarian Civil Military Coordination meeting that took place in Bangkok between March 28 and April 1 2016. The document purports to be a registration form for an attendee from Indonesia and is supposed to be sent to a Thailand Ministry of Defense email address. The sample has a compilation date of March 10, 2016, was  rst observed by ASERT on March 20, 2016 and also contains an invalid digital signature claiming to be signed by Google. Coupling the campaign ID of “modth” with the purpose and location of the meeting and the email address this form is supposed to be mailed to, a possible target of this sample could be Thailand’s Ministry of Defense. The C2s used by this sample overlap with the prior sample that references the ASEAN meeting in Myanmar nearly perfectly – the  rst C2 uses port 80, whereas the prior sample used 81 and they both use the same mutex and password. This overlap suggests a possible referencing an ASEAN meeting in ThailandThe decoy document “2016.02.29-03.04 -ASEM Weekly.docx” dropped by English like the other two observed documents – Google Translate identi es the language in the document as Mongolian.Decoy document references an Asia-Europe Meeting (ASEM) dropped a sandbox, but manual recovery yielded a document in Korean with a malware campaign ID of kk31. The document appears to reference Korean language schools abroad and the telephone number present yields an a liation with the Korean Ministry of Foreign named “Commission on Filipinos Overseas & Dubai.doc“, but this document did not render correctly in a malware sandbox or manually. VirusTotal revealed a sample from the Philippines which suggests that they, not Dubai / UAE, were the targets. The C2s for this sample used webserver.servehttp[.]com, also exhibited by many of the recent samples which suggests the same actor may be involved in this campaign activity.ConclusionAs this post and other recent posts detail, PIVY continues to evolve and be used in a myriad of targeted exploitation campaigns – not unlike many other targeted malware families such as PlugX or the Dukes. This will certainly not be the last evolution of PIVY, and ASERT continues to monitor these threats as they are discovered. I would also like to say thank you to Curt Wilson of ASERT for his assistance with research covered in this First Seen: Nov. 24, 2015 Name:STEP Democracy Year 1 Acheivements_25112015.exe Decoy Doc: STEP Democracy Year 1 Acheivements_25112015.docx Campaign ID: om C2s: jackhex.md5c.net:8080 jackhex.md5c.net:53 jackhex.md5c.net:53 Mutex: 20150120 First Seen: Nov. 23, 2015 Name:Year1achievementsv2.exe Decoy Doc: Year1achievementsv2.docx Campaign ID: om C2s: jackhex.md5c.net:8080 jackhex.md5c.net:53 jackhex.md5c.net:53 Mutex: 20150120 First Seen: April 7, 2016 Name: Commission on Filipinos Overseas & Dubai %E2%80%AEcod.doc Decoy Doc: Commission on Filipinos Overseas & Dubai.doc Campaign ID: gmkill C2s: webserver.servehttp.com:8080 webserver.servehttp.com:8080 webserver.servehttp.com:8081 Mutex: 20150120 First Seen: April 11, 2016 Name: 1.exe Decoy Doc: Chairman's Report of the 19th ASEAN Regional Forum Heads of Defence Universities, Colleges, Instiutions Meeting, Nay Pay Taw, Myanmar.doc Campaign ID: mm20160405 Domain Created: December 17, 2015 C2s: admin.nslookupdns.com:81 admin.nslookupdns.com:53 admin.nslookupdns.com:8080 Mutex: 20150120 First Seen: March 20, 2016 Name: Unknown Decoy Doc: Robertus Subono‐REGISTRATION_FORM_ASEAN_CMCoord2016.docx Campaign ID: modth Domain Created: December 17, 2015 C2s: admin.nslookupdns.com:80 admin.nslookupdns.com:53 admin.nslookupdns.com:8080Mutex: 20150120 First Seen: March 10, 2016 Name: 2016.02.29‐03.04 ‐ASEM Weekly.docx.rar^2016.02.29‐03.04 ‐ASEM Weekly.docx.exe Decoy Doc: 2016.02.29‐03.04 ‐ASEM Weekly.docx (Mongolian language) Campaign ID: wj201603 Domain Created: January 14, 2016 C2s: web.microsoftdefence.com:8080 web.microsoftdefence.com:8080 web.microsoftdefence.com:80 Mutex: 20150120 Name: Unknown Decoy Doc: 1.docx (corrupted but recoverable, Korean language) First Seen: April 9, 2016 CampaignID: kk31 C2s: webserver.servehttp.com:59148 webserver.servehttp.com:59418 webserver.servehttp.com:5000 Mutex: 20160301 Name: Unknown Decoy doc: 1.pdf, references project in Vietnam requesting an email to a Thailand email address First Seen: March 10, 2016 C2s: webserver.servehttp.com:59148 webserver.servehttp.com:59418 webserver.servehttp.com:1024 Mutex: 20160219 Campaign ID: mt39Discovered during investigation, but do not drop decoy docs, exhibited similar configuration padding Name: 2.tmp Decoy Doc: None First Seen: June 3, 2015 Domain Created: May 29, 2015 C2s: news.tibetgroupworks.com:80 news.tibetgroupworks.com:80 news.tibetgroupworks.com:80 Campaign ID: 213 Mutex: 2015012SHA1 Hashes63e00dbf45961ad11bd1eb55d 9c2771c2916a6 web.microsoftdefence.com admin.nslookupdns.com jackhex.md5c.net webserver.servehttp.comSUBSCRIBE TO THIS BLOGFirst NameLast NameCompanyEmailSUBSCRIBESEND FEEDBACKArbor’s Security Engineering & Response Team (ASERT) delivers world-class network security research and analysis for the bene t of today’s enterprise and network operators. ASERT engineers and researchers are part of an elite group of institutionsthat are referred to as ‘super remediators’ and represent the best in information security. ASERT has both visibility and remediation capabilities at nearly every tier one operator and a majority of service provider networks globally.ASERT shares operationally viable intelligence with hundreds of international Computer Emergency Response Teams (CERTs) and with thousands of network operators via in-band security content feeds. ASERT also operates the world’s largest distributed honeynet, actively monitoring Internet threats around the clock and around the globe via ATLAS , Arbor’s global network of sensors: url®TAG CLOUDBlack Peace Group Attacks algorithm Aldi 504 tra c network Iran Internet Protocol hijack Facebook Dirt Jumper Danny McPherson China Bot Wikileaks IPv6 Armageddon YouTube Security Botnet Internet service provider Internet tra c Google outage Arbor Networks - DDoS Experts BGP peering ""End of Internet"" Botnets Crypto Denial-of-service attack down Halloween internet IPv4 malware Streaming media 500 Internal DDoS AlbaDDoS Aldi Bot attack Beer DDoS BlogCORPORATE SITE PRIVACY POLICY THREAT PORTAL LEGAL ATLAS PORTAL© 2016 Arbor Networks, Inc. All rights reserved. ","The cybersecurity company Arbor Networks observed new activity involving the Poison Ivy remote access trojan (RAT) malware targeting several Asian countries over the past year. Technical analysis shows this Poison Ivy variant, nicknamed ""Korplug"", uses DLL sideloading to infect systems. It drops decoy documents hinting at targets, a DLL, and a shellcode file. The malware copies a legitimate Windows executable to load the DLL which decrypts configuration data and connects to command and control servers. Decoy documents suggest targeting of pro-democracy groups in Myanmar around recent elections. Other documents reference ASEAN meetings and members, hinting at targeting of Southeast Asian government and military organizations. Additional decoy documents are written in Korean and Mongolian languages. Infrastructure analysis reveals overlaps between this Poison Ivy activity and other malware families including Gh0strat and Nitol, suggesting possible coordination by a shared threat actor. The malware continues to evolve with new configurations and artifacts likely designed to evade defenses. Arbor Networks assesses that Poison Ivy remains an active threat, with new variants being used in targeted campaigns across Asia by motivated actors. They recommend monitoring systems for related indicators of compromise and ensuring protections against known Poison Ivy malware capabilities. ",test_19,threat actors; documents; a decoy doc; Decoy Document; Poison Ivy; a l; Windows; US; the dropped DLL; om; the malware; capabilities.
