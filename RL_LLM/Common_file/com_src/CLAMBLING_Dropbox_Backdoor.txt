2/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄTalent-Jump Technologies, Inc Talent-Jump Technologies, IncTechnical Blog Technical BlogRecent¬∑Archives¬∑RSSCLAMBLING - A New BackdoorBase On Dropbox (EN)#Malware #APT #IncidentResponsePost on Feb 17 2020 By Theo Chen, Zero ChenIn July 2019, one of our customer‚Äôs company suÔ¨Äering the APT attack and we start the investigation immediately. During the investigation we found a brand new backdoor sample, which implements lots of features by using Dropbox API, using Dropbox like a C&C server. After the reverse engineering, we extract the Dropbox token used by the sample, dig into Dropbox folder, and reveal the whole functional structure.The report is co-authored with Trend Micro.Kenney Lu, Daniel Lunghi, Cedric Pernet, and Jamz Yaneza. (17 February 2020). Trend Micro. ‚ÄúOperation DRBControl - Uncovering A Cyberespionage Campaign Targeting Gambling Companies In Southeast Asia‚ÄùFirst Stage InfectionThe threat actor uses Windows Defender Core Process MsMpEng.exe which has a legal digital signature to load the malicious DLL Ô¨Åle. Load the shellcode from thewww.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/1/232/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄpayload Ô¨Åle then release the Ô¨Ånal malicious executable to complete the Ô¨Årst stage infection.During the investigation, we found a total of 8 diÔ¨Äerent loader‚Äôs Ô¨Ålenames [Appendix 1] renamed from MsMpEng.exe and placed at C:\ProgramData\Microsoft in its separated folder. The loader is just called the function ServiceCrtMain imported from mpsvc.dll.The malicious DLL Ô¨Åle mpsvc.dll has two types . The older type will try to read shellcode from payload Ô¨Åle English.rtf, decode and decompress the content using RtlDecompressBuffer to release the Ô¨Ånal executable (Figure 1).[Appendix 2]Figure 1. Older type of mpsvc.dllThe newer one has a diÔ¨Äerent way to start the infection. There is a piece of shellcode hard-coded in the mpsvc.dll, after decoding the shellcode from mpsvc.dll, it will inject and execute to load the shellcode from mpsvc.mui (Figure 2), which will release the Ô¨Ånal executable and inject into the process.www.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/2/232/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄFigure 2. Newer type of mpsvc.dllBoth of these two types of mpsvc.dll will release a full functional backdoor, which can connect to the C&C server. But the Ô¨Ånal executable released by a newer type of mpsvc.dll has some upgrade, including the function to interact with Dropbox API. The following article will focus on the malicious executable released by the newer type of mpsvc.dll.The hardcoded shellcode in a newer type of mpsvc.dll will Ô¨Årst allocate 0x80000 bytes of memory space. Getting the current module‚Äôs full path and replace the extension dll to mui and read the shellcode in this mui Ô¨Åle, then jump to the base address of mui Ô¨Åle plus its Ô¨Årst byte. (Figure 3)www.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/3/232/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄFigure 3. Decoded shellcode in mpsvc.dllIn the end, the shellcode in mpsvc.mui has another diÔ¨Äerent piece of hard-coded bytes, which will decompress by RtlDecompressBuffer to the Ô¨Ånal malicious executable (Figure 4).www.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/4/232/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄFigure 4. The Ô¨Ånal malicious executable in buÔ¨Äer.Sample AnalysisThe Ô¨Ånal malicious executable sample we extracted has numerous features. Here is the analysis of some major functions.Bypass UAC, the threat actor only changes the GUID to 9BA94120-7E02-46ee-This sample can bypass UAC via .NET. It is not a new technique which was disclosed in 2017 ADC6-10640B04F93B (Figure 5) and specify the location of DLL Ô¨Åle which will load by the .NET application in the elevated process.[1]www.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/5/232/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄFigure 5. Code snippet of bypass UAC.PersistenceThere are two ways to persist. Register as a startup program in HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersio n\\Run if it has no privileged (Figure 6). Otherwise, it will register itself as a system service (Figure 7).Figure 6. Register as a start program.www.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/6/232/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄFigure 7. Register as a system service.Information GatheringIt will collect some basic information like IP address, hostname, username, OS version and so on. Also, it will search the registry key‚Äôs value HKEY_CURRENT_USER\\Software\\Bitcoin\\Bitcoin-Qt and try to look for the wallet address if exist (Figure 8). All of this information will upload to Dropbox as %Y-%m-%d %H-%M-%S.log, below is a Ô¨Åle sample:Lan IP: x.x.x.x Computer: WIN-XXXXXX UserName: Administrator OS: Win10(X64) Version: 8.0 Bit: Not Found !!! Exist: NOwww.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/7/232/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄFigure 8. Code snippet of information gathering.Recording FeaturesThis sample acquired three types of recording features, including key-log, clipboard log, and screen recording. The screen recording Ô¨Åle naming format is [%y-%m-%d] %H-%M-%S.avi. The key-log and clipboard log will encode by diÔ¨Äerent key and salt, then save as <hash>.pas for key-log and <hash>.log for clipboard log (Figure 9).www.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/8/232/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄFigure 9. Code snippet of key log encoding.Connect to C&C ServerThis sample can also connect to a speciÔ¨Åc C&C server and send back data by using a fake HTTP POST request (Figure 10).www.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/9/232/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄFigure 10. Code snippet of preparing for fake POST request.RTTI InformationThe RTTI information remaining, here is the full class name list we got:CHPAvi CHPUdpInteract With Dropboxwww.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/10/232/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄDuring reverse engineering, we found that the Dropbox API token with 64 characters is hardcoded in stack string (Figure 11).Figure 11. Code snippet for the Ô¨Årst 24 characters of Dropbox API token.Besides connecting to the C&C server, this sample can also upload & download with Dropbox API. Especially when the log Ô¨Åle is uploaded, it will try to download bin.asc and check the Ô¨Åle has fake GIF Ô¨Åle header or not. If everything is correct, it will continue to the custom decoding phase, which will calculate with an array of bytes hard-coded in the sample, to release the inject payload (Figure 12).www.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/11/232/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄFigure 12. Code snippet of interaction with Dropbox API.Inside of Dropbox FolderAfter we got the Dropbox token, we can now dig into Dropbox by using oÔ¨Écial API, for example, list the account information which creates this token, list the full Ô¨Åle and folder information.In the Dropbox, the folder structure like this:/<unique_hash>/%Y-%m-%d\ %H:%M:%S.log /<unique_hash>/bin.asc /x86bin.ascEach infected victim has its folder named by unique hash /[0-9A-z]/, this hash is generated by machine key and some other information. %Y-%m-%d\ %H:%M:%S.log is the log Ô¨Åle upload by the victim. *.asc is the Ô¨Åle upload by the threat actor. For example, bin.asc is the payload download by the victim when the log Ô¨Åle is upload succeeds.www.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/12/232/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄSort out the log Ô¨Åle on Dropbox, we can get the full list of infected computers (Figure 13).Figure 13. The list of infected computers.Second Stage InfectionAfter the Ô¨Årst infection stage completed, it will persistent itself as a system service or autorun program. Collecting information and establish a connection to the C&C server. The most interesting part is each time when the log Ô¨Åle is upload succeeds, it will try to download bin.asc from each computer‚Äôs unique folder. Most ofwww.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/13/232/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄbin.asc we captured is requesting the victim to download x64bin.asc Ô¨Åle from Dropbox.Further analysis of x64bin.asc, we found the second Dropbox API token, its purpose is diÔ¨Äerent from the Ô¨Årst one. Now the threat actor is ready to use Dropbox as another C&C server with the full backdoor feature.The second infection stage‚Äôs sample has some bonus features including the ability to interact with Dropbox, the command code mapping show as below:Command Code Action2345678ListDrivesListFilesExecuteFileManageFileUploadFileDownloadFileOpenTerminalIn these commands, there are three diÔ¨Äerent Ô¨Åles, each of these Ô¨Åle has speciÔ¨Åc Ô¨Ålename and purpose:eLHgZNBH: The status Ô¨Åle, upload to Dropbox at regular intervals. yasHPHFJ: The command Ô¨Åle, containing command and arguments. csaujdnc: The execution result of the command.The status Ô¨Åle eLHgZNBH contain the basic information about victim and timestamp, upload to Dropbox at regular intervals. Whenever status Ô¨Åle upload succeeds, it will try to download the command Ô¨Åle yasHPHFJ if it existed. Extract the command code and arguments from yasHPHFJ then execute the command and upload the execution result to Dropbox as csaujdnc (Figure 14).www.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/14/232/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄFigure 14. Flow of three Ô¨Åles interact with DropboxBy using this control Ô¨Çow, the threat actor can use Dropbox as a C&C server to control the victim‚Äôs computer even the Ô¨Åxed connection between the speciÔ¨Åc C&C server‚Äôs IP address has been found and blocked. Unless we block content.dropboxapi.com and api.dropboxapi.com, otherwise we can not isolate the infected computer.The Dropbox API remain the detail of each Ô¨Åle and folder, for example this is a Ô¨Åle information return by Dropbox API:{ '.tag': 'file', 'name': 'Secret_File.txt', 'path_lower': '/secret_file.txt', 'path_display': '/Secret_File.txt', 'id': 'id:<UNIQUE_FILE_ID>', 'client_modified': '2019-07-21T02:45:42Z', 'server_modified': '2019-07-21T02:53:04Z', 'rev': '[0-9a-f]{6,}', }www.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/15/232/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄIt contains the server_modiÔ¨Åed timestamp even with history revision Ô¨Åle id, we can use rev to list the full history of this Ô¨Åle and download it. Sort out this information and the command code mapping, we can now list the full command executed on each computer and its arguments. Here is two computers‚Äô execution list (Figure 15 & 16).Figure 15. Real command execution list from one victim.Figure 16. Another real command execution list.According to these record, the threat actor follows almost the same action on every infected computer. First, download additional attack programs from Dropbox, like mimikatz or other UAC bypass tools. Second, search the high-value Ô¨Åle includingwww.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/16/232/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄprivate source code, conÔ¨Åg Ô¨Åle, database, and the key-log / clipboard log. Upload all of these Ô¨Åles to Dropbox for further searching. Last but not least, inÔ¨Åltrate the company intranet or even the cloud service.Combining all decoded yasHPHFJ Ô¨Åles, we can show the threat actor‚Äôs approximate working hours (Figure 17).Figure 17. The threat actor‚Äôs approximate working hours.ConclusionWe start to monitor the Dropbox for each token and parse the infected computer‚Äôs list, here we can see the infected computer‚Äôs number from July 2019 to September 2019 this two month (Figure 18 & 19).Figure 18. Dropbox A (Ô¨Årst token): infected computer‚Äôs number.www.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/17/232/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄFigure 19. Dropbox B (second token): infected computer‚Äôs number.We got nearly 200 infected computers at the highest peak from Dropbox A, alone with nearly 80 computers from Dropbox B. Both of these static has a drop at August 21, 2019, the threat actor clear the Dropbox folder for some reason. Monitoring ends on September 20, 2019, all tokens we got are revoked by the threat actor.During these two months, we got Ô¨Åve diÔ¨Äerent Dropbox token. Each of these tokens has its purpose. The Ô¨Årst two tokens are the major one we discuss in this article, others are more like for testing.From the Ô¨Årst infection stage, established the connection between the C&C server and Dropbox at the same time. If the IP address of the C&C server been blocked, it can still have limited control from Dropbox. Once it completed the second infection stage, Dropbox is turning into a second channel C&C server which has full remote control features (Figure 20). Steal the data and inÔ¨Åltrate the whole company. This 112c75ddd2rsoplicy.exe (PE32+) DRM.exe (PE32+) Firewall.exe (PE32+) Kaspe.exe (PE32+) RSoPProv.exe (PE32+) Video.exe (PE32+) office.support.googldevice.com safe.mircosofdevice.com server.correomasivochile.com srv2.mkt-app.com store.microsoftbetastore.com update.mircosotfdefender.comReferences1. UAC bypass via elevated .NET applications 2. Dropbox for HTTP Developers 3. url companies-in-southeast-asiaOlder PostCommentswww.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/22/232/18/2020CLAMBLING - A New Backdoor Base On Dropbox (EN) | Ë©ÆÁùøÁßëÊäÄ0 CommentstalentjumpRecommendÔÑàt Tweet f ShareStart the discussion‚Ä¶LOG IN WITHOR SIGN UP WITH DISQUS?LoginÓòÉ1 Sort by BestBe the Ô¨Årst to comment.Subscribe‚úâdAdd Disqus to your siteAdd DisqusAddDisqus' Privacy PolicyPrivacy PolicyPrivacyüîíwww.talent-jump.com/article/2020/02/17/CLAMBLING-A-New-Backdoor-Base-On-Dropbox-en/23/23 