Analysis of HUI Loader --JPCERT / CC Eyesblogs.jpcert.or.jp/ja/2022/05/HUILoader.htmlHidemasa Tomonaga (Shusei Tomonaga)2022/05/16HUI Loader analysisEmailIn order to hide the functionality of the malware, an attacker may encode the malware itself and decode it only at runtime to make it work. In such cases, the encoded malware itself is loaded and executed by a program called a loader. In this way, splitting the malware into a loader and the encoded malware body minimizes the functionality of the loader and hides important functionality of the malware, making it harder to find on the infected host. This time, I will explain about HUI Loader, which has been used since around 2015, among such loaders.Overview of HUI LoaderHUI Loader is a loader that has been pointed out [1] to be used by multiple attack groups in JSAC2022 . JPCERT / CC has also confirmed attacks using HUI Loader since around 2015. Figure 1 shows the attack group using HUI Loader and the changes in HUI Loader.Figure 1: Transition of HUI LoaderThe use of HUI Loader was first confirmed around January 2015, confirming that it was used by attack group APT10. After that, from around April 2015, it was used by Blue Termite. These attack groups used encoded malware that was loaded into three types of HUI Loader: Note that Poison Ivy and Quasar were customized by the attacker from the original.PlugX Poison Ivy [2] Quasar [3]Since 2016, we have continuously confirmed that it is being used by attack group APT10, but since June 2020, we have also started using attack group A41APT [1] . In addition, since August 2021, it has also been used by attack group DEV- 0401 [4] . The method of encoding the malware itself has not changed from the beginning, and it can be decoded as follows.for i in range ( len ( enc_data ) ) :data = ord ( enc_data [ i ] ) ^ 0x20 ^ ord ( key [ i % len ( key ) ] ) dec_data .append ( data ) _The following describes the following HUI Loader function changes that have been made so far.1/4Persistence Password randomization Disable security features Deletion of characteristic stringsPersistenceHUI Loader may or may not have the Persistence function. The Persistence function confirms the following three patterns.service Registry (Run key) Startup folderMany HUI Loader register a service and start it as a service on reboot. The service name etc. will differ depending on the sample. The type that boots from the registry was confirmed around 2015, but it has not been seen in recent samples. For the type that starts from the startup folder, create an LNK file in the startup folder as shown in Fig. 2 and start it via the shortcut file.Password randomizationFigure 2: Code to create an LNK file in the startup folderHUI Loader, which was confirmed around 2015, decoded the malware itself using a regular character string as a password. Therefore, the same password was often used for multiple samples. Since 2016, passwords have been 07-14 07-16 11:17:042017- 05-24 11:50:562017- 09-07 09-19 05:03:45Table 1: Examples of passwords used by HUI LoaderDisable security featuresSome HUI Loader have code that aims to bypass the Windows OS security features Event Tracing for Windows (ETW) and Antimalware Scan Interface (AMSI). Figures 3 and 4 are part of the code that bypasses ETW and AMSI.Figure 3: Code example that bypasses ETWThe beginning of the AmsiScanBuffer function and the EtwEventWrite function is changed to the RETN instruction.Figure 4: Code example that bypasses AMSIDeletion of characteristic stringsHUIHWASDIHWEIUDHDSFSFEFWEFEWFDSGEFERWGWEEFWFWEWD The HUI Loader contained a characteristic string in the sample . However, since December 2021, we have confirmed samples that do not contain this character string. Figure 5 compares samples with and without characteristic strings.Figure 5: Characteristic string(left: no characteristic string, right: with characteristic string)in conclusion3/4HUI Loader is a loader that has been used for a long time while being updated little by little from around 2015. It is expected that it will continue to be used in the future. IoC of HUI Loader introduced this time is open to the public on Github. Please use it as needed.url Response Group Hidemitsu TomonagaReference information[1] JSAC2022: What we can do for the chaotic A41APT campaignurl JPCERT / CC Eyes: PoisonIvy that supports authentication proxyurl JPCERT / CC Eyes: Attack activity by Quasar Familyurl Symantec Enterprise Blogs: LockFile: Ransomware Uses PetitPotam Exploit to Compromise Windows Domain windowsurl Â© 1996-2022 JPCERT / CC All Rights Reserved.4/4 