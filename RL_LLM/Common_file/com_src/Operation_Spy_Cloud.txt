The 'Spy Cloud' Operation: Geumseong121 groupcarries out the APT attack disguising the evidenceof North Korean defectionThe Background of 'Operation Spy Cloud' APT CampaignESRC (ESTsecurity Security Response Center) researchers identified the new APT campaigncarried out by the state-sponsored group named 'Geumseong121' in early March 2020.'Geumseong121', a North Korean threat group has been conducting the state-sponsoredespionage activities in the cyberspace of South Korea for years, mainly targeting those whoare engaged in unification, foreign affairs, or national security, the leaders of the organizationsspecializing in North Korean issues, and North Korean refugees.ESRC analyzed the recently discovered campaign based on Indicators of compromise (IoC)data and pieces of evidence collected by threat intelligence multi-channel sensors includingthe ESTsecurity’s security solution ALYac.The report titled “The stealthy mobile APT attack carried out by Geumseong121 APT hackinggroup” published in November last year, reveals that the group has attempted to performcyber-attacks targeting a wide range of devices including computers as well as mobile devices.In particular, the group infiltrated an unspecified website and exploited it as a commandcontrol (C2) server in the 'Operation Dragon Messenger' campaign. Also, we observe theevolution of the attack strategies in the web servers, which have been built by the group usingits design, for use in the newly discovered attack.Moreover, the use of trust-based attack tactics such as Google Play Store or YouTube isdistinguished from the existing attack strategies that have been used by most threat actors.The APT campaign used the advanced spear-phishing techniques with the bait file containingevidence of North Korean defectors to trick email recipients into believing they received anemail from a trusted source.ESRC named the Geumseong 121 group’s APT campaign as 'Operation Spy Cloud' based onthe use of Google Drive and PickCloud service.APT attack vector: spear phishing tactics and processesThe group of attackers behind the 'Operation Spy Cloud' make full use of and derive benefitfrom a spear-phishing technique that enables the direct and stealthy access to the attacktargets.The spear-phishing email used in the attack contains a malicious link, which tricks users to clickto download the file attaching the malicious MS Word DOC document.Based on the samples we collected, the campaign's decoy documents used the file formatsDOC, XLS, and HWP, the Korean government standard word processor format, targeting theusers in South Korea.[Figure 1] Attack flow of 'Operation Spy Cloud'The attacker attempted to distribute the file by using a URL link instead of attaching the fileconsidering that a security solution could capture emails where a malware threat is detected inan attachment and block the email before delivery. This allows attackers to modify or deletefiles as needed, to evade detection and minimize the footprint.ESRC has identified some file download links used in the attack, which were not active anylonger during the analysis process because the attackers had already removed the files.The analysis result of the malicious DOC Word file used for the attack reveals that theshellcode is combined with the obfuscated malicious VBA macro.When executing the shellcode, it connects to the Google Drive set as the command control(C2) server, executes the EXE malicious module, and attempts to leak computer information tothe pCloud.In-depth analysis of the tactics and tools used in 'Operation Spy Cloud'When a malicious DOC document is executed, a fake screen appears as if a certain imagearea is not displaying properly as follows, with the phrase saying that 'This picture is notautomatically downloaded from the Internet to protect personal information.' on the top ofthe document.The attackers trick users into believing that the image is not displayed properly due to theprivacy protection and clicking the [Enable Content] button.[Figure 2] Malicious document disguised as a file related to North Korean refugeesThe following VBA macro functions are included in the DOC document, and the maliciousfunction is activated when the [Enable Content] button is executed.In the first stage, it uses the 'CreateMutex' function to declare the mutex as 'm_mtn' value toavoid duplicate execution.Option ExplicitPrivate Declare PtrSafe Function CreateMutex Lib "kernel32" Alias "CreateMutexA" (ByVallpMutexAttributes As Long, ByVal bInitialOwner As Long, ByVal lpName As String) As LongPrivate m_mt As LongPrivate Sub ghjkjhgyujx()m_mt = CreateMutex(0, 1, "m_mtn")Dim er As Long: er = Err.LastDllErrorIf er <> 0 ThenApplication.DisplayAlerts = FalseApplication.QuitElseEnd IfEnd SubThen, the producer checks for the file name of a specific foreign security program using Midfunction in the string list, and if it does not exist, continues the decoding routine. Therefore, itcan be used as ‘kill switch’ depending on the conditions.- c:\windows\avp.exe- c:\windows\kavsvc.exe- c:\windows\clisve.exe2WOGfbmNyi*IKP7JX9A)dcLelj(kETogHs.#wxBU+13rv&6VtC,uYz=Z0RS8aM4sen_str = pQFqnD5h[Figure 3] Function to check for a specific security programNext, it registers the registry key to modify the macro security settings as follows:It replaces theHKEY_CURRENT_USER\Software\Microsoft\Office\(Version)\Word\Security\AccessVBOMvalue with '1', which allows secure access to the VBA project object model in developer macrosettings. It also declares a specific encoding string to decode the obfuscated shellcode listed atthe bottom of the macro function.[Figure 4] Registering the registry key and shellcode decoding string declarationstr_on = abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890&*(),.#+=str_en = 7JX9A)dwxBU+13rv&tC,uYz=Z0RS8aM4FqnD5h2WpQOGfbmNKPcLelj(kogHs.#yi*IET6VThe 72 byte-string is replaced with a string that is symmetrical at each position andrearranged. The shellcode is one of the key areas in the following macro functions.[Figure 5] Encoded shellcode areaThe analysis of the shellcode identifies the command attempting to connect to a specificGoogle Drive, which is used as a command control (C2) server. In this case, a securitydetection system could determine it as a normal connection.[Figure 6] Access to Google Drive, the C2 server using the shellcode commandGoogle Drive includes a file named 'invoice.sca' disguised as an invoice file.The last modified time of the file is on the afternoon of March 10, 2020, and the file isencrypted with XOR algorithm. The owner who shared the file is using the Gmail account'godlemessy@gamil.com'. The analysis result shows that it was the G-mail account used bythe group behind the campaign, which has often seen in similar threat cases previously.[Figure 7] Attacker information and payload registered in Google DriveThe 'invoice.sca' file (0xbf 0x7a 0x79 0x51 4 bytes) is XOR-encrypted in iterative decodingscheme, then the malicious module inside will appear.File Name invoice.sca (decode)Time Stamp (UTC) 2020-03-02 23:32:17MD5 392647675E8DFCD2602B4FFE38A19E2B[Figure 8] Comparison of payload decodingThe decoded malicious code communicates to the cloud server using pCloud access tokendata, steal the system information, and installs the additional backdoors according to theattacker's intention. The main functions of the spy module are not much different from thetools used by the 'Guemseong 121' group.[Figure 9] Access token for pCloud communicationThe information such as the json file containing the account history and the email addressthat the attacker used, and when the attacker signed up for the service have been identifiedby browsing the account of the attacker who registered the cloud service based on the API."registered": "Wed, 10 Apr 2019 06:40:53 +0000","email": "kpsa-press@daum.net",The information reveals that the attacker registered the cloud service on April 10, 2019, andsigned up with the Daum/kakao account 'kpsa-press@daum.net'.[Figure 10] json file information used for registration of cloud serviceESRC has released an email address similar to 'kpsa-press@daum.net' in the report titled'Geumseong121's APT attack impersonating the Ministry of Unification, distribute malware toGoogle Drive' in April 2019.The previously discovered email address 'kpsapress@gmail.com' was using the domain ofGoogle Gmail instead of Daum/kakao account.The Gmail's recovery email is set as 'kps·······@d···.net', which is similar to the account 'kpsa-press@daum.net'.[Figure 11] Analysis of Google Account RecoveryHowever, TTPs (Tactics, Techniques, and Procedures) and the final payload are exactly thesame as the materials that were used for 'Operation Spy Cloud'.The research findings so far suggest that the 'Geumseong 121' group is using the samestrategies and technologies in the same way as it was in its previous attacks.Similarity comparison analysis of 'Spy Cloud' and 'Geumseong 121' attackcasesESRC released the threat intelligence report 'Operation Printing Paper 3', in which in-depthdata and Indicator (IoC) data ensuring that the same group is behind the 'Operation SpyCloud' APT attack are included, on Threat Inside service on March 13, 2020.[Figure 12] The latest threat intelligence report cover page of the same APT groupESRC has analyzed multiple attack traces of 'Operation Spy Cloud' quite comprehensively,finding out that the 'Guemseong 121' group's cyber operation activities and threat indicatorsare strongly connected.Several e-mail accounts and subscription information of Internet cloud service used byattackers are the same exactly, some of which have been changed or revoked.In particular, Google Gmail accounts found in DOC malicious documents were recycled asthey were used in HWP malicious documents, and several HWP post script techniques used invulnerability attacks also overlapped.Moreover, not only Windows-based malicious files but also Android-based smartphone attackmethods have been found in the 'Operation Spy Cloud' campaign.[Figure 13] Comparative analysis of 'Guemseong 121' attack casesThe same technique has been used for most PostScripts of the HWP malicious document file.The similarity is very high in variable declaration, etc., and the same post scripts are used insome cases. New techniques have been introduced to evade detection of security solutions insome variants.[Figure 14] Comparison of postscript techniques used in malicious hwp documentsThe comparative analysis of the functions of the final payload binary files generated when thevulnerability in the hwp document is triggered indicates that they consist of the samecommands. Also, cloud services such as Dropbox and pCloud have been used as commandcontrol (C2) servers for information leaks.[Figure 15] Comparison of final binary functions installed as a hwp document fileAs we have seen so far, the 'Geumseong 121' group has been continuously carrying out themultiple threat activities targeting against South Korea.ESRC analyzed many hacking tools and strategies used by the 'Guemseong 121' group toconfirm that the group has carried out cyber reconnaissance on a daily basis.As cyber criminals become increasingly sophisticated and cyber security threats continue torise and government-supported cyber operations emerge as a threat to national security,threat intelligence-based response and cooperation in cybersecurity is urgently needed.We will provide you with more detailed information related to our research containing thethreat cases and Indicators of Compromise (IoC) information of the 'Geumseong 121' groupon the 'Threat Inside' service. 