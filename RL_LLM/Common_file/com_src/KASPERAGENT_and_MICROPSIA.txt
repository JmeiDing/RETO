Blog Home (url > Unit 42 (url > Targeted Attacks in the Middle East Using KASPERAGENT and MICROPSIATargeted Attacks in the Middle East Using KASPERAGENT and MICROPSIABy Tomer Bar (url and Tom Lancaster (url April 5, 2017 at 5:00 AM Category: Unit 42 (url Tags: Android (url ClearSky (url Google (url KASPERAGENT (url malware (url MICROPSIA (url Microsoft Windows (url Middle East (url mobile (url mobile network operators (url SECUREUPDATE (url VAMP (url  18,376 (7)(url micropsia%2F+Targeted+Attacks+in+the+Middle+East+Using+KASPERAGENT+and+MICROPSIA)  (url u=https%3A%2F%2Fresearchcenter.paloaltonetworks.com%2F2017%2F04%2Funit42-targeted-attacks-middle-east-using- kasperagent-micropsia%2F)  (url mini=true&url=https%3A%2F%2Fresearchcenter.paloaltonetworks.com%2F2017%2F04%2Funit42-targeted-attacks- middle-east-using-kasperagent- micropsia%2F&title=Targeted+Attacks+in+the+Middle+East+Using+KASPERAGENT+and+MICROPSIA&summary=&source=)(//www.reddit.com/submit)This blog is the result of joint research between Unit 42 and Eyal Sela ClearSky Cyber Security (url Over the past few months Palo Alto Networks have been working together with ClearSky on preventing and detecting targeted attacks in the Middle East using two relatively new Microsoft Windows malware families which we call KASPERAGENT and MICROPSIA. In addition, our research has uncovered evidence of links between attacks using these two new malware families and two families of Google Android malware we are calling SECUREUPDATE and VAMP. We named the ﬁrst new Microsoft Windows malware family “KASPERAGENT” based on strings we found in the malware. (Note that we DO NOT believe this is a reference to Kaspersky Lab). We named the second new Microsoft Windows malware family MICROPSIA because the malware is very tightly packed making it appear smaller than it is, similar to the human condition micropsia (url We named the ﬁrst new Google Android malware family SECUREUPDATE because it masks its malicious updates a secure updates. We named the second new Google Android malware family VAMP because it’s focused on stealing data. The attacks are not highly sophisticated, but the themes used, organizations and geographies targeted, as well the persistence of the attacker suggest a determined and noteworthy adversary. Some of this activity has been covered in a recent post by 360 security (url however there is still a great deal of extra detail we are able to add in this report. Starting in March 2016, Palo Alto Networks began monitoring this threat following the successful prevention of the execution of a sample of the KASPERAGENT malware on a customer system, however the malware had likely already been used in attacks as early as July, 2015. At the time of writing, we have uncovered:113 samples of the KASPERAGENT malware 94 samples of the MICROPSIA malware 17 samples of Android Malware which are related to this activity. 39 command and control domains registered in relation to this activityMost of the attacks discovered so far target users in the United States, Israel, Palestinian Territories, and Egypt; although there are occasional outliers. Notable outliers include media organizations in a variety of countries.This post will begin by exploring how the attackers attempt to gain a foothold into target networks before brieﬂy describing the malware families used. One Bit.ly at a time This group of attackers favors using URL shortening services to disguise the true links they are sending in spear phishing emails. In particular, a number of samples we analyzed were linked via the URL shortening service “bit.ly”. The URL shortening service then redirects users to the malicious payload hosted on attacker controlled pages, with the malicious payload nearly always contained in an archive ﬁle (most commonly a RAR ﬁle.) Using the statistics provided by these link-shortening services, we can gain an immediate insight into the targets clicking these links:Figure 1: The bit.ly statistics for a link to a dropper for the MICROPSIA malware family. The statistics vary per link, suggesting diﬀerent target audiences for diﬀerent waves of spear phishing. For example, the statistics shown in Figure 1 the campaign targeted 113 users in Egypt, whereas in another example shown in Figure 2, Egypt did not make the top 3 countries targeted:Figure 2: The bit.ly statistics for another link to a copy of the MICROPSIA malware family FAKE NEWS! Sending spear phishing emails with direct links to malicious shortened URLs was not the only method employed by the attackers to entice users to install the malware, another method favored by the attackers was the setting up of fake news sites. Figure 3 shows examples of pages created by the attackers to this end.Figure 3: Two fake new sites with links to shortened malicious URLs. We are unable to conﬁrm how traﬃc was driven to these sites, the attackers may have helped drive traﬃc via fake social media accounts, or they may have sent spear phishing links to these pages. Malware Analysis: MICROPSIA, KASPERAGENT and the missing link During our analysis, we discovered two distinct malware families which for the most part leveraged distinct infrastructure with no overlaps, initially leading us to categorize these campaigns separately. Later, we discovered a key link between the two sets of activity which leads us to believe they are related. The MICROPSIA activity centers around domains registered using the email address adam.swift.2016@gmail[.]com – and no samples of KASPERAGENT talk to these domains. However, one of the domains (drive.acount-manager[.]net) registered by this KASPERAGENT, causing us to link the two sets of activity. KASPERAGENT We have named the most common malware involved in this campaign, KASPERAGENT, due to PDB strings left behind in many samples of the malware. An example of a PDB string left behind is given below: 1 c:\Users\USA\Documents\Visual Studio 2008\Projects\New folder (2)\kasper\Release\kasper.pdb This analysis is based on the following ﬁle: The malware also drops a decoy document containing Arabic names and ID numbers to the same folder and displays it to the user. KASPERAGENT is developed in Microsoft Visual C++ and attempts to disguise itself as a product that does not exist: “Adobe Cinema Video Player”. The malware ﬁrst establishes persistence using the classic method of adding a Run key, using the value “MediaSystem”. The malware connects to a C2 serverhosted on www.mailsinfo[.]net. The C2 server string in the binary is “obfuscated” in the most basic of senses, with the author adding ‘@’ characters between letters and splitting the starting “www.m” to another string.Figure 4: The Command and Control domain is obfuscated using a basic technique Most of the samples of KASPERAGENT use “Chrome” as the user agent, but this recent sample uses “OPAERA”, possibly a misspelling of “Opera”, the browser. The malware communicates with the C2 server via HTTP requests and in the most recent samples observed the callbacks are made to PHP scripts whose names relate to towns or navigation. Example URLs used include:GET request to /dad5/town.php POST request to /dad5/addCity.php and /dad5/sign.phpMost examples of the malware are nearly identical, and the malware simply acts as a basic reconnaissance tool and downloader for further payloads, however some examples of the malware include extended capabilities beyond that of a simple downloader. Take screenshots Recording user keystrokes Exﬁltrate basic environment information such as the username and computer name Perform arbitrary commands Enumerate removable drives and copy ﬁles of interest to a new folder for exﬁltration Update the malware to a new version Exﬁlitrate arbitrary ﬁles (zip compressed and encrypted)It’s also worth mentioning that sometimes that both versions of the malware are wrapped in a Microsoft .NET Framework loader which is responsible for deploying the malware and displaying the decoy document. The author (imaginatively) calls this wrapper contains the PDB string: C:⧵Users⧵Yousef⧵Desktop⧵MergeFiles⧵Loader v0⧵Loader⧵obj⧵Release⧵Loader.pdb MICROPSIA Analysis The MICROPSIA malware family is written in Delphi (url and is an information stealing malware family with a wide range of data theft functionality built in. This analysis is based on the following We named the malware MICROPSIA because of the way it is often packaged. The malware is often delivered as a RAR, which once extracted contains an EXE, which is further packed using UPX. Once unpacked from UPX, the next level is a further SFX RAR ﬁle, which then contains the actual malware ﬁles within. This eﬀectively means the initial payload is extremely compressed andappears much smaller than it really is. (url The ﬁnal payload contains four legitimate executables as resources:1. Two embedded DLLs relating to the OpenSSL library used for traﬃc encryption. 2. A copy of a command line version of WinRAR – used for encrypting and compressing the exﬁltrated data 3. The ﬁle ‘shortcut.exe’ from optimumx.com (Creates, modiﬁes or queries Windows shell links)this is used for persistence by creating a link in the startup folder to the payload.The malware begins execution by ﬁrst copying itself to a predeﬁned location, setting up persistence via an LNK ﬁle (hence the inclusion of the aforementioned shortcut.exe) The main capabilities of the malware are as follows:Logging of keystrokes to a hardcoded text ﬁle and exﬁltration to a remote server Capturing screenshots of the infected machines Searching for ﬁles with extensions matching Microsoft Oﬃce documents and using WinRAR to archive these prior to The value “d58ccc009be55ﬀ172a9039bf35cf27” is used to encrypt exﬁltrated documents and appears to be an MD5 hash, but we have not identiﬁed a string that maps to this hash. A side of phishing Interestingly in some cases the attackers combined an attempt to infect targeted users with malware, with an attempt to steal their credentials via traditional phishing techniques. The attackers sometimes directed users to sites spooﬁng legitimate services such as Google Drive to download the malware, however ﬁrst the target users would be asked to ﬁll in their credentials in, giving the attackers two chances to successfully steal target users’ data (via the phish and via the eventual malware infection):Figure 5: In some cases, users were required to ﬁll in their credentials to download the malware And there’s an APK twist… Whilst a large number of the domains associated with the adam.swift.2016@gmail[.]com email address are associated with MICROPSIA samples, some have been observed hosting Android apps or acting as C2 domains for Android malware samples. Analysis of these apps shows these are also malicious, and the apps also contain some social engineering tricks to enable installation. There are two main APK malware families used by the threat actor. The ﬁrst is a malware family used to gain a foothold on to the device, it is eﬀectively a downloader with no additional functionality and we call this malware SECUREUPDATE.Figure 6: The applications often pretend to be social applications popular with end users. calendar to sleep, creating an alarm in the future, at which point the malware would call back to receive an “Update”:Figure 7: The alarm functionality in the SECUREPDATE malware was used to download and execute a further payload at a later date. In a similar vein to the ‘a side of phishing’ section, some of the versions of SECUREUPDATE backdoor attempt to steal credentials for users, making them create accounts for these fake apps in addition to the installation of the malware. This technique relies on credential re-use across many accounts but will still yield some success for the attackers:Figure 8: Some of the apps require users to “Login” giving the attacker the chance to record credentials of victims that may well be reused elsewhere. The second malware family is a malware family we call VAMP, which is already described in great detail (urlﬁle/APTSWXLVJ8fnjoxck.pdf) in the blog by 360, VAMP is fully featured with all the capabilities you’d expect from a malware family that resides on a phone. Features of the malware include:Ability to record calls Contact theft Theft of documents stored on the device Theft of messagesAnother outlier in terms of domains registered by adam.swift.2016@gmail[.]com is the domain AppPure[.]info. From the outset, the site appears to be a legitimate page:Figure 9: The app store created by the attackers which we believe was used to distribute malicious apps.Although we have been unable to ﬁnd malicious content hosted on this site, we believe that it is very likely that amongst the many legitimate apps available for download via this store some malicious apps may exist. Concluding thoughts Through this campaign there is little doubt that the attackers have been able to gain a great deal of information from their targets. We have been unable to uncover any evidence which allows us to conﬁdently attribute this campaign to any known threat actor at present. The scale of the campaign in terms of sheer numbers of samples and the maintenance of several diﬀering malware families involved suggests a reasonably sized team and that the campaign is not being perpetrated by a lone wolf, but rather a small team attackers. The campaign also illustrates that for some targets old tricks remain suﬃcient to run a successful espionage campaign, including use of URL shortening services, classic phishing techniques as well as using archive ﬁles to bypass some simple ﬁle checks. Palo Alto Networks customers are defended from this threat in the following ways:WildFire and Traps detect all of the malware discussed in this report as malicious. The C2 domains listed in this report are blocked through Threat Prevention. AutoFocus customers can monitor this activity by looking at the tags: VAMP (url#/tag/Unit42.Vamp) KASPERAGENT (url#/tag/Unit42.KasperAgent) MICROPSIA (url#/tag/Unit42.Micropsia) SECUREUPDATE (url#/tag/Unit42.SecureUpdate)Appendix A – Associated C2 Domains mediafreeuploader[.]co[.]uk al-amalhumandevelopment[.]com acount-manager[.]net gooogel-drive[.]com acount-manager[.]org acount-manager[.]info mary-crawley[.]com mydriveweb[.]com google-support-team[.]com mavis-dracula[.]com acount-manager[.]com ran-togomory[.]comshildon-cooper[.]info beauty-dance[.]net margaery[.]co go-mail-accounts[.]com kagami-adam[.]com cecilia-dobrev[.]com cecilia-gilbert[.]com gooogel[.]org feteh-asefa[.]com Appendix B – Associated Windows Malware Samples Appendix D – Observed PDB Strings C:⧵Users⧵USA⧵Documents⧵Visual Studio 2008⧵Projects⧵New folder (2)⧵kasper⧵Release⧵kasper.pdb C:⧵Users⧵Yousef⧵Desktop⧵MergeFiles⧵Loader v0⧵Loader⧵obj⧵Release⧵Loader.pdb c:⧵Users⧵USA⧵Documents⧵Visual Studio 2008⧵Projects⧵New folder (2)⧵s7 – Copy – Copy 19-2-17⧵Release⧵s7.pdb c:⧵Users⧵USA⧵Documents⧵Visual Studio 2008⧵Projects⧵New folder (2)⧵s7⧵Release⧵s7.pdb C:⧵Users⧵Progress⧵Desktop⧵Loader v0⧵Loader⧵obj⧵Release⧵Loader.pdb D:⧵Merge⧵Debug⧵testproj.pdb c:⧵Users⧵USA⧵Documents⧵Visual Studio 2008⧵Projects⧵New folder (2)⧵kasper – Copy – 21-2-17⧵Release⧵kasper.pdb C:⧵Users⧵Yousef⧵Desktop⧵MergeFiles⧵merge photos⧵Loader v0⧵Loader⧵obj⧵Release⧵Loader.pdb C:⧵Users⧵Yousef⧵Desktop⧵Loader v0⧵Loader⧵obj⧵Release⧵Loader.pdbGot something to say?Leave a comment Notify me of followup comments via e-mailName (required)Email (required)WebsiteSUBMIT 