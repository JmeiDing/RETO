www.trellix.com /en-us/about/newsroom/stories/threat-labs/targeted-attack-on-government-agencies.html Targeted Attack on Government AgenciesBy Sushant Kumar Arya, Mohsin Dalla · July 13, 2022 Executive summaryThe Trellix Email Security Research Team has discovered a malicious campaign targeting government agencies of Afghanistan, India, Italy, Poland, and the United States since 2021. The attack starts with a spear phishing email with a geo-political theme. The spear phishing emails were themed around India Afghanistan relationship. Attacker used politics as a lure to trick users into clicking on a malicious link. The email used for this phishing attack contains an attachment or a weaponized URL that delivers an Excel sheet. Upon opening the Excel sheet, Excel executes an embedded malicious macro which then decrypts and installs a Remote Access Trojan (AysncRAT & LimeRAT) and maintains persistence. Once the Remote Access Trojan is installed on the victim machine, it establishes communication with a Command-and-Control server used to exfiltrate victim data. The Remote Access Trojan is capable of taking screenshots, capturing keystrokes, recording credentials/confidential information, and adding infected systems to botnets. It can also perform network discovery and move laterally to other systems in the affected organization. The email used in this attack originated from the South Asia region which suggests the involvement of a South Asian threat actor. Trellix Email Security has detection coverage for this malicious campaign.Figure 1. Target countries1/10Threat landscapeThe Trellix Email Security product can follow the entire attack chain and analyze the final payload. In this scenario, it followed the chain: EMAIL -> URL -> ZIP -> XLS -> Macro. Finally, our threat database was able to detect the malicious macro performing decryption, creating an executable object, performing process injection, and utilizing other malicious techniques. Trellix Email Security has detection for the malicious Excel sheet with name - FE_APT_Dropper_Macro_DoubleHide_1.Figure 2. Attack timelineAttack timelineAs seen in Figure 2, the attack was active for over a year. The attacker sent emails for a short interval and then went back into hiding. This was followed by subsequent similar waves. The first wave of attack was noticed during March-April 2021, followed by another in July 2021, then again in December 2021, and most recently during end of March 2022. Email detailsThe attackers used the free mail service Gmail to send the spear phishing emails. Based on email header analysis, it was evident that the emails originated from Google servers and were sent from the South Asia region. The time zone of the email sender (+0500 UTC) further suggests the involvement of South Asian threat actors.2/10Figure 3. Email headersThe spear phishing email was themed around geopolitical news related to India like "Indian Nationals ( who were hidden in Kabul ) Killing in Kabul Tonight" and “Indian workers missing from the dam project.” More recently, the email used a COVID theme with the subject - "31 Covid Deaths In 24 Hours: Information campaign by NDTV". The email had a Google drive link serving a malicious ZIP file. In some cases, the malicious ZIP was sent as an email attachment. The ZIP contains an Office document which is used to drop a RAT (Remote Access Trojan).Figure 4. Email sample3/10Figure 5. Attack chainTechnical detailsThe document file (DOC/XLS) acts as a dropper, which drops and executes a file named "msword.exe". The Excel sheet contains a VBA macro which is enabled when the document file is opened. The malicious executable code is stored in the document file itself (within a form text field) in the base64 encoded format. The VBA macro reads the base64 content, decodes it, and then decrypts the decoded content with a hardcoded XOR key. Multiple levels of base64 decoding and XOR decryption are used to obfuscate the malicious executable file.Figure 6. XLS with macro4/10Figure 7. Macro code: Workbook OpenFigure 8. Macro code: Main function which is called inside Workbook Open eventXOR Key : "MxjnbvbX%$#@c%%!@#$C%^&* (K(*&K0^%$W$@!&@#$C%EGGGxcel^MicrosoLKHGFD^%$W@2017!&^%$#lx^&%$0"5/10Figure 9. Macro code: XOR function“msword.exe” is an SFX archive executable, which contains multiple malicious executable files as shown in Figure 10.Figure 10. msword.exe contentsFile name igfx.exe Delphi compiled file installs RAT file according to available .Net versionFile info LimeRAT [Runtime: .Net Framework 2.0] AsyncRAT [Runtime: .Net Framework 4] AsyncRAT [Runtime: .Net Framework 4.5] AsyncRAT [Runtime: .Net Framework 4.5.1] AsyncRAT [Runtime: .Net Framework 4.5.2] AsyncRAT [Runtime: .Net Framework 4.6] AsyncRAT [Runtime: .Net Framework 4.6.1] AsyncRAT [Runtime: .Net Framework 4.7 AsyncRAT [Runtime: .Net Framework 4.7.2]Upon execution, "msword.exe" drops the RAT files shown in the table above. These RAT executables are obfuscated using “Crypto Obfuscator For .Net”. “msword.exe” then starts the process “igfx.exe” which performs the following actions:Checks the .NET version in the registry; based on the installed version, renames the compatible RAT file to “excel.exe” Checks the registry keys to determine the .NET version in the order listed below. If found, a version of the runtime file (AsyncRAT) is picked corresponding to the .NET version. If none of the registry keys are found, the file “3_5” (LimeRAT) is used.HKLM\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4 HKLM\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4.5 HKLM\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4.5.1 HKLM\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4.5.26/10HKLM\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4.6 HKLM\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4.6.1 HKLM\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4.7 HKLM\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4.7.2Sets the file attributes of “excel.exe” to hidden and read-only. Adds a “Run” registry entry for persistence. Deletes the unused RAT executable files. Starts the “excel.exe” process.Figure 11. Process chainFigure 12. Run registry entriesBoth AsyncRAT and LimeRAT source code are publicly available. Async rat settings configurationPorts = "6606” Version = "2.5.7b" InstallFile = "msexcl.exe" Key = "MZ-RX Aes256 aes256 = new Aes256(Key); Group = "Debug";Async rat commands7/10Server Commandspong plugin saveplugin Save and Run plugin fileGet interval from client Run/Load plugin fileClient Commands:clientinfo Send system info to server ping sendplugin Get plugin from serverPing serverLime rat settings configurationPastebin = "url" EXE = "CLIENT.exe" fullpath = Environ(PATH1) & PATH2 & EXE BTC_ADDR = "THIS IS YOUR BTC 1234567890" 'Bitcoin address Delay = "3"Lime rat commandsServer CommandsIPSend Run timer ICAP Capture screen Thumbnail CPL Check if plugin is installed IPL Save plugin and then load it (server send plugin) IPLM Load plugin without saving it (server send plugin)8/10Client CommandsINFO Sends system info IP Ping to server IPStart Timer started #CAP Sending Thumbnail GPL Get plugin from server MSG Send MessageThese RATs can extend their capabilities using existing or user-defined plugins. At the time of analysis FE_APT_Dropper_Macro_DoubleHide_1MITRE ATT&CK TechniquesThe registered task/service pretends to be benign by name Keylogging capabilities Can capture the screen of the victim Collect data stored in the clipboard from users copying information within or between applications. Performs network discover for lateral movement into networkT1071 Application Layer Protocol HTTP/DNS requests are used in the C&C traffic T1036 Masquerading T1056 Input Capture T1113 Screen Capture T1115 Clipboard Data T1049 System Network Connections Discovery T1547 Boot or Logon Autostart T1204 User Execution T1041 Exfiltration Over C2 T1137 Office Template MacrosRun entry is made when persisting via the registry Opening malicious xls to execute macro Send stolen data using CNC channel Execute malicious code upon macro executionExecutionChannelIOCs:File Name feb212021_kabul.contact@gmail.com Information & Guidance Fwd: Combined MoFA Recruitment Approval Guests List - Media Release (Personal & Confidential) Indian workers missing from the dam project Indian Nationals ( who were hidden in Kabul ) Killing in Kabul Tonight 11 Indian Nationals found dead in Kabul Circular Indian Nationals Killing in Kabul 31 Covid Deaths In 24 Hours: Information campaign by NDTVEmail Senders:kabul.contact@gmail.com mashrefhaideri@gmail.com latifmahmood66666@gmail.com fscon.kab@gmail.com admn.kabul@gmail.com ravish49.ndtv@gmail.com10/10 