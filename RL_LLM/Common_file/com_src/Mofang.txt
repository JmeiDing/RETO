Lead Author: Yonathan Klijnsma Co-authors:Danny Heppener, Mitchel Sahertian, Krijn de Mik, Maarten van Dantzig, Yun Zheng Hu, Lennart Haagsma, Martin van Hensbergen, Erik de JongMofang A politically motivated information stealing adversaryVersion 1.0 May 17, 2016Executive SummaryMofang (模仿, Mófa ̌ng, to imitate) is a threat actor that almost certainly operates out of China and is probably government-affiliated.It is highly likely that Mofang’s targets are selected based on involvement with invest- ments, or technological advances that could be perceived as a threat to the Chinese sphere of influence. This is most clearly the case in a campaign focusing on government and critical infrastructure of Myanmar that is described in this report. Chances are about even, though, that Mofang is a relevant threat actor to any organization that invests in Myanmar or is otherwise politically involved.In addition to the campaign in Myanmar, Mofang has been observed to attack targets across multiple sectors (government, military, critical infrastructure and the automo- tive and weapon industries) in multiple countries. The following countries have, in the above named sectors, been affected, although fox-it suspects there to be more: India, Germany, United States, Canada, Singapore, South Korea.Despite its diverse set of targets Mofang is probably one group. This is based on the fact that its tools (ShimRat and ShimRatReporter) are not widely used, and that campaigns are not usually observed in parallel.Technically, the group uses distinct tools that date back to at least February 2012: ShimRat and ShimRatReporter. The mofang group does not use exploits to infect targets, they rely on social engineering and their attacks are carried out in three stages: 1 Compromise for reconnaissance, aiming to extract key information about the targetinfrastructure.2 Faux infrastructure setup, designed to avoid attracting attention. 3 The main compromise, to carry out actions on the objective.The name ShimRat is based on how its persistence is build up. It uses the so-called shims in Windows to become persistent. Shims are simply hot patching processes on the fly, to ensure backward compatibility of software on the Microsoft Windows platform.2 | fox-it | Mofang | A politically motivated information stealing adversary | May 2016As far as known, the Mofang group has never used exploits to infect targets, instead relying heavily on social engineering in order to successfully infect targets. The only exploits the group uses are privilege elevation exploits built into their own malware. The vulnerabilities that were being exploited were already known about at the time of use.The full report contains contextual as well as technical information about the group and its activities. These can be used, for example, for threat assessments, compromise assessments, incident response and forensics activities. Should you have any additional information or questions about this group or its activities, please get in touch with fox-it through info@fox-it.com.fox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 3Table of ContentsExecutive Summary1Introduction23Who is Mofang and who do they attack? 2.1 About the Mofang group 2.2 Mofang’s targets: a diverse set of entitiesThe distinct modus operandi of Mofang 3.1 Stage 1: Initial reconnoitering compromise 3.2 Stage 2: Faux infrastructure setup 3.3 Stage 3: The main compromise4 A history of past attacks5 Campaigns in Myanmar5.1 Activities related to the Kyaukphyu Special Economic Zone 5.2 Earlier campaigns in Myanmar6Other notable campaigns and attacks 6.1 Attack on Indian defense expo exhibitors 6.2 Attack on ‘seg’ 6.3 Attack using a Citrix lure 6.4 The global campaign7 Preferred tools7.1 ShimRat 7.2 ShimRatReporter8 Network based detection (IOCs)8.1 Snort signatures 8.2 Domains & IP addresses9 Host based detection (IOCs)9.1 yara rules 9.2 ShimRat samples 9.3 ShimRatReporter samples 9.4 Antivirus hijacking components 9.5 Observed services 9.6 Observed shims256 514 | fox-it | Mofang | A politically motivated information stealing adversary | May 20161 IntroductionImitation, in this case imitation of a target’s infrastructure, is a defining feature of their modus operandi.This threat report gives insight into some of the information that fox-it has about a threat actor that it follows, called Mofang. The name Mofang is based on the Mandarin verb 模仿 (Mófa ̌ng), which means to imitate. Imitation, in this case imitation of a target’s infrastructure, is a defining feature of their modus operandi.It is highly likely that the Mofang group is a group that operates out of China and is probably government-affiliated. Among others, one of their focus areas is the government and critical infrastructure sector of Myanmar. Additional information was used to contextualize and explain the observed attacks and campaigns, since there is obviously no easy insight in their actual agenda and goals. The additional research into geopolitical and economic factors resulted in the hypotheses about the ‘why’ of these campaigns. The full picture, however, will probably remain unknown.fox-it has chosen to release this report now, for additional context to the changing political landscape in Myanmar. This report contains contextual as well as technical information about the group and its activities. These can be used, for example, for threat assessments, compromise assessments, incident response and forensics activities. Should you have any additional information or questions about this group or its activities, please get in touch with fox-it through info@fox-it.com.Chapter 2 through 6 deals with Mofang, the group, its targets and some of their most notable campaigns and attacks. These chapters also contain geopolitical and economic context. Chapter 7 explains the working of Mofang’s preferred tools: ShimRat and SimRatReporter. The final two chapters of this report, chapter 8 and 9, provide technical Indicators of Compromise for use in detecting and hunting, both at a host and at a network level.fox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 52 Who is Mofangand who do they attack?2.1 About the Mofang group Despite its diverse set of targets (described in paragraph 2.2), Mofang is probably one group. This is based on the fact that its tools (ShimRat and ShimRatReporter) are not widely used, and that campaigns are not usually observed in parallel.Based on a numbers of factors that will be explained in more detail in this Chapter, it is highly likely that the Mofang group is a group that operates out of China and is probably government-affiliated.The most compelling evidence that supports this hypothesis is the fact that the targets and campaigns known so far can be persuasively correlated to important geopolitical events and investment opportunities that align with Chinese interests. The most notable of these will be described in chapter 5, which describes systematic espionage in the government and critical infrastructure sector of Myanmar. It describes: • Companies that are involved with investment possibilities that also involveChinese state owned organizations, become targets;• Government agencies or companies that play a role in deciding about Chineseinvestments, become targets;In addition to the above, there are four notable technical facts. Details such as these can, of course, be changed and manipulated without material impact to attacks, which makes them weaker indicators of attribution than contextual evidence derived from likely campaign goals. In this case, the technical facts support the hypothesis for attribution.Based on a numbers of factors that will be explained in more detail in this Chapter, it is highly likely that the Mofang group is a group that operates out of China and is probably government-affiliated.6 | fox-it | Mofang | A politically motivated information stealing adversary | May 20161 There are many similarities at the code level between the stager used by Mofang and others stagers attributed to Chinese groups. Also striking is the method of hijacking Antivirus Products to run the malware, which fox-it calls ShimRat, as described in chapter chapter 7.1. This has been seen in multiple espionage cam- paigns attributed to Chinese groups. In fact the similarities are so strong that some investigators have mistaken ShimRat to be another widely known piece of malware: PlugX. Based on in-depth investigation of both, fox-it has come to the conclusion that they are not the same. ShimRat is probably t is used by a separate group.2 All the documents that were used for the initial attacks contain meta- data that suggests they were created with WPS Office. This product, also known as Kingsoft Office, is a Chinese product comparable to Microsoft Office. Artifacts can be seen in document metadata as shown in Figure 1.3 Simplified Chinese is set as the character set in many of the resources inside variousmalware samples, as shown in Figure 2.Figure 1 detail of decoy document metadataFigure 2 Resource information inside a malware samplefox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 7Figure 3 郁, 郁! used in the 1991 Hong Kong comedy Tricky Brains4 An earlier version of ShimRat’s C2 communication protocol used two very specific words as keywords for requests and responses: Yuok and Yerr. Although the meaning is not directly obvious, it may be an approximate phonetic representation of the Cantonese 郁 佢, beat him or kill him. If this is true, it would suggest at least passive knowledge of Cantonese on the part of the malware author. The use of Yuok and Yerr was discontinued and replaced by ataD or Data in 2013, as shown in the side by side comparison in Figure 4. The current communication protocol is documented in paragraph 7.1.6.Figure 4 Side by side comparison of previous and current C2 communication8 | fox-it | Mofang | A politically motivated information stealing adversary | May 2016CanadaUnited StatesGermanyIndiaSouth KoreaMyanmarSingaporeGovernment Weapon Industry**R&D departments speci(cid:3)callyFigure 5 Countries and sectors targeted by Mofang2.2 Mofang’s targets: a diverse set of entities On analysis of the organizations that were attacked by Mofang in the past, at first glance it appears that there is no particular sector or country that it targets. Figure 5 shows aggregate information about known attacks from the past four years.Looking at the attacks, it is highly likely that targets are selected based on involvement with investments, or technological advances that could be perceived as a threat to the Chinese sphere of influence. This is most clearly the case in the campaign focusing on Myanmar. In it, a company was attacked that was involved in a special economic zone1 in Myanmar, which would be of specific interest to China’s National Petroleum Corporation’s investments. It is highly likely that they were targeted because of this, as new waves of attacks can be correlated with events surrounding the investments in that area.1Special economic zones, ofwhich Myanmar currentlyhas three, are specific areaswithin a country wherecertain laws and regulationsare different from the rest ofthe country, usually with theaim of furthering the ‘host’country’s economy.fox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 93 The distinct modus operandiof MofangThe Mofang group uses distinct malware that dates back to at least February 2012. The two tools used in their campaigns are: 1 ShimRat 2 ShimRatReporterAs far as known, the Mofang group has never used exploits to infect targets, instead relying heavily on social engineering in order to successfully infect targets. The only exploits the group uses are privilege elevation exploits built into their own malware. The vulnerabilities that were being exploited were already known about at the time of use. A more detailed description of the malware can be found in paragraph 7.1 and 7.2.The Mofang group has a distinct method of carrying out attacks using these two tools, with the goal of stealing information. In short, their method, which is described below, can be summarized as follows: 1Initial reconnoitering compromise: an initial compromise is performed on specific employees of a targeted organization with the aim of extracting key information about the target infrastructure to be used in stage 2;2 Faux infrastructure setup: the group sets up (external) infrastructure designed toavoid attracting attention;3 The main compromise.3.1 Stage 1: Initial reconnoitering compromise For the initial compromise, an ‘environment mapping tool’ known as ShimRatReporter, is delivered to suitable targets. ShimRatReporter can extract a wealth of information about an infrastructure, but the most pertinent data needed for the next stage in their attack are: • Local privileges for the infected user; • Local domain; • Local proxy setup; ShimRatReporter is fully explained in chapter 7.2.The delivery method of ShimRatReporter is most likely through emails pointing to an executable placed on a compromised (and trusted) website.fox-it has observed targeted and untargeted variations of the initial stage of the attack: 1 Untargeted: the ShimRatReporter sends out the report with the information and immediately downloads the ShimRat malware from a hardcoded location. This variation is probably less targeted, with victims added to the global campaign C2 for check-in and control. For more information about the global campaign, see paragraph 6.4.2 Targeted: the ShimRatReporter sends out the report and exits afterwards. The ShimRatReporter tool was only used to map out the victim but in no way to auto- mate further infection (yet).10 | fox-it | Mofang | A politically motivated information stealing adversary | May 2016Modus operandi of the Mofang groupTargeted campaignh e ri n g informationtagTarget organizationGlobal campaignh e ri n g informationtagSpear phishing attack with ShimRatReporter1TargetSetting up the customizedinfrastructure22Operators3Setting up the infrastructureThe main attack witha customized ShimRat versionThe main attackwith ShimRatcontrolinformationVictim’s PCs and servers with classi(cid:127)ed informationfox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 113.2 Stage 2: Faux infrastructure setup The second stage of an attack is setting up a faux infrastructure, specifically to mimic the anti-virus products used by the target or the target itself. The ShimRat malware then communicates over HTTP with preconfigured command and control servers. A combination of typo-squatting and closely related names are used to register domains under the same or different tlds.This method of setting up command and control infrastructure is customized for each target and campaign. Anything outside of campaigns targeting specific companies is added to the ‘global campaign’ which is described in paragraph 6.4. The global campaign infrastructure mimics the Microsoft Windows or Microsoft Office software.3.3 Stage 3: The main compromise After having gathered all necessary information about the locally configured proxies and having set up a faux infrastructure, a custom built version of the ShimRat mal- ware will be deployed to infect users with preconfigured local proxies, C2 servers and persistence information.As mentioned before, delivery of ShimRat relies heavily on social engineering, through the use of emails enticing targets to open an attached (decoy) document. These doc- uments contain actual text to make the target think it was indeed a legitimate Word document, pdf file or Excel sheet. When the document is opened, an executable is dropped which decompresses the final payload and places it on disk.The final payload consists of ShimRat bundled with extra files: legitimate application files which suffer from dll hijacking vulnerabilities. These vulnerabilities are used to launch the actual malware. The legitimate application is started which in turn runs the actual malware. A benefit of this method is that the malware runs under the process of a legitimate application. When it requests higher privileges via uac, the uac warning screen will show this legitimate application. Also, anyone inspecting running applica- tions, would see legitimate software running.It is worthy to note that the Mofang group commonly exploits dll hijacking vulner- abilities in anti-virus products for persistence purposes, presumably in order to look as harmless as possible. Over the years they’ve used application components from Norman, McAfee and Norton. A complete list of the used applications can be found in paragraph 9.4. The methods of persistence (described in paragraph 7.1.1) are sometimes adapted depending on the target. Rather than using generic texts in the persistent services, customized names and descriptions are used, based on the installed software information that was extracted with the ShimRatReporter tool previously.Follow up actions in the attacks, such as stealing information or lateral movement through the network, are possible with the capabilities of the ShimRat malware as has never used exploits to infect targets, instead relying heavily on social engineering in order to successfully infect targets.fox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 134 A history of past attacksThe first activity of the Mofang group was seen in February 2012, when the first version(s) of their malware, ShimRat, was seen in attacks.Based on compile time artifacts in the first versions of the malware, it is likely that the project had started 2012. A program database path, a file present on the authors’ machine used to aid in debugging the malware, present in early samples gives more indication that the project started in 2012:z:\project2012\remotecontrol\winhttpnet\amcy\app\win7\installscript\objfre_wxp_x86\i386\InstallScript.pdb z:\project2012\remotecontrol\winhttpnet\amcy\app\win7\serviceapp\objfre_wxp_x86\i386\ServiceApp.pdb z:\project2012\remotecontrol\winhttpnet\cqgaen\app\installscript\objfre_wxp_x86\i386\InstallScript.pdb z:\project2012\remotecontrol\winhttpnet\cqgaen\app\serviceapp\objfre_wxp_x86\i386\ServiceApp.pdbThe following is a timeline from early 2012 through to 2016. This timeline contains development information and a small subsection of the incidents that fox-it is aware of related to this group. The Mofang group is currently still active.14 | fox-it | Mofang | A politically motivated information stealing adversary | May 2016n Gl2012JanuaryFebruaryMarchAprilMayJuneJulyAugustSeptemberOctoberNovemberDecember2013JanuaryFebruaryMarchAprilMayJuneJulyAugustHistory and TimelineShimRat First ever ShimRat malware sample observed in an attack. The initial work- ing folder for the authors of ShimRat was ‘project2012’ which indicates this malware was created in 2012.ShimRat An attack took place against a Myanmar government entity. A compromised government server from the Ministry of Commerce was used as a C2 server. Image: see page 20ShimRat An unknown organization was attacked using a fake Google mail domain for payload staging. The C2 was also running on this fake Google domain.ShimRat A Canadian organization was attacked. Custom infrastructure was used.ShimRat An attack started against an unknown organization. The organi- zation was running ‘AVG Antivirus’ internally and the infrastructure setup mimicked an AVG Antivirus domain.ShimRat An unknown organization was attacked. The C2 infrastructure was setup to mimic the New York Times website.ShimRat An attack was started against a German automotive company specializing in vehicles for armed forces.ShimRat An attack was started against another german automotive company. Infrastructure was setup specifically for this target. Company proxy configurations were present in samples indicating an earlier breach.AttacksDevelopmentShimRatShimRatReporterfox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 15n An attack started against a US government organization. The lure used was a registration form for an electronic warfare training course. C2 infrastructure from the global campaign was used. Image: see page 23ShimRat An attack started against the exhibitors of the 2013 MSME DEFEXPO in India. C2 infrastruc- ture from the global campaign was used. Image: see page 22ShimRat An organization in Singapore was attacked. Custom infrastructure was setup.ShimRatReporter An attack started against an unknown organization in either the United States or CanadaShimRatReporter An attack started against a Myanmar government entity. A documented from the ‘HumanRightsNow’ organization named ‘Status of Human Rights and Sanctions in Myanmar – April 2014’ was used as a lure and decoyShimRat An attack was started against an unknown South Korean organi- zation. The C2 infrastructure was hosted on a compromised server.ShimRatReporter First ever ShimReporter malware sample observed in an attack.ShimRat An attack was launched against an unknown US organization. The C2 infrastructure was hosted on a compromised server. The lure was faked payment documents.ShimRat An attack started against an unknown organization. The C2 infrastructure was setup to mimic a travel agency of some kind.16 | fox-it | Mofang | A politically motivated information stealing adversary | May 20162015JanuaryFebruaryMarchAprilJuneJulyAugustSeptemberOctoberNovemberDecemberongoingn An attack started against a Myanmar government entity. Payloads during the campaign were staged of a compromised Burmese government server.ShimRatReporter An attack started against a company called ‘CPG Corp’ active in the Myanmar special economic zones. This campaign is described under section 6.2.ShimRat An attack started against a Myanmar entity. The payload was staged from the Myanmar port authority webserver. Image: see page 20ShimRatReporter An attack started against an unknown entity tracked in the ‘Global Campaign’ described in section 6.5.ShimRatReporter An attack started against an unknown entity in Myanmar. The payload was staged from the official website for the Myanmar national airline. Image: see page 21ShimRat An attack started against a US organization leveraging a fake Citrix website. The domain for the payload was an old expired domain that used to host a legitimate piece of software. Image: see page 24ShimRat An attack started against an unknown organization, the campaign used global campaign infrastructure. The lure used was a document about LED lighting and semiconductor technology.fox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 17Myanmar Special Economic Zones (SEZ)Kyaukphyu SEZThilawa SEZDawei SEZ5 Campaigns in Myanmar5.1 Activities related to the Kyaukphyu Special Economic Zone Since 2009, foreign investment in Myanmar has increased substantially. While it amounted to around usd 300 million in 2009–2010, it grew to usd 20 billion in the period of 2010–2011. To further increase and facilitate foreign investment, the government of Myanmar established special economic zones (sezs). These zones are supposed to encourage economic growth and foreign investments even more. These sezs would give investors a variation of tax reliefs, 5 year tax holidays as well as longer land leases.In 2011 Myanmar established the Central Body for the Myanmar Special Economic Zones, a regulatory body which would oversee foreign investments in the sezs. In the same year the sez law and Dawei law were also passed, establishing a set of three sezs in Myanmar. The current sezs under development in Myanmar are the Dawei sez, Thilawa sez and the Kyaukphyu sez2.The Mofang group has been active in relation to the Kyaukphyu sez. The state owned China National Petroleum Corporation (cnpc) has been investing in this sez since early 2009 after signing a memorandum of understanding (MoU) with the Myanmar government. This MoU, not legally binding, established the development, operation and management of an oil and gas pipeline by the cnpc. This investment by the cnpc ensured their position to get these pipelines running from the Kyaukphyu sez to mainland China. This pipeline would be completed in combination with a seaport to be built in the sez as well. This port, and pipeline, would save the cnpc about 5,000 kilometers of sailing and eliminate the need to go through the Strait of Malacca. While an agreement was signed, an MoU is not legally binding in any way and either party can always step out.This was perhaps a fear on the Chinese part when the government of Myanmar started a consulting tender for the Kyaukphyu sez in 2013. The idea behind this tender was to pick a consortium that would become the advisor for the Kyaukphyu sez, meaning they would oversee operations and make decisions on certain investments. In late September 2013 this tender closed3 and in early March the results were presented4. A consortium led by the cpg Corporation, a company originating from Singapore, was the winner and would become the sez consultant.In 2014 the Myanmar government with the help of cpg Corporation initiated another tender, this time to set up infrastructure in the sez. This tender closed in November and results would be put out early 2015. The date of the publication of the tender outcome passed but no information was published. In late June the Myanmar government still had not put out any word who would win infrastructure investments for the sez5. One of the contenders for this tender was China’s citic group.2url the end of June 2015 Mofang started its campaign to gather information of a specific target in relation to the sezs: the cpg Corporation. The first attack started in early July with a ShimRatReporter payload.18 | fox-it | Mofang | A politically motivated information stealing adversary | May 2016The lure used in this attack is interesting and specific to this attack and location. Burmese characters are not representable in the current Unicode character sets. The Zawgyi font6 was created to accommodate for this. One can download special appli- cations to support this font. This is usually required when submitting information on websites using the Burmese character set. The locations where these applications are downloaded from are public blogs and other public download locations.This need to install the Zawgyi fonts by cpg employees is what Mofang used to infect initial cpg targets: the ShimRatReporter was presented as AlphaZawgyl_ font.exe. The reporter would call back to a domain set-up to mimic the official cpg domain cpgcorp.com.sg. The C2 server for the initial ShimRatReporter payload was cpgcorp.org with the reporting gate being located at library.cpgcorp.org/links/images/ file/blanks.php.There were a few attacks with ShimRatReporter using the above mentioned C2 domain. However, a later sample showed how the Mofang group used the information gathered by the reporter for follow up attacks. Another C2 domain, secure2.sophosrv.com , was set up, which mimicked the official secure2.sophos.com domain. This is presumably based on information from the reports that the cpg Corporation internally used the Sophos Antivirus products. This ShimRatReporter sample was preconfigured to download the 2nd stage payload, ShimRat, from the following two locations:library.cpgcorp.org/links/images/blanks.jpg secure2.sophosrv.com/en-us/support/blanks.jpgThe downloaded ShimRat payload contacted its C2 server gate at secure2.sophosrv. com/en-us/support/ms-cache_check.php. One thing to note is that while all of the communications by ShimRat to its C2 server used HTTPS, ShimRatReporter operates under plain HTTP.The actual publication of the outcome of the infrastructure tender was postponed until the start of 2016. Early 2016 the results came in and China’s citic group had won the tender7. This allowed China to continue building upon their gas and oil infrastructure as well as the seaport.Figure 6 Satellite images showing Kyaukphyu SEZ developments. Image © 2016 Google Earth.6url#Why_not_Zawgyi.3F7url | Mofang | A politically motivated information stealing adversary | May 2016 | 195.2 Earlier campaigns in Myanmar Myanmar has been the target of Mofang’s attacks for years before the campaign related to the sez. Throughout the years, the Mofang group has compromised countless servers belonging to government or other Myanmar related organizations, in order to stage attacks. A few notable ones are described below.The earliest activity from Mofang in Myanmar dates back to around May 2012 when they attacked a government entity. Interestingly they abused a Myanmar government server they had compromised earlier, to function as the C2 server. It was the website of the Ministry of Commerce located at commerce.gov.mm. The C2 gate was located at /templates/css1/logon.php.Another compromised server from the Myanmar government used to stage a ShimRat payload that was seen around early June 2015. The payload for this campaign was located website of the Myanmar port authorities at the time. The C2 server for this campaign was dns.undpus.com.Figure 7 The Myanma Port Authority website was used to stage at attack in June 2015In late September 2015 Mofang used the website of Myanmar’s national airline hosted at www.flymna.com for an attack against an organization in Myanmar. The payload was located at www.flymna.com/sites/photo.tar and contained ShimRatReporter. After executing it would send its report to a C2 server at dns.undpus.com but also download a payload from a preconfigured location. This location was: dns.undpus.com/myanmar.jpg.20 | fox-it | Mofang | A politically motivated information stealing adversary | May 2016Figure 8 The website of Myanmar’s national airline was used to stage an attack in September 2015fox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 216 Other notable campaignsand attacksThis chapter highlights a few campaigns and attacks that provide further illustration to Mofang’s motives and attack method.6.1 Attack on Indian defense expo exhibitors The ‘International MSME Sub-Contracting & Supply exhibition for Defence – Aerospace – Homeland Security’ (MSME DEFEXPO) is an annual Indian exhibition and confer- ence. It allows MSMEs8 to show their current and new capabilities in the defense and aerospace technology to various government agencies. Over the years, its exhibitors have been a continuing target for the Mofang Group.In 1991 India initiated its Look East policy9 aiming to strengthen their relations with Southeast Asian countries, and to become a counterweight against the influences of China in the region. In addition, India, just like China, has a strategic interest in and strong relations with Myanmar. For example, the countries hold joint military exercises. Additional insight into the activities and capabilities of the MSMEs at the expo would be strategically advantageous for China. Please note that there might be other reasons, why the Mofang Group was interested in this expo.The changes are about even that the targets for the MSME DEFEXPO campaign were a selected group of exhibitors. They were targeted with spear phishing emails containing Word documents or Excel sheets enticing them to install the ShimRat malware. An example of the 2013 lure is shown in Figure 10.In 1991 India initiated its Look East policy9 aiming to strengthen their relations with Southeast Asian countries, and to become a counterweight against the influences of China in the region. In addition, India, just like China, has a strategic interest in and strong relations with Myanmar. For example, the countries hold joint military exercises. Additional insight into the activities and capabilities of the MSMEs at the expo would be strategically advantageous for China. Please note that there might be other reasons, why the Mofang Group was interested in this expo.Figure 9 Exhibitors at the Indian MSME DEFEXPO are routinely attacked8Micro, Small and Mediumsized Enterprises9url 10 Excel document used to infect Defexpo 2013 exhibitors22 | fox-it | Mofang | A politically motivated information stealing adversary | May 2016The Excel sheet in the 2013 campaign contained an embedded ShimRat sample bea- coning out to a C2 server hosted at store.outlook-microsoft.net with the panel gate being located at /en-us/c/index.php. The 2013 campaign didn’t feature a target specific C2 infrastructure, but actually used infrastructure from the global campaign written about in paragraph 6.4. The probable reason for this becomes clear when looking at a campaign that was running at the same time as the MSME DEFEXPO 2013.The attendees of the ESSENTIALS OF 21st CENTURY ELECTRONIC WARFARE COURSE, a training course for government employees in the US, held in Alexandria, Virginia were also targeted. The lure in this case was the official registration form send out to attendees as shown in Figure 11. The infrastructure was set up to aid in two campaigns taking place at the same time.Figure 11 Document used to infect attendees of the Essentials of 21st Century Electronic Warfare Course held in Virginia, USA year later, the MSME DEFEXPO 2014 was scheduled and again exhibitors were being targeted. This time the campaign and infrastructure was setup specifically for this attack. Lures were send out via mail once again, similar to the 2013 campaign. This time the C2 domain followed their general methods as described in chapter 3: it mimicked the MSME DEFEXPO website. They used images.defexpoindia14.com for their C2 communication and the panel gate was hosted on /se/index.php.fox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 236.2 Attack on ‘seg’ In December 2012 Mofang started a campaign against a new target, called ‘seg’ for the purpose of this report. The victim was compromised with at least ShimRatReporter as the 2nd stage ShimRat payload was preconfigured with the local proxy of this organization.The configuration for this build was interesting and reflects the method as described in chapter 3. Table 1 contains a subsection of the configuration for this build.Configuration items C2 Gate location Service descriptionConfiguration values support.f--secure.com /cache/cache.php HTTP proxy.seg.local:8080 mshelpsrvs Windows Help Services Enables Help and Support Center to run on this computer. If this service is stopped, Help and Support Center will be unavailable.Table 1 A subsection of the configuration build for the ‘seg’ attackFrom the configuration it can be determined that the company was running F-Secure Antivirus and Mofang registered the domain to not appear suspicious. The preconfig- ured proxy and the C2 domain shows the targeted nature of this campaign. The fake F-Secure domain was in control of Mofang until March 2014, when they transferred the domain to a domain broker. F-Secure’s brand monitoring picked up on the domain and bought it from this domain broker after it became available.6.3 Attack using a Citrix lure In September 2015 Mofang launched another attack. As per their usual modus operandi, this attack relied on social engineering to infected targets. For this campaign the Mofang group used a domain that used to belong to a company called Citrix. The website citrixmeeting.com was under control of Citrix until they let it expire on April 3rd, 2015. The website used to hold information about the conferencing products from Citrix.Almost 4 months after the domain expired, on July the 27th, the Mofang group regis- tered the domain and set it up for their newest campaign. A new version of ShimRat was built on the 7th of September, uploaded to the server and only days later used in a new campaign. The payload was hosted at url livechat.exe and contained a newly packaged ShimRat sample and a new dll hijacked program. They upgraded their dll hijacking program away from Norman and McAfee, part of the C++ runtime provided by Microsoft.The ShimRat sample contacted a C2 server located at api.officeonlinetool.com, the panel gate was hosted on /index.php.6.4 The global campaign While the Mofang group has specific targets and runs campaigns focused on them, they also run something that fox-it calls the global campaign. This global campaign is a set of servers functioning as infrastructure with domains impersonating Microsoft and Google services to which a wide variety of victims is connected. The global campaign was observed before the ShimRatReporter tool and this makes sense given that the reporter is used to gather specific information about target infrastructures. Prior to its availability, the group could only use more generic C2 domains.While many attacks can be traced back to the exact targets because Mofang emulates a target’s environment, the exact victims of the global campaign are much more difficult to identify. It appears Mofang uses the more generic service domains to play it safe. The global campaigns also share a lot of infrastructure across the different domains. Looking at the C2 domains in Table 2 that fox-it has classified as the global campaign, it becomes clear that the domains of Microsoft and Google services are used for imitation purposes:Typosquad Google domains account.google.com.gmgoogle.com mail.upgoogle.comTable 2 Global campaign C2 domainsTyposquad Microsoft domains ie.update-windows-microsoft.com support.outlook-microsoft.com help.outlook-microsoft.com oem.outlook-microsoft.com windws-microsoft.com store.outlook-microsoft.comfox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 257 Preferred tools7.1 ShimRat ShimRat is a custom developed piece of malware known as a ‘RAT’, Remote Administration Tool. It has among others standard capabilities for filesystem interaction.The malware was originally built in 2012 and its features were expanded over the years. The artifacts left in the first samples, are a good indicator that the project has been started in 2012. Multiple pdB paths were seen in the early versions of ShimRat. These PDB paths are not visible in the latest versions of ShimRat, due to how the samples are prepared. The PDB paths are either stripped or filled with different paths.z:\project2012\remotecontrol\winhttpnet\amcy\app\win7\installscript\objfre_wxp_x86\i386\InstallScript.pdb z:\project2012\remotecontrol\winhttpnet\amcy\app\win7\serviceapp\objfre_wxp_x86\i386\ServiceApp.pdb z:\project2012\remotecontrol\winhttpnet\cqgaen\app\installscript\objfre_wxp_x86\i386\InstallScript.pdb z:\project2012\remotecontrol\winhttpnet\cqgaen\app\serviceapp\objfre_wxp_x86\i386\ServiceApp.pdbThe terms InstallScript and ServiceApp in the pdB paths are the two parts that malware consists of. InstallScript is the first stage of ShimRat which takes care of persistence, while ServiceApp is the second stage of the malware which performs C2 communication and exposes the infected machine to the operator.Over the years the developers of ShimRat have extended the malware with additional functionality, such as: • Persistence: originally ShimRat only supported registry startup keys and service creation in order to become persistent. Additionally, the authors developed the capability of installing a shim database for persistence in 2015.• Privilege elevation: a method to bypass Windows uac to gain higher privilegeswas implemented. The technique relied on the Migwiz Windows component. Migwiz is an application used in Windows which automatically runs in high integrity mode10. The hijacked DLL will also run in this mode allowing a uac bypass, one of many methods that exists11. This method was not developed by the ShimRat authors, but was public and the changes are even they simply copied it into their malware.One interesting technique they’ve been using is dll hijacking of antivirus components. ShimRat samples delivered from around end 2013/start 2014 on, abused legitimate antivirus applications to hijack. The reason for this is to hide itself even more. When a user would check the running process list, a legitimate Antivirus process would appear to be running. The exact list of applications is available in paragraph 9.4. The Mofang group has a preference for Antivirus products only. fox-it has not observed any other vulnerable application except for antivirus products being used.10url | fox-it | Mofang | A politically motivated information stealing adversary | May 2016Mofang packages the anti-virus components with 2 files in order to run ShimRat. One is the dll to hijack. The second file is a compressed ShimRat core dll with shellcode in a .dat file. When the antivirus component is started the dll is loaded which in turn maps the .dat file in memory. The shellcode subsequently decompresses the core of ShimRat which comes in the form of a dll and executes it. Usually the .dat file has the same name as the dll file.Figure 12 Shimrat and anti-virus componentsThe way samples arrive at targets is usually in a packed form containing a lure document. The initial payload a target receives, will extract a lure document, present the user with this, but also extracts and runs a 2nd stage loader which will drop ShimRat on the target system. This 2nd stage loader in the current version of ShimRat and contains the antivirus component and as well as the two auxiliary files containing the ShimRat core.7.1.1 Installation & Persistence One of the first things ShimRat does while active is making sure it becomes persistent on the system. Before actually activating any methods of persistence it will try to elevate privileges if needed it is not running with administrative privileges.ShimRat elevates its privileges by performing a dll hijacking attack on vulnerable Windows components. Specifically, it abuses the migwiz.exe program by hijacking cryptbase.dll. ShimRat will try to gain higher privileges, but will continue to execute whether the elevation was successful or not. This elevation would make sure no uac popups would be shown to the victim. Would the user get uac popups they would appear to be coming from the antivirus product ShimRat hijacked, as mentioned before.ShimRat has three methods of becoming persistent on a system: 3Installing a registry startup key Installing a service Install a shimfox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 27Internally ShimRat uses an installation configuration which is set by the builder. The persistence configuration structure looks as follows (see Table 3):Configuration items Injection target processTable 3: Persistence configuration structure.The installation mode in the configuration structure, is a switch to decide which per- sistence method to use. If the switch is set to 1 it will become persistent by installing a service. If it is set to 2 it will install a shim to become persistent. As a fall back method, if either installing a service or installing a shim would fail, it will use a registry startup key for persistence.7.1.2 Persistence through a registry startup key As explained, when persistence through a service or shim fails, ShimRat falls back to a registry based startup-key. It takes the installation filename variable from the configuration and uses this as the key name. The file path is based on the installation file path variable in the configuration.The key is registered under:HKCU\Software\microsoft\windows\CurrentVersion\Run7.1.3 Persistence through a service ShimRat will create a new service under Windows using the information from the instal- lation configuration shown in paragraph 7.1.1 above. This operation is performed through the Windows api functions available for registering, updating and starting of services12. It will start by stopping and removing any old service (if any exist). ShimRat will register a new service using the information from the persistence configuration and start it, after checking and removing any old services.7.1.4 Persistence through shims13 Over the years Microsoft has gone to extraordinary lengths to ensure backward compatibility on its Windows platform. One of the outcomes of this process was the creation of the Application Compatibility Framework (acf) which helps ensure this compatibility. Through this framework, special fixes known as Microsoft Fix It’s or just fixes can be run which can help mitigate security or compatibility problems.12url | fox-it | Mofang | A politically motivated information stealing adversary | May 2016The way the acf works is that when a process is started, it will determine if the newly created process needs to be shimmed. If this is the case, a special flag is raised to indicate this. Based on this flag the operating system will load the installed Shims and apply the required fixes. This means shims are simply hot patching processes on the fly. Most predefined fixes released by Microsoft are stored in:%WINDIR%\AppPatch\sysmain.sdbAny fix not defined in this sdb file, is called a ‘Custom Fix’ and can be installed by anyone with knowledge of the workings of this system.ShimRat uses a shim to perform an application fix using an InjectDLL fix. An InjectDLL fix will inject a specified dll into a target process, this allows the code from the dll to run in the context of the target process. ShimRat has implemented this shim for both 32 and 64 bit platforms. In technical terms, the fix remains the same InjectDLL fix, but the dll ShimRat injects is different.Normally when an official Fix It shim is installed it would be an official update or patch of some kind and this would be registered as being installed as an update. This means the shim is visible in the software manager in Windows under the Windows component section. ShimRat shims do not appear in the software manager due to the way it installs the shims. Normally when a shim is installed, it is performed via the official installer which will register the Shim and place it in the correct location. ShimRat performs the registration of the shim manually, bypassing the official installation and in turn making sure that it won’t show up under the installed software in Windows.The shim databases are installed in either of two locations:%WINDIR%\AppPatch\Custom\ (32 bit) %WINDIR%\AppPatch\AppPatch64\Custom\ (64 bit)After placing the files on disk, ShimRat manually loads the shims into the shim database by first registering it in the registry at two specific locations as shown in Figure 13.HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Custom HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\InstalledSDBfox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 29Figure 13 An example of a 32-bit ShimRat infection with shimsAfter filling the registry keys, ShimRat calls SdbRegisterDatabaseEx to register the database and finally ShimFlushCache to flush the cache and enable the shim. From this point on, every newly started instance of svchost.exe will be shimmed and ShimRat will be. It locks itself with the use of mutexes, to ensure there aren’t multiple copies of ShimRat running. ShimRat mutexes are a combination of the string Global\\qwe followed by one or more numbers.7.1.5 Built-in capabilities of ShimRat ShimRat has a set of inbuilt capabilities to give the operators control over their victim. The following is a list of capabilities seen in one of the most recent samples.The operators are currently able to use ShimRat for among others: • Enumerate connected drives • List, create and modify directories • Upload and download files • Delete, move, copy and rename files • Uninstall itself7.1.6 Command and control communication ShimRat communicates over HTTP to its C2 server. While versions since 2015 have seen the introduction of HTTPS usage, ShimRat does not appear to verify the SSL certificate of C2 servers, which are generally self-signed certificates. ShimRat does have the ability to use pre-configured HTTP proxies, which is useful in situations where a victim has forced local proxies in the network with authentication.30 | fox-it | Mofang | A politically motivated information stealing adversary | May 2016Like with persistence, ShimRat holds a C2 communication configuration internally. The structure of the configuration looks as follows (see Table 4):Configuration items Primary C2 location Secondary C2 location Campaign ID C2 server password Proxy passwordTable 4: C2 communication configuration.ShimRat communicates with its C2 server through a pull and push mechanism. ShimRat constantly asks its C2 server for commands and once it has executed a command, it will send back the result. The structure of the commands exchanged with the C2 server is quite simple: • Every command is encapsulated within two tags, currently these tags are the word ‘Data’ which is added in front of and at the end of the command string. In the past this used to be the string ‘Yuok’ as described in paragraph 2.1.• Every command has a unique ‘ID’. These IDs are notated as $$<ID number> • The final structure of the commands send to and from the C2 server is:<data tag><command ID><command data><data tag>For example, when ShimRat first connects to a C2 server it registers itself. This initial command id is 00, the registration command, followed by the associated data. In this case, the data comprises basic information including the machine name, DEMO-PC, system information, 0800232979FD-SYSTEM, the C2 password, test, its version and the operating system version and whether it is a 32 or 64bit operating system in the last part.ShimRat will continue sending the initial check-in data until the C2 server responds with Data. Once it has received this response, which indicates it registered successfully, it will start polling for new commands to execute.fox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 31It polls the C2 for commands by sending command id 02 in combination with its system information:Data$$02#DEMO-PC-0800232979FD-SYSTEMDataThe C2 server will respond with one of 3 possible tags: • Atad: returned when there is nothing to do for the malware. ShimRat will sleepfor a specified time period before polling again.• Aatd: returned when the C2 does not recognize the system information. It forcesShimRat to register itself again. After registering itself again ShimRat will continue polling the C2 server for commands.• Data: returned when a command is available. The whole response string wouldactually be Data$$<command ID> where ShimRat would parse the command id, execute the desired command and send the result back to the C2. Details of which command ID maps to which command can be found in Table 5.Table 5 lists the possible command ids that a C2 server could send (the Initiating command id) and the corresponding responses by ShimRat (the Responding command id). Some commands will result in one or more different responding ids based on the data ShimRat has to send back. Please note, that there are checks when executing these commands where the key- words Atad Aatd and Data are used to evaluate the outcome of the command. These states are not described or shown in the table, nor does the table include command ids 00 and 01 which are used for initial registration and command polling respectively.FunctionInitiating command IDResponding command ID(s)Enumerate drives -Table 5 Overview of ShimRat functions mapped to command IDs32 | fox-it | Mofang | A politically motivated information stealing adversary | May 20167.2 ShimRatReporter7.2.1 Summary ShimRatReporter is a tool first seen in late 2014. The goal of this tool is to gather important information about the target infrastructure. More details about this are available in paragraph 7.2.2.Additionally the tool can be configured to download a 2nd stage payload from 1 or 2 preconfigured locations. The idea behind ShimRatReporter is to be able to deliver customized ShimRat builds. This can be seen in the preconfigured proxy configura- tion in some of the attacks. In these attacks, the ShimRat builds that were sent to the target machines were already configured with the credentials for the local proxy in the target network.7.2.2 Report generation ShimRatReporter generates a text based report to send out to its C2 server. The report is constructed with the following sections.SectionContentsReport header Network informationOperating system Browser and proxy configuration Active user sessionsUser accountsInstalled softwareReport footerThe header contains a timestamp at which the report was made and the local computer name. The first section is titled IP-INFO and contains information about the Windows IP configuration. This includes local IP information, routing tables, mac address, gateway, dns servers and whether the network has dHcp enabled. The second section is titled Network-INFO and contains a list of all the tcp and udp endpoints (similar to the output of the Netstat command) by formatting the output of the GetExtendedUdpTable and GetExtendedUdpTable Windows api functions. This section is titled OS-INFO and contains the operating system name and specific windows version including any service packs if they are installed. This section is titled Process-INFO and contains a list of all the running process on the machine including their pid and parent pid. This section is titled Browser-INFO and contains the User-Agent of the default browser as well as any proxy configurations set in the registry. This section is titled QueryUser-INFO and contains a list of active sessions on the machine enumerated with the WTSEnumerateSessions Windows api function. This section is titled Users-INFO and contains a list of the non-privileged and privileged accounts that are available on the machine. This section is titled Software-INFO and contains a list of all the installed software on the machine excluding any Windows updates / components. The footer of the report contains some additional information on whether the 2nd stage payloads, if configured, were successfully downloaded and executed.fox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 337.2.3 Command and control communication ShimRatReporter communicates over HTTP with a preconfigured C2 server. The gener- ated report is first compressed using lz compression applied with the RtlCompressBuffer Windows api function. After compression, the data is encrypted with a combination of shifting and xor using a static key. The key hardcoded in all versions seen in the wild is ‘NetMeter’.After a report is generated, the raw buffer with the data is taken and iterated through using an index. If the index is divisible by two, the value in the buffer is xor-ed. If it’s not divisible by two, the value of the key is added to the value in the buffer. This is probably best explained by showing the code for the decryption tool that fox-it has created:For every element in the encrypted report data, the index is checked to be divisible by two, using the modulo operation to wrap the key. If this is true, the value in the encrypted report is xor-ed with a value from the static key. If it is not divisible, it will subtract the ordinal key value from the current element in the encrypted report. In the encryption process the subtraction is just an addition.The report is then sent out in a post request to a preconfigured C2 server and a gate path. The url parameter filename is added to the post url. Its value is the computer name, also listed in the report, and an id. The C2 servers responds with a 200 ok when the report has been successfully received.Figure 14 Example ShimRat report upload34 | fox-it | Mofang | A politically motivated information stealing adversary | May 2016Additionally, ShimRatReporter can be configured to download a payload. Reporting is default but payload downloading is optional. Payloads are downloaded from preconfigured locations. The payloads are encrypted in a similar way. Figure 15 shows an example payload download from the same campaign as shown in Figure 14.Figure 15 Example ShimRat payload downloadfox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 358 Network based detection (IOCs)The following sections contain iocs for infrastructure communication from the Mofang group from 2012 until the end of 2015. There are duplicate domains and ips in the list, due to an overlap in domains for the ips and a domain having pointed at multiple ips.8.1 Snort signatures The following Snort signatures provide coverage for the known HTTP based ShimRat and ShimRatReporter C2 communication protocols. One thing to keep in mind is that some variants of ShimRat communicate over HTTPS, which these rules will not cover.These IOCs are also available from our Github repository located at: url com/fox-it/mofang/alert tcp $HOME_NET any -> $EXTERNAL_NET $HTTP_PORTS (msg:"FOX-SRT - Trojan - ShimRat check-in (Data)"; flow:established,to_server; content:"POST"; http_method; content:". php HTTP/1."; content:"|0d0a0d0a|Data$$"; fast_pattern:only; content:!"Content-Type"; content:!"Referer:"; content:!"Cookie:"; content:"|0d0a0d0a|"; pcre:"/Data\$\$\d\d/R"; content:"Data"; isdataat:!1,relative; threshold: type limit, track by_src, count 1, seconds 600; classtype:trojan-activity; reference:url,blog.fox-it.com/2016/06/15/mofang-a-politically- motivated-information-stealing-adversary/; sid:21001854; rev:4;)alert tcp $HOME_NET any -> $EXTERNAL_NET $HTTP_PORTS (msg:"FOX-SRT - Trojan - ShimRat check-in (php)"; flow:established,to_server; content:"POST"; http_method; content:".php HTTP/1."; content:"|0d0a0d0a|php"; fast_pattern:only; content:!"Content-Type"; content:!"Referer:"; content:!"Cookie:"; threshold: type limit, track by_src, count 1, seconds 600; classtype:trojan- activity; reference:url,blog.fox-it.com/2016/06/15/mofang-a-politically-motivated-information- stealing-adversary/; sid:21001855; rev:4;)alert tcp $HOME_NET any -> $EXTERNAL_NET $HTTP_PORTS (msg:"FOX-SRT - Trojan - ShimRat check-in (Yuok)"; flow:established,to_server; content:"POST"; http_method; content:".php HTTP/1.1|0d0a|User-Agent: "; fast_pattern:only; content:!"Content-Type"; content:!"Referer:"; content:!"Cookie:"; content:"|0d0a0d0a|"; pcre:"/(php)?Yuok\$\$\d\d/R"; content:"Yuok"; isdataat:!1,relative; threshold: type limit, track by_src, count 1, seconds 600; classtype:trojan-activity; reference:url,blog.fox-it.com/2016/06/15/mofang-a-politically- motivated-information-stealing-adversary/; sid:21001856; rev:4;)alert tcp $HOME_NET any -> $EXTERNAL_NET $HTTP_PORTS (msg:"FOX-SRT - Trojan - ShimRatReporter check-in"; content:"POST"; http_method; content:"Accept-Encoding: utf-8|0d0a|"; fast_pattern; uricontent:".php?filename="; content:"Accept: */*"; content:!"Referer"; content:!"Content- Type"; threshold: type limit, track by_src, count 1, seconds 600; classtype:trojan-activity; reference:url,blog.fox-it.com/2016/06/15/mofang-a-politically-motivated-information-stealing- adversary/; sid:21001857; rev:4;)36 | fox-it | Mofang | A politically motivated information stealing adversary | May 20168.2 Domains & IP addresses The following domains and associated ips have a lot of historical data. Keep in mind the listed domains could be on shared hosting machines or compromised websites. Please make sure to correlate any hits from the table below with the listed samples and their configurations in section 10.1.This table only contains domains setup by the Mofang group themselves, it does not contain some of the compromised shared hosting domains listed in some samples in paragraphs 9.2 and 9.3.DomainIPFirst seenDomainIPFirst seenDomain video.today-nytimes.comapi.officeonlinetool.com ie.update-windows-microsoft.comtravel.tripmans.com dns.undpus.com secure2.sophosrv.com update.nfkllyuisyahooapis.com www.go-gga.com images.defexpoindia14.com update.micrdsoft.com support.f--secure.com - September 2013b.support.outlook-microsoft.net logon.had-one-job.com www.avgfree.us - May 2015fox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 379 Host based detection (IOCs)9.1 yara rules The following yara rules can be used to detect the ShimRat and ShimRatReporter samples.These IOCs are also available from our Github repository located at: url com/fox-it/mofang/ShimRatrule shimrat description = "Detects ShimRat and the ShimRat loader" author = "Yonathan Klijnsma (yonathan.klijnsma@fox-it.com)" date = "20/11/2015" $datamarker1 = "Data$$00" $datamarker2 = "Data$$01%c%sData" $cmdlineformat = "ping localhost -n 9 /c %s > nul" $shim_func3 = "GetHookAPIs"condition: ($dll and $dat and $headersig and $datasig) or ($datamarker1 and $datamarker2) or ($cmdlineformat and $demoproject_keyword1 and $demoproject_keyword2 and $comspec) or ($dll and $dat and $shim_func1 and $shim_func2 and $shim_func3) }38 | fox-it | Mofang | A politically motivated information stealing adversary | May 2016ShimRatReporterrule shimratreporter description = "Detects ShimRatReporter" author = "Yonathan Klijnsma (yonathan.klijnsma@fox-it.com)" date = "20/11/2015"strings: $IpInfo = "IP-INFO" $NetworkInfo = "Network-INFO" $OsInfo = "OS-INFO" $ProcessInfo = "Process-INFO" $BrowserInfo = "Browser-INFO" $QueryUserInfo = "QueryUser-INFO" $UsersInfo = "Users-INFO" $SoftwareInfo = "Software-INFO" $AddressFormat = "%02X-%02X-%02X-%02X-%02X-%02X" $proxy_str = "(from environment) = %s"$netuserfun = "NetUserEnum" $networkparams = "GetNetworkParams"condition: all of them }fox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 399.2 ShimRat samples The following list of samples includes the core of ShimRat as well as the loader dll in the cases where ShimRat relied on dll hijacking to start.ShimRat core url - url “Citrix lure”, see section 6.3 url d8e68d2d5141a4a07dSHA256MD5ShimRat core loader DLL Filename(s)msvcr110.dll4e493a649e2b87e- 4fa4a0ebbdee76d7d117fdf40 | fox-it | Mofang | A politically motivated information stealing adversary | May 2016ShimRat core MD5SHA256ShimRat core loader DLL Filename(s)elogger.dllelogger.dat “Global campaign”, see section 6.4 url c25b2MD5ShimRat core loader DLL Filename(s)elogger.dllelogger.dat - url “Myanmar”, see section 5 url 8168da36a7908d150e44fMD5SHA256ShimRat core loader DLL Filename(s)elogger.dll26ff9e2da06b7e90443d- da5b71cfox-it | Mofang | A politically motivated information stealing adversary | May 2016 | 41ShimRat core SHA256ShimRat core loader DLL Filename(s)elogger.dllelogger.dat “Myanmar”, see section 5 url a32f9946f9SHA256MD5vmware-vmx.exe “Global campaign”, see section 6.4 url Filename(s)elogger.dllelogger.dat - url url url “Myanmar”, see section 5 url - url “MSME DEFEXPO”, see section 6.1 url “Global Campaign”, see section 6.4 url url “MSME DEFEXPO”, see section 6.1 url “seg”, see section 6.2 HTTP=proxy.seg.local:8080 url “Global campaign”, see section 6.4 url “Global campaign”, see section 6.4 url “Global campaign”, see section 6.4 url url url “Global campaign”, see section 6.4 url url url url url “Global campaign”, see section 6.4 url The following samples are the core ShimRatReporter samples. Some of these were delivered in zip archives or packaged in some form but those aren’t listed.These table blocks contain parsed configuration data for the samples, the domains listed here are also present separately in the Network ioc paragraph 2, but added here to give an overview and outline the relationship between the iocs.ShimRatReporter core Observed filename(s) Related campaign Configured C2 domain Configured C2 reporting gate Observed filename(s) Related campaign Configured C2 domain Configured C2 reporting gate Configured 2nd stage payload Observed filename(s) Related campaign Configured C2 domain Configured C2 reporting gate Configured 2nd stage payload MD5 SHA256vmware-vmx.exe - www.ipacking.co.kr url dns.undpus.com url url dns.undpus.com url url Observed filename(s) Related campaign Configured C2 domain Configured C2 reporting gate Observed filename(s) Related campaign Configured C2 domain Configured C2 reporting gate Configured 2nd stage payload Observed filename(s) Related campaign Configured C2 domainConfigured C2 reporting gate Configured 2nd stage payloadMD5 wbmail.city-library.com url “Global campaign”, see section 6.4 ie.update-windows-microsoft.com url url “Myanmar”, see section 5 library.cpgcorp.org secure2.sophosrv.com url url url As described in section 7.2 the ShimRat malware uses certain antivirus product compo- nents that are vulnerable to dll hijacking in order to run. The following tables contain all the indicators for these components.Keep in mind that these indicators are only useful indicators if the antivirus product the component comes from is not installed.Company Application name Version (product specific) Hijacked DLL First seen used elogger.dll 2014-04-30 Version (product specific) Hijacked DLL First seen used McAfee Oem Module mcutil.dll 2015-03-15 Version (product specific) Hijacked DLL First seen used Norton Identity Safe msvcr110.dll 2015-09-07 As explained in paragraph 7.1.3, ShimRat can become persistent through the use of services. The configuration of the service which includes the service name, title and description is configured inside the individual ShimRat samples. The list below are uniquely observed service configurations. Correlating these with the actual process the service starts, is a good indicator of the presence of ShimRat.Service name Service title Service descriptionService name Service title Service descriptionService name Service title Service descriptionService name Service title Service descriptionService name Windows WebLogic Service DHCP service for windows networks.Provides Windows DHCP Net founda- tion frame support ,through the framework, on servers that are also running the service.WNetDHCP Windows DHCP Service DHCP service for windows networks.Provides Windows DHCP Net founda- tion frame support ,through the framework, on servers that are also running the service.helpservices Windows Help Services Enables Help and Support Center to run on this computer. If this service is stopped, Help and Support Center will be unavailable.mshelpsrvs Windows Help Services Enables Help and Support Center to run on this computer. If this service is stopped, Help and Support Center will be unavailable.mshelpsrvsv Windows Help Services Enables Help and Support Center to run on this computer. If this service is stopped, Help and Support Center will be unavailable.50 | fox-it | Mofang | A politically motivated information stealing adversary | May 2016Service name Windows Help log Enables Help and Support Center to run on this computer. If this service is stopped, Help and Support Center will be unavailable.Service name Kaspersky protect service Kaspersky protect service9.6 Observed shims As discussed in paragraph 7.1.4, ShimRat can obtain persistence on systems by installing shims. The following table contains the settings for these shims and some observed hashes. Checking for the configurations of these shims will be more effective than just checking the listed hashes.Platform Type of fix Type of fix {503ec3d3-165a-4770-b799-099d43b833ec} {e8cc2eb5-469c-43bd-9d69-de089e497302} {f8c4cc07-6dc4-418f-b72b-304fcdb64052} {7feee735-1296-4c40-bdd4-7d4f09acc2d0} • Was founded in 1999. • Established one of the first Cyber SecurityOperations Centers in Europe.• Is Europe’s largest specialized cyber securitycompany.• Operates in three business areas:1 Cyber Threat Management: a solution portfolioaimed at reducing the risks of cyber threats, and includes: professional services, managed security services, and technology;2 Web and Mobile event analytics: a solution portfolio that is aimed at reducing financial risks in (online) payment transactions;3 High Assurance: solutions that make trustedcommunication possible to the highest classification levels.• Has been involved in many high-profile Incident Response cases. Most of the cases we worked on are secret. An approved selection can be shared upon request.fox-it Olof Palmestraat 6, Delft po box 638, 2600 ap Delft The Netherlandst +31 (0) 15 284 79 99 f +31 (0) 15 284 79 90 e fox@fox-it.comwww.fox-it.com 