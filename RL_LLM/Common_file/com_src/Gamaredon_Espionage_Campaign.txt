2/24/2020Cyberwarfare: A deep dive into the latest Gamaredon Espionage Campaign – Yoroi BlogCyberwarfare: A deep dive into the latest Gamaredon Espionage Campaignblog.yoroi.company/research/cyberwarfare-a-deep-dive-into-the-latest-gamaredon-espionage-campaignZLAB-YOROI2020-02-17Introduction Gamaredon Group is a Cyber Espionage persistent operation attributed to Russians FSB (Federal Security Service) in a long-term military and geo-political confrontation against the Ukrainian government and more in general against the Ukrainian military power.Gamaredon has been active since 2014, and during this time, the modus operandi has remained almost the same. The most used malware implant is dubbed Pteranodon or Pterodo and consists of a multistage backdoor designed to collect sensitive information or maintaining access on compromised machines. It is distributed in a spear phishing campaign with a weaponized ofﬁce document that appears to be designed to lure military personnel.In the recent months, Ukrainian CERT (CERT-UA) reported an intensiﬁcation of Gamaredon Cyberattacks against military targets. The new wave dates back to the end of November 2019 and was ﬁrst analyzed by Vitali Kremez. Starting from those ﬁndings, Cybaze-Yoroi ZLab team decided to deep dive into a technical analysis of the latest The complex infection chain begins with a weaponized Ofﬁce document named “f.doc”. In the following table the initial malware information is provided.url A deep dive into the latest Gamaredon Espionage Campaign – Yoroi BlogHash Gamaredon Pteranodon weaponized document Doc ﬁle weaponized with Exploit768:u0foGtYZKQ5QZJQ6hKVsEEIHNDxpy3TI3dU4DKfLX9Eir:uG1aKQ5OwCrItq3Tg‐ GfLt9rTable 1. Information about initial dropperThe decoy document is written using the ukrainian language mixed to many special chars aimed to lure the target to click on it, and, once opened, it appears as in the following ﬁgure.The document leverages the common exploit aka template injection and tries to download a second stage from “hxxp://win-apu.]ddns.]net/apu.]dot”.Figure 1. Overview of the documenturl A deep dive into the latest Gamaredon Espionage Campaign – Yoroi BlogFigure 2. URL used by document to download the second stageThanks to this exploit (Remote Code Execution exploit) the user interaction is not required, in fact the “enable macro” button is not shown. The downloaded document has a “.dot” extension, used by Microsoft Ofﬁce to save templates for Gamaredon Pteranodon loader dot ﬁleHash Threat Brief Description Dot ﬁle enabling the infection of the Gamaredon Pteranodon Ssdeep768:5KCB8tnh7oferuHpC0xw+hnF4J7EyKfJ:oI8XoWruHpp/P4Table 2. Information about second stageIf we decide to open the document, we see that the document is empty, but it requires the enabling of the macro.The body of the macro can be logically divided into two distinct parts:Figure 3. Overview of the second stage documentThe ﬁrst one is the setting of the registry key “HKEY_CURRENT_USER\Software\Microsoft\Ofﬁce\” & Application.Version & _”\Word\Security\” and the declaration of some other variables, such as the dropurl “get- icons.]ddns.net”; The second one is the setting of the persistence mechanism through the writing of the vbs code in the Startup folder with name “templates.vbs”. This vbs is properly the macro executed by the macro engine of wordurl A deep dive into the latest Gamaredon Espionage Campaign – Yoroi BlogThe evidence of the written ﬁle in the Startup folder:Figure 4. Code of the “template.vbs” stored in the Startup folderFigure 5. Evidence of the “template.vbs” ﬁle in the Startup folderAnalyzing the content of “templates.vbs” it is possible to notice that it deﬁne a variable containing a URL like “hxxp://get- icons.]ddns.]net/ADMIN-PC_E42CAF54//autoindex.]php” obtained from “hxp://get-icons.]ddns.]net/” & NlnQCJG & “_” & uRDEJCn & “//autoindex.]php”, where “NlnQCJG” is the name that identiﬁes the computer on the network and “uRDEJCn” is the serial number of drive in hexadecimal encoding. From this URL it tries to download another stage then storing it into “C:\Users\admin\AppData\Roaming\” path with random name. At the end, “templates.vbs” script will Threat Gamaredon Pteranodon implant SFX archive deep24576:zXwOrRsTQlIIIIwIEuCRqKlF8kmh/ZGg4kAL/WUKN7UMOtcv:zgwR/lIIIIwI6RqoukmhxGgZ+WUKZUMvTable 3. Information about ﬁrst SFX archiveBy simply opening the SFX archive, it is possible to notice two different ﬁles that are shown below and named respectively “8957.cmd” and “28847”.Figure 7. Content of the Gamaredon Pteranodon SFX archiveWhen executed, the SFX archive will be extracted and the “8957.cmd” will be run. The batch script looks like the following screen:It contains several junk instructions with the attemption to make the analysis harder. Cleaning the script we obtain:Figure 8. Bat script source code (with junk instructions)url A deep dive into the latest Gamaredon Espionage Campaign – Yoroi BlogFigure 9. Batch script source code (cleaned)At this point, the batch script renames the “28847” ﬁle in “28847.exe”, opens it using “pﬂjk,fkbcerbgblfhs” as password and the ﬁle contained inside the “28847.exe” ﬁle will be renamed in “WuaucltIC.exe”. Finally, it will be run using “- post.php” as argument.The fact that the “28847.exe” ﬁle can be opened makes us understand that the “28847” ﬁle is another SFX ﬁle. Some Gamaredon Pteranodon implant SFX archiveHash Threat Brief Description SFX Archive Second Stage Ssdeep24576:vmoO8itbaZiW+qJnmCcpv5lKbbJAiUqKXM:OoZwxVvfoaPuTable 4. Information about the second SFX archiveExploring it, it is possible to see several ﬁles inside of it, as well as the 6323 ﬁle. The following ﬁgure shows a complete list.In this case, the SFX archive contains 8 ﬁles: ﬁve of them are legit DLLs used by the “6323” executable to interoperate with the OLE format deﬁned and used by Microsoft Ofﬁce. The “ExcelMyMacros.txt” and “wordMacros.txt” ﬁles contain further macro script, described next. So, static analysis on the “6323” ﬁle shown as its nature: it is written using Microsoft Visual Studio .NET, therefore easily to reverse. Before reversing the executable, it is possible to clean it allowing the size reduction and the junk instruction reduction inside the code. The below image shows the information about the sample before and after the cleaning.Figure 10. Content of the second SFX archiveurl A deep dive into the latest Gamaredon Espionage Campaign – Yoroi BlogFigure 11. Static information about .NET sample before and after the cleaningThe source code looks as follows.Figure 12. Part of .NET sample source codeThe ﬁrst check performed is on the arguments: if the arguments length is equal to zero, the malware terminates the execution. After that, the malware checks if the existence of the ﬁles “ExcelMyMacros.txt” and “wordMacros.txt” in the same path where it is executed: if true then it reads their contents otherwise it will exit.url A deep dive into the latest Gamaredon Espionage Campaign – Yoroi BlogFigure 13. Function used by .NET sample to check the presence of the “WordMacros.txt” and the “ExcelMyMacros.txt” ﬁles”Part of the content of the variable “xVGlMEP”:url A deep dive into the latest Gamaredon Espionage Campaign – Yoroi BlogThere is a thin difference between the two ﬁles.Figure 14.Piece of the “WordMacros.txt” codeFigure 15. Difference between “WordMacros.txt” and “ExcelMyMacros.txt” ﬁles”As visible in the previous ﬁgure, the only difference between the ﬁles are in the variable, registry key and path used by Word rather than by Excel. Finally the macros are executed using the Ofﬁce engine like in the following ﬁgure.So let’s start to dissect the macros. For a better comprehension we will be considering only one macro and in the speciﬁc case we will analyze “wordMacros.txt” ones. First of all the macro will set the registry key “HKEY_CURRENT_USER\Software\Microsoft\Ofﬁce\” & Application.Version & _”\Word\Security\” and then will set up two scheduled tasks that will start respectively every 12 and 15 minutes: the ﬁrst one will run a “IndexOfﬁce.vbs” in the path “%APPDATA%\Microsoft\Ofﬁce\” and the second one will run “IndexOfﬁce.exe” in the same path.Figure 16. Winword with maliciousmacrourl A deep dive into the latest Gamaredon Espionage Campaign – Yoroi BlogFigure 17. Registry keys and Scheduled tasks set by malwareFinally, the malware will write the “IndexOfﬁce.txt” ﬁle in the “%APPDATA%\Microsoft\Ofﬁce\” path. The following ﬁgure shows what has been previously described:The script will check the presence of the “IndexOfﬁce.exe” artifact: if true then it will delete it and it will download a new ﬁle/script from “hxxp://masseffect.]space/<PC_Name>_<Hex_Drive_SN>/post.]php”.Figure 18. Part of “IndexOfﬁce.txt” ﬁleurl A deep dive into the latest Gamaredon Espionage Campaign – Yoroi BlogFigure 19. Domain “masseffect.]space” declaration and use of the Encode functionThe malware tries to save the C2 response and encoding it using Encode function. This function accepts three parameters: the input ﬁle, the output ﬁle and the arrKey; arrKey is calculated thanks to GetKey function that accepts as input the Hexadecimal value of the Driver SN installed on the machine and returns the key as results. Part of Encode function and complete code of GetKey function are shown below.Figure 20. Encode functionurl A deep dive into the latest Gamaredon Espionage Campaign – Yoroi BlogVisiting the web page relative to C2, it shows a “Forbidden message” so this means that the domain is still active but refuses incoming requests.Figure 21. Function GetKeyFigure 22. Browser view of the URL “masseffect.]space”Conclusion Gamaredon cyberwarfare operations against Ukraine are still active. This technical analysis reveals that the modus operandi of the Group has remained almost identical over the years.The massive use of weaponized Ofﬁce documents, Ofﬁce template injection, sfx archives, wmi and some VBA macro stages that dinamically changes, make the Pterodon attack chain very malleable and adaptive. However, the introduction of a .Net component is a novelty compared to previous Pterodon samples. Indicator of Compromise hxxp://get-icons.]ddns.]net/apu.]dot/hxxp://masseffect.]space/Yara Ruleurl A deep dive into the latest Gamaredon Espionage Campaign – Yoroi Blogall of themmeta: description = "Yara Rule for Gamaredon_f_doc" author = "Cybaze Zlab_Yoroi" last_updated = "2020-02-14" tlp = "white" category = "informational"strings: $a1 = { 4B 03 } $a2 = { 8E DA 30 14 DD 57 EA 3F } $a3 = { 3B 93 46 0F AF B0 2B 33 } $a4 = { 50 4B 03 04 14 00 06 00 08 }meta: description = "Yara Rule for Gamaredon_apu_dot" author = "Cybaze Zlab_Yoroi" last_updated = "2020-02-14" tlp = "white" category = "informational"strings: $a1 = "Menu\\Programs\\Startup\\\"" $a4 = "templates.vbs" $a5 = "GET" $a6 = "Encode = 1032" $a7 = "WShell=CreateObject(\"WScript.Shell\")" $a13 = "WinMgmts:{(Shutdown,RemoteShutdown)}!" $a14 = "Scripting" $a15 = "//autoindex.php"rule Gamaredon_Campaign_January_2020_Initial_Dropper { rule Gamaredon_Campaign_January_2020_SFX_Stage_2 {strings: $a1 = { 4D 5A } $a2 = { FF 75 FC E8 F2 22 01 00 } $a3 = { FE DE DB DB FE D5 D5 D6 F8 } $a4 = { 22 C6 24 A8 BE 81 DE 63 } $a5 = { CF 4F D0 C3 C0 91 B0 0D }all of them11 of ($a*)meta: description = "Yara Rule for Gamaredon SFX stage 1" author = "Cybaze Zlab_Yoroi" last_updated = "2020-02-14" tlp = "white" category = "informational"meta: description = "Yara Rule for Gamaredon SFX stage 2" author = "Cybaze Zlab_Yoroi" last_updated = "2020-02-14"url A deep dive into the latest Gamaredon Espionage Campaign – Yoroi Blogtlp = "white" category = "informational"strings: $a1 = { 4D 5A } $a2 = { 00 E9 07 D4 FD FF 8B 4D F0 81 } $a3 = { B7 AB FE B2 B1 B5 FA 9B 11 80 } $a4 = { 81 21 25 E0 38 03 FA F0 AF 11 } $a5 = { 0A 39 DF F7 40 8D 7B 44 52 }all of themmeta: description = "Yara Rule for Gamaredon dot NET stage" author = "Cybaze Zlab_Yoroi" last_updated = "2020-02-14" tlp = "white" category = "informational"condition: This blog post was authored by Davide Testa, Luigi Martire and Antonio Pirozzi of Cybaze-Yoroi ZLAB.strings: $a1 = { 4D 5A } $s1 = { 31 01 C6 01 F2 00 29 01 5C 03 76 } $s2 = { 79 02 38 03 93 03 B5 03 } $s3 = { 00 07 00 00 11 00 00 72 01 } $s4 = { CD DF A6 EF 66 0E 44 D7 }all of ($a*) and 2 of ($s*)url 