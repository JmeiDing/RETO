ContentsChapter 1 INTRODUCTION 2Main Discovery 2Chapter 2 Persistent Cyber-espionage 31.Initial attacks 3Lure documents 32. Attack procedures 9Dropper 10USB Worms 11ICEFOG Backdoor 143. Persistent monitoring & concentrated attacks 14Chapter 3 Vulnerability Analysis 171.Introduction 172.Exploit mechanism 18Chapter 4 Command and Control Mechanisms 241. Onion.City 252.Fixed IP 25Chapter 5 ICEFOG “Rebirth”：aimed at misleading or false flagging? 271.Inertial thinking in relevance analysis 272.Truth behind the “smoke curtain” 29Chapter 6 Special clues 321. PDB path 322.File property of lure documents 333.Information in Korean 33Chapter 7 Conclusion 36Chapter 1 INTRODUCTIONMain DiscoveryOn February 25th, 2016, the Lazarus Group and its APT attacks were analyzed and released to the public by the industry alliance led by Novetta1 which is composed of Kaspersky Labs2, Alien Vault Labs3and other security companies. Coincidentally, the Group is also the organization behind DarkSeoul Operation4 targeting Korean financial institutions and media houses in 2013 and the cyber-attack targeting Sony Pictures Entertainment (SPE)5 in 2014. This group mainly targetssome Asian countries like Korea and the victim industries include government, entertainment &media houses, army, aeronautical & astronautical institutes, financial entities and instructionindustries, etc.In the year of 2015, we also detected an APT organization targeting government entities,transportation companies and energy industries. Through our further investigations, it hasn’tbeen found to be connected with the Lazars Group for the time being. Due to the fact that the Trojans dropped by this organization uses Onion.City6 as their C&C and that their malwaredocument names all contain dog.jpg, this organization’s APT attacks which stretched from 2013to 2015 is code-named as Operation OnionDog. The initial malicious code dated back in May,2011, followed by at least three concentrated attacks which happened in 2013, July-August in2014 and July - September in 2015, respectively. Afterwards, we identified 96 pieces of malwarealong with 14 C&C domains and IP addresses.1Operation Blockbuster, url Blockbuster revealed, url BlockBuster unveils the actors behind the Sony attacks, url ny-attacks42013 South Korea cyberattack, url malware of OnionDog spread itself by taking full advantage of the vulnerability in Hangul -popular office software in Korean speaking countries; in the meanwhile, it infected targetsthrough USB Worms inside an isolated network. What also caught our attention is that membersof this organization communicated via Onion.City so that they could visit domains in the DeepWeb without the help of Tor browser. This has created an ideal invisible cloak for the hackers inthe anonymous environment of Tor. In addition, our in-depth analysis prevails that this threatactor tried to fly false flags or mislead investigators by adopting the techniques and resources ofother APT organizations that are already revealed to the world.Chapter 2 Persistent Cyber-espionage1. Initial attacksSeeing from the current data we collected, malicious program spread itself mainly by eithertaking advantage of the vulnerability of HWP documents or pretending to be HWP documents.Attacks in this kind of guise usually are carried out via spearfishing emails.Hangul is prevalent local office software in South Korea with the file format of HWP (Hangul of the backdoor, please see the published research from Kaspersky Lab8.3. Persistent monitoring & concentrated attacksPicture 10 Attack timelineExcept for the backdoor, if other malicious Trojans want to execute all the functionalities, theywill need to check whether the time on the host computer is within the effective time of theattack. Judging from the time slot between malware compile dates and ending dates, weconcluded that the average survival time of the OnionDog Trojans should be 15 days. Picture 108 The Icefog APT: A Tale of Cloak and Three Daggers,url the attack timeline over the past few years. From 2013, the OnionDog gang carried outattacks on yearly basis and each session lasted very short time. Curiously, the ending time of the criminal campaigns are very similar, for instance, four campaigns in 2015 ended on August 8thwith one day earlier than two campaigns in 2014.Ending date September 8th, 2015Compile date August 27th, 2015August 8th, 2015August 5th, 2015August 8th, 2015August 3rd, 2015August 8th, 2015August 8th, 2015July 13th, 2015August 9th, 2014August 9th, 2014July 31st, 2014July 23rd, 2015July 10th, 2015July 10th, 2015July 18th, 2014July 15th, 2014July 13th, 2014October 25th, 2013October 10th, 2013Survival time12351629322251815Picture 11 Codes for Ending-date checkingChapter 3 Vulnerability Analysis1. IntroductionThrough our in-depth analysis, we are sure that the vulnerability of HWP is not a zero-day one 23:39:10, May 1st, 2013The first show-up of ICEFOG sample Virustotal May 6th, 2013Publication time of the ICEFOG report by Daggers,url Truth behind the “smoke curtain”At the very beginning, we assumed the organization behind OnionDog should be ICEFOG, butfurther investigations make us begin to doubt. The active time of OnionDog malicious files isaround the month of July in 2014. Activities of other samples were active in the similar timewindows like October in 2013, July to August in 2017 and July to September in 2015. In addition,Kaspersky published its report on ICEFOG at the end of September. Usually, after being exposedby security vendors, it is time when APT organization would cease their attacks and stop usingrelevant C&C or backdoors. This time, the threat actor doesn’t follow the regular rule. Of course,the possibility still exists that the attackers was exposing themselves on purpose as long as theycan reach their goal maximally. However, it makes us begin to doubt our original assumption.According to the attack time listed above and our experience in APT analysis, there must be otherintentions to explain why the attackers used previous attack methods even though some of thebackdoors and C&C have been unveiled and detected. Regarding their real intentions, ourspeculations are:a. Lack of attack capabilities leave the attackers no choice but to use previous techniquesand resources;b. Attackers are very confident that they can reach the same goal even if they use oldtechniques and resources because they know very well about the targets;c. Their real purpose is to fly false flags on other APT organizations or to confuse andmislead security researchers.We did some tests on HWP exploit files in virtual environment and found that actually when theHWP exploit file was triggered, it firstly opened lure documents, and then ran the OnionDogsamples. In the whole process, it didn’t release any ICEFOG samples. That is to say, if users’computers are attacked by HWP exploit file, only OnionDog samples will be released and runrather than ICEFOG samples. This phenomenon aroused questions to us: why the attackersimplant a backdoor which they will never use in the following attacks to the HWP exploit?With this question in mind, we pulled out and arranged all the attacks according to chronologicalorder to have a better view of the whole cyber-attack campaign. Besides the timestamp ofICEFOG itself, Kaspersky’s reporting time and the active time of OnionDog samples, there are twotime slots that require more attention which is related to the status of C&C domainwww.sejonng.org.Picture 22 Timeline of HWP exploit and relevant resourcesIn the report of ICEFOG from Kaspersky dated to September 25th, 2013, the domainwww.sejonng.org had yet been marked as “SINKHOLED by Kaspersky Lab”. Later in the historical data of WHOIS owned by DomainTools13, we noticed the domain was already marked as “serverHold14” on January 1st, 2014. What’s more, from the website snapshot15 provided by DomainTools, it shows that the domain has already been mark as “sinkhole16” by Kaspersky on June 4th, 2014 or even earlier.Additionally, the most recent update about domain www.sejonng.org is that it has been taken over and sinkholed in the WHOIS record17 of virustracker.info.13url#016url 23 Historical page record of “www.sejonng.org” (from DomainTools)We deduced that when attackers started to distribute HWP exploit files, the C&C domain ofICEFOG backdoor has no longer belong to themselves. Combining all the factors above, we cameto the conclusion that our third assumption should be the OnionDog gang’s real purpose: to flyfalse flags on other APT organizations or mislead researchers.Similar circumstance happened in the past APT attacks in which APT organizations used fakeinformation to obstruct researcher from security companies. Taking the duqu 2.0 Analysis as anexample, researchers from Kaspersky Lab also encountered the situation where the threat actoradded some fake symbols and very rare compression algorithm to direct researchers to believethe malware was related to APT1 or MiniDuke.Picture 24 Excerpt from Kaspersky technical report about THE DUQU 2.018Chapter 6 Special clues1. PDB pathPDB1 url 