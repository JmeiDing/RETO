Operation ENDTRADE: TICK’s Multi-Stage Backdoors for AttackingIndustries and Stealing Classified DataBy Joey Chen, Hiroyuki Kakara, and Masaoki ShojiContents04 Introduction06 Notable Features of Use of Publicly Available RATs and Tools39 Malware Developers42 Potential Targets and TICK’s Desired Information43 Trend Micro ResearchWritten by: Joey Chen, Hiroyuki Kakara, and Masaoki ShojiStock image used under licensed fromShutterstock.comWe have been observing cyberespionage group TICK since 2008, but we noticed unusual active deployments after we started to monitor their activities more closely towards the end of 2018. By the first half of 2019, we found that the group was able to zero in on specific industries in Japan from which it could steal proprietary information and classified data. We named this campaign “Operation ENDTRADE,” based on its targets.Analysis of their attacks revealed that they have come up with new malware families capable of evading detection, obfuscation, and escalation of administrative privileges for subsequent attacks to go along with the deployment of previously used malware and modified tools. They have also incorporated techniques and mechanisms for detecting specific cybersecurity products and processes, as well as attempt to terminate a Trend Micro product’s process. Further, the use of legitimate email accounts and credentials to deliver the malware payload, as well as language targeting to increase the accuracy of malware delivery, makes it more effective against unprepared targets. The combination of these schemes — especially when they are continuously refined — could significantly affect the sectors identified as potential victims. It could also endanger people, turning it into an issue of safety.This research paper provides technical details and analysis based on our observation of Operation ENDTRADE.IntroductionTICK (a.k.a. “BRONZE BUTLER” or “REDBALDKNIGHT”) is a cyberespionage group known for its supplychain attacks and use of different malware families to attack organizations across different sectors suchas defense, aerospace, satellite communications, and retail industries, as well as industrial chemicalcompanies. Trend Micro has been observing this group’s operations from as early as 2008, includingits use of social engineering attacks commonly written in fluent Japanese following their usual targetvictims’ affiliations.First observation of the actual attackFirst observation of new tool occurredJANFEBMARAPRMAYJUNJULAUGABKBBKLilithAvengerbuild_downdown_newdoc_llPretenderCasperHideﬂoderFigure 1. Operation ENDTRADE’s timeline of activities, malware development, and deploymentTowards the end of 2018, we noticed TICK using and adjusting their preferred malware families (such asXXMM and DATPER) to become more efficient. We then started following their activities and found thatthe group was developing new malware and participating in a series of illicit activities even during attacks.The group has also removed the known signatures of its previously used malware routines and families,and adjusted their respective structures.4 | Operation ENDTRADE: TICK’s Multi-Stage Backdoors for Attacking Industries and Stealing Classified DataWe observed actual attacks, which used lateral phishing, in January 2019. Numerous emails were thensent to a number of organizations from one legitimate hijacked Japanese enterprise email address betweenmid-February and mid-April. In May, another round of emails were sent to a number of organizations fromanother legitimate email address. We have since referred to TICK’s activities as “Operation ENDTRADE,”based on these activities.We also observed that the new malware families the group uses were capable of checking if infectedsystems are running specific antivirus products from known cybersecurity vendors such as Qihoo 360,McAfee, Symantec, and Trend Micro. The result of which will be implemented in the C&C callbackparameter.The new malware family also scans the operations systems’ (OS) code pages to check if it is in Japaneseor Chinese, which would indicate that targets are located in these specific countries. Some of the targetedcompanies with headquarters in Japan and subsidiaries in China confirmed that attack attempts wereobserved during specific periods.5 | Operation ENDTRADE: TICK’s Multi-Stage Backdoors for Attacking Industries and Stealing Classified DataNotable Features of Operation ENDTRADE Spear phishing for malware deliveryTICK crafted and sent spear phishing emails to deliver malicious payloads to the victims’ networks, notablyin Japanese and in the context of the Chinese economy. The emails had the following characteristics:• They were sent from legitimate email addresses, likely the result of a lateral phishing scheme• They were written in correct Japanese• They were disguised as if they were legitimate reports and prompted users to open the attachments• Many of the emails contained subject topics related to “salary rate increase” or “job market”Prior to sending these emails, TICK attacked a Japanese economic research company and a PR agencyand stole email credentials from both organizations. These email addresses were then used to send thespear phishing emails, prompting potential victims to open the attachments. The attachments had thefollowing characteristics:• Drop/download the payload while opening the Japanese documents (hereon referred to as decoy files)• Decoy files appeared as normal documents from banks, PR companies, or economic organizations• The payload scans the system to identify any installed antivirus products. It then attempts to terminateTrend Micro’s antivirus processes, or at least flag the callback traffic to identify the location of thetargeted system6 | Operation ENDTRADE: TICK’s Multi-Stage Backdoors for Attacking Industries and Stealing Classified DataFigure 2. Spear phishing sample in correct JapaneseFigure 3. Japanese documents on the Chinese economy, dated June 25, 2019.7 | Operation ENDTRADE: TICK’s Multi-Stage Backdoors for Attacking Industries and Stealing Classified DataNew malware familiesWe observed TICK actively targeting victims with a variety of methods and techniques around December2018, adding more malware families as they launched new campaigns. We learned that they developednew tools that try to detect antivirus products and attempt to terminate Trend Micro’s antivirus product.We named them based on their characteristic program database (PDB) strings:• Two new downloaders named ABK and BBK• Two new Trojans named Snake and build_downFigure 4. Code that terminates specific antivirus’ processABKBBKTomatoAvengerbuild_downerSnakedown_newFigure 5. Combination of all the downloadersFurther analysis showed two additional malware families in the network. Naming them down_new andAvenger, we learned that these downloaders combine features of previous malware families and inheritefficient modules and features from ABK, BBK, Snake and build_down into their final downloaders. All ofthem have one important task: Connect to a website and verify the victim system’s volume serial numberto determine if it will send the command to download the backdoor. In the instance of multiple drives orvolumes, the downloaders collect information from drive C.8 | Operation ENDTRADE: TICK’s Multi-Stage Backdoors for Attacking Industries and Stealing Classified Data{masked}EXE.pdfFortiAvat.exePDFEXE1Use RTLO to drop2Execute and connect to C23Hash host volume info and verify with C24C2C2Usually is a legitimate sitecmd.exeEXEmscoree.dllDLLDownload encrypted backdoor and use AES decrypt the backdoor5 Executeschost.exeEXE6Inject shellcode into svchost.exe7Connect to C2C2Figure 6. Attack chain of ABK/BBK{masked}EXE.pdfFortiAvat.exePDFEXE3Hash host volume info and verify with C21Use RTLO to drop2Execute and connect to C2C2C2C2Usually is a legitimate site4A web page to relate attacker’s commandFigure 7. Attack chain of down_new9 | Operation ENDTRADE: TICK’s Multi-Stage Backdoors for Attacking Industries and Stealing Classified Data{masked}EXE.pdfwinlogan.exeGet host volume info and cpu id to verify with C23.1PDFEXE3.2 Upload vicitim info to C23.3 Request a stenography picture1Use RTLO to drop2Execute and connect to C2C2C2Usually is a legitimate site4AppLaunch.exe/Iemstsc.exeDownload encrypted loader and decrypt itlogo.bmpwinlogin.exe6DropEXE8 DLL hijackBMPEXE5Extract the backdoor folderDLLEXE7 Dropmscoree.dllFigure 8. Attack chain of Avenger10 into svchost.exeExploiting vulnerabilitiesIn early 2019, TICK began implementing techniques that exploit vulnerabilities CVE-2018-0802 andCVE-2018-0798 into their new downloaders ABK and BBK. The two referenced vulnerabilities are bothcategorized as Microsoft Office Memory Corruption Vulnerabilities in MS Equation Editor, which can beexploited for remote code execution (RCE) via stack buffer overflows. From the sample we obtained,svcdst.exe was the ABK downloader.xxx.doc8.t.winhelp.wllsvchdst.exeUsually is a legitimate siteDOCDLLEXE1 UseCVE-2018-0802 to drop2 Execute and drop main downloader3 Add itself to Hash host volume info and verify (EN: 20190625 US-China trade disputes and its effect on Financial and capital markets ({masked}) .pdf) 2019{masked}関連影響レポート_日系企業各社の対応_{masked}.pdf (EN: 2019{masked}-related impact report_Response of Japanese Companies.pdf) {masked}中国産業データ＆リポート-習主席G20欠席なら追加関税導入-20190612.pdf (EN: {masked}Chinese industrial data & report - more tariffs if Xi doesn’t show at G20 - 20190612.pdf) 20190523_{masked}関連影響レポート_1900時点_{masked}.pdf (EN: 20190523_{masked}-related impact report_1900_{masked}.pdf) 【顧客配布可】米中摩擦～新たな世界秩序と企業戦略～（日本語）.pdf (EN: [For Customers]US-China trade disputes~New world order and corporate strategy~ (Japanese) .pdf) 中国における日系企業の求人動向レポート2019年3月分.pdf (EN: Job market report of Japanese companies in China - March 2019.pdf) 新元号豆知識-元号-{masked}20190408.pptx (EN: New era name tips - era name-{masked}20190408.pptx) {masked}-中国経済週報（2019.3.21～3.29）.pdf (EN: {masked}-Chinese economy weekly report (2019.3.21～3.29) .pdf) (詳細版)2019年昇給率参考資料.pdf (EN: (Details)Reference material for Salary increase rate 2019.pdf)2019中国商务环境调查报告.pdf(EN: 2019 China Business Environment Survey Report.pdf)2019中国昇給率見通し各所発表.pdf(EN: 2019 Chinese salary increase rate outlook announcements 2019.pdf)2018年12月早会內容.pdf(EN: December 2018 - Morning meeting content.pdf)2019 {masked}CN Group Calendar - C.DOCX2018年12月米中貿易摩擦調査.pdf(December 2018 - Survey on US-China trade disputes.pdf)Dates2019/07/052019/06/262019/06/152019/05/312019/05/222019/04/222019/04/082019/04/012019/03/222019/03/122019/02/202019/02/172019/01/162019/01/16Table 1. Filenames of decoy documents used in Operation ENDTRADEAnalyzing samples of the newest downloader variant of down_new, TICK hard-coded two code pages 932and 936. Code page 932 refers to Japanese character encoding, while 936 refers to Simplified Chinese,indicating targets in Japan and China.12 | Operation ENDTRADE: TICK’s Multi-Stage Backdoors for Attacking Industries and Stealing Classified DataFigure 10. Code pages inside the down_new downloaderFile size expansion to avoid antivirus scansTICK’s Operation ENDTRADE expanded the ABK downloader’s file size past 50MB, likely to avoid sandboxand antivirus (AV) products’ file size thresholds.Figure 11. Use of the NumberOfBytesToWrite parameter to expand the ABK dowloader’s file size13 | Operation ENDTRADE: TICK’s Multi-Stage Backdoors for Attacking Industries and Stealing Classified Dataxxx.doc.exetaskma.exe2 dropEXE4 Hash host volume application informationList current processDownload file from internetSleepRBLRecursively list directoriesForce print file nameList in long formatTable 3. A list of down_new’s commandsThe callback information stands out because its HTTP post header is hard-coded in the sample.The trojan can get the infected machine’s MAC address and volume information and use it to single outuser information.27 | Operation ENDTRADE: TICK’s Multi-Stage Backdoors for Attacking Industries and Stealing Classified DataFigure 36. Code showing down_new collecting home phone data and URL pathThis trojan also only collects English characters as send information; if callback data is too short, down_new uses =hmo as the URI value. Otherwise, it uses =A1f as URI value and sends AES encrypted databack to the C&C.Figure 37. down_new’s AES key28 | Operation ENDTRADE: TICK’s Multi-Stage Backdoors for Attacking Industries and Stealing Classified Data#!/usr/bin/python # -*- coding: UTF-8 -*- #Copyright (C) 2019 Joey Chen from __future__ import absolute_import, division, unicode_literals from Crypto.Cipher import AES def aes_decrypt(data, key, _IV): cryptor = AES.new(key, AES.MODE_CBC, _IV) return cryptor.decrypt(data) if __name__ == ‘__main__’: encrypt_data = «<ciphertext input>» cyphertext = encrypt_data[:3]+encrypt_data[51:560] #print cyphertext cyphertext_ = base64.decodestring(cyphertext) IV = encrypt_data[3:8]+encrypt_data[32:51] #print IV IV_ = base64.decodestring(IV)[0:16] Key = encrypt_data[8:32] #print Key Key_ = base64.decodestring(Key)[0:16] plain_text = aes_decrypt(cyphertext_, Key_, IV_) Desired InformationTICK appears to be targeting Japanese organizations, specifically those with subsidiaries in China, toserve as footholds for intrusion. Occasionally, overseas head offices’ security systems and protectioncontrols may become weaker or have insufficient control on foreign subsidiaries. We have observed thisto be true as we analyzed some infiltration attacks move successfully from Chinese offices to Japanesenetworks. For instance, we observed TICK placing a malicious executable file with a folder icon in theShared folder of an infected desktop from a Chinese subsidiary, which an employee in Japan executed.We also found intrusions in the defense, chemical, aerospace, and satellite service industries.Before May 2019, the group targeted a large number of companies across different industries, but oneof the main targets was the defense sector. During an extended assistance for incident response in theregion, we found TICK trying to steal military-related documents from the victim’s network. However,by mid-May 2019, TICK appeared to have shifted their attention to the chemical industry. From theseincidents, we believe that the goal of this entire operation is to steal proprietary and classified information– confidential military specifics, technology and advanced materials – which may be of interest to TICK’sparent organization.We will continue to monitor this campaign and develop our protection system as they sustain attacks onthe said industries. We expect the group to shift their targeted sectors again.42 | Operation ENDTRADE: TICK’s Multi-Stage Backdoors for Attacking Industries and Stealing Classified DataConclusionTICK is a cyberespionage group that should not be considered dormant nor inactive, but a persistententity with advanced skill levels and the financial capacity to support its activities. Besides settingthemselves apart from cybercriminal groups only concerned with yielding profits from any potentialvictim, they ensure that their intended targets are of high-value, as evidenced by the extensive verificationroutine they perform once a target has been compromised. In addition, they have developed new malwarefamilies (such as Avenger and down_new) that are based on the malware families they previously used,with specific PDB strings that stand out with every deployment of Operation ENDTRADE. By using themin consecutively executed attacks and being able to steal legitimate emails for spear phishing, targetingJapanese companies and their foreign subsidiaries in China may only be one the many operations theyhave lined up. This may ring true considering a number of their attack routines and malware appear to stillbe in development and testing phase.Furthermore, while TICK has developed a considerable number of malware families, we expect themto develop more malware for future attacks, with features to prevent identification from the analyzedroutines, as evidenced by some of their signatures in Operation ENDTRADE. First, their new malware’scallback URI paths are comparably similar to their previously deployed malware. Second, they continueusing legitimate sites as their C&C server sites to download payloads from. Third, one of their preferredtechniques – steganography – is not only used in every attack in the past but showed a number ofversions and enhancements for this specific operation. Studying their victims’ environments, we found anumber of their characteristic tools mentioned by other cybersecurity companies in thwarting their attackattempts. Finally, one of their backdoors (DATPER) and trojans (BBK) used the same website as their C&C.The diversity and scope of their malware families highlight the varying degrees of proficiency this groupcan employ to remain undetected and exfiltrate data. This is evident in the group’s use of legitimate andpublicly-available tools in order to make it more difficult for inexperienced IT teams, research teams, oreven dedicated incident response teams to trace, analyze, and detect the attacks. Technical details fromthe malware routines also heavily imply that these attacks may just be the tip of the iceberg: more attackscan be expected, with improved versions compared to what we have seen. Industries and businesssectors should make it a priority to invest and install advanced security measures, strengthen their securitypolicies and procedures, and improve their employees’ security knowledge and awareness.43 | Operation ENDTRADE: TICK’s Multi-Stage Backdoors for Attacking Industries and Stealing Classified DataWe strongly advise that enterprises develop and implement monitoring systems and establish a clear chainof command. This operation not only highlights the importance of these two, but also observed that whenattacks like these occur, affected organizations find it difficult to take control of their foreign subsidiaries’security systems. In addition, companies with small overseas offices may not have sufficient resourcesto isolate and investigate the infected machines, making monitoring weak and incident response difficult.Enterprises and critical infrastructures will always be targeted by persistent attacks. Therefore, it isparamount that organizations become aware and knowledgeable on the latest threats that may be usedagainst them and the necessary measures that can be established to defend against them. When sensitiveinformation and assets are stolen, it not only affects the targeted group but all the business partners, andas this campaign showed, it can easily become an economic or safety concern.44 | Operation ENDTRADE: TICK’s Multi-Stage Backdoors for Attacking Industries and Stealing Classified DataAppendixMITRE ATT&CK TechniquesTacticInitial Supply Chain CompromiseExploitation for Client ExecutionCommand-Line InterfaceExecutionScheduled Task ScriptingSigned Binary Proxy ExecutionThird-party SoftwareUser Execution Registry Run Keys / Startup FolderID T1060DescriptionUsed to deliver first stage malware Used for initial intrusion on subsidiaries Used to exploit CVE-2018-0802 and CVE- 2018-0798 Used by some modified tools for command-line interface Used to execute malware Used VBScript Used to execute malicious files and AV evade detection Used publicly available tools during attacks such as RAR Used for initial infection Used to add themselves to registry RUN keyPersistence AccessBypass User Account ControlT1088Used UAC bypassing tool for Windows 10Binary Padding Bypass User Account Control Disabling Security Tools Deobfuscate/Decode Files or T1064Used to add junk data and expand the file size Used UAC bypassing tool for Windows 10 Used to attempt termination of AV process Used TSPY_LOADVBS to execute encoded command Used to delete files after use Used right to left override (RTLO) technique Used by Casper to inject backdoor’s shellcode Used VBScriptCredential DumpingT1003Used MimikatzAccount DiscoveryFile and Directory DiscoveryDiscoverySoftware DiscoverySystem Information DiscoverySystem Service DiscoveryLateral MovementRemote File CopyWindows Admin SharesT1087T1083T1518T1082T1007T1105T1077Used net utility for internal reconnaissance Accessed shared folders to find confidential information Enumerated installed software Used to collect volume serial ID and other system information Used TROJ_GETVERSION to discover system service Copied malware to remote desktop via Windows Admin Shares Copied malware to remote desktop via Windows Admin Shares45 | Operation ENDTRADE: TICK’s Multi-Stage Backdoors for Attacking Industries and Stealing Classified DataTacticTechniqueAutomated CollectionData from Local SystemCollectionIDT1119T1005Data from Network Shared DriveT1039Screen CaptureCommonly Used Port Custom Cryptographic Protocol Remote Access Tools Remote File Copy Standard Application Layer Protocol Standard Cryptographic ProtocolWeb ServiceExfiltration Over Command and And ControlExfiltrationDescriptionUsed a trojan to perform series of discovery techniques and saves it to a text file Collected data from both local and network shared drives Collected data from both local and network shared drives Possibly-stolen RAR file contained desktop screen capture image Used ports 80 or 443 Used for downloaded/sent-back data Used for downloaded/sent-back data Used for downloaded/sent-back data Used various RAT families Used to download files in C&CT1113T1043 T1105T1071Used to communicate with remote C&CT1032T1102T1041T1002 T1022Used AES Used to compromise legitimate web sites as C&C servers Possibly sent collected data to attacker via C&C channel Used password-protected RAR TROJ_ABK.ZYGH TROJ_BBK.ZCGB-A TROJ_BUDOWN.ZCGB-A TROJ_BUDOWN.ZJGD-A TROJ_BUDOWN.ZJGD-A Backdoor.Win32.PLUGX. AUSUPVTROJ_AVNGR.ZJGHTROJ_AVNGR.ZLGI BKDR_CSAPER.ZCGGBKDR_CASPER.ZAGFBKDR_DATPER.SMZKEBTrojan.Win32.OTORUN.AW CNFL HackTool.Win64.Mimikatz.AD HackTool.Win64.Mimikatz.AU HackTool.Win32.PortScan.SWJHackTool.Win32.TestMac.AHackTool.Win32.TestMac.B HKTL_SCRENCAP.ZYGD50 | Operation ENDTRADE: TICK’s Multi-Stage Backdoors for Attacking Industries and Stealing Classified Data 