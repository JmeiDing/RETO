Get SupportENMENUGet updates: Unit 42 Sign up to receive the latest news, cyber threat intelligence and research from Unit42Business EmailBlog Home > Unit 42 > Patchwork Continues to Deliver BADNEWS to the Indian SubcontinentPatchwork Continues to Deliver BADNEWS to the Indian SubcontinentBy Brandon Levene, Josh Grunzweig and Brittany Ash March 7, 2018 at 5:00 AM Category: Unit 42 Tags: BADNEWS, Dropping Elephant, India, Monsoon, Pakistan, patchwork 9,597 (5) Summary In the past few months, Unit 42 has observed the Patchwork group, alternatively known as Dropping Elephant and Monsoon, conducting campaigns against targets located in the Indian subcontinent. Patchwork threat actors utilized a pair of EPS exploits rolled into legitimate, albeit malicious, documents in order to propagate their updated BADNEWS payload. The use of weaponized legitimate documents is a longstanding operational standard of this group. The malicious documents seen in recent activity refer to a number of topics, including recent military promotions within the Pakistan Army, information related to the Pakistan Atomic Energy Commission, as well as Pakistan’s Ministry of the Interior. The BADNEWS malware payload, which these malicious documents ultimately deliver, has been updated since the last public report in December 2017. BADNEWS acts as a backdoor for the attackers, providing them with full control over the victim machine. It has historically leveraged legitimate third-party websites to host the malware’s command and control (C2) information, acting as “dead drops”. After the C2 information has been collected, BADNEWS leverages HTTP for communication with the remote servers. We’ve observed modifications to how the malware obtains its (C2) server information, as well asConvert webpages to pdf online with PDFmyURLreCAPTCHASUBMIT Please upgrade to a supported browser to get a reCAPTCHA challenge.Alternatively if you think you are getting this page in error, please check your internet connection and reload.TRENDING ARTICLESWhy is this happening to me?Where to Find Us At RSA Conference 2018!The Cybersecurity Moonshot and Zero TrustNews of the Week: April 7, 2018Channel Scoop: April 6, 2018modifications to the C2 communication. These changes to BADNEWS, as well as the use of recent EPS-based exploits, demonstrate that the group are actively updating their toolsets in efforts to stay ahead of the security community. In this posting, we detail our findings and document these changes. The malicious documents that Unit 42 examined contained legitimate decoy lures as well as malicious embedded EPS files targeting the CVE-2015-2545 and CVE-2017-0261 vulnerabilities. These vulnerabilities are well covered in previous public works, which can be found from PWC and FireEye. Older documents used by Patchwork focused on the CVE-2017-0261 vulnerability, however in late January 2018 when, paradoxically, newer documents abandoned this vulnerability to attack the older CVE-2015-2545 vulnerability. The lures are primarily documents of interest to Pakistani nuclear organizations and the Pakistani family. When the shellcode embedded within the malicious EPS is executed, the following three files are dropped:%PROGRAMDATA%\Microsoft\DeviceSync\VMwareCplLauncher.exe %PROGRAMDATA%\Microsoft\DeviceSync\vmtools.dll %PROGRAMDATA%\Microsoft\DeviceSync\MSBuild.exeIn the list of dropped files, VMwareCplLauncher.exe is a legitimate, signed VMware executable that serves to ultimately deliver the BADNEWS payload. The vmtools.dll file is a modified DLL that both ensures persistence and loads MSBuild.exe, which is the BADNEWS malware renamed to spoof a legitimate Microsoft Visual Studio tool. After the files are dropped, the VMwareCplLauncher.exe executable is run, which in turn loads the vmtools.dll DLL file. This DLL file creates a scheduled task named BaiduUpdateTask1, which attempts to run the malicious, spoofed MSBuild.exe every subsequent minute. The technique of having a signed, legitimate, executable load a malicious library is commonly referred to as side-loading, and has been witnessed in a number of campaigns and malware families in the past. The flow of execution from the time the victim opens the malicious Microsoft Word document, to the execution of BADNEWS, may be seen below:Convert webpages to pdf online with PDFmyURLFigure 5 Side-loading technique employed to deliver BADNEWSThe following image demonstrates the scheduled task created by the modified vmtools.dll to ensure BADNEWS runs and remains running on the victim machine.Convert webpages to pdf online with PDFmyURLFigure 6 Scheduled task created to load BADNEWSBADNEWS Much of BADNEWS has remained consistent from when it was originally discussed by Forcepoint in August 2016. Additionally, recent analysis by Trend Micro notes some minor changes during 2017. To briefly recap, the BADNEWS malware family acts as a backdoor, with communication occurring over HTTP. A number of commands are provided to the attackers, including the ability to download and execute additional information, upload documents of interest, and take screenshots of the desktop. The malware collects C2 information when it is originally executed via “Dead Drop Resolvers”. Dead drop resolvers have been used by multiple threat actor groups using various malware families and those behind Patchwork are well versed with this tactic. This tactic uses public web services to host content that contains encoded commands that are decoded by the malware. For the remainder of the analysis in this research blog, we are discussing the following file:SHA256 2017-12-22 11:54:03 UTCConvert webpages to pdf online with PDFmyURLOne of the first modifications we witnessed in this new variant of BADNEWS is a new mutex that is created to ensure a single instance of BADNEWS is running at a given moment. This malware family used the new mutex ‘com_mycompany_apps_appname_new’. This variant of BADNEWS uses different filenames compared to previous versions. The following filenames are used by BADNEWS throughout its execution. All of these files reside in the victim’s %TEMP% directory:Filename Contains victim unique identifier Keystroke logs List of interesting files Temporarily holds screenshot when given command by C2 Temporarily contains downloaded file to be executed when given command by C2Other changes we noticed in this variant include how the malware obfuscates C2 information stored via dead drop resolvers. Previous variants of BADNEWS looked for data between ‘{{‘ and ‘}}’, and used a simple cipher to decode this data. This new variant now looks for data between ‘[[‘ and ‘]]’ in a number of hardcoded URLs. This can be seen in the following images taken from hxxp:// feeds.rapidfeeds[.]com/88604/, which is one of the dead drop resolvers we encountered in this sample:Convert webpages to pdf online with PDFmyURLFigure 7 Dead drop resolver used by BADNEWSIn order to decrypt this data, the authors have included additional steps from previous versions. To decode this information, BADNEWS takes the following steps:1. Base64-decode the string 2. Perform the decoding cipher used in previous versions 3. Base64-decode the result 4. Decrypt the result using the Blowfish algorithm and a static keyA script, which is included in the Appendix, will decrypt data from these dead drop resolvers. In the example shown above, we are presented with a result of 185.203.118[.]115 after all four steps are taken. BADNEWS performs many of the expected functions associated with previous versions including keylogging and identifying files of interest. Unlike a previously reported variant, this version of BADNEWS no longer looks at USB drives for interesting files. Instead, it looks at fixed drives only. It continues to seek out files with the following extensions:.xls .pptxConvert webpages to pdf online with PDFmyURL.pdfIn order to prepare for C2 communication, BADNEWS will aggregate various victim information, which is appended to two strings. These strings have the following format:1 uuid=[Victim ID]#un=[Username]#cn=[Hostname]#on=[OS Version]#lan=[IP Address]#nop=#ver=1.01 uuid=[Victim ID]#un=[Username]# It should be noted that the variables used for this string are different from previous versions. For example, in the previous variant of BADNEWS, the victim’s unique identifier was stored under a variable named ‘uid’, the username was stored in a variable named ‘u’, etc. Additionally, the hardcoded version string of ‘1.0’ is different from previous samples. C2 communication is also updated from prior versions, with the following commands now supported by BADNEWS:Command Description Upload edg499.dat, which includes the list of interesting files. Spawn a new instance of BADNEWS after. Upload the file specified by the C2. Upload the TPX498.dat file, which contains the list of collected keystrokes. Copy file to adbFle.tmp, and upload it to the C2. Take screenshot, temporarily store it as TPX499.dat, and upload it to the C2. Download specified file to %TEMP%\up and execute it in a new process5 813 2333Convert webpages to pdf online with PDFmyURLDuring C2 communications, BADNEWS will communicate to the C2 previously identified via HTTP. The following hardcoded URI is used for normal communication with the C2 (note the additional created strings containing the victim’s information. An example request in a sandboxed environment may be seen below:Figure 8 Example request made by BADNEWSTo decrypt the data provided in the POST request, a number of steps are required. First, the attackers include a series of extra ‘=’ and ‘&’ characters within the data stream. Once these are removed, the data is decoded with base64. Finally, the result is decrypted using AES-128 and the following static key (hex-encoded):DD1876848203D9E10ABCEEC07282FF37Conclusion The Patchwork group continues to plague victims located within the Indian subcontinent. Through the use of relatively new exploits, as well as a constantly evolving malware toolset, they aim toConvert webpages to pdf online with PDFmyURLcompromise prominent organizations and individuals to further their goals. Recent activity has shown a number of lures related to the Pakistan Army, the Pakistan Atomic Energy Commission, as well as the Ministry of the Interior. One of the malware families tied to this group, BADNEWS, continues to be updated both in how it uses dead drop resolvers, as well as how it communicates with a remote C2 server. Palo Alto Networks customers are protected against this threat in a number of ways:Traps blocks the exploit documents witnessed during this campaign WildFire accurately identifies the samples mentioned in this blog as malicious The Patchwork and BADNEWS tags in AutoFocus may be used for continued monitoring and tracking of this threat.Additionally, the providers being used for dead drops have been notified. Indicators of Compromise Malicious Word Document SHA256 Hashes BADNEWS SHA256 Hashes C2 ServersConvert webpages to pdf online with PDFmyURL185.203.118[.]115 94.156.35[.]204 Dead Drop Resolvers hxxp://feed43[.]com/8166706728852850.xml hxxp://feed43[.]com/3210021137734622.xml hxxp://www.webrss[.]com/createfeed.php?feedid=49966 hxxp://feeds.rapidfeeds[.]com/88604/ Script to Decrypt Dead Drop Resolvers1 from Crypto.Cipher import Blowfish from struct import pack rol = lambda val, r_bits, max_bits: (val << r_bits%max_bits) & (2**max_bits-1) | ((val & (2**max_bits ror = lambda val, r_bits, max_bits: ((val & (2**max_bits-1)) >> r_bits%max_bits) | (val << (max_bits def unhexData(d): if len(d) % 2: d = d.zfill(len(d)+1) return ord(binascii.unhexlify(d)) def decodeDecrypt(data): decdata = '' for x in range(len(data)): x = x*2 if x < len(data): c = unhexData(data[x]) add_num = unhexData(data[x+1]) c = c << 4Convert webpages to pdf online with PDFmyURLc = (c + add_num) & 0xff c ^= 0x23 c = rol(c, 3, 8) decdata += chr(c) data2 = base64.b64decode(decdata) key = binascii.unhexlify("F0E1D2C3B4A5968778695A4B3C2D1E0F0011223344556677") cipher = Blowfish.new(key, Blowfish.MODE_ECB) dec = cipher.decrypt(data2) "url" for d in urls: r = requests.get(d) body = r.text r = re.search("\[+\s*([a-zA-Z0-9\=]+)\]+", body) if r: data = base64.b64decode(r.group(0)) print("[{}] Decrypted C2: {}".format(d, decodeDecrypt(data).split("\x00")[0]))28 49Got something to say?Leave a comment Notify me of followup comments via e-mailName (required)Convert webpages to pdf online with PDFmyURLName (required)Email (required)WebsiteSUBMITSUBSCRIBE TO NEWSLETTERSEmailSUBSCRIBECOMPANY Report a VulnerabilityLEGAL NOTICES Privacy Policy Terms of Use© 2016 Palo Alto Networks, Inc. All rights reserved.ACCOUNT Manage Subscription  SALES > 866.320.4788 SEE A DEMO TAKE A TEST DRIVEConvert webpages to pdf online with PDFmyURL 