lab52.io /blog/muddywaters-light-first-stager-targetting-middle-east/ MuddyWater’s “light” first-stager targetting Middle East _thespis ⋮Since the last quarter of 2020 MuddyWater has mantained a “long-term” infection campaign targeting Middle East countries. We have gathered samples from November 2020 to January 2022, and due to the recent samples found, it seems that this campaign might still be currently active. The latest campaigns of the Muddy Water threat group, allegedly sponsored by the Iranian government and linked to the Iranian revolutionary guard (the main armed forces of the Iranian government), could be framed within the dynamics of maintaining Iran’s regional sovereignty.This infection campaign always starts with a compressed file wrapping a malicious Word document containing VBA macros.Malicious document sampleWhile our oldest sample looks a little more sophisticated based on the content of the document, which seems more specifically crafted for Arabic speakers as shown in the previous image, the rest of them contain generic English message to enable macros.Malicious document sample1/6Malicious document sampleAlthough it has not been possible to clearly identify their specific target, it has been observed that these campaigns have been directed against countries such as Pakistan, Kazahstan, Armenia, Syria, Israel, Bahrain, Turkey, South Africa, Sudan, etc. Many of these countries may be of interest to the alleged Iranian threat actor, as some of them have been involved in recent internal conflicts, or are implicated in nuclear energy improvement, or may serve as strategic footholds for the development and influence of Iranian interests in other parts of the world.The macros are very concise and their only purpose is to write a not-so-much obfuscated VBS script into a file located in C:\ProgramData or the Windows Startup folder, with names such as Temp_[3-5 random chars].txt.2/6Malicious VBA macro codeThe dropped script is a small RAT which allows to execute commands via cmd. It first calls a recon function which executes whoami, and sets a country code which is already present in the script. The result of this will then be part of the URI used for the C2 contact. The set of different country codes found in the gathered samples are the following, and might indeed reveal the targets for each campaign:PK –> Pakistan SA –> South Africa SD –> Sudan KK –> Kazakhstan3/6Code snippet from dropped VB Script (Deobfuscated)Code snippet from dropped VB Script (Obfuscated)After building the recon string, it will execute its main function. This function first executes explorer.exe (without apparent functional reason), and then calls a function to choose one IP from an array which will rotate in case of the chosen IP not replying to the subsequent C2 connection. This connection to the C2 server will use an HTTP GET request using the following structure:http://{ IP_address }/getCommand?guid={ recon_string }HTTP GET communication from VBS sampleAs aforementioned, in the case of an empty reply, it will rotate the IP address and try again with the next. Otherwise it will deobfuscate the reply and call a function to execute it by creating a WScript.Shell object to call cmd:As also seen on the deobfuscated snippet, it will output the result into a txt file and immediately read its content to return it to the calling function in order to include the result and send it to the C2 server. The next contact will use the POST HTTP method and will follow a slightly different structure and the command output in the body:http://{ IP_address }/getTargetInfo?guid={ recon_string }&status={ flag_value }4/6HTTP POST communication from VBS sampleInterestingly, the value renamed by us as “flag_value” will be included as the “state” value within the POST request. In the script file, it is a variable that is initialized to 0 in every collected sample, and is always set to 1 before executing the received command and sending the result in the POST request. Other than this, it is not modified or used in the script file. However, it is checked during the renamed “whoami_wrap” for the initial host recon at the beginning of the script. It is compared with the value 126, and in case of resolving True, it will display the following message box.Malicious VBS “alternative functionality”The only implemented functionality in every analyzed sample is the #1, which will use WMI to display the following information about the infected system:Code snippet for the “alternative functionality”Such a small script with incomplete functionality, after almost two years being used for different campaigns could suggest that the attackers might modify its functionality in a later stage, based on the obtained information from the 