SESSION ID:CTT-W08Evolving Threats: dissection of a Cyber- Espionage attackStefano Maccaglia Advisory Consultant IR RSA (a Division of EMC)#RSACWho I Am#RSAC I prefer not to talk too much about myself…  Let just say I am Advisory Consultant at RSA IR  I am an Incident Responder with deep knowledge of malware and networkanalysts I have started my career in 1997  I have worked for several top 100 companies  Before that I have been a cracker in Europe «underground scene» of Amiga andPCs.Agenda What we discuss today  Today I would introduce a case I am still working on.  The case is related to Military Sector, and it has been recorded with minimaldifferences in several EU military environments.#RSAC The details of the attack are under strict NDA, but with slight modifications I havethe chance to share the most important details about the attacker strategies, tactics and tools used. The case is interesting for several reasons that we will discuss today.  The triage is still going on.The adversary APT28  The attack has been attributed to APT Group 28, also known as “Sofacy” or“Sednit”. I will call it “APT28” from now on.#RSAC APT28 group believed to have been in operation since 2007 and has beenidentified in several attacks that have targeted Eastern European governments, military and security-related organizations including the North Atlantic Treaty Organization (NATO). The group uses a complex set of tools and strategies to put a foothold in anenvironment and to control and steal interesting data. Several sources consider APT28 a group of CyberMercs based in Russia.The target: the moat without water How to develop a good network segmentation and be breached  The attack has targeted a military environment in EMEA region.  The environment has born segmented, with several layer of controls to preserveconfidentiality and integrity of exchanged and stored data.#RSAC The segmentation separates the network in several layers with different level of“trust”. Any operator receives a badge and a smartcard to operate in the network.  Communication from a lower to an higher layer of trust is blocked, insteadcommunication from higher layer to a lower one are permitted. At the beginning of the investigation I discovered that the base lacks any realnetwork visibility. The only network devices capable of analyzing streams were sporadic IDS and IPS placed in non strategic points.The target: the moat without water How to develop a good network segmentation and be breached  The environment is a Microsoft AD Forest with a pyramidal structure. • The root AD trusts several subdomains each withits proper set of AD servers.#RSAC• The forest is regulated with different level of trust. • The «Secret» and «NATO» networks are physicallyseparated entities were people can access only through dedicated machines.• Under no circumstances a user from standard ADstructure can access Secret networks.The target: the moat without water How to develop a good network segmentation and be breached  Patching policies are 15 days behind Microsoft releases.  All other applications are patched and upgraded based on internal CERT approval.  The reason for the delay is due to the need to verify the consistency and the impact#RSACof upgrade/patch against production environment. During the investigation we have discovered that, in the Data Center, two ADservers related to trusted subdomains, were not properly patched since November 2014 due to the swap from a maintenance contractor to another. The lack of the patch MS14-068 is a key to understand how deep and how hardthey have been breached.The Attack#RSACThe attack strategy How they break-in  The attack started from a targeted spear-phish campaign against the participants of#RSACthe 2014 Farnborough Air Show. The attack has targeted 7 officials of Air Force (AM) and 2 official of the Navy (MM)the email domain source was: “militaryexponews[.]com” The attack exploit a Microsoft Word vulnerability (CVE-2015-2424).  Only in two cases the attack completes successfully for the attacker.  In seven cases, the exploit, despite successfully detonated, was not able to start theinfection because the machines lack direct Internet access (proxy blocked connection attempts). The reconstruction of the first stage has been performed after the creation of aproper set of IOCs starting from the infected systems.The Attack Dissemination strategy#RSACSpear DropperFirst C&C external C2 orDropzoneSecond C&C andsends stolendataEVILTOSScandownload from C&CLateralmovementsand ExfilCHOPSTICK systemAttack Overview: End of First Wave The infected hosts, during roaming in external sites, communicates with C2#RSACAttackerMain C2Whenroaming theyconnectto C2.Victim 1Victim 2microsofthelpcenter.infoAttempts to access C2Blocked by proxyAttempts to access C2BaseNote: The repeated attempts to communicate externally from infected machines blocked by proxy have been considered «of no interest» for the SOC of the base. No other investigation or action has been taken, at time, against these machines.The attack strategy More patients to care about…  To escalate the infection the attacker have used the OWA access of the stolenaccounts to enumerate other potential victims for a new wave of targeted emails.#RSAC Also, one of the officers has access to internal Sharepoint service and participatesto boards were specific internal meetings and projects are discussed. With tailored messages published in Sharepoint board, the attacker has been ableto sneak through the inner layers of the military infrastructure distributing the dropper. One lesson I learn from Sharepoint…it has a horrible Log format.Attack Overview: End of Second Wave#RSACStill under controlStill under controlAttackerC2sVictim 1Victim 2microsofthelpcenter.info 1oo7.net The infection evolution  In this second wave of attack the adversary, knowing that the previous phase has not succeeded as planned due to access restriction with proxy and firewalls, has modified the dropper in order to work with internal proxy (with HTTP and SSL).#RSAC The modification has insured the control of all successfully infected hosts.IOCProxyTest performed after collection of the dropper from original spear phising emailThe attack strategy The infection progression  The attacker has now a significant set of standard Domain Users account.  Not enough to pawn the infrastructure, but good enough as a starting point.  Thanks to his backdoor, he can easily begin to extend his action to other systems.  Lacking logs and network visibility, for that part, we can only speculate that he#RSACsuccessfully identifies the vulnerable Navy subdomains by accessing Navy computers in the base. The victims have direct access to the abovementioned AD servers because they usethem for standard authentication. APT28 at this point has breached AD servers, has collected domain adminscredentials and has moved forward to the Root AD and the repositories where “interesting data” resides.CVE 2014-6324 LOG IOC  Windows Audit log showing the successful exploitation of the Kerberos Service. • When looking at the Audit log, to#RSACunderstand the successful exploit we should compare the Security ID with the Account Name. These two should be identical.• In this case, slightly modified from theoriginal log, we can see the «Officer A» logging with the Security ID of «Administrator».Pwning the core: CVE-2015-1701 AKA… «How to pwn your AD and live undetected»…  The attacker has been able to exploit root AD Servers thanks to a unknown (initially)#RSAClocal privilege escalation vulnerability CVE-2015-1701.The attacker has exploited a callback in UserSpace. Upon completion, the payload continues execution in UserMode with the privileges of the System process.Note: The technique has been reported by Microsoft thanks to the analyses carried out in this engagement…The Incident#RSACPatient Zero How the victim discovers the problem  The diplomatic representation in Addis Ababa is composed of few militaries andseveral diplomats connected to Internet with the standard VPN service from public networks (transit through the Base). For that part, nobody has noticed the strange connections to the external C2s repeated each day.#RSAC But for a specific task, the owner of the infected laptop has used a connection froma military outpost, tightly regulated in access time and permissions. Once connected, the computer has attempted to beacon to the C2s and the localnetwork operator has identified the strange traffic signaling it to his superiors.  The alert has escalated to the Army regiment which has started to investigate.  The analysis performed has followed the traditional practice.Patient Zero What’s on Customer “Patient Zero” machine?  The forensic analysis on the «Patient Zero» identified by the Customer showedthe following suspicious files and registry modifications, but no attempts to expand the focus of the investigation have been made.#RSACRegistry Keys and ValuesHKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\Network Identification Service\parameters\ServiceDll = C:\Windows\System32\netids.dllHKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\Network Identification Service\parameters\ServiceDllUnloadOnStop = 1HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost\ntsvcs = Network Identification Service HKEY_LOCAL_MACHINE\software\microsoft\windowsNT\currentversion\svchost\ntsvcs\CoInitializeSecurityParam ➝ 1CreatedModifiedYesYesYes YesNoNoNo NoEVILTOSS backdoorPatient Zero consequences How the attacker reacted  The Army has triaged the compromised system reinstalling the OS and applications#RSACand has close the case. As result of the triage, the attacker changes strategy for a while.  APT28 has lowered the volume of his traffic and, for more than 20 days nothinghas been reported. The military was ready closed the case, but another anomaly has been foundedduring a scheduled maintenance on a server in the base Data Center. Looking at the logs, they have discovered the presence of repeated accesses fromad Administrator account logging from an external IP address. The case has escalated quickly this time.The Methodology#RSACWhat we can bring to the table?#RSAC I am part of RSA IR Team and our structured approach, developed from ourfield experience is now tuned to face attacks like this one. Our approach leverages on “Actionable IoCs” and the support of tools that could easily integrate these IoCs to speedup the IR investigation process. This is a methodology and not a “method”, because it counts on procedures,analyses and evidences in a scientifically sounding approach. To collect actionable IoCs we use a synergic approach that includes networkand system visibility with log and malware analyses. It involves aggregation of IoCs and their classification to create a “KnowledgeBase” of attacks, tools and strategies that could be “reused” in subsequent engagements to streamline the response and support the attribution.The MethodologyNetwork and log indicators. Classification and attribution.Triage planned from a tailored set of strategic actions.Actionable IoCs What our methodology suggests  IR is an ongoing process that spawns on multiple areas.#RSACActionable IoCs What our methodology suggests  To operationalize the IoC you should develop, use and store it in a reusable logic.#RSACInvestigation: first step  The Customer has initially escalated the problem to another team, but despitethe efforts and a triage attempt, the result was not satisfactory.#RSAC Few days after the triage they discover additional lateral movements in theirnetwork. At this point the Customer called us.  We notice, since the initial talk, that the Customer was lacking any network visibility and the investigation was performed without a structured approach.No network visibilityNo detailed analysis has been performed initiallyLimited quantity of historical logsThe initial investigation has been limited to MD5 search on Domain machines.Zero Trust Below zero trust…  Following our advice to bring a network forensic tool in their environment (RSA Security Analytics) we have been able to ensure that, even after the «apparent» expulsion of the attacker, several machines were still infected.#RSACSuccessful expulsion/triage…The «network the chance to attacks.Our investigation Our approach tailored to the case  We have rebuilt the investigation process from the scratch aiming to identify maliciousbehavior from the already collected samples to build optimal Network Forensic IOC and to apply them as a base to highlight further machines infected.#RSACIntegrated a Network Forensic Tool: RSA SARedefined Actionable IOCs at Network, System and Log level for different platforms and systems.Refocused the malware analysis on all identified samples to identify Actionable IOCs.Improved the triage strategy by moving from °seek & destroy° to a more strategic approach. Thanks to that we have been able to enumerate remaining infected machines and to unearth the “missing piece”: the Chopstick RAT that the original IR team was not capable of identify. We know, from experience, that APT28 uses Chopstick RAT for most interesting targets.Attacker Tools#RSACAPT 28 Tools APT 28 Tools seen in this investigation  CORESHELL: This downloader is the evolution of the previous downloader ofchoice from APT28 known as “SOURFACE” (or “Sofacy”). This downloader, once executed, create the conditions to download and execute a second-stage (usually Eviltoss) from a C2.#RSAC EVILTOSS: This backdoor is delivered through CORESHELL downloader to gainsystem access for reconnaissance, monitoring, credential theft, and shellcode execution. CHOPSTICK: This is a modular implant compiled from a software framework thatprovides tailored functionality and flexibility. By far Chopstick is the most advanced tool used by APT 28. MIMIKATZ: Everyone of us knows this tool. In this case, this has been ofdevastating effects to completely compromise AD Forest.APT 28 Tools CORESHELL behavioral analysis Coreshell was relatively easy to detonate, apart for some AntiVM checks before executing. The behavioral analysis has permitted to highlight several DNS connections:#RSACThe DNS requests aim to different external hosts. The malware use a beacon mechanism based on HTTP POST and a separate thread for instructions still in HTTP. The User-Agent, as explained earlier, can be used as IOC, at least for the oldest variants.Note: Latest version of CORESHELL uses the victim’s browser User-Agent making the IOC useless.APT 28 Tools CORESHELL ATTRIBUTION BY COMPARISON#RSACThe attribution has been performed in two ways:  by comparison, between the discovered samples and the public ones. by analysis, looking forindicators related to the date and time of compilation, the time zone, the language of the malware and its behaviour.The dropped files have been verified as well and compared between different droppers.APT 28 Tools EVILTOSS IOCs  At system level the malware modifies the Registry in order to ensure persistence.  It is dropped and executed, usually, from one of these folders:#RSACEVILTOSS installation folder %commonprogramfiles%\System\Registry Keys and Values HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\Network Identification Service\parameters\ServiceDll = %EVILTOSS folder%<EVILTOSSNAME>.dll HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\Network Identification Service\parameters\ServiceDllUnloadOnStop = 1HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost\ntsvcs = Network Identification Service HKEY_LOCAL_MACHINE\software\microsoft\windowsNT\currentversion\svchost\ntsvcs\CoInitializeSecurityParam ➝ 1CreatedModifiedYesYesYes YesNoNoNo Nodownload files from a remote computer and/or the Internet run executable files log keystrokes send gathered informationAPT 28 Tools EVILTOSS ATTRIBUTION BY COMPARISON#RSACThe attribution has been performed in two ways:  by comparison, between the discovered samples and the public ones. by analysis, looking forindicators related to the date and time of compilation, the time zone and the language of the malware discovered. Also lateral movements have been verified in terms of timeframe of the log and hosts involved.APT 28 Tools EVILTOSS IOCs  EVILTOSS and CORESHELL share a lot of commonalities, both in thecommunication mechanism and the obfuscation/encryption. I.E. both obfuscate strings that are decoded at runtime. EVILTOSS uses RSA encryption to encrypt data and send it through a HTTPPOST message very similar to CORESHELL traffic:#RSACCont…C2 ack for exfilAPT 28 Tools CHOPSTICK  CHOPSTICK is a Trojan family, written in C++ and built from a framework.  It offers a diverse set of capabilities for different deployments.  It collects detailed information from the host settings and it is aware of the presence#RSACof several security products. It may communicate with external servers using SMTP, HTTP or HTTPs.  CHOPSTICK stores all collected information in a hidden file for temporary storage.  It communicates with the C2 via Windows “mailslot”, not named pipes or sockets.  CHOPSTICK main executable creates a “mailslot” in Windows machines and acts asthe mailslot server, while its code injected into the other processes acts as a client allowing the Trojan to access and steal any type of information. The RC4 encryption used here also uses a 50 bytes static key plus four-byte randomsalt value.APT 28 Tools CHOPSTICK IOCs  Looking at network traffic we discover that, after approximately 60 seconds ofexecution time, CHOPSTICK begins communicating with one of its C2 servers. Usually as in our sample the traffic was over HTTP:GET /find/?itwm=90QDFR9CWZckwkTPHr2GOUXPXI91A&from=yVVgOqV1UG&utm=HTXh&utm=9kV7L3Z&oprnd=Xjp1kKrDgAeFu&from=06&9u2J=nYruvlhMtXN5 HTTP/1.1 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*;q=0.8 Accept-Language: en-us,en;q=0.5 Accept-Encoding: gzip, deflate User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; InfoPath.2; .NET CLR 2.0.50727; .NET CLR 3.0.04506.648; .NET CLR 3.5.21022) Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*;q=0.8 Accept-Language: en-us,en;q=0.5 Accept-Encoding: gzip, deflate User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; InfoPath.2; .NET CLR 2.0.50727; .NET CLR 3.0.04506.648; .NET CLR 3.5.21022) Content-Length: 69 Connection: Keep-Alive Cache-Control: no-cache EMo1MTmWmHwJAwHlezPSG5-SGWRYwQm6MbGxkYhvCv7-FRCezztd2UxRArSxP285WXg==The attack strategy IOC: C2 list  Thanks to our structured approach we have been able to identify the C2s used by the attacker and with them, we have been able to enumerate infected hosts based on network communications. Note: Some of the discovered C2s are in common with other attacks recorded against other military environments in EMEA.The C2 list has confirmed the attribution and has paved the way for a more structured approach for TriageIncident Timeline and Stats Results of our methodology Vs previous results obtained by the Customer#RSACPeak of attack distributionInitialSpearphishingFirst Phase ofAttackPatient Zero300250200150100500Final triage managed byour TeamLast record of infectedmachineOct‐14 Nov‐14 Dec‐14 Jan‐15Feb‐15 Mar‐15 Apr‐15 May‐15Initial massivetriageJun‐15Jul‐15Aug‐15First time ourmethodology has appliedSep‐15Remediation APT28APT28RemediationConclusion What I can suggest  It is extremely valuable to build an internal Knowledge base about incidents andattacks recorded and published and to extract IOCs from these incidents. It is extremely useful to refocus the IR procedures dividing them in four areas:#RSAC Network Forensic  Malware AnalysisActionable IOCsRapid Incident reaction Proactive Management It could be extremely important to streamline the IR procedures by transforming IOCs to actionable IOCs, that means to evaluate and define which IOC can be reused and which one is limited to a specific attack or event. It is important to drill and to give IR personnel the chance to learn how to build, use,extract, evaluate and properly store Actionable IOCs.Conclusion What our methodology suggests#RSACYou should not approach IR operations in a unstructured way.You should ensure proper «visibility» to all IR fields.You should avoid to manage the Incident through «work arounds» and «shortcuts»You should avoid to rely only on technologiesYou should keep your IR capabilities updatedOnce formalized, you should use IoCs as key element to evaluate the attack surfaceYou should organize the triage in a strategic approach.#RSACEMC, RSA, the EMC logo and the RSA logo are trademarks of EMC Corporation in the U.S. and other countries. 