The Citizen LabINTRODUCTIONResearch Brief July 2012From Bahrain with Love:FinFisher’s Spy Kit Exposed?Author: Morgan Marquis-BoireThe FinFisher Suite is described by its distributors, Gamma International UK Ltd., as "Governmental IT Intrusion and Remote Monitoring Solutions." 1 The toolset first gained notoriety after it was revealed that theEgyptian Government’s state security apparatus had been involved in negotiations with Gamma InternationalUK Ltd. over the purchase of the software. Promotional materials have been leaked that describe the tools as providing a wide range of intrusion and monitoring capabilities.2 Despite this, however, the toolset itself hasnot been publicly analyzed.This post contains analysis of several pieces of malware obtained by Vernon Silver of Bloomberg News thatwere sent to Bahraini pro-democracy activists in April and May of this year. The purpose of this work isidentification and classification of the malware to better understand the actors behind the attacks and the riskto victims. In order to accomplish this, we undertook several different approaches during the investigation.As well as directly examining the samples through static and dynamic analysis, we infected a virtual machine(VM) with the malware. We monitored the filesystem, network, and running operating system of the infectedVM.This analysis suggests the use of “Finspy”, part of the commercial intrusion kit, Finfisher, distributed byGamma International.DELIVERYThis section describes how the malware was delivered to potential victims using e-mails with maliciousattachments.In early May, we were alerted that Bahraini activists were targeted with apparently malicious e-mails. Theemails ostensibly pertained to the ongoing turmoil in Bahrain, and encouraged recipients to open a series ofsuspicious attachments. The screenshot below is indicative of typical message content:July 2012The attachments to the e-mails we have been able to analyze were typically .rar files, which we found tocontain malware. Note that the apparent sender has an e-mail address that indicates that it was being sent by“Melissa Chan,” who is a real correspondent for Aljazeera English. We suspect that the e-mail address is not are instead tricked into running an executable ".exe" file.4Upon execution these files install a multi-featured trojan on the victim’s computer. This malware provides theattacker with clandestine remote access to the victim’s machine as well as comprehensive data harvesting andexfiltration capabilities.INSTALLATIONThis section describes how the malware infects the target machine.The malware displays a picture as expected. This differs from sample to sample. The sample “ArrestedSuspects.jpg” (“gpj.stcepsuS detserrA.exe”) displays:3July 2012It additionally creates a directory (which appears to vary from sample to sample):C:\Documents and Settings\XPMUser\Local Settings\Temp\TMP51B7AFEFIt copies itself there (in this case the malware appears as “Arrested Suspects.jpg”) where it is renamed:C:\Documents and Settings\XPMUser\Local Settings\Temp\TMP51B7AFEF\Arrested Suspects.jpg” =>C:\Documents and Settings\XPMUser\Local Settings\Temp\TMP51B7AFEF\tmpD.tmpThen it drops the following files:C:\DOCUME~1\%USER%\LOCALS~1\Temp\delete.batC:\DOCUME~1\%USER%\LOCALS~1\Temp\driverw.sysIt creates the folder (the name of which varies from host to host):C:\Documents and Settings\%USER%\Application Data\Microsoft\Installer\{5DA45CC9-D840-47CC-9F86-FD2E9A718A41}This process is observable on the filesystem timeline of the infected host (click image to enlarge):“driverw.sys” is loaded and then “delete.bat” is run which deletes the original payload and itself. It theninfects existing operating system processes, connects to the command and control server, and begins dataharvesting and exfiltration.4Examining the memory image of a machine infected with the malware shows that a technique for infectingprocesses known as “process hollowing" is used. For example, the memory segment below from the“winlogon.exe” process is marked as executable and writeable:July 2012Here the malware starts a new instance of a legitimate process such as “winlogon.exe” and before theprocess’s first thread begins, the malware de-allocates the memory containing the legitimate code and injectsmalicious code in its place. Dumping and examining this memory segment reveals the following strings in theinfected process:Note the string:y:\lsvn_branches\finspyv4.01\finspyv2\src\libs\libgmp\mpn-tdiv_qr.c5This file seems to correspond to a file in the GNU Multi-Precision arithmetic library:url process “svchost.exe” was also found to be infected in a similar manner:July 20126Further examination of the memory dump also reveals the following:July 2012This path appears to reference the functionality that the malware uses to modify the boot sequence to enablepersistence:y:\lsvn_branches\finspyv4.01\finspyv2\src\target\bootkit_x32driver\objfre_w2k_x86\i386\bootkit_x32driver.pdbA pre-infection vs post-infection comparison of the infected VM shows that the Master Boot Record (MBR)was modified by code injected by the malware.The strings found in memory “finspyv4.01” and “finspyv2” are particularly interesting. The FinSpy tool is part of the FinFisher intrusion and monitoring toolkit.5OBFUSCATION AND EVASIONThis section describes how the malware is designed to resist analysis and evade identification.The malware employs a myriad of techniques designed to evade detection and frustrate analysis. Whileinvestigation into this area is far from complete, we discuss several discovered methods as examples of thelengths taken by the developers to avoid identification.A virtualised packer is used. This type of obfuscation is used by those that have “strong motives to prevent Organisation: Gamma International GmbH Address: Baierbrunner Str. 15 Phone: +49-89-2420918-0 Fax: +49-89-2420918-1 Email: info@gamma-international.de Changed: 2011-04-04T11:24:20+02:0019July 2012Martin Muench is a representative of Gamma International, a company that sells “advanced technicalsurveillance and monitoring solutions”. One of the services they provide is FinFisher: IT Intrusion, includingthe FinSpy tool. This labelling indicates that the matching sample we were provided may be a demo copy aFinFisher product per the domain ff-demo.blogdns.org.We have linked a set of novel virtualised code obfuscation techniques in our Bahraini samples to anotherbinary that communicates with Gamma International IP addresses. Taken alongside the explicit use of thename “FinSpy” in debug strings found in infected processes, we suspect that the malware is the FinSpy remoteintrusion tool. This evidence appears to be consistent with the theory that the dissidents in Bahrain whoreceived these e-mails were targeted with the FinSpy tool, configured to exfiltrate their harvested informationto servers in Bahraini IP space. If this is not the case, we invite Gamma International to explain.RECOMMENDATIONSThe samples from email attachments have been shared with selected individuals within the securitycommunity, and we strongly urge antivirus companies and security researchers to continue where we have leftoff.Be wary of opening unsolicited attachments received via email, skype or any other communicationsmechanism. If you believe that you are being targeted it pays to be especially cautious when downloadingfiles over the Internet, even from links that are purportedly sent by friends.ACKNOWLEDGEMENTSMalware analysis by Morgan Marquis-Boire and Bill Marczak. Assistance from Seth Hardy and Harry Tuttlegratefully received.Special thanks to John Scott-Railton.Thanks to Marcia Hofmann and the Electronic Frontier Foundation (EFF).We would also like to acknowledge Privacy International for their continued work and graciously providedbackground information on Gamma International.20July 2012FOOTNOTES1 url 2 url#SpyFiles 3 url 4 This technique was used in the recent Madi malware attacks. 5 url 6 Unpacking Virtualised Obfuscators by Rolf Rolles -url 8 E.g. url 9 url to topMEDIA COVERAGEThe Wall Street JournalSlateCSOTech Week EuropeBloombergElectronic Frontier FoundationPrivacy InternationalSpiegel OnlinePC MagThe New York TimesAbout the AuthorMorgan Marquis-Boire is a Technical Advisor at the Citizen Lab, Munk School of Global Affairs, Universityof Toronto. He works as a Security Engineer at Google specializing in Incident Response, Forensics andMalware Analysis.21 