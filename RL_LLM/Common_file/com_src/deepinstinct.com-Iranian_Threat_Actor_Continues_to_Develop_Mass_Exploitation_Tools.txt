www.deepinstinct.com /blog/iranian-threat-actor-continues-to-develop-mass-exploitation-tools Iranian Threat Actor Continues to Develop Mass Exploitation Tools ⋮ 6/1/2022100% Prevention Score in the 2022 MITRE ATT&CK Evaluation for EnterpriseLearn moreJune 1, 2022 | Simon KeninDeep Instinct researchers have recently identified unusual – and dangerous – activity within the environment of one of our customers, an infrastructure and construction company in the Southern U.S. After close analysis, we found that an Iranian APT was attempting to compromise an Exchange server and that seven attempts were made in total, each of which was immediately prevented by Deep Instinct.Due to the discovery, Deep Instinct was able to find additional new malware variants and TTPs related to the threat actor. Notably, installation of a root certificate and an attempt to blend malicious traffic with legitimate traffic.A full analysis of the event follows. Discovery1/9Figure 1: Deep Instinct console showing the prevented eventWhile investigating the logs from the machine that triggered the alert for the malicious file, it was observed that the file was created by the Exchange Server:Figure 2: Log entry showing w3wp.exe process responsible for creating a fileAfter inspecting additional events from the same machine, a total of seven exploitation attempts were discovered, 2021-10- 30T13:21:50 C:\Windows\Temp\user.exe 2021-12- 2021-12- 05T14:44:34 C:\Windows\Temp\user.exe 2022-01- 01T11:51:48 C:\Windows\Temp\user.exe 12T08:47:36 C:\Windows\Temp\user.exe 2022-02- publicly reported and attributed to an Iranian threat actor Microsoft refers to as PHOSPHORUS. While most of the hashes which surfaced in our telemetry are identical to the ones published in an article from “The DFIR Report,” we have found additional hashes that overlap with other aliases of the same threat actor, so to avoid any further confusion we will refer to the threat actor simply as PHOSPHORUS. user.exeThe previously unknown sample that was found in our telemetry has been described by “The DFIR Report.”Its sole purpose is to create a new user account on the compromised system with the credentials DefaultAccount P@ssw0rd1234.2/9It is then added to the local administrator’s group, allowed RDP access to this account, and the password is set to never expire.This action allows the attacker to connect to the compromised system at a later time.While searching in VirusTotal for files with similar behavior, we were able to identify another previously unknown controlled server, followed by a creation of a scheduled task to run the downloaded FRPC.FRPC stands for Fast Reverse Proxy Client; the downloaded FRPC is configured to connect to yet another attacker- controlled server, creating a tunnel between the attacker and the compromised system.The attacker executes “user.exe” before “task_update.exe,” the created tunnel. This allows the attacker to log in to the compromised system via RDP, even if the RDP is not exposed directly to the internet.Based on the above behavior, we were able to find a new variant of task_update.exe with the hash addstore -f root %wintmp%\cert.cer.”The behavior of installing a root certificate using “certutil” is not present in previous iterations of “task_update” and it and it is impersonating Microsoft:Figure 4: Details of the certificate added by the threat actor3/9This variant has been observed downloading FRPC from a previously undocumented attacker-controlled server 172.245.26[.]118. FRPC EvolutionThe hash of the new FRPC variant that was observed downloaded by the new task_update.exe is installed certificate, the certificate chain of the FRPC is slightly different but not valid:Figure 6: Certificate chain after the installation of the root certificateWe can see the root certificate has been changed, yet the intermediate certificate is still invalid.While observing the traffic created by this variant, Deep Instinct researchers identified a previously undocumented evasion technique used by the threat actor.4/9Hiding Malicious Domains in Plain SightThe binary generates many connections to domains and subdomains of legitimate companies along with connection to visually similar subdomains that are attacker controlled.This specific variant connects to the following domains:kcp53.msupdate.usLegitimate domain Attacker-controlled domain kcp53.bing.com kcp53.symantec.com kcp53.tcp443.org sophos.com tcp443.bing.com tcp443.kaspersky.com tcp443.symantec.com tcp443.virustotal.comtcp443.msupdate.us tcp443.tcp443.orgThis surge of network activity is used to confuse analysts by blending the malicious domains with similar-looking legitimate domains, which may lead the analyst to classify all the above as legitimate traffic.While analyzing a plethora of previously undocumented FRPC variants used by the threat actor we have concluded that this change was made in early 2022. Prior to this change, FRPC variants only had one attacker-controlled domain configured.Some of the new FRPC variants contained additional malicious and legitimate subdomains which are listed in the appendix.In addition to the windows FRPC variants, ELF variants were identified that were also used with log4j exploitation. was previously mentioned in a CISA alert AA21-321A describing Iranian APT activity. The file is used to create a SSH tunnel to the attacker’s machine while exposing RDP port, and was also hosted on another attacker-controlled server, activate-time-microsoft[.]cf.The first unknown executable (“ad” file), referred to in the code as “AudioManagement,” is installed as service named “Windows Backup Management.”5/9Figure 8: Code snippet responsible for creating SSH tunnel and adding the “AudioManagement” payload as a system serviceConnecting the dotsWhile Microsoft tracked ransomware activity by PHOSPHORUS as early as May 2021, further research reveals 2021 only connects to the subdomain tcp443.newdesk[.]top which resolved in the past to the IP 148.251.71[.]182.The IP 148.251.71[.]182 was also used to resolve to the domain tcp443.symantecserver[.]co.This domain is mentioned in another article by “The DFIR Report” regarding Exchange exploitation, both the IP and the domain are related to Plink, however, the hash of the file was not published.The same article mentioned the usage of FRPC with a standalone config file, the hash of the file is the attackerFurthermore, the configuration file contains the attacker-controlled domain newdesk[.]top as well as the IP 94.182.164[.]92 which is located in Iran.The domain newdesk[.]top used to resolve in 2020 to the IP 89.32.248[.]47 is also located in Iran.This same Iranian IP was also resolved to yet another PHOSPHORUS subdomain update.symantecserver[.]co in 2021.In 2022, the subdomain update.symantecserver[.]co started resolving to another IP address located in Iran - 79.175.165[.]150.Figure 11: Maltego Graph Illustrating ConnectionsConclusionIn this article we described threat actor activity related to PHOSPHORUS, an Iranian APT actor active from at least 2020.The threat actor is known to exploit Fortinet CVE-2018-13379, Exchange ProxyShell, and the log4j vulnerabilities.Our analysis indicated that PHOSPHORUS continues in its automated scanning and exploitation process in order to widely gain access to multiple vulnerable organizations.Furthermore, we found that the actor is continuously changing its payload and infrastructure and discovered a new evasion technique used by PHOSPHORUS to conceal their malicious traffic and mislead security teams.Thanks to Deep Instinct’s prevention capabilities the threat actor was unsuccessful in executing the payloads in a customer environment despite successful exploitation of the Exchange server.7/9If you’d like to see the platform in action for yourself, we’d be honored to show you what true prevention looks like. 172.245.26[.]118/update.log connecting to multiple domains Signed FRPC from 172.245.26[.]118/update.log connecting to multiple domains FRPC from 172.245.26[.]118/update.log FRPC from 148.251.71[.]182/update_win connecting to multiple domains FRPC from 148.251.71[.]182/update_win connecting to a single domain FRPC from 148.251.71[.]182/update_win connecting to a single domain FRPC from 148.251.71[.]182/update.tmp connecting to a single domain FRPC from 148.251.71[.]182/symantec.tmp connecting to a single domain FRPC from 198.144.189[.]74/logo.png connecting to a single domain FRPC from 198.144.189[.]74/logo.png connecting to a single domain FRPC from 198.144.189[.]74/logo.png connecting to a single domain activate-time-microsoft[.]cf onedriver-srv[.]ml 172.245.26[.]118 198.144.189[.]74 148.251.71[.]182 94.182.164[.]92 107.173.231[.]114 IOAkcp53.bing.com kcp53.ubuntu.com kcp53.kaspersky.com kcp53.symantec.com kcp53.eset.com tcp443.bing.com tcp443.ubuntu.com tcp443.kaspersky.com tcp443.symantec.com tcp443.virustotal.com© 2022 Deep Instinct. All rights reserved.9/9 