Lazarus Group APT targeting South Korean userszscaler.com/blogs/security-research/naver-ending-game-lazarus-aptZscaler’s ThreatLabz research team has been closely monitoring a campaign targeting users in South Korea. This threat actor has been active for more than a year and continues to evolve its tactics, techniques, and procedures (TTPs); we believe with high confidence that the threat actor is associated with Lazarus Group, a sophisticated North Korean advanced persistent threat (APT) group.In 2021, the main attack vector used by this threat actor was credential phishing attacks through emails, posing as Naver, the popular South Korean search engine and web portal.In 2022, the same threat actor started spoofing various important entities in South Korea, including KRNIC (Korea Internet Information Center), Korean security vendors such as Ahnlab, cryptocurrency exchanges such as Binance, and others. Some details about this campaign were published in this Korean blog, however they did not perform the threat attribution.Even though the TTPs of this threat actor evolved over time, there were critical parts of their infrastructure that were reused, allowing ThreatLabz to correlate the attacks and do the threat attribution with a high-confidence level. Our research led us to the discovery of command-and-control (C2) domains even before they were used in active attacks by the threat actor. This proactive discovery of attacker infrastructure helps us in preempting the attacks.In this blog, we will share the technical details of the attack chains, and will explain how we correlated this threat actor to Lazarus.We would like to thank Dropbox for their quick action in taking down the malicious accounts used by the threat actor, and for also sharing valuable threat intelligence that helped us with threat attribution.1/14Attack chains This threat actor has frequently updated its attack chains over the last two months. We identified three unique attack chains used by the threat actor to distribute the malware in emails:Figure 1: Attack flowSpear phishing emails distribution During our analysis, we discovered that at least one of the IP addresses (222.112.127[.]9) used by the threat actor to log in to the attacker-controlled Dropbox accounts was also used to send spear phishing emails to the victims in South Korea.Below are examples of two such emails that were sent from the IP address 222.112.127[.]9.Note: This IP address is related to KT Corporation, a Korean telecom provider. Multiple IP addresses related to KT Corporation were abused by this threat actor during the current attack.Email #1In this email, a macro-based document was sent to the victim.Figure 2: Email sent to the victim2/14Figure 3 below shows that the decoy content of the document is related to Menlo Security company. This is consistent with other decoy contents used by the threat actor. the decoy content used was related to Ahnlab - a Korea-based computer security company. This is done for the purpose of social engineering.Figure 3: Decoy contentEmail #2In this email, a password protected macro-based XLS file was sent to the victim. The password for the file was mentioned in the email body.The theme of the file is related to cryptocurrency investments. This theme is consistent with other documents sent in this campaign as well. Lazarus Group is known to have a keen interest in attacking cryptocurrency users, asset managers, and companies.3/14Figure 4: Email sent to the victimFigure 5 below shows the sender's IP address in the email headers as indicated by the X-Originating-IP field.Figure 5: Email header showing originating IP, Sender and RecipientThreat attribution In order to perform the threat actor attribution, we did a correlation of the below data points.1. C2 IP addresses2. Attacker-controlled Dropbox accounts’ registrant email addresses3. C2 domains’ registrant email addresses4. Passive DNS data5. Sender's email address in credential phishing attacks6. Sender's IP address in credential phishing attacksNote: OSINT information related to the above data points was also used in correlation analysis.# Correlating different attacks to same threat actor As described in the network communication section later in the blog, the Stage-3 binary initially connects to an attacker-controlled Dropbox account to fetch a C2 domain which is used to perform further network communication.4/14In collaboration with Dropbox, we were able to discover the email addresses associated with the attacker-controlled Dropbox accounts used during this attack. One such email addresses was: [email protected][.]comThis same email address was recently mentioned in Prevailion's blog. It was linked to several domains which were used during Naver-themed phishing activity.Also, according to this blog from 2021, this same email address was also used to send Naver-themed credential phishing attack emails to users in South Korea.Correlating the above data points, we can say with a high confidence level that the attack chains we have described in this blog are also related to the same threat actor.# Attribution to Lazarus APTAccording to the threat infrastructure mapping done in Prevailion blog, the IP address 23.81.246[.]131 belongs to one of the critical nodes used by the threat actor during Naver-themed phishing activity. One of the domains linked to this IP address was navercorpservice[.]com. If we check the passive DNS data for this domain, we find two other IP address resolutions: 172.93.201[.]253 in November 2021 and 45.147.231[.]213 in September 2021.The IP address 172.93.201[.]253 was recently used to host the domain - disneycareers[.]net which was attributed to Lazarus APT in Google TAG blog.Further, what caught our attention was the IP address 45.147.231[.]213. This IP address was earlier used by North Korea-based APT threat actor. Recently, we also had a new domain resolution alert for this IP address as part of our C2 infrastructure tracking. If we pivot on the passive DNS data for this IP address, we can see that the domain: www.devguardmap[.]org was hosted on this IP address in Jan 2021 which was attributed to Lazarus APT as per this tweet from ESET and Google TAG blog.Correlating all the above data points, we reached the conclusion that the attack-chains we discovered are related to Lazarus threat actor. To the best of our knowledge, at the time of writing, this threat actor attribution has not been publicly documented yet.Technical analysis For the purpose of technical analysis we will consider the attack chain starting with a dropped on the filesystem in the path: C:\\programdata\\chmtemp\\chmext.exe and executed.5/14The code responsible for extracting, dropping and executing the binary is present inside 1hh.html as shown below.Figure 6: HTML code dropping and executing the binary[+] Stage 2: DropperThe dropper on execution performs the following operations:1. Detects sleep patching to identify controlled execution environment such as Sandbox execution2. Checks the name of all the running processes and terminates if it finds a process running with the name "v3l4sp.exe". This process name corresponds to the security software developed by Ahnlab (a popular and frequently used security vendor in South Korea).3. Creates file in the path "C:\ProgramData\Intel\IntelRST.exe"4. XOR decodes the embedded PE from a hardcoded address5. Writes the decoded PE to the file created in Step-36. Modifies PEB to masquerade itself as explorer.exe7. Executes IntelRST.exe8. Creates RUN registry entry for persistenceValue: IntelCUIData: C:\ProgramData\Intel\IntelRST.exe[+] Stage 3: Dropped binary6/14The file IntelRST.exe dropped by the Stage-2 dropper is an ASpacked binary. On execution it performs the following operations:1. Similar to the dropper binary it tries to detect sleep patching to identify controlled execution environment2. Collects machine information and stores using the specified format which is later exfiltrated and used as machine identifier.String format:[decoded_string]_[username]_[volume_serial_number_post_8_bytes]decoded_string: (encoded string) ^ (key) [encoded_string_byte_offset%keySize]username: GetUserName()volume_serial _number: Using DeviceIoControl with IOCTL_STORAGE_QUERY_PROPERTY (0x2d1400)3. Checks name of all the running processes and terminates if there is some process running with the name "v3l4sp.exe" or "AYAgent.aye" or "IntelRST.exe"4. If running with administrator privileges then it executes a PowerShell command using cmd.exe to add WindowsDefender exclusion.PowerShell command: Powershell -Command Add-MpPreference -ExclusionPath "C:\ProgramData\Intel\IntelRST.exe5. Finally it starts the network communication[+] Network communication The network communication occurs in the following sequence:1. Send a GET request to the URL "url".2. Query the file size and send another network request to read the file content.Note: The file content points to the C2 domain to be used for rest of the network communication.3. Using the extracted C2 domain, send a POST request to the path "/post.php" and exfiltrate collected user information.Exfiltrated user information format:uid={string_generated_in_Step-2_of_Stage- 3_binary}&avtype=%d&majorv=%d&minorv=%d7/144. Finally send a GET request to the path "/{decoded_string_from_step-2_of_Stage- 3_binary}/{formated_string_from_step-2_of_Stage-3_binary}/fecommand.acm"Note: At the time of analysis we didn't get any active response from the C2 server for the above network request.Zscaler Cloud Sandbox detection # Document detection# Dropper detection8/14Indicators of compromise (50).chmGuide to confirmed cases and living with them (50).chm메타콩즈가이드_1900002.chmMeta Kong's Guide_190002.chmNFT Metakongz Minting.chmNFT Metakongz Minting.chm202204_Cryptocurrency_Investment Planning.docxincident report.docxMasanhappo-gu 40 billion loan request.docx4 billion_fund investment contract.docxEmergency Disaster Subsidy Application Form.docxDaehan Mine Development Co., Ltd. docxcryptos_login.docx202204_암호화폐_투자기 획.docx사건 경위서.docx마산합포구 400억 대출요 청.docx40억_자금투자계약서.docx긴급재난지원금신청서양 식.docx대한광산개발(주).docx크립토스_로그인.docx[+] C2 domainsnaveicoipg[.]online naveicoiph[.]tech12/14naveicoip[.]tech parfumeparlour[.]store# New domain resolutions for the IP 23.81.246[.]131navernidb[.]link noreplya[.]xyz[+] Emails# Dropbox accounts associated email addresses[email protected][.]com [email protected][.]com [email protected][.]com[+] PDB pathD:\Works\PC_2022\ACKS_2012\fengine\Release\fengine.pdbAbout us13/14Zscaler ThreatLabz is a global threat research team with a mission to protect customers from advanced cyberthreats. Made up of more than 100 security experts with decades of experience in tracking threat actors, malware reverse engineering, behavior analytics, and data science, the team operates 24/7 to identify and prevent emerging threats using insights from 300 trillion daily signals from the Zscaler Zero Trust Exchange.Since its inception, ThreatLabz has been tracking the evolution of emerging threat vectors, campaigns, and groups, contributing critical findings and insights on zero-day vulnerabilities, —including active IOCs and TTPs for threat actors, malware, and ransomware families, phishing campaigns, and more.ThreatLabz supports industry information sharing and plays an integral role in the development of world-class security solutions at Zscaler. See the latest ThreatLabz threat research on the Zscaler blog.14/14 