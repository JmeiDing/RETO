ZLABMalware Analysis ReportA long-term espionage campaign in Syria.23/07/2018CSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.comTable of Contents The Open Repository and the Fake Promotional Site 2The malicious apk files 6A suspicious windows executable hidden inside the apk 11The Command and Control Infrastructure 14Yara rules 22The Open Repository and the Fake Promotional SiteCSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.comA few days ago, the security researcher Lukas Stefanko from Eset discovered an open repository containing some Android applications.Figure 1 - Lukas Stefanko's Twitter about the open reporitory.The folder was found on a compromised website at the following URL:hxxp://chatsecurelite.uk[.]to.This website is written in Arabic language and translating its content it seems to offer a secure messaging app. The homepage shows how the application works and includes some slides about it.CSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.comFigure 2 - Screens of the fake security websiteThe content on the website says that most common messaging applications are vulnerable and attackers can compromise them to spy on the users. The author claims to have developed an app called “ChatSecure” to mitigate security vulnerabilities that have been reported in popular messaging apps, including WhatsApp and Telegram.ChatSecure is the name of a legitimate free and open source iOS messaging app that features OMEMO encryption and OTR encryption over XMPP.The content of the bogus website explains that also Office applications are vulnerable to cyber attacks and offers patches to address the vulnerabilities exploited by the hackers.CSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.comFigure 3 - ChatSecure legitimate iOS app.Threat actors exploited the interest in the ChatSecure, currently available only for Apple iOS device, to trick Android users into believe that the Android version of the app is not available.The Android app poses itself as fake update for the legit app.CSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.comFigure 4 - Example of installationThe malicious apk files In this paragraph, we’ll report the gathered samples that were stored in the open repository.سيفوأ.apk” ("UpdateOfficeforMobile.apk")ثيدحت“AndroidOfficeUpdate2018.apk” Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com used icons of the application and the variable package name in which is written the code.CSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.comThe malware shows a classical RAT behavior, it includes a series of hard- coded commands that the C2 can send to the bot. The list of accepted commands, with the relative opcodes is the following:Figure 5 - Command listAfter installation and according to the list of commands, the first opcode captured during the analysis is “Connect to Server”, associated with the 17 opcode, in order to register the new bot on the Command and Control (Figure 6). As we can see in the Figure, the new bot sends to the Command and Control other information about the compromised device, such as:• Which apk starts the infection • Android version of the device • Wifi or mobile internet network • Installation of the bot date • Root permissions enabled checkCSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.comFigure 6 - Registration of the infected device on the C2CSubsequently, the malware starts to ping periodically the C2C using the opcode 30.CSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.comFigure 7 - Ping commandThe hardcoded port used in the malware is 1740, but during the analysis, it was changed by the command and control in 11950 with another opcode provided in the list, the opcode 39. This command is able to change the IP and the port of the Command and Control. In our case:Figure 8 - The Opcode 39CSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.comA suspicious windows executable hidden inside the apkInspecting the Apk file, we found an anomalous file in the path “/res/raw” called “hmzvbs”. Conducting a deep analysis of the suspicious file, we have noticed that this is an executable windows file written in C# .NET language, as reported in following figure:Figure 9 - hmzvbs executable windows file descriptionThe reason why this executable file is hidden inside of the apk is still unknown, we have found no track of any exploit code that could be used by the malware to perform lateral movements to deliver the executable to a Windows machine.“hmzvbs.exe” Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.comThis file is a dropper file for an embedded DLL, that is encrypted with a custom routine and that it is decoded at runtime. So, inserting a breakpoint after the routine it was simple to retrieve the real payload of the malware.Figure 10 - Piece of the encrypted real payload embedded in hmzvbs fileDLL file “\%APPDATA%\Local\Temp” with “cebto_task_64.exe” and executes this new file.the nameFigure 11 - real payload created by hmzvbs fileThe behavior of the DLL payload contained in “cebto_task_64.exe” file is similar to the Android malware, but in this case, the communication is basedCSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.comon the port 5005 instead of 1740, how visible in the following figure:Figure 12 - started communication on 5005 portAt this moment, the computer victim is a bot and it can communicate with C2C throw a series of hardcoded commands, that are very similar to the list previously showed for Android malware.In particular, the list of commands is here reported”:CSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.comFigure 13 - Accepted command by the botTo ensure persistence after rebooting the system, “cebto_task_64.exe” file execute a scheduling command as follow:Figure 14 - Persistence mechanism of the malwareThe Command and Control InfrastructureAn unusual characteristic of this malware attacks is the use of the Command and Control server. The C2 it is located in the same area under attack while usually threat actors hide and locate their servers in places different to those attacked, in order to make hard the investigations.Another characteristic of the malware is that the C2 has an impressive number of open, the complete list is reported in the following table:open open ubxd4093/tcp sysrqdopencaicci4035/tcpopen wap-push-http4095/tcpopenxtguiopenencore4036/tcpopen wap-push-https4096/tcpopenbreopencisco-net-mgmt 4037/tcpopenravehd4097/tcpopenpatrolviewopen3Com-nsd4038/tcpopenfazzt-ptp4098/tcpopendrmsfsdopencinegrfx-lm4039/tcpopenfazzt-admin4099/tcpopendpcpopenncpm-ft4040/tcpopenyo-main4100/tcpopenigo-incognitoopenopenremote- winsock ftrapid-14041/tcpopen houston4101/tcpopenbrlp-04042/tcpopenldxp4102/tcpopenbrlp-1openftrapid-24043/tcpopen nirp4103/tcpopenbrlp-2openoracle-em14044/tcpopenltp4104/tcpopenbrlp-3openaspen-services4045/tcpopenlockd4105/tcpopenshofarplayerCSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.com82/tcp popensslp4046/tcpopen acp-proto4106/tcpopensynchroniteopenea14047/tcpopenctp-state4107/tcpopenj-acopenibm-dt-24048/tcpopen unknown4108/tcpopenaccelopenrsc-robot4049/tcpopen wafs4109/tcpopenizmopencera-bcm4050/tcpopencisco-wafs4110/tcpopeng2tagopendpi-proxy4051/tcpopencppdp4111/tcpopenxgridopenuma4052/tcpopeninteract4112/tcpopenapple-vpns-rpopenetp4053/tcpopenccu-comm-14113/tcpopenaipn-regopennetrisk4054/tcpopenccu-comm-24114/tcpopenjomamqmonitoropenansys-lm4055/tcpopenccu-comm-34115/tcpopencdsopenmsmq4056/tcpopenlms4116/tcpopensmartcard-tlsopenconcomp14057/tcpopen wfm4117/tcpopenhillrservopenhp-hcip-gwy4058/tcpopenkingfisher4118/tcpopennetscriptopenenl4059/tcpopen dlms-cosem4119/tcpopenassuria-slmopenopenremoteanythin g newoak4060/tcpopen dsmeter_iatc4120/tcpopen minirem4061/tcpopenice-location4121/tcpopene-builderopenmlchat-proxy4062/tcpopenice-slocation4122/tcpopenfpramsopenpxc-splr-ft4063/tcpopenice-router4123/tcpopenz-waveopenpxc-roid4064/tcpopenice-srouter4124/tcpopentigv2openpxc-pin4065/tcpopen avanti_cdp4125/tcpopenrwwopenpxc-spvr4066/tcpopen pmas4126/tcpopenddreplopenpxc-splr4067/tcpopenidp4127/tcpopenunikeyproopennetcheque4068/tcpopenipfltbcst4128/tcpopennufwopenchimera-hwm4069/tcpopen minger4129/tcpopennuauthopenopensamsung- unidex altserviceboot4070/tcpopentripe4130/tcpopenfronet4071/tcpopen aibkup4131/tcpopenstarsCSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.com1750/tc popenpda-gate4072/tcpopenzieto-sock4132/tcpopennuts_demopenacl-manager4073/tcpopeniRAPP4133/tcpopennuts_bootpopentaiclock4074/tcpopencequint-cityid4134/tcpopennifty-hmiopentalarian-mcast1 4075/tcpopen perimlan4135/tcpopencl-db-attachopentalarian-mcast2 4076/tcpopenseraph4136/tcpopencl-db-requestopentalarian-mcast3 4077/tcpopen ascomalarm4137/tcpopencl-db-remoteopentalarian-mcast4 4078/tcpopencssp4138/tcpopennettestopentalarian-mcast5 4079/tcpopensantools4139/tcpopenthrtxopentrap4080/tcpopenlorica-in4140/tcpopencedros_fdsopennexus-portal4081/tcpopenlorica-in-sec4141/tcpopenoirtgsvcopendnox4082/tcpopenlorica-out4142/tcpopenoidocsvcopenesnm-zoning4083/tcpopenlorica-out-sec4143/tcpopenoidsropentnp1-port4084/tcpopenfortisphere-vm4144/tcpopen wincimopenpartimage4085/tcpopen ezmessagesrv4145/tcpopenvvr-controlopenas-debug4086/tcpopenftsync4146/tcpopentgcconnectopenbxp4087/tcpopen applusservice4147/tcpopenvrxpservmanopendtserver-port4088/tcpopen npsp4148/tcpopenhhb-handheldopenip-qsig4089/tcpopen opencore4149/tcpopenagslbopenjdmn-port4090/tcpopen omasgport4150/tcpopenPowerAlert-nsaopensuucp4091/tcpopen ewinstaller4151/tcpopen menandmice_noopenvrts-auth-port4092/tcpopen ewdgs4152/tcpopenh idig_muxopenmbl-battd4213/tcpopenvrml-multi-use4273/tcpopenvrml-multi-useopenatlinks4214/tcpopenvrml-multi-use4274/tcpopenvrml-multi-useopenbzr4215/tcpopenvrml-multi-use4275/tcpopenvrml-multi-useopenstat-results4216/tcpopenvrml-multi-use4276/tcpopenvrml-multi-useopenstat-scanner4217/tcpopenvrml-multi-use4277/tcpopenvrml-multi-useCSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.com4012/tc popenstat-cc4218/tcpopenvrml-multi-use4278/tcpopenvrml-multi-useopennss4219/tcpopenvrml-multi-use4279/tcpopenvrml-multi-useopenjini-discovery4220/tcpopenvrml-multi-use4280/tcpopenvrml-multi-useopenomscontact4221/tcpopenvrml-multi-use4281/tcpopenvrml-multi-useopenomstopology4222/tcpopenvrml-multi-use4282/tcpopenvrml-multi-useopensilverpeakpeer4223/tcpopenvrml-multi-use4283/tcpopenvrml-multi-useopenopensilverpeakcom m altcp4224/tcpopenxtell4284/tcpopenvrml-multi-use4225/tcpopenvrml-multi-use4285/tcpopenvrml-multi-useopenjoost4226/tcpopenvrml-multi-use4286/tcpopenvrml-multi-useopenddgn4227/tcpopenvrml-multi-use4287/tcpopenvrml-multi-useopenpslicser4228/tcpopenvrml-multi-use4288/tcpopenvrml-multi-useopeniadt4229/tcpopenvrml-multi-use4289/tcpopenvrml-multi-useopend-cinema-csp4230/tcpopenvrml-multi-use4290/tcpopenvrml-multi-useopenml-svnet4231/tcpopenvrml-multi-use4291/tcpopenvrml-multi-useopenpcoip4232/tcpopenvrml-multi-use4292/tcpopenvrml-multi-useopenmma-discovery4233/tcpopenvrml-multi-use4293/tcpopenvrml-multi-useopensmcluster4234/tcpopenvrml-multi-use4294/tcpopenvrml-multi-useopenbccp4235/tcpopenvrml-multi-use4295/tcpopenvrml-multi-useopentl-ipcproxy4236/tcpopenvrml-multi-use4296/tcpopenvrml-multi-useopenwello4237/tcpopenvrml-multi-use4297/tcpopenvrml-multi-useopenstorman4238/tcpopenvrml-multi-use4298/tcpopenvrml-multi-useopen MaxumSP4239/tcpopenvrml-multi-use4299/tcpopenvrml-multi-useopenhttpx4240/tcpopenvrml-multi-use4300/tcpopencorelccamopenmacbak4241/tcpopenvrml-multi-use4301/tcpopend-dataopenpcptcpservice4242/tcpopenvrml-multi-use4302/tcpopend-data-controlopengmmp4243/tcpopenvrml-multi-use4303/tcpopensrcpCSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.com4158/tc popenuniverse_suite4244/tcpopenvrml-multi-use4304/tcpopenowserveropenwcpp4245/tcpopenvrml-multi-use4305/tcpopenbatmanopenopenboxbackupstor e csc_proxy4246/tcpopenvrml-multi-use4306/tcpopenpinghgl4247/tcpopenvrml-multi-use4307/tcpopenvisicron-vsopenvatata4248/tcpopenvrml-multi-use4308/tcpopencompx-lockviewopenpcep4249/tcpopenvrml-multi-use4309/tcpopendserveropensieve4250/tcpopenvrml-multi-use4310/tcpopen mirrtexopendsmipv64251/tcpopenvrml-multi-use4311/tcpopenp6ssmcopenazeti4252/tcpopenvrml-multi-use4312/tcpopenpscl-mgtopenpvxplusio4253/tcpopenvrml-multi-use4313/tcpopenperrlaopenunknown4254/tcpopenvrml-multi-use4314/tcpopenchoiceview-agtopenunknown4255/tcpopenvrml-multi-use4315/tcpopenunknownopenunknown4256/tcpopenvrml-multi-use4316/tcpopenchoiceview-cltopenhctl4257/tcpopenvrml-multi-use4317/tcpopenunknownopenunknown4258/tcpopenvrml-multi-use4318/tcpopenunknownopeneims-admin4259/tcpopenvrml-multi-use4319/tcpopenunknownopenvrml-multi-use4260/tcpopenvrml-multi-use4320/tcpopenfdt-rcatpopenvrml-multi-use4261/tcpopenvrml-multi-use4321/tcpopenrwhoisopenvrml-multi-use4262/tcpopenvrml-multi-use4322/tcpopentrim-eventopenvrml-multi-use4263/tcpopenvrml-multi-use4323/tcpopentrim-iceopenvrml-multi-use4264/tcpopenvrml-multi-use4324/tcpopenbalouropenvrml-multi-use4265/tcpopenvrml-multi-use4325/tcpopengeognosismanopenvrml-multi-use4266/tcpopenvrml-multi-use4326/tcpopengeognosisopenvrml-multi-use4267/tcpopenvrml-multi-use4327/tcpopenjaxer-webopenvrml-multi-use4268/tcpopenvrml-multi-use4328/tcpopenjaxer-manageropenvrml-multi-use4269/tcpopenvrml-multi-use4329/tcpopenpubliqare-syncCSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.com4184/tc popenvrml-multi-use4270/tcpopenvrml-multi-use4330/tcpopendey-sapiopenvrml-multi-use4271/tcpopenvrml-multi-use4331/tcpopenktickets-restopenvrml-multi-use4272/tcpopenvrml-multi-use4332/tcpopenunknownopenmsql4393/tcpopen apwi-rxspooler4453/tcpopennssalertmgropennetconf-ch-ssh4394/tcpopen apwi-disc4454/tcpopennssagentmgropennetconf-ch-tls4395/tcpopen omnivisionesx4455/tcpopenprchat-useropenrestconf-ch-tls4396/tcpopenfly4456/tcpopenprchat-serveropenunknown4397/tcpopen unknown4457/tcpopenprRegisteropenunknown4398/tcpopen unknown4458/tcpopen mcpopenunknown4399/tcpopen unknown4459/tcpopenunknownopengaia4400/tcpopen ds-srv4460/tcpopenunknownopenlisp-data4401/tcpopen ds-srvr4461/tcpopenunknownopenlisp-cons4402/tcpopen ds-clnt4462/tcpopenunknownopenunicall4403/tcpopen ds-user4463/tcpopenunknownopenvinainstall4404/tcpopen ds-admin4464/tcpopenunknownopenm4-network-as4405/tcpopen ds-mail4465/tcpopenunknownopenelanlm4406/tcpopen ds-slp4466/tcpopenunknownopenlansurveyor4407/tcpopen nacagent4467/tcpopenunknownopenitose4408/tcpopenslscc4468/tcpopenunknownopenfsportmap4409/tcpopen netcabinet-com4469/tcpopenunknownopennet-device4410/tcpopenitwo-server4470/tcpopenunknownopenplcy-net-svcs4411/tcpopenfound4471/tcpopenunknownopenpjlink4412/tcpopensmallchat4472/tcpopenunknownopenf5-iquery4413/tcpopen avi-nms4473/tcpopenunknownopenqsnet-trans4414/tcpopen updog4474/tcpopenunknownopenqsnet-workst4415/tcpopen brcd-vr-req4475/tcpopenunknownCSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.com4210/tc popenqsnet-assist4416/tcpopen pjj-player4476/tcpopenunknownopenqsnet-cond4417/tcpopen workflowdir4477/tcpopenunknownopenqsnet-nucl4418/tcpopen axysbridge4478/tcpopenunknownopenomabcastltkm4419/tcpopencbp4479/tcpopenunknownopenmatrix_vnet4420/tcpopen nvm-express4480/tcpopenproxy-plusopennacnl4421/tcpopenscaleft4481/tcpopenunknownopenafore-vdp-disc4422/tcpopentsepisp4482/tcpopenunknownopenunknown4423/tcpopenthingkit4483/tcpopenunknownopenunknown4424/tcpopen unknown4484/tcpopenhpssmgmtopenunknown4425/tcpopen netrockey64485/tcpopenassyst-dropenshadowstream4426/tcpopen beacon-port-24486/tcpopenicmsopenunknown4427/tcpopen drizzle4487/tcpopenprex-tcpopenwxbrief4428/tcpopen omviserver4488/tcpopenawacs-iceopenepmd4429/tcpopen omviagent4489/tcpopenunknownopenelpro_tunnel4430/tcpopenrsqlserver4490/tcpopenunknownopenl2c-control4431/tcpopen wspipe4491/tcpopenunknownopenl2c-data4432/tcpopenl-acoustics4492/tcpopenunknownopenremctl4433/tcpopenvop4493/tcpopenunknownopenpsi-ptt4434/tcpopen unknown4494/tcpopenunknownopentolteces4435/tcpopen unknown4495/tcpopenunknownopenbip4436/tcpopen unknown4496/tcpopenunknownopencp-spxsvr4437/tcpopen unknown4497/tcpopenunknownopencp-spxdpy4438/tcpopen unknown4498/tcpopenunknownopenctdb4439/tcpopen unknown4499/tcpopenunknownopenunknown4440/tcpopen unknown4500/tcpopensae-urnopenunknown4441/tcpopen netblox8291/tcpopenunknownCSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.com4356/tc popenunknown4442/tcpopensarisopenunknown4443/tcpopen pharosopenunknown4444/tcpopenkrb524openunknown4445/tcpopen upnotifypopenunknown4446/tcpopen n1-fwpopenunknown4447/tcpopen n1-rmgmtopenunknown4448/tcpopen asc-slmdopenxandros-cms4449/tcpopenopenwiegand4450/tcpopenopenapwi-imserver4451/tcpopenopenapwi-rxserver4452/tcpopen17000/tc popenunknownopenunknownopenunknownopenunknownopenunknownopencommtact-httpsopenunknown4382/tc pThe high number of opened ports suggests us two possible scenarios:• Attackers are enlarging the surface of attack to make hard into the malwarereal ports usedfordiscovering which are communication.the• The server works also as a honeypot.CSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.comdescription = "Yara Rule for APT-C-27 Android malware" author = "CSE CybSec Enterprise - Z-Lab" last_updated = "2018-07-20" tlp = "white" category = "informational"strings:$a = "hmzvbs" $b = { ?8 ?D ?A }condition:all of themYara rulesmeta:import "pe" condition:CSE CyberSec Enterprise SPA Via G.B. Martini 6, Rome, Italy 00100, Italia Email: info@csecybsec.com Website: www.csecybsec.comdescription = "Yara Rule for APT-C-27 Windows malware" author = "CSE CybSec Enterprise - Z-Lab" last_updated = "2018-07-20" tlp = "white" category = "informational"pe.version_info["InternalName"] contains "WiNANd5ro16XP" and pe.imports("mscoree.dll")description = "Yara Rule for APT-C-27 Embedded DLL" author = "CSE CybSec Enterprise - Z-Lab" last_updated = "2018-07-20" tlp = "white" category = "informational"pe.version_info["InternalName"] contains "Win64AndoX" and pe.imports("mscoree.dll") 