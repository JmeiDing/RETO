IN THE TRAILS OF WINDSHIFT APTTaha K.– Head of Malware Research Labs, Dark Matter LLCCONTENTSPART I: APT MYTHS & DEFINITIONSPART II: WHY AND HOW WINDSHIFT IS DIFFERENT?PART III: WINDSHIFT APT – MODUS OPERANDI (MO)PART IV: WINDSHIFT APT TOOLSET: MAC OS, WINDOWS MALWARE.PART V: ATTRIBUTION, WHO’S BEHIND WINDSHIFT APT?PART VI: CONCLUSIONSLITTLE BIT ABOUT ME• Malware RE for the last decade • Areas of interests:• Tracking APT’s and reversing their tools and MO’s. • Cyber crime investigations involving credit card fraud and bank cyber heists.• My background: I worked at FireEye Labs, and Symantec as Senior Malware reverseengineer.• Currently I work for Dark Matter LLC, as Head of malware research labs • MSCS and MBA from l’Ecole pour l’informatique et les techniques avancees, Paris - FranceIAPT MYTHS AND DEFINITIONSPART I: APT MYTHS AND DEFINITIONS• Does APT always means Advanced?• Case scenario: A target using unpatched Windows XP with no AV.– A very advanced toolset would be an overkill and comes with an unnecessary toolsetexposure, whilst a simple toolset will get the job done most of the times.– Modern APT’s, Re-use of available tools, think copy-cat, evading attribution. – Simplicity always wins over complexity. Especially when time frames are shortsand/or budgets are limited.PART I: APT MYTHS AND DEFINITIONS• How to measure an advanced APT?EvasionExfiltrationCounter measuresStealthOPSECEffectivenessIntelSuccessRateReachNoiseDetectionPredictabilityUniquenessAdaptabilityPersistencePART I: APT MYTHS AND DEFINITIONS• Public and most known “Middle-East” APT’s, based on public feeds:• GREENBUG • … • Up-to-date Middle-East APT OSINT data can be found here:• url I: APT MYTHS AND DEFINITIONS • Most of them rely on open-source tools:• Empire, Metasploit, Mimikatz, invoke-obfuscation, PsExec… • Minor some customization: strings replacements, code refractoring, • Sometimes relying and re-using low commodity malware:• RATs: NANOCORE, NETWIRE, njRAT, • OR build copy-pasta Android malware, • Usually copy-cat actors, unless some of them developed custom basic hack tools:• POWERSTATS, ISMAGENT, MICROSPIA, • Then they unlock the glorifying life-time “APT” attribution.#UnlockyourAPTTagPART I: APT MYTHS AND DEFINITIONS • Example of OilRig custom x64 Mimikatz:• Original Mimikatz x64 version have 1779 functions in total • OilRig modified Mimikatz have only 660 functions in total • Based on mimikatz version 0.1 • Have all the strings changedPART I: APT MYTHS AND DEFINITIONS • String changes for the OilRIG custom x64 Mimikatz:PART I: APT MYTHS AND DEFINITIONS • String changes for the OilRIG custom x64 Mimikatz:IIWHY AND HOW WINDSHIFT APT IS DIFFERENT?PART II: WHY AND HOW WINDSHIFT IS DIFFERENT?Pure Intelligence and Cyber espionage actor -> mostly active surveillanceIt’s been there for a while, and never got popped.It’s a long term non-attributable APT.• • Versatile, sophisticated and unpredictable Spear phishing attacks •They Re-use your favorite APT malware (and Infrastructures): • aka Hacking other APT actors• Very rarely directly engage targets with malware :• 2 attempts in 2017, very specific individuals. • 3 attempts in 2018, again very specific individuals.•They are ONLY after specific individuals. Rarely targets corporate environments. This what helped them staying under the radar for years.IIIWINDSHIFT APT – MODUS OPERANDI (MO)PART III: WINDSHIFT APT – MODUS OPERANDI (MO)• Phase 1: RECON – phase 1 duration 1-2 years• Via maintained fake personas on different social platforms:– Linkedin, Facebook, Twitter, Instagram, Google Plus.• Sending Friend Requests, engaging a conversation, to getidentifiable information, emails, phone numbers, friends contacts• Through social media mobile apps:– Example of such apps, phonebooks, stealing contact list,emails and SMS contents url identifies-app-stealing-personal-information/PART III: WINDSHIFT APT – MODUS OPERANDI (MO)• Phase 1: RECON – phase 1 duration 1-2 years• Example of fake online persona Asalah linked to WINDSHIFT APT:أﺻﺎﻟﺔآلﺳﻣﯾﺣﺔ() Al SameehaPART III: WINDSHIFT APT – MODUS OPERANDI (MO)• Twitter OSINT 101:• Legitimate Twitter account vs APT maintained Twitter Account(Weekly Activity) – using tweets_analyzer.py tool -APT maintained Twitter account: @aheemaslahalasaPART III: WINDSHIFT APT – MODUS OPERANDI (MO)• Phase 2: RECON – phase 2 – duration 6 months – 1 year• Long term monitoring of targets via benign emails:– Click habits, subjects of interests – Geo locating targets + Type of computer target uses (via User-Agent) – Email click rate – Usage of mailing lists, sending daily emails: duplicating content of local media• Building a sort of content habit and relationship with the target over time.=> increasing click rates, preparing the targets for the next phases.PART III: WINDSHIFT APT – MODUS OPERANDI (MO)• Phase 2: RECON – phase 2 – duration 6 months – 1 year– Benign email, example of Khaleej times content duplication, link pointing to legitKhaleej times as well:PART III: WINDSHIFT APT – MODUS OPERANDI (MO)• Phase 2: RECON – phase 2 – duration 6 months – 1 year– From the email source we found Tracking via Wasmyemailread[.]com:Also tracking via ifread[.]comPART III: WINDSHIFT APT – MODUS OPERANDI (MO)• Phase 3: Credential harvesting, duration 1 day• Sending emails mimicking legit password recovery or password reset of following providers :– Targeting personal emails : Gmail , Apple iCloud, Etisalat (main ISP in UAE) – Targeting professional emails: OWA outlook• Send SMS redirecting to a credential harvesting page. • Domain typo squatting • Domains resolves only 1 day during the attack then shutdown. • Anonymous domains registered with freenom.com for free: .ml, .tk, .ga. gq • Also domains registered with Internet BS, Namecheap, with Whois Privacy Guard • Credential harvesting landing pages are using HTTPS : free SSL certificates with let’s encrypt, orCOMODO Free SSL PART III: WINDSHIFT APT – MODUS OPERANDI (MO)• Phase 3: Credential harvesting, duration 1 day• OWA harvesting attempt:PART III: WINDSHIFT APT – MODUS OPERANDI (MO)• Phase 3: Credential harvesting, duration 1 day• Apple ID harvesting attempt via SMS and Emails :PART III: WINDSHIFT APT – MODUS OPERANDI (MO)• Phase 3: Credential harvesting, duration 1 day• SMS targeting Etisalat Users:PART III: WINDSHIFT APT – MODUS OPERANDI (MO)• Phase 3: Credential harvesting, duration 1 day• Gmail harvesting attempt:PART III: WINDSHIFT APT – MODUS OPERANDI (MO)• Phase 4: Hacking targets, 1 or twice per year• This phase usually happens if Phase 3 was unsuccessful after many attempts. Itis the last resort phase.• Infection vector: Emails (related to previous interaction emails of phase 2) having link to a drive by download delivering malware. Or emails having a direct malware attachment, usually within an archive.• Weaponize and re-use malware from different threat actors. • Re-use command and control infrastructure from other groups • Real separation between spear phishing infrastructure and malware C2infrastructure, to avoid attribution, suspicions and takedowns PART III: WINDSHIFT APT – MODUS OPERANDI (MO)• Below is the separation of WINDSHIFT APT C&C and spear phishinginfrastructures:PART III: WINDSHIFT APT – MODUS OPERANDI (MO)• Phase 5 : Disappear• Shutting the domain names and all related information for months • Switching to other spear phishing infrastructures • Continuously getting more access to new infrastructures:– Hacking – Renting infrastructures – purchasing new access from VPS resellers (bitcoin), bullet proof hosting providers.• Repointing domains to new infrastructures • Getting access to more malware, and more C2 infrastructures and maintain the accessuntil flaggedPART III: WINDSHIFT APT – MODUS OPERANDI (MO)• Phase 5 : Disappear • Example of OWA spear phishing domain : on January 2018, webmail-badirah-ae.html-5.me moving from WILDCARD-UK Unlimited to Bodis LLC :Bodis LLC is known to be linked to Dark Hotel and to many others:IVWINDSHIFT APT – TOOL-SETPART IV: WINDSHIFT APT – TOOL-SET• Current Tool-set by chronological order, mostly cyber espionagetools, still under on-going development: Dark Matter Code Target OS WINDTAIL.AFirst seen Jan - 2017macOSWINDTAIL.BmacOSWINDTAIL.CmacOSWINDTAPEmacOSJan - 2018Jan - 2018Jan - 2018WINDDROP - Downloader of a unknown malwarePART IV: WINDSHIFT TOOL-SET - WINDTAIL.A• WINDTAIL.A : Signed macOS backdoor exfiltrating files having thefollowing extensions: .txt .pdf .doc .docx .ppt .pptx .db .rtf .xls .xlsx• Persists via LoginItems • Strings encrypted with AES-256-ECB and encoded with Base64.AES key hardcoded in the sample:PART IV: WINDSHIFT TOOL-SET - WINDTAIL.A• First apparition in January 2017• Infection vector via spear phishing emails, pointing to a speciallycrafted webpage. The targeted emails were pointing victims to access a VIP contacts list:PART IV: WINDSHIFT TOOL-SET - WINDTAIL.APART IV: WINDSHIFT TOOL-SET - WINDTAIL.A• The specially crafted webpage will download a file VVIP_Contacts.zip, and willcall a URL scheme: openurl2622015://a:PART IV: WINDSHIFT TOOL-SET - WINDTAIL.A• The custom URL scheme of VVIP_Contacts.app contained a typo “missing theletter L”• Which results in the failure of this first targeted attack. • Nevertheless, attackers gave a backdoor a realistic look by mimicking an Excelsheet icon, and most of the unaware victims will fall in this second trap by double clicking on the app to access the VIP contact listPART IV: WINDSHIFT TOOL-SET - WINDTAIL.A• Demo #1 :• How a custom URL scheme is added to the LaunchServices database (via a filedownload, network shares, etc )• How to trigger the custom URL scheme using a specifically crafted webpage • Weakness of the attacker controlled user consent pop-up • Lateral movement: how WINDTAIL.A infect any MacOS via network shares • 1-click Malware infection and persistencePART IV: WINDSHIFT TOOL-SET - WINDTAIL.A• Rewrite ? of “Hack Back” aka “KitM OSX” , 2012 surveillance malware. We find the exactsame helper function re-used (reading last 8-bytes of a specified file)• Signed with new Developer ID certificate • Weaponized with AES-256-ECB • Sign of code re-use -> • Same C&C servers IP from 2012 •“Hack Back” aka “KitM OSX” is linked to:• Operation Hangover / Appin Security• Indian APT group from 2012PART IV: WINDSHIFT TOOL-SET - WINDTAIL.B• WINDTAIL.B, first apparition in January 2018 • Infection vector is with direct email attachmentsPART IV: WINDSHIFT TOOL-SET - WINDTAIL.B• Weaponized with AES-256-ECB • Full rewrite of WINDTAIL.A (appeared exactly one year later after WINDTAIL.A) • Additionally downloads and execute WINDTAPE (see next slides) • Weird similarities with Komplex OSX Trojan from Sofacy APT (aka APT 28): • Testing if www.google.com is available using the Reachability framework• Komplex OSX communicated with C2 hosted via AltusHost B.V a Netherlands serviceprovider. AltusHost B.V is linked to several group and majorly used by Russian and Indian APT groups:PART IV: WINDSHIFT TOOL-SET - WINDTAIL.B • WINDTAPE, is the a second stage downloaded by WINDTAIL.B •The below PCAP was recorded from our macOS Honeypot:PART IV: WINDSHIFT TOOL-SET - WINDTAPE• Main purpose :• Taking a Screenshot of the current Desktop • Sending the Screenshot to the C2 • Removing the Screenshot • Repeat every 5 seconds••Using KSReachability framework to determine if the infected hosts is connected to the internet, KSReachability code is originally cloned from this GIT repo: url (We found the exact same Credits.rtf left inside WINDTAIL.A)Function names in Farisi : • Goli means Flower/Rose • Namac means SaltPART IV: WINDSHIFT TOOL-SET - WINDTAPE•String encryption: • The encryption used is DES with a hardcoded Key and IV. • CCCrypt is used, so I wrote the decryption routine in objective-C as following:PART IV: WINDSHIFT TOOL-SET - WINDTAPE• Demo #2 :• WIDTAPE taking screenshots + Exfiltrating the captured images tothe C&CPART IV: WINDSHIFT TOOL-SET - WINDTAPE•Final Remarks on the encryption keys used in WINDTAIL.A/B and WINDTAPE • The encryption keys are hardcoded in the sample in the UTF-16LE format:PART IV: WINDSHIFT TOOL-SET - WINDDROP• WINDDROP, a Windows dropper, first appeared in May 2018, found by pivoting over the C2 through an online malware repository. This sample shares the same C&C server with the other macOS backdoors. It starts by sending information about the infected hosts :PART IV: WINDSHIFT TOOL-SET - WINDROP• Downloads a second stage backdoor drop.txt• Pass the execution to the a second still unidentified backdoor. No details about this secondstage backdoor found yet, the file was removed from the server.PART IV: WINDSHIFT TOOL-SET - WINDROP• Stack strings are encrypted, tools like FLOSS wont be able decode them:VS• Configuration strings are encoded:PART IV: WINDSHIFT TOOL-SET - WINDROP• All the decryption is performed via a standalone decryption function:PART IV: WINDSHIFT TOOL-SET - WINDROP• Can it be decrypted using emulation ? Yes. • emulation using Radare2 is possible, see:•url• Can we do it with Binary Ninja?PART IV: WINDSHIFT TOOL-SET - WINDROP• Demo#3: Decrypt WINDROP encrypted strings using:• The Unicorn engine• Binary Ninja• Ripr plugin• And some ninja skills PART IV: WINDSHIFT TOOL-SET - WINDROP • WINDROP strings can be decrypted via x86 emulation :VATTRIBUTION, WHO’S BEHIND WINDSHIFT APT?PART V: ATTRIBUTION, WHO’S BEHIND WINDSHIFT APT?• An advanced APT hacked into Appin servers, or purchased their source code:• An APT hacked into Operation Hangover and got access to “KitM” and “HackBack” malware source code : • Since not activity was recorded between 2012 and 2017 moreover Appin wasshutdown during that time.• Suddenly variants of malware appeared in 2017 all signed with developer id’shaving emails very similar BAHAMUT APT MO’s: example warren82port@mail.com was used to sign WINDTAIL malware.• BAHAMUT APT, is an obscure group tracked by Bellingcat showing a verysimilar email address composition : usually English first name, last name, and a number @ mail (.com, .ru) as well as VERY similar MO’s:PART V: ATTRIBUTION, WHO’S BEHIND WINDSHIFT APT?BAHAMUT APTWINDSHIFT APTsource: Bellingcatsource: Dark MatterPART V: ATTRIBUTION, WHO’S BEHIND WINDSHIFT APT?BAHAMUT APTWINDSHIFT APTsource: Bellingcatsource: Dark MatterPART V: ATTRIBUTION, WHO’S BEHIND WINDSHIFT APT?BAHAMUT APTWINDSHIFT APTsource: Bellingcatsource: Dark MatterPART V: ATTRIBUTION, WHO’S BEHIND WINDSHIFT APT?BAHAMUT APTWINDSHIFT APTEmail: warren82port@mail.comWarren Portman Apple Developer ID: 9S442G74FHEmail: ?? Caren Van Apple Developer ID: 4F9G49SUXBsource: Bellingcatsource: Dark MatterVICONCLUSIONSPART VI: CONCLUSIONS• Appin Security was highly likely either targeted by an advanced APT group or tools stolen byrogue employee or tools (malware, servers access ) were sold to a third party.• Fact 1: Appin Security previously reported tools and infrastructures are today re-used to covertlyhack into governments.• Fact 2: We found overlaps with known existing APT actors:– MO’s (including: Domain registration, phishing emails and SMS’s) : BAHAMUT APT,Fancy Bear– Infrastructure used: BAHAMUT APT, Fancy Bear – Malware coding practices similarities: SOFACY – VPS providers: SOFACY, Fancy Bear, CARBANAK, DARK HOTEL, MORPHO, BAHAMUT – Passive DNS data: overlap with BAHAMUT, SOFACY• Fact 3: WINDSHIFT APT are currently targeting government using Appin Security tools.REFERENCES• •url url url url url url url url url url url url url url url url url url url url url url aa40c9e08852 url url url url url url YOU 