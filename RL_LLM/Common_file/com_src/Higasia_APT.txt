6/5/2020New LNK attack tied to Higaisa APT discovered - Malwarebytes Labs | Malwarebytes LabsNew LNK attack tied to Higaisa APT discoveredblog.malwarebytes.com/threat-analysis/2020/06/higaisaThreat Intelligence TeamJune 4, 2020This post was authored by Hossein Jazi and Jérôme SeguraOn May 29th, we identiﬁed an attack that we believe is part of a new campaign from an Advanced Persistent Threat actor known as Higaisa. The Higaisa APT is believed to be tied to the Korean peninsula, and was ﬁrst disclosed by Tencent Security Threat Intelligence Center in early 2019.The group’s activities go back to at least 2016 and include the use of Trojans such as Gh0st and PlugX, as well as mobile malware. Its targets include government ofﬁcials and human rights organizations, as well as other entities related to North Korea.In this latest incident, Higaisa used a malicious shortcut ﬁle ultimately responsible for creating a multi-stage attack that consists of several malicious scripts, payloads and decoy PDF documents. Distribution The threat actors used a malicious LNK ﬁle bundled within an archive ﬁle which was most likely distributed via spear-phishing.We were able to identify two variants of this campaign that possibly have been distributed between May 12th and 31st:“CV_Colliers.rar” “Project link and New copyright policy.rar”Both RAR archives bundle two malicious LNK ﬁles. In the newer variant (CV_Colliers.rar), the LNK ﬁles are disguised as a Curriculum Vitae (CV) and International English Language Testing System (IELTS) exam results. The older one (Project link and New copyright policy.rar) seems to target product teams that are using zeplin.io.url LNK attack tied to Higaisa APT discovered - Malwarebytes Labs | Malwarebytes LabsThe following shows the overall process ﬂow when executing the malicious LNK ﬁle.Figure 1: Process graphLNK ﬁle The LNK ﬁle contains a list of commands that will be executed upon running, and a blob that is a base64 encoded compressed payload. Here is the list of commands that will be executed:Figure 2: Malicious lnk commandsCopy content of the LNK ﬁle into “g4ZokyumB2DC4.tmp” in %APPDATA% temp directory. Copy content of “certutil.exe” into “gosia.exe” ( “*ertu*.exe is used to bypass security detection). Look for the base64 blob using “ﬁndstr.exe” and write it to “cSi1rouy4.tmp”. Decode content of “cSi1rouy4.tmp” using “gosia.exe -decode” (certutil.exe -decode) and write it to “o423DFDS4.tmp”. Decompress content of “o423DFDS4.tmp” in temp directory along with a decoy PDF document using “expand.exe -F:*” (Figure 3) . Copy “66DF33DFG.tmp” and “34fDKfSD38.js” ﬁles into “C:\Users\Public\Downloads” directory. Execute the JS ﬁle by calling Wscript. Open the decoy document.url LNK attack tied to Higaisa APT discovered - Malwarebytes Labs | Malwarebytes LabsFigure 3: Content of the “o423DFDS4.tmp” cab ﬁleThe list of commands executed by this LNK shortcut is the same as the one reported by Anomali on the Higasia Covid-19 campaign. The only difference is the name of the tmp ﬁles and name of certutil.exe which in this new case is “gosia.exe”, while in the March campaign the name was “mosia.exe”.Both LNK ﬁles embedded within the archive are executing similar commands with the different Command and Control (C&C) conﬁgurations. Running each of them would show a different decoy document.Figure 4: CV Decoy documenturl LNK attack tied to Higaisa APT discovered - Malwarebytes Labs | Malwarebytes LabsFigure 5: IELTS test result decoy documentJS ﬁle The JavaScript ﬁle performs the following commands:Create “d3reEW.exe” in “C:\Users\Public\Downloads” and store “cmd /c ipconﬁg” in it. Execute the dropped “svchast.exe”. Copy “svchhast.exe” into startup directory and rename it as “ofﬁceupdate.exe”. Add “ofﬁceupdate.exe” to scheduled tasks. Send a POST request to a hardcoded URL with “d3reEW.exe” as data.Figure 6: JS contentFigure7: POST requesturl LNK attack tied to Higaisa APT discovered - Malwarebytes Labs | Malwarebytes Labssvchast.exe Svchast.exe is a small loader that loads the content of the shellcode stored in “63DF3DFG.tmp”.Figure 8: Main function of svchast.exeIn fact, this shellcode is a wrapper around the ﬁnal shellcode. It performs some checks and then calls the ﬁnal shellcode.url LNK attack tied to Higaisa APT discovered - Malwarebytes Labs | Malwarebytes LabsFigure 9: Calling ﬁnal shellcodeThe ﬁnal shellcode dynamically resolves the imports and allocates memory for the content that will be executed.Figure 10: Resolving the importsurl LNK attack tied to Higaisa APT discovered - Malwarebytes Labs | Malwarebytes LabsFigure 11: Allocate memory for new threadFinally it calls “CreateThread” to create a thread within its memory space to make HTTPS requests to its C&C server.Figure 11: CreateThreadAt the time of analysis, the server was down so we weren’t able to clearly identify the ultimate goal of this attack. Chaining techniques for evasion While most malware campaigns use a simple decoy document that typically retrieves a malware payload, more advanced attackers will often try unconventional means to infect their victims.We reproduced this attack in our lab using an email as the infection vector, as we surmise that victims were spear-phished. Malwarebytes (in this case the Nebula business version) stopped the LNK ﬁle execution from WinRAR and therefore completely stopped the attack.url LNK attack tied to Higaisa APT discovered - Malwarebytes Labs | Malwarebytes LabsIOCs CV_Colliers.rar sixindent[.]epizy[.]com goodhk[.]azurewebsites[.]net zeplin[.]atwebpages[.]comC2s used by svchast.exe 45.76.6[.]149 www.comcleanner[.]info MITRE ATT&CK techniquesTactic ExecutionNameID T1059 Command-LineInterfaceT1106 Execution throughAPIT1053 Scheduled TaskT1064 Scripting T1204 User ExecutionPersis‐ tenceT1060 Registry Run Keys /Startup Folder T1053 Scheduled TaskPrivilege EvasionT1053 Scheduled TaskT1064 ScriptingT1140 Deobfuscate/Decode Files or InformationDiscoveryT1012 Query RegistryT1082 System InformationDiscoveryT1016 System Network Con‐ﬁguration DiscoveryDetails Starts CMD.EXE for commands (Win‐ RAR.exe, wscript.exe) execution Application (AcroRd32.exe) launched itself Loads the Task Scheduler DLL interface (Ofﬁceupdate.exe) Executes scripts (34fDFkfSD38.js) Manual execution by user (opening LNK ﬁle) Writes to a start menu ﬁle (Ofﬁceupdate.exe) Uses Task Scheduler to run other ap‐ plications (Ofﬁceupdate.exe) Uses Task Scheduler to run other ap‐ plications (Ofﬁceupdate.exe) Executes scripts (34fDFkfSD38.js)certutil to decode Base64 binaries, ex‐ pand.exe to decompress a CAB ﬁle Reads the machine GUID from the registry Reads the machine GUID from the registry Uses IPCONFIG.EXE to discover IP addressurl LNK attack tied to Higaisa APT discovered - Malwarebytes Labs | Malwarebytes Labsurl 