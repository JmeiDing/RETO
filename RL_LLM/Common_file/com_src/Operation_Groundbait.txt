Operation Groundbait: Analysis of a surveillance toolkitANTON CHEREPANOV, ESET Version 2016-05-17Operation Groundbait: Analysis of a surveillance toolkit1ContentsExecutive Summary 02C&C servers 23The discovery 03Attribution 25The campaigns 04Conclusion 27Campaigns against separatists 05 Campaign against Ukrainian nationalist political party 09 Other campaigns 10Credits 28APPENDIX A. Details of Prikormka Campaigns 29Technical details 12APPENDIX B. Indicators of Compromise (IoC) 31The dropper 13 Prikormka modules 15 PERSISTENCE module 16 DOWNLOADER module 17 CORE module 17 DOCS_STEALER module 18 KEYLOGGER module 19 SCREENSHOTS module 19 MICROPHONE module 19 SKYPE module 19 LOGS_ENCRYPTER module 20 GEOLOCATION module 21 OS_INFO module 21 PASSWORDS module 22 FILE_TREE module 22ESET detections 32 Host-based 32 Mutexes 32 C&C servers 32 Servers used for sending spearphishing emails 32 SHA-1 hashes 33Operation Groundbait: Analysis of a surveillance toolkit1Executive SummaryOperation Groundbait (Russian: Прикормка, Prikormka) is an ongoing cyber-surveil- lance operation targeting individuals in Ukraine. The group behind this operation has been launching targeted and possibly politically-motivated attacks to spy on individuals.This paper presents ESET’s findings about Operation Groundbait based on our re- search into the Prikormka malware family. This includes detailed technical analysis of the Prikormka malware family and its spreading mechanisms, and a description of the most noteworthy attack campaigns.Key findings:• The country where the malware has been seen most is Ukraine.It has been active since at least 2008.• The primary targets of Operation Groundbait are anti-governmentseparatists in the self-declared Donetsk and Luhansk People's Republics in Eastern Ukraine.• There have also been a large number of other targets, including Ukrainian government officials, Ukrainian politicians, Ukrainian journalists and others.• The attackers most likely operate from within Ukraine.Operation Groundbait: Analysis of a surveillance toolkit2The discoveryIn the third quarter of 2015 ESET identified a previously unknown modular mal- ware family, Prikormka. Further research revealed that this malware has been active since at least 2008 and the country where the malware has been seen most is Ukraine. The reason why it had gone unnoticed for so long is the relatively low infection ratio before 2015. The number of infections surged significantly in 2015.178One of the first examples of this malware that we analyzed in our laboratory had the name prikormka.exe. The Russian and Ukrainian word prikormka (Прикормка) means groundbait, a type of fish bait that is cast into the water to attract fish. We used this codename during our research and afterward we decided to keep it, so the malware has the names Win32/Prikormka and Win64/Prikormka respectively.The low detection ratio and ability to stay undetected for years is a common char- acteristic of targeted attacks (APTs). The investigation of campaigns and Priko- rmka activity has increased our confidence that this malware is used in targeted attacks.Targeted attacks are generally carried out for various purposes, including recon- naissance, intellectual property theft, sabotage, and espionage. After analyzing tactics, techniques and procedures employed by this particular malware group, we came to the conclusion that individuals are targeted rather than companies. Even when the Prikormka malware was detected in a corporate environment, we never saw any lateral movement — a technique used by advanced adversaries in cyber-attacks.4439We suspect that this group operates in Ukraine, where most of the victims are located. For that reason and due to the nature of these attacks, we classified them since 2008, according to the PE header timestamps. While timestamps by them- selves usually are not a reliable indicator, in this case, their accuracy was con- firmed by ESET’s LiveGrid® telemetry.Operation Groundbait: Analysis of a surveillance toolkit3The campaignsIn this section, we will show the most noteworthy and prominent campaigns and the decoy documents with which they are associated.Let’s examine detection statistics by country based on our ESET LiveGrid® statistics:20152016Belgium 2%Russia13%Ukraine 86%Tajikistan1%Russia12%Ukraine 87%Figure 2. Detection statistics for Prikormka malware according to ESET LiveGrid®.According to our telemetry, Ukraine is the country with the majority of detections of this malware. In addition, our research revealed that the attackers behind this malware demonstrate native fluency of the Ukrainian and Russian languages and comprehensive understanding of the current political situation in Ukraine.To answer the question of what kind of victims were attacked in the above-listed countries, we have analyzed the decoy documents used to target them.The main infection vector that we identified during our research consists of spear- phishing emails with attached malicious executables or with a download link to a malicious file hosted on a remote server. When the user clicks on a malicious attachment that is masquerading as a document, the Prikormka dropper displays a decoy document in order to trick victims and distract their attention, since victims normally expect to see a document open when they click on an attachment. This technique works against less tech-savvy computer users; infection success, how- ever, depends on the quality of spearphishing emails. The attacker has a greater chance to infect the computer when spearphishing letters and decoy documents are relevant to the victim — in other words, when the victim would not be sur- prised to receive such a message from someone. Thus, analyzing such decoy docu- ments can reveal information about the intended targets of these cyber-attacks.Secondly, there is another artefact embedded in each sample of Prikormka mal- ware, that we call the Campaign ID. These Campaign IDs are unique text strings used to identify specific infections or attempts at infection by the Prikormka malware operators. The combinations of letters and numbers used can sometimes reveal information about the intended targets.So far we have identified more than 80 different Campaign IDs and even more decoy documents linked to these IDs. It was observed that usually one Campaign ID is used against one target, which can be an individual, some entity, or group of people. This means that one particular ID might be discovered on multiple computers.A more comprehensive listing of representative campaigns, along with their com- pilation timestamps and unique Campaign IDs is in Appendix A.It is worth mentioning that in some cases it is hard to identify intended victims, especially when the Prikormka malware infections were discovered at the stage when the malware was already installed and active. However, we have become aware of some active Prikormka infections on computer networks belonging to high-value targets, including the Ukrainian government. Other noteworthy tar- gets are mentioned in the following descriptions of Groundbait campaigns.Operation Groundbait: Analysis of a surveillance toolkit4Campaigns against separatistsAmong Prikormka's primary targets are separatists in Eastern Ukraine. Since 2014 this region has been involved in an armed military conflict.In April 2014 a group of people unilaterally proclaimed independence in two regions of Eastern Ukraine: Donetsk and Luhansk. In response, the Ukrainian government classified these two entities as terrorist organizations and, therefore, the territory of these regions was declared an Anti-Terrorist Operation (ATO) zone. In May 11th 2014, the authorities of these self-proclaimed republics held a referendum seeking to legitimize the establishment of the republics.A significant number of decoy documents that were used in Prikormka attacks ex- ploited various topics related to the self-proclaimed states of the Donetsk People’s Republic (DPR) and the Luhansk People’s Republic (LPR). Moreover, a number of decoy documents contain private data including internal statistics and documents apparently used in the internal workflow of these self-proclaimed states. This fact leads us to believe that operators are intentionally targeting people located in these two regions. These assumptions are confirmed by our ESET LiveGrid® telemetry: the Donetsk and Luhansk regions are at the two most infected regions in Ukraine by the Prikormka malware.The attackers use social engineering tricks to convince a victim to open a mali- cious attachment. These tricks include giving provocative or attractive names to the email attachments. Here are few examples of such filenames:• Нацгвардейцы со шприцами сделали из донецкогомальчика мишень для ракет.exe (From the Russian: National Guard of Ukraine aimed rockets at boy from Donetsk). Compilation timestamp: November 5th 2014• Последнее обращение командира бригады 'Призрак'Мозгового Алексея Борисовича к солдатам и офицерам ДНР и ЛНР.scr (From the Russian: Leader of the Prizrak Brigade Aleksey Borisovich Mozgovoy's last appeal to soldiers and officer of DonetskPeople’s Republic and Luhansk People’s Republic). Compilation timestamp: May 24th 2015• Места дислокации ВСУ в зоне проведения АТО.scr(From the Russian: Dislocation of the armed forces of Ukraine in ATO zone). Compilation timestamp: December 15th 2015Here are examples of decoy documents that were used in attacks against separatists in Luhansk and Donetsk regions.• The first example is an executable with the filename СПРАВОЧНИКпо МИНИСТЕРСТВАМ обновленный.exe (From the Russian: Ministries directory – updated) that drops a decoy document with a list of Ministries of the self-proclaimed republic. The Campaign ID for this executable is D _ xxx. (Figure 3)• Here is another example of a decoy document, which wasdropped by an executable named материалы к зачету по законодательству.exe (From the Russian: Materials for the law exam). This executable drops several documents including the LPR temporary constitution and other legal and political documents. The Campaign ID is L _ ment; the word “ment” is Russian slang for a policeman. Thus, the attackers demonstrate intimate knowledge of the Russian language. (Figure 4)• Some of the decoy documents use the Minsk agreement topic. Here is an example of one such document, which comes from a dropper with the filename Схема демилитаризованной зоны в районе Шиокино.exe (From the Russian: Scheme of the demilitarized zone in the Shyrokyne (Shyrokyne written with a typo in Russian)). The Campaign ID was Lminfin. (Figure 5)Operation Groundbait: Analysis of a surveillance toolkit5Figure 3. Decoy document, with a list of Ministries of DPR. (Here and in further images, potentially sensitive data have been redacted by ESET.)Operation Groundbait: Analysis of a surveillance toolkit6Figure 4. Decoy document containing the law, which describes the rulesfor special crime investigation activities.Figure 5. Decoy document, which exploits the Minsk Agreement topic.Operation Groundbait: Analysis of a surveillance toolkit7• Another decoy document even contains a map of the buffer zoneestablished by the Minsk Protocol. Here is an example, which came from a dropper with the filename Отвод с 4 участками по сост на 14.08.exe (From the Russian: Pullout [of heavy weapons] on 14.08). The Campaign ID was BUR. (Figure 6)Important note: Most of the Prikormka binaries that seem to have been intended for use against separatists have Campaign IDs starting with D or L characters. It's possible that this means Donetsk People’s Republic and Luhansk People’s Repub- lic, respectively. Also, we observed an executable named Заявление Эдуарда Басаргина 13 октября 2015 года в 15 часов.exe (From the Russian: Edu- ard Basargin's statement on 13th October 2015 at 3pm), which uses the Campaign ID RF _ lgm. Since we have identified detections in Russia, the RF prefix could mean Russian Federation.Figure 6. Decoy document with a map of the buffer zone.Operation Groundbait: Analysis of a surveillance toolkit8Campaign against Ukrainian nationalist political partyAll previously mentioned decoy documents were extracted from executables that had Russian filenames. Ukrainian is the official state language; however, people in Eastern Ukraine tend to use Russian, as opposed to Western regions, which use Ukrainian.Some of the Prikormka binaries had names in Ukrainian. For example, we have seen the filename План ДНР на 21 липня, щодо відводу військ.exe (From the Ukrainian: The DPR plan for withdrawal of troops on 21st July). Names of attach- ments in the Ukrainian language might suggest that the receiver of such malicious letters prefer to speak Ukrainian over Russian. The fact that Prikormka malware was detected in Western regions of Ukraine strengthens this assumption. The Campaign ID for this particular executable was Psek, which inclines us to believe with a high degree of confidence that members of Ukrainian nationalist party Right Sector (Ukrainian: Pravyi Sektor) were targeted with Prikormka malware.Figure 7. Decoy document possibly used against members of a Ukrainian nationalist party.Operation Groundbait: Analysis of a surveillance toolkit9Other campaignsSeparatists in Donetsk and Luhansk and the other targeted high profile victims weren’t the only targets of Operation Groundbait. We have observed some other campaigns with interesting decoy documents, but we can't identify the intended victims solely on the basis of those documents.Here is an example of a decoy document which was possibly used against a re- ligious institute. The decoy document comes from dropper with filename Новое слово жизни.exe (From the Russian: New word of life). The Campaign ID was medium. This choice of Campaign ID may refer to mediumship and spiritualism.Another campaign was discovered in March 2016. This time, the name of the malicious file was in Hungarian: Önéletrajz fizikai munka 2.pdf.scr, which translates to English as “CV physical work”. The decoy document dropped by this file was a person's CV (curriculum vitae or resume), written in Hungarian. This malicious .SCR file was sent compressed in single archive with two other docu- ments: the CV of the same person in Ukrainian, and a certificate in Hungarian that confirms that this person is able to perform the physical job. Based on this infor- mation it is hard to say who might be the intended target, but the fact its recip- ient possibly knows Hungarian and Ukrainian makes this campaign interesting. The Campaign ID was F _ ego.Figure 8. Decoy document possibly used against religious organizations.Figure 9. The Hungarian document that was sent to the victim in a single archivewith the Prikormka malware.Operation Groundbait: Analysis of a surveillance toolkit10Here is an example of a decoy document, dropped from a file with the name bitcoin.exe. The Campaign ID in this case was hmod.Figure 10. Decoy document that explains how to commit credit card fraud.The Russian text in the decoy document explains, step by step, how to buy bitcoins using stolen credit cards. The text abounds in slang words often used by Rus- sian-speaking carders. ¹Another example is a mysterious decoy document extracted from a malware dropper with the name prikormka.exe. The Campaign ID is 30K _ alfa.1 Cybercriminals involved in stolen credit card crime.This decoy document contains the pricelist of a Ukrainian shop that sells various types of groundbait.Figure 11. The mysterious decoy document dropped by the file named prikormka.exe.Operation Groundbait: Analysis of a surveillance toolkit11Technical detailsIn this section, we will describe technical aspects of Prikormka malware, including malware architecture, C&C communication and detailed analysis of modules used.Figure 12. Simplified scheme of the Prikormka malware's architecture.Operation Groundbait: Analysis of a surveillance toolkit12The dropperThe dropper is the initial component of this malware, which is usually sent through email as an attachment. Usually the dropper has a .SCR or .EXE file extension and is compressed into an archive. In order to trick the victim, the Prikormka dropper can masquerade as various types of document or self-extracting archive.The SFX executable can contain one or more decoy documents. For example one SFX that was dropped by Prikormka contained 24 documents. Of course, the num- ber and size of the decoy documents affects the size of the droppers. The biggest dropper we identified had a file size of 25MB.Most of the dropper executables have an embedded application manifest, which specifies that the executable requires administrator privileges in order to run on the system. If the user does not have administrator privileges, the system will prompt for credentials.Figure 13. Icons used by Prikormka malware.Figure 15. The embedded application manifest embedded in Prikormka dropper.When executed, the dropper infects the computer, but also displays one or more decoy documents. To this end, the malware displays a WinRAR self-extraction (SFX) archive window. In some cases, the dropper creates a legitimate, non-mali- cious SFX executable on disk and then launches it. Interestingly, that SFX archive always has a Russian localized graphic user interface, even in cases where the file- name of the dropper is in Ukrainian. The dropper which has a Hungarian filename does not display this window at all.Figure 14. The Russian interface of SFX archive.The dropper needs administrator privileges because of the technique used by the malware to become persistent on the infected system. Specifically, the malware uses so-called DLL load-order hijacking in order to start automatically on every system boot. The dropper saves one of the Prikormka DLL modules to the Win- dows-directory under the name ntshrui.dll. Because this DLL file is stored in the Windows directory, it will be loaded on system boot by the explorer.exe process instead of the legitimate ntshrui.dll file, which is stored in the C:\Windows\System32 subdirectory. Thus, the Prikormka module hijacks the order of loading DLL files. This persistency method is not something new; it has been publicly examined multiple times by anti-malware research community.Another interesting technique is used by the Prikormka malware, specifically by droppers with .SCR file extensions. The .SCR file extension stands for screensaver and represents a standard Windows executable file. The main difference between .EXE and .SCR is that a screensaver is executed with special command line argu- ments. Usually, cybercriminals just rename an executable with the .SCR extension in order to bypass various security measures based on file extension. Prikormka's authors implemented a check for such command line arguments, so when theOperation Groundbait: Analysis of a surveillance toolkit13binary is executed as a standard executable (without the required arguments), it won’t infect the system. Thus, this simple check allowed the malware to bypass some sandboxes used for automatic sample processing.In the case where the infection starts from a .SCR file, the Trojan uses standard methods for loading its DLL via rundll32.exe and for maintaining persistence, by setting an entry with the name guidVGA or guidVSA in the registry Run key:[HKCU\Software\Microsoft\Windows\CurrentVersion\Run]In order to be loaded by the 32-bit and the 64-bit version of Windows Explorer the malware has binaries for both platforms. Most modules are written in the C pro- gramming language and compiled with Microsoft Visual Studio.The dropper stores modules in its resources; some of these resources are encrypt- ed with a simple XOR operation.Earlier versions of Prikormka used a different technique – Campaign IDs were embedded in the binary file of one of modules:Figure 17. The Campaign ID with value hmyr32 is embedded in the binary.The Campaign ID value was hardcoded in the Prikormka binary at compilation time; moreover, the ID in the 32-bit version of binaries ended with 2, while the Campaign ID in 64-bit version of binaries ended with 4.This technique was probably efficient for a small number of victims, but it presum- ably created problems for the attackers once the number of victims grew. Perhaps recompiling and repacking the core parts of a toolset for every new victim became too time consuming, so somewhere around mid-2015, the attackers changed this scheme. Since June 2015 the Campaign ID is stored in a separate file named rbcon.ini, which the attackers call objectset. The malware authors have also included a new value called roboconid, which represents the Operator’s ID. Our investigation allowed us to confirm that this ID is a unique number for the mal- ware operator, who performs cyber operations and is assigned to infect, spy on, and track a particular target.Figure 16. Resources located inside the Prikormka dropper binary.The dropper is responsible for creation of the rbcon.ini file, which used by the malware to store Campaign ID and other values.Figure 18. The rbcon.ini file which contains both Campaign ID and Operator ID.Operation Groundbait: Analysis of a surveillance toolkit14Some of the binaries of the dropper contain a PDB-path, which can reveal the directory structure used by attackers.It should be noted that malware operators are responsible for deciding which modules should be pushed to the infected computer.Prikormka might store modules with different functionality under similar names or, conversely, it can store modules with similar functionality under various names. Some versions of the malware store modules with a filename that contains only the current date and time. For these reasons we refer to the plugins by code names in the following text.Figure 19. Some of the PDB-paths discovered inside Prikormka droppers.The malware writers internally call this Trojan PZZ; we have other evidence that supports this theory. The Prikormka family is a typical cyber-espionage Trojan with a modular architecture. The functionality of the Trojan allows attackers to steal sensitive data from the infected computer and upload them to command and control (C&C) servers.Prikormka modulesThe Prikormka modules are stored on disk in the infected system in the form of DLL files. There are modules for various purposes, such as communication with C&C servers, auxiliary purposes (e.g. persistence), and exfiltration of different types of sensitive information from the infected computer. As mentioned before, Prikormka modules are compiled for both 32- and 64-bit Windows platforms.There is a standard set of downloadable modules with pre-defined names, which will be described in detail in the next sections. So as to be executed, the module (DLL file) should be stored under a specific filename on the disk and should have one of the following export functions: Starting, KickInPoint, Cycle. However, attackers are able to push any custom module to a particular victim. Specifically, we observed that custom modules are usually named mp.dll.Module code namePERSISTENCE DOWNLOADER COREInternal name of module samlib.dllhelpldr.dllhauthuid.dllDOCS_STEALER KEYLOGGER SCREENSHOTSiomus.dllkl.dll, hlpuctf.dllscrsh.dllMICROPHONEsnm.dllSKYPE LOGS_ENCRYPTERswma.dllatiml.dllGEOLOCATIONgeo.exeOS_INFOPASSWORDSInfoOSBrotherFILE_TREEmpTREEmp.dllFIlenamePurposesamlib.dll, ntshrui.dllUsed for persistencehelpldr.dll, _wshdmi.dllDownloads CORE modulehauthuid.dll, _svga.dll, _wshdmi.dlliomus.dllhlpuctf.dllscrsh.dllsnm.dllswma.dllatiml.dllInv.exemp.dllmp.dllLoads all other modules, communicates with C&C- servers, uploads logs Collects documentsLogs keystrokesGrabs screenshots of desktop Captures audio from microphone Records Skype audio callsCompresses and encrypts collected logs Geo-locates the infected computer Collects information about infected computer Collects saved passwords for various installed applications Collects file tree of fixed disk of infected computerTable 1. List of Prikormka modules identified during our research.Operation Groundbait: Analysis of a surveillance toolkit15The following list contains filenames of modules that were referenced within mal- ware code, but we haven’t seen them during our research and thus were unable to assess their functionality:• miron.dll • mupdate.exeIt is important to note that Prikormka components made in the "old" period (be- tween 2008 and 2010) used a completely different naming scheme. Here are some examples of such filenames:• smdhostn.dll • lid.dllPERSISTENCE moduleAs described above, this module uses the DLL load-order hijacking technique to maintain persistence in the system.When launched, this module creates the folder %USERPROFILE%\AppData\Local\ MMC and copies the following files there from the %WINDIR% directory:• hauthuid.dll (CORE) • hlpuctf.dll (KEYLOGGER) • atiml.dll (LOGS _ ENCRYPTER) • iomus.dll (DOCS _ STEALER) • swma.dll (SKYPE) • helpldr.dll (DOWNLOADER) • rbcon.iniThis component then loads and passes execution to the CORE module, or to the DOWNLOADER module if the CORE module is not found.If the %USERPROFILE%\AppData\Local\MMC\nullstate.cfg file exists, then the component deletes all the filenames listed above from the MMC directory and quits, thus deactivating itself.Some of the binaries of the PERSISTENCE module contain a PDB-path, which re- veals the directory structure used by the malware authors at compile time. Three of these paths contain a time stamp, possibly from when the project was created or modified. One such path contains the Russian string Раб. программы, which translates as “computer programs for work”.Operation Groundbait: Analysis of a surveillance toolkit16Figure 20. Some of the PDB-paths discovered inside Prikormka's PERSISTENCE module.DOWNLOADER moduleThe main purpose of this component is to download the CORE module and ex- ecute it. The DOWNLOADER module makes an HTTP request to one of its C&C servers, receives data, decrypts the data, saves it under the name hauthuid.dll and then loads the DLL. The communication is encrypted with the Blowfish cipher and then base64 encoded.Figure 21. Traffic captured from the Prikormka malware's DOWNLOADER module.Along with the Campaign ID and Operator ID, the module includes in the request a date and time when infection occurred and whether the platform is 32-bit or 64-bit Windows. Some of the binaries of the DOWNLOADER module contain PDB- paths, revealing that internally this module is called Loader or helpldr:Figure 22. PDB-paths discovered inside Prikormka's DOWNLOADER module.CORE moduleThe CORE module is responsible for communications with C&C servers and other tasks, including downloading additional modules, loading them, and uploading stolen data to the remote server.Since this malware (and specifically the CORE module) has existed for several years, the details of implementation might vary, but the main concept of the CORE module has remained unchanged over the years. The concept of the Prikormka malware is simple: the CORE module downloads additional components, which are used to harvest various types of data. When such a component is loaded, it gathers sensitive information and saves this information to some specific log file. The log file might store collected data in plain-text or it may be encrypted. The CORE module checks periodically for such log files and when a log is available, it uploads it to the remote server. The CORE module won’t upload a log file if it is bigger than 500MB.In order to store downloadable modules and collected log files, the CORE module creates two directories:• %USERPROFILE%\AppData\Local\MMC\ • %USERPROFILE%\AppData\Local\SKC\Operation Groundbait: Analysis of a surveillance toolkit17The MMC folder is primarily used for additional downloadable malware compo- nents; the SKC folder is used for storing collected log files. In the subsequent text we will use the term “log folder” to refer the SKC directory.The downloadable modules are not able to upload collected data. In fact, only the CORE and DOWNLOADER modules communicate with C&C servers. The commu- nication protocol of the CORE module is very similar to that of the DOWNLOADER module.It is worth mentioning that early versions of Prikormka stored C&C servers in plain-text; later, attackers used the base64 algorithm in order to hide the servers’ addresses. Finally, the latest versions of the CORE modules use simple encryp- tion: to decrypt it, the researcher should add the hexadecimal value 0x17 to each encrypted byte.Figure 23. Traffic captured from the Prikormka malware's CORE module.The only difference between DOWNLOADER and CORE HTTP requests is the st parameter in the URL. This parameter indicates which of the downloadable mod- ules are active and loaded by Prikormka. With the current implementation, there is room for 11 additional modules. The server responds with the content of the module that should be executed, or with a dummy answer.The logs are uploaded during a POST request to a similar URL:• hxxp:/server.ua/wd.php?sn=%DATE _ TIME _ OF _ INFECTION%Figure 24. Example of simple encryption used by Prikormka to hide C&C servers.DOCS_STEALER moduleThis module is responsible for collecting documents from removable media or fixed drives, connected via a USB interface.The module focuses on collecting files with document-type extensions: .DOC, .XLS, .DOCX, .XLSX, .PPT, .PPTX, .PPS, .PPSX, .PDF, .RTF, .TXT, .ODT. However, it does not collect all files, but only those which were modified in the last 7 days (or 14, or 30, depending on which version of the module).The collected files then are compressed, encrypted with Blowfish, and stored under the following scheme:• %USERPROFILE%\AppData\Local\ioctl\%DISK _ ID%\%DATE% _ %TIME%.kfOperation Groundbait: Analysis of a surveillance toolkit18KEYLOGGER moduleSKYPE moduleThis module is responsible for collecting keystrokes and the titles of foreground windows. The collected information is saved to the log folder under the following names:• %DATE% _ %TIME% _ fix.lg • fmmlgIf the log file is bigger than 10Mb, the module removes the log and starts anew. Some versions of the module encrypt the log file using Blowfish.SCREENSHOTS moduleThis module is responsible for capturing screenshots of the victim’s desktop. By default, the module captures a screenshot every 15 minutes. However, if the victim opens a VoIP application Skype or Viber, then the period between screen- shots is lowered dramatically to 5 seconds. The captured screenshot is saved in the JPEG format. The collected information is saved to the log folder under filenames %DATE% _ %TIME%.tgz.scrsh or %DATE% _ %TIME%.stgz.MICROPHONE moduleThis module is responsible for recording sound from a microphone. The module records audio with 10 minutes duration. It stops recording on command, or when there is no more free disk space available. The recorded audio is encoded with the LAME MP3 encoder. The collected information is saved to the log folder under the filename %DATE% _ %TIME%.snm.This module is responsible for recording Skype audio chats. In order to record Skype calls, the module uses a legitimate interface, called the Skype Desktop API. When a third party application is about to use this API, the Skype messenger displays a warning, which asks the user to allow the access. To bypass this Skype security feature, the Prikormka module creates a thread that attempts to find the window and click the “Allow access” button programmatically, without human interaction.Figure 25. The warning displayed by Skype.The strings and some code fragments in this Prikormka module suggest that the implementation of this module was partly borrowed from the code published on the website openrce.org in 2006.Operation Groundbait: Analysis of a surveillance toolkit19After encryption, the original (but not the encrypted) files are deleted. Results of the encryption are stored in the following files:• %USERPROFILE%\AppData\Local\MMC\ipl • %USERPROFILE%\AppData\Local\MMC\kplThe encrypted content is additionally encoded with the base64 algorithm. Inter- estingly, before the content starts, the module puts an additional signature there:Figure 26. The string CREATE APPLICATION minishell suggests copied-and-pasted code.The collected information is saved to the log folder using %DATE% _ %TIME%.skw and _ skype.log filenames.LOGS_ENCRYPTER moduleFigure 27. The “atKsoft” signature at the beginning of encrypted log files.This module is responsible for log encryption. The module compresses data via the LZSS algorithm and encrypts the following log files with Blowfish:We have not found any legitimate application which can read such files or any other meaning of this mysterious “atKsoft” signature.• %USERPROFILE%\AppData\Local\MMC\inf • %USERPROFILE%\AppData\Local\MMC\fsh • %USERPROFILE%\AppData\Local\SKC\*.scrsh • %USERPROFILE%\AppData\Local\SKC\*.snm • %USERPROFILE%\AppData\Local\SKC\*.skw • Files listed in %USERPROFILE%\AppData\Local\MMC\ierdir.datThe file ierdir.dat is created by the CORE module; it contains an encrypted list of files requested by attackers to upload from victim’s computer.Operation Groundbait: Analysis of a surveillance toolkit20GEOLOCATION moduleThis module is responsible for geo locating the infected computer. Unlike other modules, this module is written in the C# programming language. This module collects information about currently available WiFi networks, including Service Set Identifier (SSID) and MAC-address. Afterward, the module makes a request to the Google service, providing collected information as parameters; the Google service response contains the possible location based on the information supplied.The collected information is saved to the log folder under the filename geo%DATE%.inf.The binary of the GEOLOCATION module has a PDB-path; the structure of this path is similar to the PDB-path of the DOWNLOADER module:Figure 29. The PDB-path discovered inside the GEOLOCATION module.OS_INFO moduleThis module is responsible for collecting information about the infected computer.The following information is collected by this module:• Battery info for Notebooks• Windows OS version• Computer name and User name•IP Addresses and MAC Addresses• Physical memory• Available disk drives• Available printers• Desktop resolutionFigure 28. Traffic captured from Prikormka malware's GEOLOCATION module.•Installed antivirus softwareThe module uses Windows API functions in order to collect this information. The collected information is saved to the log folder under the filename %DATE% _ %TIME%.inf.Operation Groundbait: Analysis of a surveillance toolkit21PASSWORDS moduleFILE_TREE moduleThis module is responsible for collecting passwords stored in applications installed on the infected computer.The module gathers the application version, logins and passwords stored in the following applications:• Google Chrome• Opera Browser• Yandex Browser• Comodo Dragon Internet Browser• Rambler Browser (Nichrome)• Mozilla Firefox• Mozilla ThunderbirdFor some reason, this module does not collect passwords for Microsoft Internet Explorer and Microsoft Edge browsers. Because the Yandex Browser and the Rambler Browser are popular mostly in Russian speaking countries, we think that it indicates that this module was designed for use against users located in such countries.The collected information is saved to the log folder under the filename %DATE% _ %TIME%.inf.This module is responsible for collecting information about the file system of the computer's fixed drives, including paths of files with specific file extensions, their size and creation time. The actual content of the file is not collected by this module.The attackers are interested in the following file extensions:• Documents: TXT, DOC, DOCX, XLS, XLSX, PPT, PPTX, PDF• Archives: ZIP, RAR• Databases: DB, SQLITE• The Bat! email client: TBB, CFG, CFN, TBN, TBB• Microsoft Outlook: OST, PST• Other: DAT, WAV, EXESince The Bat! email client is popular in Russian-speaking countries, the fact that malware is focused on file extensions associated with this email client is another indicator that the malware is created with the intention of using it against Rus- sian-speaking users.It should be noted that the list of all file extensions does not represent the list found in any particular sample. This list contains all the possible file extensions that we observed in different versions of the FILE_TREE module. The attackers might build a custom version of this module for a specific victim. The collected in- formation is saved to the log folder under the filename %DATE% _ %TIME% _ tree. inf. Some binaries of FILE_TREE modules have PDB-paths; one such path reveals the username of the malware writer.Figure 30. A PDB-path discovered inside a FILE_TREE module.Operation Groundbait: Analysis of a surveillance toolkit22C&C serversDuring our investigation we obtained access to an Operation Groundbait C&C server that was misconfigured and allowed a public directory listing.During our research into Operation Groundbait we have observed a number of C&C server domain names and IP addresses. Most of them are located in Ukraine and are hosted by Ukrainian hosting providers. Appendix B contains a more com- prehensive listing.One of the C&C servers, gils.ho[.]ua has been in operation since 2008, accord- ing to information from the hosting company. In order to hide their illegal activity, the attackers created a bogus website. The website is dedicated to the capital of Ukraine—Kiev.Figure 32. Operation Groundbait C&C serverdirectory listing.Figure 33. The internal directory structureof a subfolder.At one point, the root directory contained 33 subdirectories, with an individual folder for each victim. This means that the server was used to control 33 Priko- rmka-infected computers. The name of each sub-folder contains an Operator ID, a Campaign ID and the architecture of the infected device.Each folder contains two sub-folders with the following names: data and util. The first folder contains encrypted exfiltrated data and the second folder has encrypted Prikormka modules.Figure 31. Bogus website created by attackers.Operation Groundbait: Analysis of a surveillance toolkit23In addition to the data and util folders, each victim-specific subfolder contained two plain-text log files: journal and log, revealing interesting findings about the malware operators and their victims.The log file contains the communication log between the server and the infected computer: specifically, the IP address of the infected computer, date and time, type of request (GET or POST), the size of request, and the status of Prikormka modules (in cases where it is a GET request).Figure 34. The content of one log file located on the Operation Groundbait C&C server.The journal file contains the communication log between the server and the malware operator. The communication log contains the IP address of the operator, the date, time, and type of request. It should be noted that once downloaded by the malware operator, the file with exfiltrated data gets removed from the server.Figure 35. The content of the journal file located on an Operation Groundbait C&C server.According to our analysis of the communication logs from one server there were 33 victims, located mostly in Eastern Ukraine. In addition to those, there were a few victims located in Russia or in Kiev, Ukraine.The analysis of logs revealed that several malware operators connected to the server using various internet service providers in Kiev and Mariupol. Some of them accessed the C&C via the Tor network.Operation Groundbait: Analysis of a surveillance toolkit24AttributionIn this section we make an attempt to identify the origin of the threat based on clues that were intentionally or unintentionally left by the attackers:• Most of Prikormka's C&C servers are located in Ukraine and hostedby Ukrainian hosting companies• The group behind this threat has fluent knowledge of the Russianand Ukrainian languages, as evidenced by text in the decoy documents and malware binaries• Some of the PDB-paths revealed that attackers used directories withnames in Russian• All analyzed Prikormka droppers contained language codes that correspond to Ukrainian (hexadecimal code 0x0422) or Russian (0x0419) languages in their PE resources (Figure 37)• The compilation timestamps of Prikormka binaries suggest that themalware authors operate in the Eastern European time zone• According to C&C server logs, a number of malware operatorsparticipating in Operation Groundbait have been making connections through various internet providers in two Ukrainian cities: Kiev and Mariupol.42droppers with Russianlanguage codes49droppers with Ukrainianlanguage codesFigure 36. The language codes distribution between droppers.Operation Groundbait: Analysis of a surveillance toolkit25Interestingly, the droppers from earlier period (2012-2015) do contain resources with Russian language codes. The malware authors gradually switched from Rus- sian to Ukrainian in the mid of 2015.We can deduce from this that the malware authors work from 6.00 to 16.00 (UTC), sometimes staying late in the evening. This corresponds to the period 8.00 to 18.00 Eastern European Time, which would include normal Ukraine working hours.Based on our research and the abovementioned facts, we conclude that the at- tackers behind Operation Groundbait are people with an interest in surveillance or spying on separatists in the Donetsk and Luhansk regions and a few specific high-profile targets, including Ukrainian politicians. The malware operators and/ or authors have a knowledge of the Ukrainian and Russian language, and likely operate from within Ukrainian borders.Figure 38 depicts the distribution of the compilation hour of Prikormka samples.36363129242525211712120 0 1 0 1 27 743 20 1012345678910111213141516171819 20 2122 23Figure 37. Samples sorted by hour (UTC).Operation Groundbait: Analysis of a surveillance toolkit26ConclusionOur research into these attack campaigns and the Prikormka malware itself sug- gests that this threat is the first publicly known Ukrainian malware that is being used in targeted attacks.In terms of technical advancement, the attackers didn’t demonstrate any sophis- ticated methods or novel techniques. But whether an attacker uses sophisticated methods or not does not matter as long as they reach their ultimate goal: stealing the sensitive information they need from their targets.The most noteworthy achievement accomplished by the attackers behind Operation Groundbait is that they have stayed under the radar for over 7 years. The malware has been seen in the wild since at least 2008. This finding is con- firmed by the timestamps of binaries, ESET telemetry, and by hosting providers used.Operation Groundbait is, after BlackEnergy and Operation Potao Express, yet another demonstration that that using highly targeted malware for espionage amidst an armed conflict is an everyday reality.Indicators of Compromise (IOC) that can be used to identify an infection can be found in Appendix B or on github.For any inquiries or to make sample submissions related to the subject, contact us at: threatintel@eset.comOperation Groundbait: Analysis of a surveillance toolkit27CreditsSpecial thanks to @TheEnergyStoryOperation Groundbait: Analysis of a surveillance toolkit28APPENDIX A. Details Of Prikormka CampaignsPT Time stamp (UTC) Apr 19 09:11:27 2012Campaign ID N/A (corrupted)Malware Operator ID N/APT Time stamp (UTC) Jul 05 06:21:49 2015Campaign ID LminfinMalware Operator ID 7Jul 25 08:31:32 2012Sep 13 08:21:54 2013Mar 12 15:17:23 2014Jul 15 12:18:51 2014Oct 03 08:57:13 2014Nov 05 07:56:00 2014Nov 05 19:30:35 2014Nov 13 10:20:10 2014Nov 25 15:12:31 2014Dec 01 08:07:07 2014Dec 05 13:11:35 2014Jan 31 13:19:22 2015Feb 10 18:31:49 2015Feb 19 15:51:33 2015Mar 02 16:23:42 2015Mar 11 08:43:12 2015Mar 23 12:46:24 2015Mar 23 16:03:19 2015Apr 10 12:26:20 2015May 06 06:08:52 2015May 24 08:46:38 2015Jun 11 14:59:45 2015Jun 21 15:36:24 2015Jun 26 13:25:22 2015Jun 29 06:19:36 2015Jul 01 12:42:04 2015SKtMNaPgksAbkW_zp7azmaPsephmod1ffhmyr31ii1voPgad5PkofPtropl01u001AsapP647Plg8_W_cu6aPod13_AsteMVD_LNR_kontaktr03u0002Dmindoh_zbr03u0002N/AN/AN/AN/AN/AN/AN/AN/AN/AN/AN/AN/AN/AN/AN/AN/AN/AN/AN/AN/AN/AN/A7N/A7N/AJul 09 14:48:56 2015Jul 16 14:29:29 2015Jul 16 14:55:50 2015Jul 16 15:03:59 2015Jul 18 04:35:41 2015Jul 18 05:07:50 2015Jul 19 07:41:54 2015Jul 19 08:11:26 2015Jul 20 17:51:04 2015Jul 21 06:08:53 2015Jul 26 19:17:52 2015Jul 26 19:22:27 2015Aug 07 09:23:57 2015Aug 14 06:11:43 2015Aug 17 17:58:58 2015Aug 17 18:32:51 2015Aug 22 11:35:37 2015Aug 28 13:42:34 2015Sep 03 12:02:35 2015Sep 24 16:39:43 2015Oct 13 10:52:47 2015Oct 13 11:54:58 2015Oct 14 06:55:23 2015Oct 21 12:56:05 2015Oct 21 19:33:21 2015gmLmgbLrodDmoLsck3DmoPMil_6PLmgb2PsekmediumMDLV2OSCEBOY_DBURRBxMRV1D_00732D_xxxzkonvL_mgbR_pol_xRF_lgmLKos_xxK83_moDLB3Oct 22 08:48:26 2015DLB_sgrish177777N/AN/A73771277N/A77N/A77771077Operation Groundbait: Analysis of a surveillance toolkit29PT Time stamp (UTC) Mar 22 15:25:59 2016Apr 08 12:13:20 2016Apr 18 11:10:21 2016Apr 27 12:40:46 2016May 05 11:42:54 2016Campaign ID sgukievavlL_ukrBpuhL_gpMalware Operator ID 116767PT Time stamp (UTC) Oct 29 14:00:05 2015Campaign ID FSfarmMalware Operator ID Indicators of Compromise (IoC)Users of ESET security software are fully protected from the Prikormka malware described in this paper. Additionally, ESET will provide further information regard- ing this threat to any individuals or organizations that may be infected – either currently or in the past.Contact email: threatintel@eset.comOperation Groundbait: Analysis of a surveillance toolkit31ESET detectionsWin32/Agent.UIG trojan Win32/Agent.XOR trojan Win64/Agent.XOR trojan Win32/Agent.XQX trojan Win32/Agent.XRA trojan Win32/Agent.XRB trojan Win32/Agent.XRC trojan Win64/Agent.DX trojan Win32/TrojanDropper.Agent.RGH trojan Win32/TrojanDropper.Agent.RHN trojan Win32/Prikormka trojan Win64/Prikormka trojan MSIL/Prikormka trojanHost-based%PROGRAMFILES%\IntelRestore\ %USERPROFILE%\Resent\roaming\ocp8.1\ %USERPROFILE%\AppData\Local\MMC\ %USERPROFILE%\AppData\Local\PMG\ %USERPROFILE%\AppData\Local\SKC\ %USERPROFILE%\AppData\Local\CMS\ %USERPROFILE%\AppData\Local\VRT\ %USERPROFILE%\AppData\Local\ioctl\ %WINDIR%\ntshrui.dll %WINDIR%\hauthuid.dll %WINDIR%\hlpuctf.dll %WINDIR%\atiml.dll %WINDIR%\iomus.dll %WINDIR%\swma.dll %WINDIR%\helpldr.dll %WINDIR%\rbcon.ini %USERPROFILE%\AppData\Local\CMS\krman.ini %USERPROFILE%\AppData\Local\VRT\ _ wputproc.dllMutexesZxWinDeffContexLNKINFO64 Zw _ &one@ldrContext43 6B53A3A3CB9D87D5925C82839015DAD16042C2FFPrikormka early versions:1B8BC6924F4CFC641032578622BA8C7B4A92F65E 539033DE14539D485481549EF84C9E49D743FC4COperation Groundbait: Analysis of a surveillance toolkit33Prikormka PERSISTENCE modules:AD9A6F7BA895769844663B4936E776239D3A3D17 FCD81737FF261A84B9899CB713933AA795279364Prikormka DOWNLOADER modules:D12CD6C4CA3388B68FCF3E46E206064CAA75F893 35159C96F695B96773C5C1DCF8206DBE75A83D86Prikormka CORE modules:2A64606DB1DB872E7176F0C6C3FF932E2146BFC9 6AE2C768D932EDA538983DD7A50CF7DE14BF54D2Operation Groundbait: Analysis of a surveillance toolkit34BE73A2C17AAE689BC1A20761850374636B67BF0F 12ACC64605D4FE2F3CEEEFBD0A7C4FD655E6AEAAPrikormka DOCS_STEALER modules:BA434FB6169E8A1785E353EEBF9B907505759A07 652B012E0ACACB78221CAA7A3C3EE461F07264EAPrikormka KEYLOGGER modules:BFDCD0A3F7495C43D8D42B4272BDC90695DC44D7 DE966273DD5AD4DAA01562109932EBD39A13A5A2Prikormka SCREENSHOTS modules:645DFA35E41F6442793CF7647A75956E05563DE8 AD74ABEA34A20D0196A152E6668E3C29135B22D4Prikormka MICROPHONE modules:FCE83DF7018A49072F9A28A8E135EB00C011D9EB 2C76974722287C7CDB0FCA2BC6CCEDEE62E77D24Prikormka SKYPE modules:C3AA3DBD33751F85002F2F65562098F516737435 6C24E244A0DDA2CADED4D1B5CC8B820A46DC19F4Operation Groundbait: Analysis of a surveillance toolkit35Prikormka LOGS_ENCRYPTER modules:Prikormka FILE_TREE modules:3EDD14E6FA0297ED3162D7F119D8D126662ED28B 2BD3FE012486BD89C87858CC4C3DC9D86742738CPrikormka GEOLOCATION modules:50CCCD576A815AC8EFFB160A628646C876DF8CB0Prikormka OS_INFO modules:4B8EE967F44ECA2EEB3B8420A858CECFE0231208 6C902496AC1FEF60D343B03822F49DB5F66BE038Prikormka PASSWORDS modules:B986114C5173052FCB9583A55D5099D99B709352 17F5E1FC52D6C617CD81B0983B70FAC7A60F528COperation Groundbait: Analysis of a surveillance toolkit36 