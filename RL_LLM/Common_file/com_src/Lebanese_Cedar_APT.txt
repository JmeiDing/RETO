“Lebanese Cedar” APTGlobal Lebanese Espionage Campaign LeveragingWeb ServersJanuary 2021TLP:WHITE(C) All rights reserved for ClearSky Cyber Security ltd 2021www.clearskysec.com info@clearskysec.com____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE1 | P a g eTable of ContentsIntroduction 3Current Toolset 8MITRE ATT&CK Categorization 9Modus Operandi 11Installation & C&C 12Customized WebShell – "Caterpillar" 2.0 13WebShell Containing Modules Taken from Iranian Hacktivist Groups 17Open-Source WebShell Obtained Online 19Open-Source Management Panels 19The "Explosive" Custom RAT 20Anti-Debugging 21New Modules 21Communication with C2 over SSL 21Attribution 22Summary and Insights 24Indicators of Compromise 25Hashes 25____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE2 | P a g eIntroduction Lebanese Cedar is an APT group that has been operating for almost a decade attacking companies and organizations around the world.The group's main attack vector is intrusion into Oracle and Atlassian WEB servers. We assess that the intrusion into these systems was done by exploiting known vulnerabilities in systems that were not patched and detecting loopholes using open-source hacking tools.In early 2020, suspicious network activities and hacking tools were found in a range of companies. Comprehensive forensic research of the infected systems revealed a strong connection to Lebanese Cedar and a new version of the "Explosive” V4 RAT (Remote Access Tool) or "Caterpillar" V2 WebShell was found within the victim’s networks.Lebanese Cedar TimelineBased on a modified JSP file browser with a unique string that the adversary used to deploy ‘Explosive RAT’ into the victims’ network, we found some 250 servers that were apparently breached by Lebanese Cedar. Our report reveals a partial list of the companies that the group has attacked. The target companies are from many countries including: The United States, the United Kingdom, Egypt, Jordan, Lebanon, Israel, and the Palestinian Authority. We assess that there are many more companies that have been hacked and that valuable information was stolen from these companies over periods of months and years.Lebanese Cedar APT has been operating since 2012. These operations were first discovered by Check-Point researchers and Kaspersky labs in 2015. Since 2015 Lebanese Cedar APT - also referred to as “Volatile Cedar” – maintained a low profile and operated under the radar. According to Check-Point’s report, the group is motivated by political and Ideological interests, targeting individuals, companies, and institutions worldwide. We endorse Check Point’s strong case attributing Lebanese Cedar APT to the Lebanese government or a political group in Lebanon. Moreover, there are several indications that link Lebanese Cedar APT to the Hezbollah Cyber Unit1.1 url © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE3 | P a g eKnown for its highly evasive, selectively targeted, and carefully managed operations, Lebanese Cedar follows courses of action associated with Advanced Persistent Threat groups (APTs) funded by nation- states or political groups.“Caterpillar WebShell” was found in most of the victims we investigated, in many of the systems we also found traces of “Explosive” RAT. We identified the specific open-source JSP file browser2 that was modified for the hackers’ purposes. We found that Lebanese Cedar deployed the payload of Explosive RAT into the victims’ network. Lebanese Cedar is the only known threat actor that uses this code.These files were installed on the victims’ Oracle servers, thus exposing them, and enabling hackers to install new files within the server. We used the same pattern and the unique strings of a publicly available JSP file browser to detect infected servers. To identify the targets, we queried public-facing web servers of Oracle 10g for specific directories and filenames, including the unique hash of the file we identified in the compromised network, that included the unique strings of Lebanese Cedar.The operation enabled us to fingerprint the targets of Lebanese Cedar APT and categorize them based on sector and country of origin. We identified 254 infected servers worldwide, 135 of them shared the same hash as the files we identified in the victims’ network during our IR investigation. Some of the servers represent countries that were attacked – among them, many Middle Eastern countries (most of them in Egypt, Saudi Arabia, Israel, and Jordan) – and others represent hosting servers hacked by the APT. A map of all the servers we identified during our scan is presented below:2 url © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE4 | P a g eMost of the victims we identified are from the Telecommunications and IT industry, Hosting providers, Communications companies and Managed Hosting and Applications companies. Examples of telecom providers whose servers were observed in our scans and share the same hash as the one we identified in the IR investigation include the following:CountryUnited StatesUnited KingdomEgyptSaudi ArabiaVictims’ examples Oklahoma Office of Management & Enterprise ServiceSecured Servers LLC Frontier Communications Iomart Cloud Services LimitedTE Data Middle East Internet Company LimitedDetails about the company A government agency which manages and supports the basic functioning of the government of OklahomaWeb hosting and infrastructure solutions American telecommunications company A company managed infrastructure, data protection, security, and connectivity solutions to help business transformation Internet service provider Mobile network operator Telecommunications services company Telecommunications services company Telephone voice and data communications services____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE5 | P a g eCountryVictims’ examples Arabian Internet & Communications Services Co.ltd Vtel Holdings Limited/Jordan Co. National Information Technology CenterJordanJordanian Universities Network L.L.C.Details about the company Telecommunications services companyTelecommunications service provider Data storage, sharing computing resources, email/internet, and website hosting Private organization aimed to serve public and private universities in Jordan through shared services framework modelUnited Arab Emirates Palestinian AuthorityEtisalat HadaraTelecommunication Group Company Internet ServicesIn our analysis, we identified two types of JSP files with the unique string – test.jsp, that was installed in the servers between 2018-2019 and yup.jsp that was installed in the servers after 2020. In most cases, the files were installed on the following four dates: January 24th, 2019, January 06th 2020, February 25th, 2020 and August 3rd, 2020. The files were installed simultaneously on multiple ports that redirect to the Oracle server. The focus on both specific victims and common dates, leads to the conclusion that Lebanese Cedar specifically target their victims, and install the malicious files with automatic scripts.An example for the JSP file browsers installed in one of victims’ oracle server.The oracle servers that the group accessed are still open. This allows other hackers and criminals to attack these networks and view and access all the files in the server (including deleting and downloading them).Although we assume that the group kept operating since it was exposed in 2015, we could not find any evidence supporting this assumption. It appears that during the past five years, the group successfully____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE6 | P a g eremained unnoticed by the security community. ClearSky analysts have several assumptions as to how the group had managed to maintain a consistently low profile:• The utilization of common WebShell as the group’s primary hacking tool, while rarely using othertools, led researchers to a dead-end in terms of attribution.• Lebanese Cedar has shifted its focus significantly, initially they attacked computers as an initial point of access then progressed to the victim’s network then further progressing to targeting vulnerable, public facing web servers. Among these, the most commonly attacked server is a vulnerable version of an Oracle web server.• Known for its ‘radio silence’ periods, the group had probably ceased its operations for long enoughto avoid researchers’ attention.____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE7 | P a g eCurrent Toolset Lebanese Cedar APT’s arsenal consists of a fully-fledged WebShell, a custom-developed RAT and a set of carefully selected complementary tools, including URI brute force tools. The group uses open-source tools alongside their own custom tools, including custom WebShell, most likely created by Iranian hacktivist groups such as ‘ITSecTeam’ and ‘Persian Hacker’. The nature of the relations between Lebanese Cedar and these groups is still vague.Most of the tools deployed in the recent campaign were developed by the group itself. In addition, some more common tools have been used. The tools used by the group can be divided into the following categories:1. Self-developed tools – tools tailored for the attack process of Lebanese Cedar APT only.o Caterpillar 2.0 by N.T – Self developed WebShell embedded in the victims’compromised servers.o Explosive – Remote Access Tool (RAT) that has been used by this threat actor since 2015and was modified over time to include new features.2. Open-source tools – tools available online used by the group. In this category, we include theWebShell’ code that was embedded in Caterpillar V2, as well as the following.o Web hacking tools▪ GoBuster – a tool used to brute-force website URIs (directories and files), DNSsubdomains (with wildcard support) and Virtual Host names on target web servers.▪ DirBuster – a multi-threaded java application designed to brute force directoriesand file names on web and application servers.o WebShell▪ Open-source WebShell and Management GUIs• JSP file browser - allows remote web-based file access and manipulationand deploys the Explosive RAT to the system.• SharPyShell – an obfuscated ASP.NET WebShell that executescommands received by an encrypted channel compiling them in memory at runtime and deploys a privilege escalation tool. • ASPXspy – provides control over a compromised web server. • Adminer (formerly phpMinAdmin) – a full-featured databasemanagement tool written in PHP.▪Iranian based WebShell•ITsecTeam WebShell – a WebShell formerly used by the hacking group ITsecTeam, embedded in Caterpillar 2.• Mamad Warning Sheller – a WebShell used by the Persian Hackerhacktivist group, similar to Caterpillar but less functional.____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE8 | P a g eo Privilege escalation tools▪ RottenPotato – Local Privilege Escalation tool from Windows Service Accounts toSYSTEM.▪ JuicyPotato - Local Privilege Escalation tool from a Windows Service Accounts toNT AUTHORITY\SYSTEM.MITRE ATT&CK CategorizationThe following is a table that presents the Lebanese Cedar APT TTP’s as observed in recent operations:Kill Chain Phase ToolsTTPs sub-CategoryCensys ExploitationWeb Hacking - URI (1 day)GoBuster Atlassian Confluence Server CVE-2019-3396 Atlassian Jira Server or Data Center CVE-2012-3152Installation and C&CWebShellASPXSpy CaterpillarMITRE ATT&CK Tactic: Technical Information Gathering ID: TA0015 Techniques: Determine 3rd party Acquire OSINT data sets and Technique: File and Directory Discovery ID: T1083 Tactic: Initial Access ID: TA0001 Technique: Exploit Public-Facing Technique: Data from Information Repositories: Confluence ID: T1213.001 Server Software Component: WebShell ID: T1505.003Caterpillar OPERATE LegitimateOpen SourceOpen Source Iranian____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE9 | P a g eMamad Warning ShellerJSP file browser3Database Management ToolAdminerPost-Exploitation FrameworkSharPyShellRemote Access Trojan (RAT)ExplosiveHacktivist LegitimateOpen SourceCustomTactic: Collection ID: TA0009 Technique: Data from Local System ID: T1005 Tactics: Privilege Escalation ID: TA0004 Discovery ID: TA0007 Tactic: Build Capabilities ID: TA0024 Technique: Remote Access Tool development ID: T1351 Fallback Channels ID: T10083 url © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE10 | P a g eModus Operandi Lebanese Cedar APT conducts their attack to reach a wide range of targets. We observed a highly selective targeting process that points to extensive reconnaissance efforts. Knowing that the group scans public- facing web servers for known vulnerabilities, we deduce that Lebanese Cedar, like other attackers, uses public tools such as Shodan, Censys and ZoomEye. We have no indication of active vulnerability scanning against our clients in this context. At the same time, the attackers utilize URI Brute Force tools such as GoBuster and DirBuster to identify open directories that could be used as a platform for WebShell injection.At the exploitation stage, the attackers exploit vulnerabilities to gain access to the web server. Our research indicates a regular use of critical 1-day vulnerabilities based on the vulnerable versions of the services in version. In these cases we cannot determine whether one-day vulnerabilities or web-hacking techniques were used. We suppose that the likelihood that zero-day vulnerabilities were used is very low. We assess that the adversary exploits a few different vulnerabilities in Oracle 10g servers, as can be presented from the victims’ map.At the injection stage, there are two main attacking vectors:•‘Caterpillar 2’ WebShell Installation• JSP File Browser and deploying ‘Explosive RAT’Acting as a focal point, the group usually attacks web servers via a custom WebShell, namely Caterpillar – a variant of the open source WebShell ‘ASPXspy’. By using WebShell, the attackers leave their fingerprint on the web server and the internal network, move laterally, and deploy additional tools. On each compromised network the attacker installed one or more WebShell, supposedly to gain persistence and diversify the use of similar tools. The attackers use the WebShell to communicate with their C&C server for running commands and exfiltrating sensitive information. Connection to the WebShell is made using NordVPN or ExpressVPN services.The attacker installed a modified version of ‘test.jsp’ or ‘yup.jsp’ file browser on the servers of victims that the group to deploy its custom RAT – Explosive. We assess that the attackers use both WebShell and RATs. In our research, we found that Caterpillar 2.0 WebShell was used more often than the Explosive RAT.Deployment of the Explosive RAT provides the attackers with higher visibility and functionality at the endpoint level. The malware executes commands such as keylogging, screenshot capture and command____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE11 | P a g eexecution. Explosive utilizes multiple evasion techniques to avoid detection and maintain persistence, such as obfuscation, communication encryption and using a separate DLL for API activity. Since 2015, the tool had been minorly changed in obfuscation and communication encryption. The RAT’s control network is well thought out. It consists of default hard-coded C&C servers, static update servers and DGA-based dynamic update servers.Installation & C&CThe primary attack vector utilized by the Lebanese Cedar group is taking over a target organization’s vulnerable web server by exploiting a security flaw, followed by a WebShell installation. Once the WebShell is installed, the attacker establishes a connection over HTTP using compromised credentials and activates the WebShell modules via a visual GUI.Each of the WebShell modules has several key functions, primarily designed to obtain escalated privileges (LPE), and perform a variety of espionage functions, such as file password theft within the target network. The WebShell is a key component of the attack process - it replaces the need for installing a RAT in the compromised machine. The WebShell is used to execute remote commands within the target network and escalate privileges. However, in some cases a RAT (Remote Access Tool) and an LPE tool (Local Privilege Escalation) had been observed in the victims’ network in addition to the WebShell.The WebShell we observed can be divided into three categories:1. Custom-made WebShell2. Existing WebShell3. Open-source WebShell____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE12 | P a g eWe estimate that the primary WebShell utilized by the Lebanese Cedar APT is “Caterpillar” V2. In some cases, when extensive operations within the target network are required, the attackers use Yup.jsp to install a RAT for remote activities. Other WebShells are used mainly to assure persistency and redundancy.Some of the WebShells we traced contain code snippets associated with tools used by Iranian hacktivist groups such as “Iranian Hacker”4 and “ITSecTeam”. While we are unable to determine the nature of the relationship between these groups and the Lebanese Cedar APT, we find it important to highlight this connection, as it may point to a connection between the APT, which is associated with Hezbollah, and the Iranian regime.Customized WebShell – "Caterpillar" 2.0 As previously indicated, Caterpillar Shell 2.0 by N.T is the main WebShell in the Lebanese Cedar APT attack infrastructure. It is a WebShell written in Visual Basic. First observed in 2015, the WebShell is used to carry out various espionage operations over the attacked web server, including potential asset location for further attacks, file installation server configuration and more.According to our findings, the group currently uses the WebShell’s second version, which is characterized by the ASPX file type, unlike the first version, that used both ASPX and ASP file types. The WebShell can be found within the target file by its original name ‘Caterpillar.aspx’ or alternatively, less prominent names such as 405.aspx, resume.aspx and more.Screenshot from an exposed WebShell found in a Saudi website, showing the connection to “Caterpillar”While accessing the WebShell, the attackers are prompted to type a designated user and password, usually embedded within the source code of the file as an md5 hash. In many cases, duplicate user and password were observed.Screenshot from the GUI of Caterpillar WebShell4 BAX26____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE13 | P a g eAs can be seen above, the management panel of the WebShell is divided into four module groups:• Operate – modules that run on the compromised server, such as file download and upload, file search and more. These modules are used to install further malware or attack tools for privilege escalation. Among these modules is “RottenPotato”.• Go To – modules used to select the desired hard drive among those installed on the compromisedserver.• Database - two modules used to control datasets; only one of them is currently functional.• Tool – the broadest module group, that enables the attackers to characterize the currentworkspace and perform actions for lateral movement, command execution and more.Each WebShell module has several properties. First, the technical properties – the module’s form ID, the http request (GET/POST) used by the attackers to communicate with the server in every command, and the designated parameters of the desired URI. Then, verbal instructions will be displayed. The instructions contain explanations about the module and the parameters the attacker must fill in order to execute commands, or in some cases attacks. Our research of the “Caterpillar” WebShell, uncovered modules that were fully copied from other sources. These modules were attached a note such as “This function has fixed by Tatra has not detected” as well as a date, in this case, from 2009. These notes enabled ClearSky researchers to identify the names of three developers involved in writing the tools used by the Lebanese Cedar APT - Nido, Zero Lord and Tatra.In the following chapter, we present a review of the module groups, including a description of the modules and a summary of the parameters of each of them.OPERATE ModulesOperate is a module group used to perform various espionage functionalities such as file creation, file download and upload, file search in selected hard drives (Chosen via the ‘Go To’ module group) and file download from external links.Screenshot from the Operate module groupScreenshot showing a file download process from an external link, such as an embedded websiteGUI Input parameter Webshell Module DescriptionAction (URI)-Creating new file or directory?action=newHTTP Request POSTForm ID (Webshell Module)New____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE14 | P a g eFilePaste information to the directory Search term (String) A link to a file on a computer to the directory ?action=paste?action=upfilePOSTUpLoadFilePOSTPastePasteSearch File in the directory Download file from the directory?action=search ?action=gotoGo to a file's directory Go to Document and Settings folder Go to Temp folderDATABASE ModulesPOST Documents and SettingsPOSTTempThe Database module group is responsible for the management of datasets on the server infected with the WebShell, or alternatively, datasets accessible via the WebShell.Screenshot from the Data Base module groupWebShell Command Description Connect to a Database serverAction (URI)Method?action=DbManagerGETForm ID (WebShell Module) Dbase ManagerInput parameterServer Name (IP) StringRead databaseUser list (embedded in the code)Connect to a SQL server from a user listPOSTRead DB ManagerGETUser SQL Enum Login?action=ReadDbMana LoginTOOL ModulesThe Tool module group is responsible for executing commands over the compromised server, selected by the attackers to gain persistent access to the server and the organizational network, perform reconnaissance activities and execute modules related to gaining control over the network. This module group contains functions similar to those of a RAT (Remote Access Tool).Screenshot from the Tool module groupIt is the broadest module group, containing 25 modules divided into the following categories:____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE15 | P a g e1. Server & Network Fingerprinting - Modules used to obtain information about the compromisedserver and network.2. Rootkit and server command execution modules - Modules used to perform a variety of actionsover the network servers3. Network Shell creation - Modules feature the Shell Connection module, meant to enable attackerto create a Network Shell4. Network server’s brute forcing – Modules used to preform brute force attack against a verity ofusers and servers over the networkInput ParameterWebShell Command DescriptionAction (URI)HTTP RequestForm ID (WebShell Module)Server & Network FingerprintingUsername --IP-General information name, IIS version, IP address and more List of Processes List of Services List of User Accounts Port ScannerLogs of running List of Local Group of users User home directory Scanning sub-net assets Change the label of an FTP server?action=informationGETSystem info?action=pro ?action=PortScan?action=applog?action=syslog List user accounts PORT ScanApplication Event LogSystem Log IIS List Anonymous Local Group?action=homedirectoryGETUser Home Directory?action=HttpFinger?action=GetNTPC?action=FtpSwitchGETGETGETHttp FingerGetNetworkComputersFtp SwitchFTP Server IP Rootkit and Server Command Execution Modules____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE16 | P a g eWebShell Command Description Run commands in SQL Server (local/remote)Run commands on remote serverAction (URI)?action=sqlrootkitHTTP Request POSTForm ID (WebShell Module) SqlRootKit?action=adminrkPOSTAdminRootKitInput ParameterUsername CommandRun commands on the compromised asset with CMD ?action=clonetimeNetwork Shell Creation ?action=RvConnectBruteForcePOSTCMD*POST POSTRegistry Shell Clone Time-Shell ConnectionCommand line Rework file or Dir Copied Filed or DirChange Registry Key Copy files to another Source basedOpenOpenOpenBrute Force on a user on server Brute Force on an FTP server Brute Force on an POP3 server?action=UserEnumLoginPostUser Enum Login?action=FtpBrute?action=POP3BrutePostPostFTP BrutePOP3 BruteWebShell Containing Modules Taken from Iranian Hacktivist Groups "Caterpillar" variant - ITSecTeam ModuleOne of the WebShells we found in our research is a variant of the “Caterpillar” WebShell that contains an additional module, taken from a WebShell developed by the known Iranian hacktivist group ‘ITSecTeam’. The module, named ‘ITSecTeam.WS’, is used by the Lebanese Cedar APT to deploy additional tools, including the ‘Explosive’ RAT.As mentioned above, the code snippet belongs to ‘ITSecTeam’ - a group associated with the IRGC (Iranian Revolutionary Guard Corps). The signature reveals that the code was written by an individual called ‘Amin Shokoni’, a member of the group. The group gained publicity from reports published by the United States Department of Justice – according to those, members of the group were convicted for conducting DDoS attacks against United States financial sector institutions between 2011-2013.____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE17 | P a g eThese WebShells point at the timestamp 07/07/2014. Please note that the date on the timestamp is hardcoded into the original code of the Caterpillar WebShell, as well as a specific URL.Screenshot from the ‘ITSecTeam’ moduleWe cannot determine why this code snippet had been embedded into the WebShell, and whether it was provided to Lebanese Cedar APT by ITSecTeam or obtained unknowingly.“Mamad Warning Sheller” WebShellDuring a response to a recent Incident, ClearSky researchers detected an ASPX file called ‘Pars.aspx’. An in-depth analysis of the file revealed that it is a WebShell developed by a hacker dubbed ‘Mamad Warning’. The WebShell name provides a basis for our assumption that the hacker is a member of the Iranian hacktivist group ‘Persian Hacker’ or ‘Iranian Hacker’, also dubbed ‘Pars’. This hacker has been actively defacing Middle East websites, often government owned.In September 2020, the United States Justice Department Indicted two hackers that are part of the group, for defacing websites world-wide with pro-Iranian messages, such as promoting Ghasem Soleimani’s photo. The first hacker is Mrb3hz4d from Iran, and the second is Mrwn007, allegedly a stateless national of the Palestinian Authority. Mamad himself was not indicted by the Justice Department, and we do not know if his origin is Iran, the Palestinian Authority or Lebanon. Unlike the other two hackers, Mamad is still active in ‘Iranian Hackers’, which also goes by the handle ‘Bax 026’5.The WebShell features three key modules:• BindShell – The module is almost identical to the ‘Shell Connection’ module of the “Caterpillar”WebShell, which had been reviewed in detail above.• Replicate – The module enables an attacker to create a new folder within the WebShell.5 url soleimani____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE18 | P a g e• Upload – The module enables an attacker to download files from their own machine or from aselected URL.Open-Source WebShell Obtained OnlineDuring our investigation, we found two open-source WebShell used by the attackers for various purposes. The first WebShell is called “ASPXSpy”. According to Check Point, this WebShell is the basis of the custom “Caterpillar” WebShell. The second WebShell we tracked is called “SharPyShell”. This WebShell enables the attackers to download a ‘Juicy Potato’ file to the compromised machine so as to obtain extended privileges.Further information about the “ASPXSpy” WebShell can be found in the hackingscripts 1 website. Further information about the “SharPyShell” WebShell can be found on GitHub2.Open-Source Management Panels We found two management web panels on the networks that we investigated, that allow the attackers to perform varied operations on the compromised servers and are not WebShell like those previously discussed in our report.AdminerAdminer is a web-based database management panel, capable of managing the following data sources - SimpleDB, Firebird, Oracle, MySQL, SQLite, PostgreSQL, MariaDB, MS SQL, Elasticsearch and MongoDB3.JSP File BrowserThe modified JSP file browser, mainly named test.jsp or yup.jsp is a variant of the management panel open source based JSP File Browser6. The system allows its users, in our case the attackers, web-based access and manipulation of files stored on a remote server, including uploading, copying, shifting, and even deleting files. The system also provides the ability to download new files to the server – in this case, the ‘Explosive’ RAT. The panel is the installed in 2 different paths, which helped us to identify these JSP files in the wild.The panel was found in GitHub, however, a code comparison between the tool found on the compromised server and the GitHub code revealed that the attackers have added an additional function to the system - CheckConUrl, which performs a file transfer over HTTP. We cannot determine if Lebanese Cedar created this function, however, we did not identify any other usage of this function that was not attributed to this APT. Therefore, we estimate that this file browser was edited by the group. Based on this edition, we were able to identify more servers world-wide that were attacked by the adversary. ‘test.jsp/yup.jsp’ is first injected to the compromised public-facing web server, and then used to deploy the ‘Explosive’ RAT.6 url © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE19 | P a g eThe code snippet of the new function added by the attackers to the systemThe "Explosive" Custom RAT‘Explosive’ is a RAT (Remote Access Tool) first revealed in 2015 by Check Point, in a report reviewing the activities of the Lebanese Cedar APT, referred to in the report is ‘Volatile Cedar’. The campaign probably began in late 2012, targeting carefully chosen individuals, companies, and state institutions worldwide, using a range of attack techniques, that revolve around the group’s custom-designed malware, Explosive. Explosive is implanted on the target server – a public facing web server - by the JSP file (WebShell) as the initial point of access to the target network and used to gather information.The malware’s data collection capabilities are both passive and active – it harvests data found on the compromised machine and features the ability to search for data on-demand. Explosive runs a keylogger on the compromised machine as of its installation and sends the data to the attackers via a C&C server. Its infrastructure includes both static and dynamic C&C servers. It also has multiple stealth and detection evasion capabilities – including a self-destruct mechanism - that can be activated upon command by its operators. Explosive also features functionalities such as machine fingerprinting, memory usage monitoring to assure stealth, remote shell, and arbitrary code execution.____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE20 | P a g eDuring our analysis, we identified only a few changes between the 2015 version of Explosive RAT and its current version. We identified three major changes: Anti-debugging methods, 2 new modules and encrypted communication between the compromised machine to the C2.Anti-Debugging The major add-on of the new version is the presence of multiple anti-debugging methods, part of which, are operating as a never-ending thread. First, Explosive will check the window name of each process. The RAT will search for a few debuggers, such as Immunity, Ollydebug and Phantom (We did not identify any search for IDA pro). Then, Explosive will run the function “IsdebuggerPresent” and will check for flags in the Process Environment Block.New Modules In our analysis, we were able to identify two new modules.1. NTCommand – Run a function named ReadSocket in the DLL module. Read.socket is a functionthat reads a string from the specified socket.2. RenF – Rename file in the system.Communication with C2 over SSL In CheckPoint’s report from 2015, they identify two communications methods: Communication over HTTP (Port 80) to a dynamic C&C server update server, and communication with a static update server. Moreover, the identified using of RAW TCP for communication with the C&C server. The URL and IP addresses were hard-coded stings in the explosive file.In our analysis, we found a new method – communication over HTTPS (Port 443). The data is encrypted with RC4 method. Similar to the original methods, the RC4 decryption key is a hard-coded string as well.Further information about the malware can be found in the CheckPoint’s technical report.____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE21 | P a g eAttribution Lebanese Cedar APT is a stealth threat actor, which is active for more than 8 years. In this report, we uncover the updated malicious activity of this threat actor in Israel and other countries world-wide. As presented in the map on the executive summary, Lebanese Cedar operates under the radar for more than 5 years, since the last report that covered their operation.We attributed the operation to Lebanese Cedar (also known as Volatile Cedar), mainly based on the code overlaps between the 2015 variants of Explosive RAT and Caterpillar WebShell, to the 2020 variants of these malicious files. We identified a high degree of similarity between the RAT we identified to the original Explosive RAT. On Intezer for example, 11 genes were identified as Explosive and 6 as Cedar. Examining the unique strings presents even greater similarity. For example, in 2015 Lebanese Cedar encoded their communication with the C2 server in 3 stages: Reverse the text of the domain, Encode the domain with Base64 and then reverse the text again. In our analysis, we identified the same method, used to encode both communication’s strings and functions.An example for the encoded string in Explosive RAT 2020 variantWe identified multiple strings, starting with the word “Exploiter”, two equals signs and then a text:Exploiter==APqoSRuRGVhN3aqoiPReversing the text revealed a decodable base64 code:Pioqa3NhVGRuRSoqPA==Decoding the text returned letters, which were needed to reverse again (>**ksaTdnE**<). In the end of the process, the function “EndTask” will be presented.The second code overlaps are between the 2015 Volatile Cedar WebShell and the Caterpillar 2 WebShell. This WebShell is an updated version of CaterPillar.asp, the WebShell that was exposed in recent campaign. The code itself is similar, however, it indicates more maturity in the code-writing techniques and more functionality for the WebShell.The TTP itself was changed. In 2015, Lebanese Cedar relied mostly on Explosive RAT as their main tool. In the recent campaign, we identified multiple Caterpillar WebShells and less utilization of Explosive RAT (based on our scans). Accordingly, we propose that the main vector of Lebanese Cedar in 2020 is utilization of WebShell.____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE22 | P a g e____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE23 | P a g eSummary and Insights Lebanese Cedar APT has been orchestrating sophisticated, well-designed attacks using custom-made attack tools since 2012, often with no disruptions by the global security community for long consecutive periods of time. The group’s ability to remain under the radar is not coincidental – it is the result of a clever selection of targets, tools, and attack vectors. Previous research of this APT attributed the group to a Lebanese threat actor (In some reports about the group, they were attributed particularly to the Hezbollah Cyber Unit7). The targets of Lebanese Cedar are from multiple sectors and spread globally.Lebanese Cedar APT uses vulnerable public-facing web servers as their initial attack vector. After gaining access to the server using 1-day vulnerabilities, extensive reconnaissance of the target is carried out using a variety of tools. Their WebShell 's are also used by the group to gain persistency and to evade detection.Many of the tools in Lebanese Cedar APT’s arsenal are open source, however, the group relies mainly on two prominent tools that are custom-made. These tools include:•“Caterpillar” WebShell, used to collect system and network information, locate assets within the network and install additional files.•“Explosive” RAT which used to harvest sensitive information of multiple types.Our research of Caterpillar WebShell revealed that the tool contains a code snippet taken from a WebShell associated to the infamous Iranian hacking group ‘ITSecTeam’. Another WebShell utilized by the group was most likely developed by another Iranian hacking group dubbed ‘Persian Hacker’.ClearSky’s research reveals that the group had been active recently, using a 4th version of the Explosive RAT and a 2nd version of the Caterpillar WebShell. Scanning the web for vulnerable public-facing web servers and analyzing the results based on our research of the group’s patterns revealed more victims.Servers likely compromised by the group were detected mainly in Europe, but also in the United Arab Emirates, Egypt, Saudi Arabia and more.7 url content/uploads/sites/2/systemfiles/Cyberattack%20tied%20to%20Hezbollah%20ups%20the%20ante%20for%20Israel's%20di gital%20defenses%20-%20Citing%20Daniel%20Cohen%20in%20The%20Christian%20Science%20Monitor.pdf____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE24 | P a g eIndicators of Compromise -CV.php-test.jsp Explosive RAT Communicate.DLLspmpm.dll dzip917951-f2030832.dll- wvwupd.exeTypeCaterpillar 2 Caterpillar 2Caterpillar 2 + ITSecTeamASPXSpy ASPXSpyMamad WarningCaterpillar 2 AdminerFile Browser JSP File Browser JSPdll dllexeHere are some of the original servers used by the hackers which we identified in our comprehensive research:68.65.122[.]109 74.208.73[.]149 191.101.5[.]183 198.101.242[.]72 169.50.13[.]61____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE25 | P a g eLebanese Cedar APTGlobal Campaign Leveraging Public Facing Web Servers(C) all rights reserved to ClearSky Cyber Security 2021TLP:White____________________________________________________________________________________________________www.clearskysec.com © All rights reserved to ClearSky Cyber Security ltd. 2021TLP: WHITE26 | P a g e 