mp-weixin-qq-com.translate.goog /s/n6XQAGtNEXfPZXp1mlwDTQ Confucius: The Angler Hidden Under CloudFlareAntiy CERT Antiy Group 2022-07-13 12:04A few days ago, Antiy Deputy Chief Engineer Li Bosong was interviewed by a reporter from the Global Times, and disclosed that the Indian APT organization "Confucius" recently discovered by Antiy CERT, and its attack activities against the Pakistani government and military institutions (see the article on Global Network for details today). Article 2 reproduced article). This article is a detailed analysis report.0 1 OverviewRecently, when Antiy CERT tracked and sorted out the attacks from the direction of the South Asian subcontinent, it found an attack by the Confucius group against the Pakistani government and military institutions.The name of the organization first came from an analysis report released by foreign security vendor Palo Alto Networks in 2016 [1] . In this report, Palo Alto Networks disclosed the attack activities of an Indian attack group, which can be traced back to 2013. In 2010, he was good at using spear-phishing emails, watering hole attacks and phishing websites, and cooperated with rich social engineering methods to conduct attacks on the governments, military, energy and other fields of China, Pakistan, Bangladesh and other neighboring countries of India for the purpose of stealing sensitive information. attack activities. In the early attack activities, the organization used internationally renowned websites (such as Quora, similar to my country's Zhihu) with the function of message interaction, and1/71entrained the encrypted remote control server address of the Trojan in the public messages. After the Trojan used by the organization is implanted into the victim host, it can obtain the content from such public messages, decrypt and restore the real remote control server address. Therefore, the first network access behavior of the Trojan on the victim host will be regarded as a normal web page request, but the attacker can use these internationally renowned websites to continuously change the remote control address or issue other instructions. On a Quora page linked to the malicious code, Palo Alto Networks found that the content posted by the attackers contained the words "Confucius says", that is, "Confucius Says", or "Zi Yue", so it called the group Confucius. It can be seen that in the process of continuously attacking China, the attackers also conducted research on Chinese culture.In this attack activity discovered by Antiy CERT, the organization mainly disguised as Pakistani government staff to deliver spear-phishing emails to the target, and tricked the target into downloading and opening the document embedded with malicious macro code through the content of the phishing email, so as to send the target machine to the target machine. Implant the open source Trojan QuasarRAT, self-developed C++ backdoor Trojan, C# stealing Trojan and JScript downloader Trojan.At present, the attack has attracted the attention of the relevant departments of the Pakistani government. Among them, the National Telecommunications and Information Technology Security Board (NTISB) of Pakistan has repeatedly issued a national cyber threat warning [2] [3] , saying that the attackers are sending government officials and the public to the public. Mimicking a fake phishing email from the Pakistan Prime Minister's Office, government officials and the public are asked to remain vigilant and refrain from providing any information via emails and social media links. This report summarizes the attack activities, tactics and tools of the Confucius organization from 2021 to the present. The characteristics of the overall activities can be briefly summarized in the following table:Table 1-1 Summary of overall attack activity characteristicsAttack time For industry/sectorgovernment, military2021-present continuous control, stealing PakistanAttack methodtarget system platform type of bait Development languageWeaponrySpear-phishing emails, phishing websites, using third- party cloud storage services to store malicious Decoy PDF files, malicious macro documents, malicious RTF files, malicious shortcuts, etc. C++, VBScript, C# and JScript C++ backdoor Trojan, C# stealing Trojan, C# downloader Trojan, open source Trojan QuasarRAT, JScript downloader Trojan0 2 activity analysis From the second half of 2021 to the present, Antiy CERT has successively captured sample files of Confucius' attacks against Pakistan. The attack timeline of the captured samples is as follows: Attacked in June 2021 using malicious RTF documents related to the list of victims of the Pakistan Army; An August 2021 attack using a macro document from the Pakistani military on the content of Pegasus spyware warnings; In August 2021, the attack was carried out using the macro document related to the tax declaration of the Pakistan Federal Tax Service; Attacks using malicious shortcut files disguised as image files in February 2022; In February 2022, the attack was carried out using macro documents related to the COVID-19 vaccination status table of Pakistani government employees and the audit table of digital assets; In May 2022, the attack was carried out using a macro document related to the application form of the Pakistani Prime Minister's Office employee; Attacked in June 2022 using malicious macro documents related to the Pakistani Ministry of Foreign Affairs. In this attack, the attackers mainly delivered spear-phishing emails to the target in the name of Pakistani government staff. COVID-19 vaccination status.2/71Figure 2‑1 Phishing emailThe attacker embeds different types of malicious links in the body of the phishing email and in the attached PDF file. When the target views the phishing email, they will be deceived by the content of the email body and PDF file carefully designed by the attacker, so that they can click the malicious link to download the malicious link. Documentation for macro code. There are three main types of malicious links used by attackers: ▶ Links to phishing websites that imitate government websites: Attackers use website cloning tools such as HTTrack to build phishing websites that imitate the official websites of government departments (such as the Office of the Prime Minister of Pakistan, the Journal of the National Defense University of Pakistan, and the Federal Tax Service of Pakistan). When the target accesses through the phishing website When linking to a phishing website, the attacker tricks the target into downloading a document with malicious macros through the content of the website. Table 2‑1 Phishing Domain Names ndu-edu.digital psca-gop-pk.digital nadra.digital mofa-pk-server.live Ministry of Foreign Affairs of Pakistan fbr-notice.com Federal Revenue Service of Pakistan Federal Revenue Service of Pakistan fbr-tax.info Federal Revenue Service of Pakistan notice-fbr.tax Federal Revenue Service of Pakistan fbr-mail.online Pakistan Canteen Department Store (a chain retail csd-pk.online enterprise under the Ministry of Defense of Pakistan)counterfeit object Office of the Prime Minister of Pakistan Office of the Prime Minister of Pakistan National Defense University of Pakistan Pakistan Punjab Safe City Authority Pakistan National Database and Registration Authority3/71Figure 2‑2 Phishing website imitating the Pakistan Prime Minister's Office4/71Figure 2‑3 Phishing website imitating the Journal of Pakistan National Defense University ▶ File download link to a third-party cloud storage service: The attacker stores the malicious macro file in the third- party cloud storage service website Dropbox network disk. When the target accesses the link with a browser, the browser will automatically request to download the stored file. Malicious macro document. ▶ Access links to third-party Deep Linking [4] (deep linking) services: Deep linking refers to the linking service provided by the linking website, so that users can obtain the information on the linked website without leaving the page of the linking website. content, the URL of the linking website is displayed in the address bar of the page, not the URL of the linked website. Attackers can use the deep link service provided by Branch to customize the characteristics of subdomains and disguise the subdomains as official websites of the Pakistani government (such as ncoc-update.app.link, pmoffice.app.link, moitt-auditform.app. link), when the target accesses the access link created by the attacker through the browser, the Branch server will automatically request to download the malicious macro document stored in the third-party cloud storage service. At the same time, when downloading a malicious macro document, the address bar of the target browser still displays the access link created by the attacker, not the download link of the third-party cloud storage service that downloads the malicious macro document. The credibility of the downloaded file in the target's mind.The overall attack flow of this attack activity is shown in the following figure:5/71Figure 2‑4 The overall attack process of this attack6/71Figure 2‑5 Decoy PDF file embedded with malicious download links7/71Figure 2‑6 Malicious RTF document related to the list of victims of the Pakistan ArmyIn this attack, in order to prevent security analysts from analyzing and tracing the source of the attack, the attackers used the following methods to evade detection:● Deliberately forge the timestamps of C# downloader Trojans and C# stealing Trojans into unreal time to counter time zone analysis.● Using encrypted malicious macro code documents, the password is generally located in the body of the email, the body of the PDF and the page of the phishing website. By encrypting the malicious macro document, the attacker ensures that when the non-target group obtains the malicious macro document, the malicious macro document cannot be opened and analyzed without the password.● The domain names all use the CDN acceleration service of CloudFlare (US Content Delivery Network and DDoS Mitigation Company), which can effectively hide the real IP address of the server to which the domain name resolves.● Using the CloudFlare firewall function to filter the address location of the access IP, only when the access IP is located in a specific country, the access page will jump to the real malicious macro document download page.8/71Figure 2‑7 Restricting access countries through the CloudFlare firewall function0 3 Sample analysis 3.1 Execution process analysis3.1.1 Use Word macro document to release comprehensive stealing componentsAttackers use malicious Word macro documents to release and execute Stage 1 and Stage 3 C# downloader Trojans, and then download subsequent attack payloads through the released downloader Trojans. At the same time, the attack payload returned by the attacker's mount server is essentially an ASCII file. The downloader Trojan at each stage will convert the ASCII file into a binary file, then load it into memory and jump to a dynamic function for execution. The overall flow chart of using the Word macro document to release the integrated stealing component is shown in the following figure:9/71Figure 3-1 The overall process of using the Word macro document to release the integrated stealing component10/71Figure 3‑2 Petition.docm (petition)Figure 3‑3 Jobs_in_GHQ_Rawalpindi_2022.docm3.1.2 Use Excel macro document to release backdoor components11/71Attackers use Excel documents that carry malicious macro codes to release backdoor components (such as the open source Trojan QuasarRAT, self-developed C++ backdoor Trojan) to the %ProgramData% directory of the host. For the open source Trojan QuasarRAT, the attacker will use the system tool PowerShell to execute. As for the C++ backdoor Trojan, the attacker uses the system tool Rundll32 to execute it. The overall flow chart of using the Excel macro document to release the backdoor component is shown in the following figure:Figure 3-4 The overall process of releasing backdoor components using Excel macro files12/71Figure 3‑5 DEPT_NCOC-3-31.xlsmFigure 3‑6 DigitalAssestsAudit.xlsm3.2 Analysis of Attack Weapons13/713.2.1 Malicious Word Macro DocumentIn this attack, the attackers mainly used malicious Word macro documents and malicious Excel macro documents. The malicious Word macro documents mainly implanted the integrated stealing components developed by the attackers into the host computer, while the malicious Excel macro documents were used by the host computer. The SRIU-AppForm.docm 41CDCEC8311F735E1ED8D3BAB9192173 87.5KB (89,600 bytes) Document/Microsoft.DOCM[:doc 2007-2013]Table 3-1 Examples of malicious macro documents creation time 2022-05-19 11:50:00 +00:00 Last Modified2022-05-27 09:02:00 +00:00 creator last modified Windows UserSO-PAUFigure 3‑7 SRIU-AppForm.docmBy analyzing the macro code embedded in the malicious Word document, it is found that the structure and function of the macro code written by the attacker are very simple, and the main functions are as follows:1. When the victim triggers the "DOWNLOAD FORM" button, the white file is downloaded to the "Download" directory of the host computer, and a pop-up message pops up indicating the location of the file.14/71Figure 3‑8 Pop-up message, download white file2. The attacker releases the C# downloader Trojan at different stages according to whether the host computer has the installation folder of the antivirus software McAfee.Figure 3-9 Release of different C# downloader TrojansWhen the installation folder of the antivirus software McAfee exists on the host, extract the Stage 3 C# downloader Trojan ASCII data from the "Comments" attribute in the document (in this sample, due to the attacker's mistake, the Trojan data is actually stored In the "Description" property of the document), after converting the ASCII data into15/71binary data, name it "sdjkfhkjsdh.txt" and release it to the %TEMP% directory of the host, and create a Trojan that is released and execute it every 20 minutes. The scheduled tasks are persisted.Figure 3‑10 Release the Stage 3 C# downloader TrojanFigure 3-11 ASCII data hidden in subject and description attributes16/71Figure 3-12 Create a scheduled taskWhen the host computer does not have the installation folder of the antivirus software McAfee, it will extract the Stage 1 C# downloader Trojan ASCII data from the "Subject" attribute in the document, convert the ASCII data into binary data, and name it "" sdjkfhkjsdh.txt" is released to the %TEMP% directory of the host computer, and use PowerShell FBR5323-Notice.xlsm 06B5A67BF37FED5B92C2211F342D7F0A 937KB (959,488 bytes) Document/Microsoft.XLSM[:xls 2007-2013]virus name creation time 2015-06-05 18:17:00 +00:00 Last Modified2022-05-10 09:17:00 +00:00 creator last modified AbbasiTAX&FBRFigure 3‑15 FBR5323-Notice.xlsmThe function of the macro code embedded in the malicious Excel document is also very simple, mainly to release the open source Trojan QuasarRAT obfuscated by .NET Reactor, and then use the system tool PowerShell to load and run the released QuasarRAT.19/71Figure 3-16 Extracting the Base64-encrypted QuasarRAT data hidden in the sheet20/71Figure 3‑17 Base64 encrypted QuasarRAT dataFigure 3-18 Decrypt and release QuasarRAT21/71Figure 3-19 Using PowerShell to load and execute QuasarRATAt the same time, the analysis of the entire macro code shows that there are some functions in the macro code that the attacker has not enabled. The unenabled functions include using the registry to persist the released QuasarRAT, and message pop-ups that can be used to confuse victims. .22/71Figure 3-20 Features not enabled3.2.2 Integrated stealing components Table 3‑3 Stage 1 C# Downloader Trojan languageTrojan/Win32.Downloader Intel 386 or later, and compatibles 8.50KB (8,704 bytes) Win32 DLLs 2076-10-03 02:38:51 +00:00 (forged) Microsoft Visual C# / Basic .NETThe function of Stage 1 C# downloader Trojan is relatively simple. It mainly obtains the Stage 2 C# downloader Trojan ASCII file from the attacker's mount server, then converts the ASCII file into a binary file, and finally loads it into memory and jumps to dynamic function to execute.23/71Figure 3‑21 Stage 1 C# downloader Trojan horse function24/71Figure 3-22 The Stage 2 C# downloader Trojan ASCII file returned by the mount serverTable 3‑4 Stage 2 C# Downloader Trojanvirus name languageTrojan/Win32.Downloader Intel 386 or later, and compatibles 348KB (356,864 bytes) Win32 DLLs 2022-04-22 13:02:49 +00:00 Microsoft Visual C# / Basic .NETThe Stage 2 C# downloader Trojan function is to download the Stage 3 C# downloader Trojan, and create a scheduled task named "YunoHonow" for the Stage 3 C# downloader Trojan. The scheduled task will use the system tool PowerShell to load and execute Stage 3 C# every 20 minutes. Downloader Trojan.25/71Figure 3‑23 Stage 2 C# downloader Trojan horse functionTable 3‑5 Stage 3 C# Downloader TrojanTrojan/Win32.Downloader Intel 386 or later, and compatibles 10.0KB (10,240 bytes) Win32 DLLs 2083-02-05 20:09:11 +00:00 (forged)virus name digital signature none Microsoft Visual C# / Basic .NET languageThe function of Stage 3 C# downloader Trojan is to download Stage 4 C# stealing Trojan, and load the C# stealing Trojan into memory and jump to the dynamic function for execution. At the same time, in order to ensure that the Stage 4 C# stealing Trojan can be successfully downloaded, the attacker also uses an alternate download link.26/71Figure 3‑24 Stage 3 C# downloader Trojan horse functionTable 3‑6 Stage 4 C# stealing TrojansTrojan[Spy]/Win32.Stealer Intel 386 or later, and compatibles 11.5KB (11,776 bytes) Win32 DLLs 2067-12-02 18:52:44 +00:00 (forged)virus name digital signature none Microsoft Visual C# / Basic .NET languageThe Stage 4 C# Trojan is a stealing Trojan. Its main function is to steal the Documents, Downloads, Desktop, Pictures directories in the Users folder of the C drive of the host computer and all files of the same type in the other drives.27/71Figure 3‑25 The overall function of C# stealing TrojansAt the same time, in order to avoid uploading files repeatedly, the Trojan will return the MD5 value of the file to the C2 server when uploading the file. Whenever the Trojan restarts, it will download the MD5 list of uploaded files from the C2 server according to the host's unique identifier (machine name__username) (the MD5 list file is located in the server's har1 directory). When the Trojan uploads files later, it avoids repeated uploading of files by judging whether the MD5 value of the current file exists in the MD5 list of uploaded files.28/71Figure 3-26 Obtain the MD5 file list of uploaded files based on the unique identifier29/71Figure 3-27 Upload file, file MD5Figure 3-28 Search for all files of the same type in the current directory30/71Figure 3-29 Upload file and file MD5, and continue to search subdirectories3.2.3 Backdoor ComponentsTable 3‑7 C++ backdoor Trojans languageBackdoor/win32.Agentb Intel 386 or later, and compatibles 220KB (225,792 bytes) Win32 DLLs 2022-04-12 05:09:50 +00:00 Microsoft Visual C/C++(2013)[DLL32]The C++ backdoor Trojan was first discovered in an attack by Confucius in September 2020. By comparing the new version of the backdoor Trojan captured this time with the previous version, it was found that its functions have not changed much from the previous version. The Trojan just makes adjustments to the overall code structure. Its main functions include creating scheduled tasks, retrieving process information, retrieving network adapter information, retrieving disk drive information, uploading files, downloading files, executing files, and rebounding Shell. After the backdoor Trojan is executed, it will first determine whether the file name and path of itself and the loader are specific to decide whether to continue execution.31/71Figure 3-30 Get the loader pathFigure 3-31 Determine the path where it is locatedSecond, ensure that only one Trojan program is running in the host by creating a mutex. The mutex used by this sample Trojan is "v2.1.1". In the follow-up, Antiy CERT captured the C++ backdoor Trojan whose mutex is "v2.1.4". From this, it can be inferred that the mutex used by the backdoor Trojan is the current Trojan version number.32/71Figure 3‑32 Mutexes of different versions of Trojans At the same time, the attacker creates a scheduled task named "Windows Logging Service" and uses the system tool Rundll32 to load and execute itself every fifteen minutes, so as to achieve the purpose of persistent monitoring of the host.33/71Figure 3-33 Scheduled task nameFigure 3-34 Scheduled task files stored in the Task directoryThen, the Trojan will generate a unique identity for the host and send it back to the C2 server. The composition of the identity is shown in Figure 3-35:34/71Figure 3-3 5 Identification35/71Figure 3-36 Sample IDFigure 3-37 Determine the operating system version36/71Figure 3-38 Determine whether the running environment is a virtual machine or a physical machine37/71Figure 3-39 Determine the number of operating system bits38/71Figure 3-40 Splicing the ID and sending it back to the C2 server The Trojan then sends the retrieved host information back to the attacker's C2 server. The retrieved information includes processes, network adapters, disk drives, installed applications, and files of the appropriate type.39/71Figure 3-41 Return informationRetrieve process information: Retrieve the process information that the host is running, and the obtained information is returned to the C2 server in the form of "program name - program PID - path where the program is located".40/71Figure 3-42 Retrieving the active process information of the hostFigure 3-43 Get the full path of the process program41/71Figure 3-44 Process information format returnedRetrieve disk drive information: Obtain the host disk drive information, so that the Trojan can retrieve the qualified file information in the disk drive subsequently.Figure 3-45 Retrieving disk informationRetrieve network adapter information: contains adapter type, name, description, Mac address, IPv4 address, gateway, subnet mask, etc.42/71Figure 3-46 Retrieving Network Adapter InformationFigure 3-47 Network information to be retrievedRetrieve application information: Obtain information such as the name, version, and path of the software installed on the host by retrieving the subkeys of the registry HKLM\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall.43/71Figure 3-48 Retrieving the registry Retrieve files of matching type from disk drives: The file types that attackers are interested in are doc, docx, pdf, txt, ppt, pptx, xls, xlsx, zip, rar, 7z, and axx.Figure 3-49 Retrieving files44/71Figure 3-50 File types targeted by attackersFigure 3‑51 Directories to be excludedFinally, after the above information is returned, the Trojan enters the backdoor state and waits for the C2 server to issue an instruction to execute the corresponding function.Through the analysis of the Trojan, it is found that the attacker mainly uses multiple While loops to achieve backdoor operations, and each designed While loop can perform one or more functions.45/71Figure 3-52 Using multiple While loops to implement backdoor operationsThe instructions issued by the attacker can be divided into first-level and second-level instructions. The first-level instruction represents an overall function, and the second-level instruction represents the branch function under the overall function.When the attacker controls the target, he first issues a first-level instruction to enter the overall function, and then issues a specific instruction to implement the branch function. The specific instructions are separated by "," characters, that is, in the form of "second-level instructions, specific operations,", and the Trojan will decompose the specific instructions through the Strtok function after receiving them. At the same time, after the Trojan completes the command, it will send back specific characters to the C2 server to identify the result of the command execution.Figure 3-53 Level 1 command issued by the attackerFigure 3-54 The second-level command issued by the attackerTable 3-8 lists the commands and functions sent by the attacker through the C2 server:Table 3-8 Command function table IDWaitnoneCFEx JEWaiting for C2 to issue a commandHiExecute the specified A wait command executed46/71CFEJDDERetrieve the specified according to the URL issued by the C2Download the executable file according to the URL issued by the C2, and execute the fileDelFnonedelete the specified fileReSh noneBounce ShellGetFGetF Skip the current file, i.e. do not upload Skip the current file, i.e. do not upload it.FeFinoneUpload the specified fileDWNLReceive data from C2 and write to fileFNoF No file retrieved The file is file not found connected to C2, but C2 did not reply Failed to connect The specified file was not retrieved The file was read successfully, and the file data will be returned soon AcDe file read failed FNNR file write failed DowF Download file JuDononeFeFifailed just download the file The file was failedDWNLDWNEReceive data from C2, write to file, and executeDnExExeFLiFinoneExit none ReST noneAfter sleeping for 5 minutes, re-enter the backdoor function and receive new commands exit the program exit the programnonenoneExit ReSTexit successfully exit successfully47/71Figure 3-55 Download files and execute executable files through URL48/71Figure 3-56 Retrieving files and executing files49/71Figure 3-57 Delete the specified file50/71Figure 3-58 Upload the specified file51/71Figure 3-59 Download file and execute fileFigure 3‑60 Rebound Shell3.2.4 Downloader componentJScript is a scripting language from Microsoft specifically designed for use in Web pages. It adheres to the ECMAScript standard and is primarily a Microsoft language that corresponds to Netscape's earlier and widely used JavaScript. Like many other programming languages, Microsoft JScript is written in text and organized into statements, blocks of related sets of statements, and comments.The attacker uses the downloader component written in the JScript language to implant the C++ launcher Trojan, VBS script and comprehensive stealing components into the target machine.52/71Its complete execution process is shown in the following figure:Figure 3‑61 JScript downloader execution flow Table 3‑9 JScript downloader Trojans virus name original file name 157720846 VT first upload time VT test results2022-04-08 16:09:11 +00:00 10/58Trojan[Downloader]/JScripts.Agent157C6E86D68D98F777D37C3753322F69 2.41KB (2,474 bytes) JScriptThe JScript downloader Trojan will identify the host system version according to the browser kernel information, and then execute different commands according to different systems. When the system version is Windows7, that is, the browser kernel is "Windows NT 6.1", the subsequent attack payloads (a C++ launcher Trojan, a C# downloader Trojan, a VBS script, a name The file is "ZeroToleranceMonth.jpg", the ZeroToleranceMonth.jpg file is suspected to be a decoy image file), and a scheduled task named "calcure42" is created through the schtasks command. When the system version is not Windows7, the subsequent attack payload will be downloaded by curl.exe through the CMD command line tool, and a scheduled task named "WinEvent5" will be created through the schtasks command.53/71Figure 3‑62 JScript downloader TrojanThe function of the downloaded VBS script is to use the system tool Rundll32 to run the C++ launcher Trojan.54/71Figure 3‑63 z.vbsTable 3‑10 C++ Launcher Trojansvirus name Trojan/Win32.Agent Intel 386 or later, and compatibles 111KB (114,176 bytes) 2022-04-01 12:51:45 +00:00 Packing type none compiled languageMicrosoft Visual C++ v.7.10 - 14.27The main function of the downloaded C++ launcher Trojan is to create a scheduled task named "Daily Trigger Test Task", which uses the system tool PowerShell to execute the Stage 3 C# downloader Trojan every fifteen minutes.55/713-64 The command to be executed by the scheduled taskFigureFigure 3‑65 Names of scheduled tasks56/71Figure 3-66 Scheduled task Task file04 Association attributionAntiy CERT conducts line extension analysis on the captured samples through the Antiy Cyber Ultra Brain Correlation Subsystem, and finds that the C++ backdoor Trojan captured this time can be associated with many previous attack activities of the attacker.57/71Figure 4-1 Correlation diagramWhen analyzing the associated attack activity samples, it was found that many of them were DeMnu obfuscators organized by Confucius. The DeMnu obfuscator was first published by the friend Qi Anxin in September 2020, and it was disclosed in the report "Operation Tibu: A Retaliation Targeted Attack from the South Asian APT Organization "Mo Luo Shu" [5] that "Mo Luo Shu" is a friend Shangqi Anxin's nickname for the Confucius organization.The Confucius organization mainly uses the DeMnu obfuscator to load its unique loader program Polyloader, and then decrypts and loads the open source remote control Trojan AsyncRat through the Polyloader.58/71Figure 4-2 The decryption function used by the DeMnu obfuscator associated this time59/71Figure 4-3 The decryption function used by the DeMnu obfuscator disclosed in the Qi Anxin reportAt the same time, the malicious payload mount links used by attackers in previous attacks are highly similar to those used by Confucius in previous attacks.Table 4-1 Comparison of malicious payload mount linksAssociated Attack Activity url url url url Confucius attacks url url url moondelight.96.lt/followup/update/KB756324Based on the above information, Antiy CERT determines that this attack activity belongs to the Confucius organization.05 Links with the SideWinder organization During the correlation analysis of this attack activity, a malicious shortcut sample named "WhatsApp.jpeg.lnk" was associated with the Antiy Cyber Ultrain Threat Intelligence Analysis Subsystem. The malicious shortcut sample uses the system tool MSHTA Load and execute the remote HTA script, but because the remote HTA script link has expired, it is impossible to know the specific function of the HTA script.Table 5-1 Examples of malicious shortcutsvirus name original file nameTrojan[Downloader]/Win32.Agent.LNK WhatsApp.jpeg.lnk60/71MD5 2.07KB (2,121 bytes) 2021-01-02 03:07:30 +00:00 Change the 2021-01-02 03:07:30 +00:00 time VT upload time 2022-02-03 15:21:42 +00:00 machine IDuser-pcFigure 5‑1 WhatsApp.jpeg.lnkSubsequently, the Antiy Cyber Ultrain Threat Intelligence Analysis Subsystem is associated with a batch of malicious shortcut samples used by attackers for testing, and the batch of test samples are all submitted to the VirusTotal platform by the same uploader.Analysis of this batch of test samples shows that the attackers began to test malicious shortcut samples roughly in August 2021, and the early malicious shortcuts mainly invoked MSHTA through CMD to execute remote HTA script files, and later used MSHTA directly. Execute remote HTA script files. Table 5‑2 Attacker test samplesMD5file name5ACF14897F3EFFF3D60AEE7A76C4753D WhatsApp.jpeg.lnkuser-pc34A84FA5EF9E5F388D7FEA9D91140FC5 WhatsApp.lnk62FE722B2BF323B318BA1D9C24FDEC51 WhatsApp.lnkCC53E7AEF38AC57499AEB0B1ED3909C9WhatsApp.lnk4D12C03CE1F90E329F28CA194ABAB826 WhatsApp.lnkuser-pcMachineID Change the time 2021-01-02 03:07:30 +00:00 2021-01-02 03:07:30 +00:00 2021-08-06 18:52:32 +00:00 2021-08-06 18:52:32 +00:00 2021-08-06 18:52:32 2021-11-04 19:34:46 +00:00 2022-02-12 13:09:35 +00:00 2022-02-12 13:10:49 +00:00 2022-02-12 13:12:28 +00:00 2022-02-12 13:14:29 +00:00Through a comprehensive analysis of the malicious shortcut samples of the Confucius organization captured this time, it is found that the malicious LNK samples used by the SideWinder organization have differences in "machine name", "creation time", "modification time" and "disk drive identifier", etc. There is a lot of overlap where the "disk drive identifier" as the disk identifier of the machine that creates the malicious shortcut file is unique in itself. Therefore, Antiy CERT guessed that there is a shared tool between the SideWinder organization and the Confucius organization.In fact, it is not uncommon for major Indian APT organizations to share code and tools with each other. For example, Trend Micro, a foreign security vendor, has repeatedly disclosed that there is a relationship between Confucius, Urpage and White Elephant to share code and assets [6] .61/71Now, from Antiy CERT finding that there are tools shared between SideWinder and Confucius, it can be seen that more and more Indian APT attack organizations will share tools and codes.Table 5-3 Metadata comparison of malicious LNK samples used by Confucius and SideWinderThe Confucius malicious LNK sample captured this time 931A598836097496F21443AE864D160BDCFC26743D5E2897112626F67612067DMalicious LNK sample used by SideWinder groupuser-pcC:\Windows\System32\hsmta.exeC:\Windows\System32\hsmta.exe \ \ \ \Windows\System32\mshta.exeluckydrawaugust2021.pdf.lnk user-pcMD5 file name WhatsApp.jpeg.lnk Identifier 29ebe0d2-885f-4b6f-9277-80f9904dafe4 29ebe0d2-885f-4b6f-9277-80f9904dafe42021-01-02 03:07:30 +00:002021-01-02 03:07:30 +00:002021-01-02 03:07:30 +00:002021-01-02 03:07:30 +00:00url 03:07:30 +00:00 \ \ \Windows\System32\hsmta.exe url pk.co/137/1/39/2/0/0/1812896830/tFUcuCDhCs3bJtZXyEgIY7JY0qsxlMwp 0909d81c/hta 2021-01-02 03:07:30 +00:000 6 Attack Mapping from Threat Framework PerspectiveThis series of attacks involves 27 technical points in 12 stages in the ATT&CK framework. The specific behaviors are described in the following table:Table 6-1 Description of technical behavior of Confucius' attack activities ATT&CK stage specific behavior NotesreconnaissanceCollect victim development Get infrastructure initial visitCollect target email account information for targeted delivery of emails in subsequent phishing attacks Search the target official website for subsequent phishing attacks to build counterfeit websites Purchase servers for phishing websites, mount servers, C2 servers, etc. Deliver spear-phishing emails with malicious links to targets Downloader Trojan using PowerShell to load malicious payload, written in JScript language Use Windows Task Scheduler to regularly execute C# stealing Trojans and C++ backdoor Trojans Use malicious macro documents with lure content to induce target execution Use Windows Task Scheduler to regularly execute C# stealing Trojans and C++ backdoor Trojans Using the registry run key to execute a C++ backdoor trojan Using QuasarRAT obfuscated with Eziriz .NET Reactor obfuscator Use the system tool Rundll32 to execute the C++ backdoor Trojan, and use the system tool M shta to execute the malicious HTA file Use C# stealing Trojans and C++ backdoor Trojans to steal target password files Using a keystroke stealer trojan collects the target's keystrokes for credentials Use the C++ backdoor Trojan to obtain information about the currently running process of the target Use C# stealing Trojan and C++ backdoor Trojan to obtain target file and directory information Use C++ backdoor trojan to get target shared folders and drivesPhishing induce users to Bootstrap or login with autostart Obfuscated files or informationExecute signed binary proxyGet credentials from input capturediscovery processDiscover files and accessFind62/71registry informationQuery the registry Use C++ backdoor Trojan to query target discovery software Use C++ backdoor Trojan to obtain target installation software information Use C++ backdoor Trojan to obtain target Use the C++ backdoor Trojan to obtain the Discover system network configuration information of the It is speculated that the attacker will use Transfer files or the penetration tool to move laterally on the Use C# stealing Trojan and C++ backdoor Trojan to automatically collect target file information Use the keystroke stealer to collect the host's keystroke behavior Use C# stealing Trojan, C++ backdoor Trojan to collect target removable media data C# downloader Trojans and C# stealth Trojans use application layer protocols such as HTTP/HTTPS Most of the tools in this activity automatically transmit the stolen data to the outside world When using the C++ backdoor Trojan to upload files, limit the size of each upload to 1 byteCollect removable media dataLimit transfer data exfiltration dataautomatic collectioninput captureLateral movementcollectcommand and controldata exfiltrationThe ATT&CK framework diagram of the behavioral technical points of the Confucius organization-related attack activities is shown in the following figure:Figure 6-1 ATT&CK mapping map corresponding to Confucius attack activities63/710 7 Summarize Among the APT attack groups from India, Confucius has no special features in attack weapons, code quality and vulnerability exploitation, but in the use of social engineering methods, it can be said to be "out of the pack". Especially in the attack activities in recent years, the Confucius group used more abundant social engineering methods to The phishing websites, spear-phishing emails, bait PDF files and malicious macro documents it constructed are all harmful to the target. Full of allure. At the same time, the organization used CloudFlare's CDN acceleration service to hide the real IP address of assets, restrict access to IP geolocation, modify the timestamp of malicious payloads, and use encrypted malicious macro files in the attack activities, which also greatly improved security analysis. It is difficult for personnel to analyze and trace it.Appendix 1: Some IOCsPart MD5 url url url url url url url url url url url url url url url url url url url url url url url url url Domain classcentral-*.ddns.net64/71dump*ngs.ml fil*oni.digital fu*tifu.live msd*igns.site office*oud.store pirna*m.xyz release.word*date.net thak*aiya.xyz webi*taller.online word*date.net fbr-no*ce.com t7g*c.app.link Appendix II: References[1] Palo Alto Networks : Confucius Says Malware Families Get Further By Abusing Legitimate Websitesurl websites/[2] Pakistan NTISB: Spam Mails for Govt Jobs/Recruitments (Advisory No 13)url Pakistan NTISB: Cyber Security Advisory No. 21 Spam Email-PMOurl Baidu Encyclopedia: Deep Linksurl Qi Anxin: Operation Tibu - A retaliatory targeted attack from the South Asian APT organization "Moruoshu" [6] Trend Micro: Linking cyberespionage groups targeting victims in South Asiaurl review65/7166/7167/7168/7169/7170/71预览时标签不可点收录于合集 #个上一篇 下一篇微信扫一扫 关注该公众号71/71 