Trend MicroAbout TrendLabs Security Intelligence BlogGo to…▼Home » Malware » MuddyWater Resurfaces, Uses Multi-Stage Backdoor POWERSTATS V3 and New Post- Exploitation ToolsMuddyWater Resurfaces, Uses Multi-Stage Backdoor POWERSTATS V3 and New Post-Exploitation ToolsPosted on: June 10, 2019 at 5:02 amPosted in: Malware, Targeted AttacksAuthor: Trend MicroBy Daniel Lunghi and Jaromir HorejsiWe found new campaigns that appear to wear the badge of MuddyWater. Analysis of these campaigns revealed the use of new tools and payloads, which indicates that the well-known threat actor group is continuously developing their schemes. We also unearthed and detailed our other findings on MuddyWater, such as its connection to four Android malware families and its use of false flag techniques, among others, in our report “New MuddyWater Activities Uncovered: Threat Actors Used Multi-Stage Backdoors, False Flags, Android Malware, and More.”One of the campaigns sent spear-phishing emails to a university in Jordan and the Turkish government. The said legitimate entities’ sender addresses were not spoofed to deceive email recipients. Instead, the campaign used compromised legitimate accounts to trick victims into installing malware.Figure 1. Screenshot of a spear-phishing email spoofing a government office, dated April 8, 2019.Figure 2. Email headers showing the origin of the spear-phishing emailOur analysis revealed that the threat actor group deployed a new multi-stage PowerShell-based backdoor called POWERSTATS v3. The spear-phishing email that contains a document embedded with a malicious macro drops a VBE file encoded with Microsoft Script Encoder. The VBE file, which holds a base64-encoded block of data containing obfuscated PowerShell script, will then execute. This block of data will be decoded and saved to the %PUBLIC% directory under various names ending with image file extensions such as .jpeg and .png. The PowerShell code will then use custom stringFeatured Storiessystemd Vulnerability Leads to Denial of Service on LinuxqkG Filecoder: Self-Replicating, Document- Encrypting RansomwareMitigating CVE-2017-5689, an Intel Management Engine VulnerabilityA Closer Look at North Korea’s InternetFrom Cybercrime to CyberpropagandaSecurity Predictions for 2019Our security predictions for 2019 are based on our experts’ analysis of the progress of current and emerging technologies, user behavior, and market trends, and their impact on the threat landscape. We have categorized them according to the main areas that are likely to be affected, given the sprawling nature of the technological and sociopolitical changes under consideration. Read our security predictions for 2019.Business Process CompromiseAttackers are starting to invest in long-term operations that target specific processes enterprises rely on. They scout for vulnerable practices, susceptible systems and operational loopholes that they can leverage or abuse. To learn more, read our Security 101: Business Process Compromise.Recent PostsMuddyWater Resurfaces, Uses Multi-Stage Backdoor POWERSTATS V3 and New Post- Exploitation ToolsCVE-2019-2725 Exploited and Certificate Files Used for Obfuscation to Deliver Monero MinerMonero-Mining Malware PCASTLE Zeroes Back In on China, Now Uses Multilayered Fileless Arrival TechniquesBlackSquid Slithers Into Servers and Drives With 8 Notorious Exploits to Drop XMRig MinerInfected Cryptocurrency-Mining Containers Target Docker Hosts With Exposed APIs, Use Shodan to Find Additional Victimsobfuscation and useless code blocks to make it difficult to analyze.Figure 3. Code snippet of obfuscated and useless codePopular PostsMay’s Patch Tuesday Include Fixes for ‘Wormable’ Flaw in Windows XP, Zero-Day VulnerabilityNew Mirai Variant Uses Multiple Exploits to Target Routers and Other DevicesLinux Coin Miner Copied Scripts From KORKERDS, Removes All Other Malware and MinersTrickbot Adds Remote Application Credential- Grabbing Capabilities to Its RepertoireExposed Docker Control API and Community Image Abused to Deliver Cryptocurrency-Mining MalwareThe final backdoor code is revealed after the deobfuscation of all strings and removal of all unnecessary code. But first, the backdoor will acquire the operating system (OS) information and save the result to a log file.Stay UpdatedEmail SubscriptionYour email hereSubscribeFigure 4. Code snippet of OS information collectionThis file will be uploaded to the command and control (C&C) server. Each victim machine will generate a random GUID number, which will be used for machine identification. Later on, the malware variant will start the endless loop, querying for the GUID-named file in a certain folder on the C&C server. If such a file is found, it will be downloaded and executed using the Powershell.exe process.A second stage attack can be launched by commands sent to a specific victim in an asynchronous way, e.g., another backdoor payload can be downloaded and installed to targets that they are interested in.Figure 5. The code in POWERSTATS v3 which downloads the second attack stageWe were able to analyze a case where the group launched a second stage attack. The group was able to download another backdoor, which is supported by the following commands:Take screenshotsCommand execution via the cmd.exe binaryIf there’s no keyword, the malware variant assumes that the input is PowerShell code and executes it via the “Invoke-Expression” cmdletFigure 6. The code in POWERSTATS v3 (second stage) that handles the screenshot commandThe C&C communication is done using PHP scripts with a hardcoded token and a set of backend functions such as sc (screenshot), res (result of executed command), reg (register new victim), and uDel (self-delete after an error).Figure 7. In an endless loop, the malware variant queries a given path on the C&C server, trying todownload a GUID-named file with commands to execute.Other MuddyWater campaigns in the first half of 2019The MuddyWater threat actor group has been actively targeting victims with a variety of tricks, and they seem to keep on adding more as they move forward with new campaigns. The campaign that used POWERSTATS v3 is not the only one we found with new tricks. We observed other campaigns that changed their delivery methods and dropped file types. Notably, these campaigns have also changed payloads and publicly available post-exploitation tools.Discovery DateMethod for droppingType of files droppedFinal payloadmalicious code2019-012019-012019-032019-04MacrosMacrosMacrosEXESHARPSTATSINF, EXEDELPHSTATSBase64 encoded, BATPOWERSTATS v2Template injectionDocument with macrosPOWERSTATS v1 orv22019-05MacrosVBEPOWERSTATS v3Table 1. MuddyWater’s delivery methods and payloads in 2019 1HIn January 2019, we discovered that the campaign started using SHARPSTATS, a .NET-written backdoor that supports DOWNLOAD, UPLOAD, and RUN functions. In the same month, DELPHSTATS, a backdoor written in the Delphi programming language, emerged. DELPHSTATS queries the C&C server for a .dat file before executing it via the Powershell.exe process. Like SHARPSTATS, DELPHSTATS employs custom PowerShell script with code similarities to the one embedded into the former.Figure 8. SHARPSTATS can be used to collect system information by dropping and executing aPowerShell script.Figure 9. The code in DELPHSTATS that queries a certain directory on the C&C server. It’s whereoperators upload additional payload.We came across the heavily obfuscated POWERSTATS v2 in March 2019. An earlier version of this backdoor decodes the initial encoded/compressed blocks of code, while an improved version appeared later on. The latter heavily uses format strings and redundant backtick characters. The function names in the earlier version were still somehow readable, but they were completely randomized in later versions.Figure 10. Obfuscated POWERSTATS v2After deobfuscation, the main backdoor loop queries different URLs for a “Hello server” message to obtain command and upload the result of the run command to the C&C server.Figure 11. Deobfuscated main loop of POWERSTATS v2Use of different post-exploitation toolsWe also observed MuddyWater’s use of multiple open source post-exploitation tools, which they deployed after successfully compromising a target.Name of the Post-Exploitation ToolProgramming language/InterpreterCrackMapExecChromeCookiesViewchrome-passwordsEmpireProjectFruityC2KoadicLaZagneMeterpreterMimikatzMZCookiesViewPowerSploitShootbackSmbmapPython, PyInstallerExecutable fileExecutable filePowerShell, PythonPowerShellJavaScriptPython, PyInstallerReflective loader, executable fileExecutable fileExecutable filePowerShellPython, PyInstallerPython, PyInstallerTable 2. Tools used by MuddyWater campaigns over the years.The delivery of the EmpireProject stager is notable in one of the campaigns that we monitored. The scheme involves the use of template injection and the abuse of the CVE-2017-11882 vulnerability. If the email recipient clicks on a malicious document, a remote template is downloaded, which will trigger the exploitation of CVE-2017-11882. This will then lead to the execution the EmpireProject stager.Figure 12. Clicking on the malicious document leads to the abuse of CVE-2017-11882 and theexecution of the EmpireProject stager.Another campaign also stands out for its use of the LaZagne credential dumper, which was patched to drop and run POWERSTATS in the main function.Figure 13. LaZagne has been patched to drop and run POWERSTATS in the main function. See addedintimoddumpers() function. Note the typo in the function name – its INTI, not INIT.Conclusion and security recommendationsWhile MuddyWater appears to have no access to zero-days and advanced malware variants, it still managed to compromise its targets. This can be attributed to the constant development of their schemes.Notably, the group’s use of email as an infection vector seems to yield success for their campaigns. In this regard, apart from using smart email security solutions, organizations should inform their employees of ways to stay safe from email threats.Organizations can also take advantage of Trend Micro™ Deep Discovery™, a solution that providesdetection, in-depth analysis, and proactive response to today’s stealthy malware and targeted attacks in real time. It provides a comprehensive defense tailored to protect organizations against targeted attacks and advanced threats through specialized engines, custom sandboxing, and seamless correlation across the entire attack lifecycle, allowing it to detect threats even without any engine or pattern updates.View our full report to learn more about the other MuddyWater details we discovered.Related Posts: Related Posts:Another Potential MuddyWater Campaign uses Powershell-based PRB-Backdoor Supply Chain Attack Operation Red Signature Targets South Korean Organizations Lazarus Continues Heists, Mounts Attacks on Financial Organizations in Latin America Monero Miner-Malware Uses RADMIN, MIMIKATZ to Infect, Propagate via VulnerabilityLearn how to protect Enterprises, Small Businesses, and Home Users from ransomware:ENTERPRISE»SMALL BUSINESS»HOME»Tags: DELPHSTATSMuddyWaterPOWERSTATSSHARPSTATSHOME AND HOME OFFICE |FOR BUSINESS |SECURITY INTELLIGENCE |ABOUT TREND MICROAsia Pacific Region (APAC): Australia / New Zealand,   ,   ,     ,   Latin America Region (LAR): Brasil, MéxicoNorth America Region (NABU): United States, CanadaEurope, Middle East, & Africa Region (EMEA): France, Deutschland / Österreich / Schweiz, Italia, Россия, España, United Kingdom / IrelandPrivacy StatementLegal PoliciesCopyright © 2019 Trend Micro Incorporated. All rights reserved. 