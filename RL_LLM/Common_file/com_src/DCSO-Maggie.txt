MSSQL, meet MaggieHeatmap of Maggie backdoor user by countryContinuing our monitoring of signed binaries, DCSO CyTec recently found a novelbackdoor malware targeting Microsoft SQL servers.The malware comes in form of an “Extended Stored Procedure” DLL, a special typeof extension used by Microsoft SQL servers. Once loaded into a server by an attacker,it is controlled solely using SQL queries and offers a variety of functionality to runcommands, interact with files and function as a network bridge head into theenvironment of the infected server.In addition, the backdoor has capabilities to bruteforce logins to other MSSQLservers while adding a special hardcoded backdoor user in the case of successfullybruteforcing admin logins. Based on this finding, we identified over 250 serversaffected worldwide, with a clear focus on the Asia-Pacific region.Based on artifacts found in the malware, DCSO CyTec calls this novel threat “Maggie”.In our follow-up post “Tracking down Maggie” we also provide practical tips on how todetect Maggie in your environment.Blog authored by Johann Aydinbas and Axel WauerDiscoveryWhile looking for new threats, a file caught our attention. Detected asAPT_ShadowForce_Malware_ON_Nov17_1 by THOR and with a matching AV detection byAhnLab-V3 as Trojan/Win.ShadowForce.R472810 we decided to take a closer look.THOR detection on VirusTotalThe DLL file is signed by DEEPSoft Co., Ltd. on 2022–04–12. According to its exportdirectory, the file calls itself sqlmaggieAntiVirus_64.dll and only offers a singleexport called maggie .DLL export in IDAExtended Stored ProceduresCloser inspection revealed this DLL to be an Extended Stored Procedure .Extended Stored Procedures are a way to offer extended functionality to SQL queriesfor use in an MSSQL server, similar to the infamous xp_cmdshell stored procedure,which allows SQL queries to run shell commands.ESPs are common DLL files using a simplistic API. When executed, ESPs are passed ahandle to the client connection which allows them to fetch user-supplied arguments(via srv_paramdata) and return unstructured data to the caller (via srv_sendmsg).Maggie utilizes this message-passing interface to implement a fully functionalbackdoor controlled only using SQL queries.In order to install Maggie, an attacker has to be able to place an ESP file in a directoryaccessible by the MSSQL server, and has to have valid credentials to load the MaggieESP into the server. It is unclear how an actual attack with Maggie is performed in thereal-world.After manually loading Maggie withsp_addextendedproc maggie, '<path to DLL>';an authenticated user could start to issue commands to the backdoor via SQLqueries, e.g. to call the whoami shell command:$ exec maggie 'Exec whoami'; MSSQL Procedure 04/08/2022 Execute Command: Exec whoami Executing whoami Successfully nt service\mssqlserverCommandsOnce installed, Maggie offers a variety of commands to query for systeminformation, interact with files and folders, execute programs as well as variousnetwork-related functionality like enabling TermService, running a Socks5 proxyserver or setting up port forwarding to make Maggie act as a bridge head into theserver’s network environment.The full list of commands we have identified:List of commands available in MaggieCommands can take multiple arguments, separated by spaces. For some commands,Maggie even includes usage instructions:Usage instructions for SqlScan commandMaggie as a network bridge headMaggie contains functionality for simple TCP redirection, allowing it to function as anetwork bridge head from the Internet to any IP address reachable by the infectedMSSQL server.When enabled, Maggie redirects any incoming connection (on any port the MSSQLserver is listening on) to a previously set IP and port, if the source IP addressmatches a user-specified IP mask. The implementation enables port reuse, makingthe redirection transparent to authorized users, while any other connecting IP is ableto use the server without any interference or knowledge of Maggie.For this to work, StartHook instructs Maggie to install network API hooks for thefollowing functions:• accept• AcceptEx• WSAAccept• setsockopt• CreateIoCompletionPortallowing Maggie to intercept connections before reaching the underlying services.The redirection setup can be controlled using the SetClientData command withSetClientData <allowed IP mask> <destination IP> <destination port>in order to enable redirection for the given IP mask (can end with ‘*’ wildcard) to thespecified IP and port.Once finished, an attacker can simply disable the IP redirection feature usingStopHook again.In addition, Maggie contains SOCKS5 proxy functionality for more complex networkoperations.Debug messages for SOCKS5 functionalityThe unknown Exploit commandsMaggie’s command list includes four commands that suggest exploit usage:Exploit AddUser Exploit TSIt appears that the actual implementation of all four exploit commands depends on aDLL not included with Maggie directly. Instead, the caller provides a DLL name aswell as an additional parameter when calling each function. We therefore assumethe caller manually uploads the exploit DLL prior to issuing any exploit commands.Maggie would then load the user-specified DLL, look for an export named eitherStartPrinter or ProcessCommand (depending on the exact command used) and passthe user-supplied argument.We were not able to dig up any potential candidate DLLs Maggie might be referencingduring our research so it’s unclear what specific exploit may be utilized here.SQL bruteforcing and the curious Maggie backdoor userMaggie’s command set also includes two commands that allow it to bruteforce loginsto other MSSQL servers:SqlScan WinSockScanTo start a bruteforce scan, the controller would have to specify a host, user andpassword list file previously uploaded to the infected server, as well as an optionalthread count. Maggie then creates every combination of (host,user,pass) andattempts to log in via SQL using ODBC, or a reimplementation only using basic socketfunctions in the case of WinSockScan .Successful logins are written to a hardcoded log file, which can be in one of twolocations:C:\ProgramData\success.dat <MAGGIE_LOCATION>\success.datMaggie then tries to determine if the bruteforced login has admin rights. In case itsuccessfully bruteforced an admin user, Maggie proceeds with adding a hardcodedbackdoor user.Based on this finding, DCSO CyTec conducted a scan on publicly reachable MSSQLservers in order to determine how prevalent the identified backdoor user is.Out of approximately 600,000 scanned servers worldwide, we identified 285 serversinfected with Maggie’s backdoor user, spread over 42 countries.Heatmap of backdoor user by countryThe distribution shows a clear focus on the Asia-Pacific region, with South Korea,India and Vietnam as top 3 followed by China and Taiwan in the fourth and fifthplace. Other countries appear to be incidental.Prevalence of backdoor user by countryA logical next step would be to see if and how the affected servers are being utilized,which however goes beyond the scope of our analysis.IoCsAs usual, you can find below IoCs in the form of a MISP event on our GitHub.Maggie ESP DLLs url Mozilla/4.0 (compatible)File paths C:\ProgramData\Success.dat AccessControl.DatMITRE ATT&CKT1110 Brute Force T1090 Connection Proxy 