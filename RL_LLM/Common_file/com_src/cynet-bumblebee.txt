www.cynet.com /orion-threat-alert-flight-of-the-bumblebee/ Orion Threat Alert: Flight of the BumbleBee ⋮ 4/14/2022By: Max Malyutin – Orion Threat Research Team LeaderOrion, Cynet’s Threat Research and Intelligence team, spotted a new malware campaign in the wild: BumbleBee.Wondering what’s going on? Let us fill you in.We noticed a new trend in Initial Access Brokers’ (IAB) tactics to gain access to their victims’ machines. Initial Access Brokers refers to a cybercrime group that specializes in gaining initial access to organizations for the sole purpose of offering it to other threat actor groups. The trend started earlier this year and our team recently spotted their new BumbleBee campaign.Usually, we observe malicious spam (MalSpam) campaigns that deliver malicious documents (MalDoc) to lure the victims to interact with the MalDoc and execute the malicious macro code by clicking “Enable Content.” That in turn downloads and executes the malicious payload, for example, the notorious Emotet campaigns.We expected these groups to change the initial access methods. We believe there is a direct relation to the changes Microsoft applied recently to the default policy in their Office products: “Macros from the internet will be blocked by default in Office” and “Excel 4.0 (XLM) macros are disabled by default.” These changes impact IABs because they have been abusing Office documents with malicious macros for years.It appears that they’ve come up with a plan B.In this post, we will cover what this campaign is, and how the IAB distributes the BumbleBee malware and its TTPs. We will also explain each TTP according to the MITRE ATT&CK model, and its purpose.A new campaign in the wild: BumbleBeeFrom our initial analysis, BumbleBee is a custom new loader that is used by different IAB groups. This malware was observed injecting Cobalt Strike shellcodes in memory and using several tactics, techniques, and procedures (TTPs) in order to compromise the victim’s environment.As part of the campaign, the threat actors abuse spoofed companies’ identities (like fake employee email addresses, fake websites, etc.) and use legitimate public storage services to deliver the malicious ISO image file. The ISO image file is responsible for luring the victim to execute the BumbleBee malware.We’ve seen Living Off the Land Binaries (LOLBins) execution with rundll32, which allows threat actors to avoid defenses. BumbleBee also creates a scheduled task on the compromised host for persistence and1/21executes a Visual Basic script via the scheduled task. The IAB relies on the user (victim) execution to execute the BumbleBee payload by luring the victim to mount an ISO image file and click on a Windows shortcut (LNK) file.The malware name, BumbleBee, was chosen because of its unique user agent, “bumblebee,” that was used as part of the communication with the command and control server (C2).Threat Analysis Group (TAG) shared observations on the financially motivated threat actor, EXOTIC LILY, that use the BumbleBee malware. In addition, TAG mentioned an interesting point of collaboration between EXOTIC LILY and the WIZARD SPIDER threat group.Orion’s observationsThis type of attack is new, and the cybersecurity community is still gathering data to glean more insights on the nature of this attack and its targets.Orion found a high number of targeted companies based in the US with the following distribution method that delivers the BumbleBee malware: Spear phishing email > URL Link (TransferXL, TransferNow, WeTransfer) > Zipped ISO > ISO (contains the LNK file and the BumbleBee payload).You can see the execution flow in the image below.The infection flowWe’ve handled several incident response (IR) cases where threat actors distributed BumbleBee malware. After the initial infection, the threat actors inject Cobalt Strike shellcode in memory and execute discovery commands to collect info about the victim’s network. We believe that threat actors performed this data collection in order to execute the next stage of the infection.The next stage is probably related to ransomware operations. We’re still investigating IR cases in order to find conclusive evidence that the next stage delivers ransomware.On April 12, 2022, the BumbleBee IAB group was spotted using IMG file format in addition to ISO file format.You can see an example in the image below.2/21The IMG file, which contains LNK and DLLOrion’s technical analysis Initial AccessThe BumbleBee payload was delivered via a spear phishing email that was sent from a spoofed email address. The email contains a URL link to the legitimate public storage service, TransferXL.Spear phishing email with a link to TransferXLBelow you’ll see the legitimate public storage site, which leads the victim to the link to the malicious file.3/21TransferXL legitimate public storage servicesOnce they click download, the victim receives a ZIP folder that contains the malicious ISO image files.Spoofed company email addressExecutionBelow is an example of what the ZIP file from the TransferXL link looks like.4/21ZIP file download from TransferXLThe ZIP file contains an ISO image file with the following name “documents-04-106.iso.” Note that the following ISO image file name pattern was used for all the files that we have analyzed:documents-[0-9]{1,4}-[0-9]{1,4}\.isoISO image fileFrom this step, threat actors rely on the victim (user) interaction with the ISO image file. The threat actors use a masquerading technique by setting the LNK file icon to be a folder icon in order to lure the victim to click on the LNK file:ISO image file contains LNK and DLLIn addition, the DLL payload attribute is set as “Hidden” in order to hide the DLL payload from the user when interacting with the ISO image file:5/21Hidden attribute for the DLLThe masqueraded LNK file properties show that the execution target is as follows:C:\Windows\System32\rundll32.exe settings.dll,IternalJob6/21LNK executes the DLL via rundll32 commandAfter the initial execution, the BumbleBee DLL is copied to the %programdata%/{RandomDir} directory. In addition to the DLL, a VBS script is also dropped to the same directory:[a-z]:\\programdata\\[a-z0-9]{16}\\[a-z0-9]{16}\.[vbs|dll]TTPs indicators during the executionWe have other artifacts from different IR cases, where we have observed the following activity. The screenshot below shows an event that detected a creation of a payload in the %ProgramData%\ {Random} directory the DLL payload is a copy of the initial BumbleBee loader that executed by Rundll32 from the ISO image file:7/21Copy of the BumbleBee DLL to %Programdata% directoryIn other IR cases, we observed an execution flow that’s bit different. For example, a LNK that points to the following execution targets:cmd.exe /c start rundll32 neqw.dll,IternalJob rundll32.exe advpack.dll,RegisterOCX sysctl.exePersistenceWe detected a scheduled task execution during the BumbleBee infection:Grandparent process:svchost.exe -k netsvcs -p -s Schedule Parent process:wscript.exe [a-z]:\\programdata\\[a-z0-9]{16}\\[a-z0-9]{16}\.vbs Child process:rundll32.exe [a-z]:\\programdata\\[a-z0-9]{16}\\[a-z0-9]{16}\.dll,{Export}Strings from the BumbleBee loader show the VBS script and the execution methodWe also observed WMI execution. The VBS file that was executed via a scheduled task, was also executed through WMI:Grandparent process:svchost.exe -k DcomLaunch Parent process:wmiprvse.exe -Embedding Child process:wscript.exe [a-z]:\\programdata\\[a-z0-9]{16}\\[a-z0-9]{16}\.vbs8/21Strings from the Bumblebee loader show the WMI Win32_Process executionDefense EvasionIn our labs, we observed that BumbleBee uses several anti-VM methods to avoid detection.One of the anti-VM checks is related to the VirtualBox product:Check for lpWindowName if matches VirtualBoxOther anti-VM artifacts were found after unpacking, as can be seen in the following strings:9/21List of strings that are related to VMware and VirtualBoxBumbleBee also detects if it is running within a VM by checking for known services that are related to different VM products:10/21List of services that are related to VM productsBumbleBee checks whether certain user names reside in the victim’s machine by comparing against a hardcoded list of user names. This allows BumbleBee to detect sandboxes and labs that are used for malware analysis:List of hardcoded usernames which are related to sandboxes and labsIn addition, it uses WMI queries to collect system details and information:SELECT * FROM Win32_BaseBoard SELECT * FROM Win32_Bus SELECT * FROM Win32_ComputerSystem SELECT * FROM Win32_Fan SELECT * FROM Win32_NTEventlogFile SELECT * FROM Win32_OperatingSystem11/21SELECT * FROM Win32_PnPDevice SELECT * FROM Win32_PnPEntityDiscoveryWe found that the threat actors used the AdFind tool to enumerate and map the victim’s network. The ADFind tool was found in the %ProgramData% directory.In the instance we observed, the following commands were used:adfind.exe -gcb -sc trustdmp adfind.exe -f “(objectcategory=group)” adfind.exe -f “(objectcategory=organizationalUnit)” adfind.exe -f “objectcategory=computer” adfind.exe -f “(objectcategory=person)”Command and ControlAfter the initial execution, the BumbleBee process (Rundll32) communicated with the Command-and- Control server (C2). We’ve seen several C2 servers from different IR cases:IP: 23.82.19[.]208:443 IP: 192.236.198[.]63:433 IP: 45.147.229[.]177:433Example of the unique User-Agent: BumbleBee in the payload’s memory12/21Additional reference to the BumbleBee malware nameAll the collected system and network information is sent to the C2 server, which sends back a response containing the next step/command to execute based on that info.BumbleBee binary analysisIn this section, we will cover some interesting indicators and artifacts that highlighted the BumbleBee actions and heuristics. These artifacts also help us to identify the BumbleBee malware.We analyzed several payloads and all of them had the same artifacts.After unpacking the BumbleBee loader and by searching in the metadata of the unpacked payload, we identified BumbleBee’s internal name, “LdrAddx64.dll,” and two export functions – “IternalJob” and “SetPath.”BumbleBee internal name, export functions, and TimeDateStampIn the image below, we found the BumbleBee internal name and export function inside the process Rundll32.exe that executed the BumbleBee DLL loader:13/21Bumblebee’s internal name and the export functions names in the memoryBy inspecting the unpacked BumbleBee sections, we discovered that the .data section contains two executables:PEStudio shows the unpacked Bumblebee section and highlighted the .data sectionWe extracted the two hidden payloads from the .data section by using Hex-Editor tool:14/21Hex-Editor shows 3 MZ headers: the first one is the Bumblebee, and the other two are additional payloadsThe first payload from the .data section is a 32-bit DLL payload:15/21PEStudio showing the payload’s metadataWe found a few interesting functions in the payload strings indicating that this payload has process injection capabilities. For example, “CreateProcess,” “NtWriteVirtualMemory,” “CreateRemoteThread,”and “WinExec.”16/21PEStudio showing the payload’s strings that could be related to process injectionThe second payload that we extracted from the .data section is a 64-bit DLL payload:17/21PEStudio showing the payload’s metadataWe analyzed the payload binary and noticed that this payload is responsible for communicating with BumbleBee’s C2 server:In the strings we can see the C2 server’s IP address and portBoth DLL payloads have the same internal name “RapportGP.dll.” An interesting point regarding the payloads internal name is that there is a legitimate DLL named “RapportGP.dll” that is part of a “Trusteer18/21Ltd” product from a computer security division of IBM.Payloads internal name and TimeDateStampFinal notesBumbleBee threat actors are not the first to change the initial access method from malicious office documents to malicious ISO image files. The ISO image file abuse was also seen a few years ago, but in recent months, we have observed an increase in “ISO campaigns.”Different threat actors abuse ISO image files to deliver their payloads. For example, BazarISO deploys Bazarloader, and IcedID started to use ISO image files instead of MalDocs like in the two examples below.Documents-17.iso (Bazarloader)19/21Invoice_pdf_1.iso (IcedID)In most of the cases, we’ve seen that during different IR cases, the campaigns escalated to full-blown ransomware attacks. We believe that IAB groups work and collaborate with ransomware affiliates like CONTI, LockBit, AvosLocker, and more. For example, we observed an IcedID infection that leads to CONTI ransomware attack (Shelob Moonlight) The Orion team is constantly monitoring BumbleBee and the IAB group’s activities closely and analyzing them to better understand their motivation. As we learn more, we will publish our findings and artifacts to share additional insights for BumbleBee infection to ransomware post-attack chain.We’re expecting to see more malware campaigns that will use the ISO delivery method in the near future. So, stay vigilant.As a final note, we’d like to share these indicators of compromise with you.Indicators of compromise: 