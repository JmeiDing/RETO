Operation Tropic TrooperRelying on Tried-and-Tested Flaws to Infiltrate Secret KeepersKervin Alintanahin Targeted Attack Defense Response TeamContentsIntroduction ii Targets 1 Campaign Components 2 Point of Entry 2 Initial Payload: TROJ_YAHOYAH 3 Installation Routine 3 Download Routine 4 Maintaining Persistence 6 Backdoor Payload: BKDR_YAHAMAM 7 Command-and-Control Communication 7 Lateral Movement 10 Possible Connections 12 Defending Against Operation Tropic Trooper 14 Threat Intelligence Gathering 14 Download Links 14 Solution Use 15 Malicious Files iv References viINTRODUCTIONTaiwan and the Philippines have become the targets of an ongoing campaign called “Operation Tropic Trooper.” Active since 2012, the attackers behind the campaign have set their sights on the Taiwanese government as well as a number of companies in the heavy industry. The same campaign has also targeted key Philippine military agencies. Though the motivations behind the operation are still unclear, the tools and tactics used reveal potential areas of weakness both countries should look into.Operation Tropic Trooper took advantage of two of the most-exploited Windows® vulnerabilities to date— CVE-2010-3333 and CVE-2012-0158—to infiltrate their chosen networks. Part of its success could be attributed to the use of basic steganography or image file attachments laced with malicious code, combined with clever social engineering. This research paper provides in-depth technical information on Operation Tropic Trooper’s targets, components, tools, and tactics.** Special thanks to Ronnie Giagone for additionalanalyses and insights.TargetsMalware used in Operation Tropic Trooper shared similar characteristics with those used in attacks targeting various organizations in Vietnam and India as early as 2011. [1] Operation Tropic Trooper targets government institutions, military agencies, and companies in the heavy industry in Taiwan and the Philippines. [2]Operation Tropic Trooper campaign flow1 | Page© 2015 Trend Micro IncorporatedCampaign ComponentsPoint of EntryThe actors behind Operation Tropic Trooper used spear- phishing emails with weaponized attachments to exploit old vulnerabilities, particularly CVE- 2010-3333 and CVE-2012- 0158. [3–5] These bugs have been two of the most exploited vulnerabilities since their discovery. [6–7] To infiltrate target networks, the attackers relied on crafty social engineering tricks. They used contextually relevant subjects, content, and aptly named attachments such as “Statement” to convince chosen recipients to download and open the files supposedly sent for review. The following filenames were also used:Spear-phishing email sample• 3AD 28 March 2013, SI re ASG Plan Bombing in ZamboangaCity.doc• Troops Disposition 26 FEB 13.doc • 2nd qtr 2013 AR PF15.doc • Draft AS-PH MLSA - v3 DAGTS_CFO_ILOG_DSA Clean.doc • 關於104年中央政府總預算.doc (translation: About 104 years totalcentral government budget.doc)• 實驗室電話表.doc (translation: Laboratory telephone table.doc)2 | Page© 2015 Trend Micro Incorporated•[REDACTED]自荐信及个人简历.doc (translation: [REDACTED] cover letter and your resume.doc)Opening the attachment runs an embedded malicious executable file, normally a downloader that accesses a malicious site to download an image file. Some attachments open decoy documents to hide their malicious nature.Sample decoy documents (left: for Filipino targets; right: for Taiwanese targets)Initial Payload: TROJ_YAHOYAHThe downloader typically attached to emails related to Operation Tropic Trooper is detected by Trend Micro as TROJ_YAHOYAH, a downloader with 32- and 64- bit support. It has an encrypted configuration file and uses HTTP GET requests to download other files that are then decrypted and executed in memory.Installation RoutineWhen executed, TROJ_YAHOYAH checks if the infected system’s Windows OS is 64-bit capable or not. If it is, the Trojan will decrypt a 64-bit copy of itself using a simple XOR cipher with a single-byte key at “0x90.” If the infected system is not 64-bit capable, the Trojan will just drop a 32-bit executable copy of itself (%APP exe, detected as TROJ_YAHOYAH), along with an encrypted Credentials.dat). The configuration file was encrypted using the same simple algorithm featured in the previously cited Rapid7 report on KeyBoy. Unlike the KeyBoy Trojan though, which searches for the string, “IJUDHSDJFKJDE,” TROJ_YAHOYAH searches for “MDDEFGEGETGIZ.” These strings, found at the beginning of the decrypted code, represent the configuration file. Absence of the said file terminates the infection process.Code that decrypts the configuration file using “0x95,0x99,0x9d,0xc3,0xc7, 0xcb,0xd7,0xe5,0xbd,0xa9, 0xb5,0xeb,0xf7,0xe3,0xe7, 0xed” as key3 | Page© 2015 Trend Micro Incorporated• NA: Checks for the system’s hostname • VR: Hard-coded string only used when accessing download sites to track which downloader was used on a target.HTTP GET request sampleTROJ_YAHOYAH checks for the following antimalware solution processes:• 360rp.exe • escanmon.execonsctl.exeTROJ_YAHOYAH’s decrypted configuration fileTROJ_YAHOYAH’s configuration file, when decrypted, contains the links to sites from which it can download the files it needs to continue its routines. After decryption, it executes a dropped copy using the -Embedding parameter then attempts to delete itself. The downloader’s name was inspired by its self- deletion routine after dropping its payload. YAHOYAH was derived from the Visayan term “hayohay,” which loosely translates to an easily discarded “servant” in English. [8]Download RoutineTROJ_YAHOYAH attempts to access links and download files via HTTP GET requests. To move to another attack phase, it uses the following user-agent strings:• MSIE: Checks for the system’s InternetExplorer® version• NT: Checks for the system’s Windows OSversion• AV: Checks for installed antimalware solutions • OV: Checks for the system’s Microsoft™Office® version4 | Page© 2015 Trend Micro Incorporatedrtvscan.exe• mcshield.exe • uiwatchdog.exeTROJ_YAHOYAH temporarily saves downloaded files in a specially created folder named “%APP DATA%\ tasks\up{random characters}.msi.”Sample .MSI file with a malicious .JPG headerSample .MSI file opened on Microsoft PaintThe image is supposed to be an 800 x 600 wallpaper that is way heavier than the real one named “Wind. jpg” normally found in Windows XP systems’ %WINDOWS%\wallpaper\web folder. The actors behind Operation Tropic Trooper may be using a simple steganography technique to mask the backdoor’s routines in order to evade antimalware and network perimeter detection. [9] We have seen the actors use other images found in the same folder such as “Ascent.jpg,” “Friend.jpg,” and “Home.jpg.”5 | Page© 2015 Trend Micro IncorporatedA more in-depth analysis of the downloaded file reveals that malicious code has been appended to it. This allows TROJ_YAHOYAH to check offset 0x0F bytes from the end of the file code to identify a marker where the malicious binary code will be added, thus increasing the file’s size. TROJ_YAHOYAH looks for the string, “EHAGBPSL,” and decrypts the appended binary code. When decrypted, an .EXE file is executed in memory. It automatically runs if the user has administrator privileges. If the user has limited privileges though, it will first attempt to obtain administrator privileges by bypassing User Account Control (UAC) but only on Windows 7. It will then decrypt another XOR-encrypted file using the key “0x90” in memory then check if the “StartWork” function was exported then execute it.Other images used in attacksMalicious code appended to that of the .JPG fileMaintaining PersistenceThe last file that TROJ_YAHOYAH executes in memory is the main installer. It contains two more files that install a .DLL file detected as TROJ_YAHAMAM. This file is registered as a service named “INCS” to maintain persistence. It also drops the following XOR- encrypted malware-laced image files:• % windows %\System32\mfc41.dll (detectedas TROJ_YAHAMAM)• % windows %\inf\mfc41.inf (a configurationfile)• % windows %\Fonts\mfc41.tff (a copy of theconfiguration file)• %windows%\Web Wallpaper\images.jpg(contains BKDR_YAHAMAM)A batch (.BAT) file is used to start the INCS service. TROJ_YAHAMAM uses a trick similar to that of TROJ_YAHOYAH in order to decrypt files. When decrypted, TROJ_YAHAMAM executes the backdoor payload.6 | Page© 2015 Trend Micro IncorporatedBackdoor Payload: BKDR_ YAHAMAMBKDR_YAHAMAM is usually encrypted then embedded in an image file. When decrypted, it is loaded and executed in memory by a .DLL file that is registered as a service (TROJ_YAHAMAM). It exfiltrates data from infected systems, downloads and uploads files, and has a remote shell. It also drops a rootkit component named “usb.sys,” detected as RTKT_HIDEPORT.ZTCA-XO. The rootkit creates the service, usb30, and hides evidence of port communication to evade detection and remain persistent.Command-and-Control CommunicationWhen executed, BKDR_YAHAMAM checks if it runs under svchost.exe. It uses the configuration file, %windows %\Fonts\mfc41.tff, which contains the following information:• C&C1 • LoginPass (for authentication purposes) • UserMarkBKDR_YAHAMAM encrypts C&C communication using multiplication with a 1-byte key. Attackers can use the “?” and “Help” commands to see the various options the backdoor offers as shown in its code.Tool used to emulate command-and-control (C&C) communication with a 64-bit version of BKDR_ YAHAMAMWe were able to download some files from two of the C&C servers that TROJ_YAHAMAM accesses. These had some image files that the 32- and 64-bit versions of the backdoor can choose from for use in attacks.7 | Page© 2015 Trend Micro Incorporated8 | Page© 2015 Trend Micro IncorporatedThe following table lists the unique SHA-1 hashes that TROJ_YAHAMAM downloads, along with their backdoor payloads.C&C servers TROJ_YAHAMAM accesses to download malicious payloadsFilenameSHA-1 HashBackdoor PayloadTrend Micro 4f3HL3.7x64_20140711BKDR_YAHAMAMInterestingly, a BKDR_POISON variant was found on the sites’ folders as well, leading us to believe that the it can also perform more harmful actions like kill processes and services, delete files and directories, and put systems to sleep, among others. BKDR_YAHAMAM also attempts to install an accompanying executable rootkit (%windows %\system32\ drivers\usb30.sys, detected as RTKT_HIDEPORT.ZTCA-XO). RTKT_HIDEPORT.ZTCA-XO is also XOR encrypted and found at byte key, “0x90,” to hide the port that the backdoor should use according to the configuration file. It will only hide communication activities occurring in the first of three port entries indicated in the configuration file. After creating and starting the rootkit service, BKDR_YAHAMAM then attempts to delete the rootkit and the related service. This will not stop the rootkit from running in the background. BKDR_YAHAMAM variants with rootkits for 32-bit systems run on 32-bit versions of Windows XP. On Windows 7 64-bit systems, however, the backdoor works but the rootkit does not.Lateral MovementIn the course of doing research, we also managed to get hold of the following tools that the actors behind Operation Tropic Trooper used in an attack:• HKTL_GETOS: Detects a target system’s OS version. [10] • HKTL_SHARESCAN: Performs the following: -pr: Scans for open ports on target systems. -letmein: Scans for saved usernames and passwords on target systems. -arp: Views the Address Resolution Protocol (ARP) on each target system. -netview: Scans target systems for shared resources.HKTL_GETOS’s OS-version-sniffing routine10 | Page© 2015 Trend Micro IncorporatedHKTL_SHARESCAN’s routines (top left: -pr; top right: -letmein; bottom left: -arp; bottom right: -netviewThese hacking tools were possibly remotely downloaded by the attackers onto infected systems. They aided in lateral movement and further intelligence gathering. Data such as credentials saved on infected systems can be stolen via Address Resolution Protocol (ARP) poisoning or main-in-the-middle (MiTM) Layer 2 and pass- the-hash attacks. [11–12] The stolen credentials allow attackers laterally move throughout a network. The threat actors no longer have to hack their way in, they have the ability to log in as legitimate users.11 | Page© 2015 Trend Micro IncorporatedPossible ConnectionsBased on the specially crafted documents we were able to gather, Operation Tropic Trooper has been active since 2012. We have seen malware samples from 2011 that behaved the same way and used similar file markers. [13] The following table provides more detailed information on Operation Tropic Trooper’s downloader, TROJ_YAHOYAH.SHA-1 HashCampaign ID Hard- Operation Tropic TrooperThreat Intelligence GatheringNetwork and system administrators can protect against Operation Tropic Trooper by blocking user access to related C&C servers. They should also keep an eye out for related strings as well as services and their corresponding paths.Download LinksTROJ_YAHOYAH downloads the following image • air88.ddns.us/js/af130901.jpg • air88.ns01.us:53/js/af130901.jpg • air88.ns01.us/images/af130218.jpg • air88.ns01.us:53/js/af130901.jpg • air99.ns01.us/js/af130901.jpg • • msc.ddns.us:443/images/ph06.jpg • nevermore.onmypc.org/images/ph06.jpg • ph11.dns1.us:53/images/phzy.jpg • ph11.dns1.us/images/dfsy.jpg • ph11.dns1.us/images/dmjs.jpg • ph11.ns01.us:443/images/phzy.jpg • ph11.ns01.us:5050/images/dmjs.jpg • ph11.ns01.us/images/dfsy.jpg • ware.compress.to/imgs/phh121018.jpg • www . amberisic611 . 4dq . com / monitor /images / Smartzh140222 . gif• www . bannered . 4dq . com / monitor / images /Smartzh131225 . gifStringsTROJ_YAHOYAH looks for the following strings to continue performing its malicious routines:• EHAGBPSL • MDDEFGEGETGIZServicesNetwork and system administrators can also look out for the following services, which are related to TROJ_ YAHAMAM:• ServiceName: INCS DisplayName: IPSEC NetworkConnections Services; ImagePath: %SystemRoot%\System32\ svchost.exe -k incsvc• ServiceName: usb30 DisplayName: usb30 ImagePath: %SystemRoot%\\System32\ DRIVERS\usb30.sys• www . bannered . 4dq . com / monitor / images /Smartzh140222 . gifSolution Use• www . cham . com . tw / images / dzh _ 0925 . jpg • www . forensic611 . 3 - a . net / monitor / images /Smartzh131225 . gif• www . forensic611 . 3 - a . net / monitor / images /Smartxy130619 . gif• www . forensic . zyns . com / monitor / images /Smartzh131225 . gif• www . metacu . ygto . com / monitor / images /Smartzh140222 . gifWe also recommend a Custom Defense strategy that uses a comprehensive “Detect—Analyze— Respond” life cycle to address threats particular to an organization. This can provide in-depth threat profile information as well as advanced threat detection at the network level to discover malicious content (malware), communication, and attacker activity that are not typically visible to traditional security solutions.15 | Page© 2015 Trend Micro IncorporatedThe following table shows how a custom defense solution such as Trend Micro™ Deep Discovery can aid in detecting the components of Operation Tropic Trooper.Attack ComponentDeep Discovery ComponentDescriptionSpear-phishing emailsEmail InspectorMalicious image filesAnalyzerMalware• BKDR_POISON.TUFN • BKDR_YAHAMAM • RTKT_HIDEPORT.ZTCA-XO • TROJ_YAHOYAHAnalyzerInspectorDetects spear-phishing emails used to infiltrate, establish a foothold in, and launch targeted attacks against targets; has email-inspection capabilities that detect malicious content, attachments, and URLs that pass unnoticed through standard email security solutionsDetects even previously unknown threats by analyzing a broad range of file types, sizes, and sources using customizable sandbox environments that attackers design and build to match organization’s desktop and device platformsDetects even previously unknown threats by analyzing a broad range of file types, sizes, and sources using customizable sandbox environments that attackers design and build to match organization’s desktop and device platformsIdentifies suspicious activities anywhere on networks, including those related to lateral movement and C&C; also detects traffic generated by malware-download-related behaviors via HTTP GET requests16 | Page© 2015 Trend Micro IncorporatedCONCLUSIONOperation Tropic Trooper is not highly sophisticated. But the fact that it has attained some degree of success and has managed to infiltrate crucial organizations in both Taiwan and the Philippines shows the urgent need for targeted entities to rectify their shortcomings in terms of security. As with other targeted attacks, Operation Tropic Trooper brings great risks, especially since its targets include government institutions and military agencies. Although we were not able to collect enough information to determine the identities and motivations of the actors behind Operation Tropic Trooper, we were able to gather enough intelligence to help potential victims defend against the campaign. Knowing that attackers are still using old techniques and exploiting known vulnerabilities will make it easierfor the targeted organizations to pinpoint and fix security gaps in their networks. Building threat intelligence is crucial in the fight against targeted attacks. Identifying the tools, tactics, and procedures (TTPs) that threat actors use based on external reports and internal historical and current monitoring can help create a strong database of indicators of compromise (IoCs) that can serve as basis for action. Using the right tools for advanced threat protection should also be part of an expanded security monitoring strategy. This includes establishing and empowering incident response teams and training employees, partners, and vendors Against Vietnam and India.” Last accessed on 7 April 2015, https:// community.rapid7.com/community/infosec/blog/2013/06/07/keyboy- targeted-attacks-against-vietnam-and-india. Investopedia, LLC. (2015). Investopedia. “Heavy Industry.” Last accessed on 22 April 2015, url heavy_industry.asp.[2][3] Loucif Kharouni. (10 January 2014). TrendLabs Security Intelligence Blog. “Targeted Attack Methodologies for Cybercrime.” Last accessed on 7 April 2015, url intelligence/whatever-works-targeted-attack-methodologies-for- cybercrime/.[4] Kyle Wilhoit. (15 December 2013). TrendLabs Security IntelligenceBlog. “Cybercriminals Using Targeted Attack Methodologies (Part 1).” Last accessed on 7 April 2015, url trendlabs-security-intelligence/cybercriminals-using-targeted-attack- methodologies-part-1/.[5] Maersk Menrige. (17 June 2014). TrendLabs Security IntelligenceBlog. “Template Document Exploit Found in Several Targeted Attacks.” Last accessed on 7 April 2015, url security-intelligence/template-document-exploit-found-in-several- targeted-attacks/.[6] Ryan Flores. (9 May 2012). TrendLabs Security Intelligence Blog.“Snapshot of Exploit Documents for April 2012.” Last accessed on 7 April 2015, url snapshot-of-exploit-documents-for-april-2012/.[7] Trend Micro Incorporated. (2014). Trend Micro Security Intelligence. “Cashing in on Digital Information: An Onslaught of Online Banking Malware and Ransomware.” Last accessed on 7 April 2015, http:// www.trendmicro.com/cloud-content/us/pdfs/security-intelligence/ reports/rpt-cashing-in-on-digital-information.pdf.[9][8] Wikimedia Foundation, Inc. (12 October 2014). Wikipedia. “Alipin.”Last accessed on 8 April 2015, url Jennifer Gumban. (3 March 2014). TrendLabs Security Intelligence Blog. “Sunsets and Cats Can Be Hazardous to Your Online Bank Account.” Last accessed on 10 April 2015, url trendlabs-security-intelligence/sunsets-and-cats-can-be-hazardous-to- your-online-bank-account/.[10] Trend Micro Incorporated. (2015). Threat Encyclopedia. “HKTL_GETOS.” Last accessed on 10 April 2015, url trendmicro.com/ArchiveGrayware.aspx?language=cn&name=HKTL_ GETOS.[11] Jeff King and Kevin Lauerman. (2015). Cisco. “ARP Poisoning (Man-in-the-Middle) Attack and Mitigation Techniques.” Last accessed on 20 April 2015, url catalyst-6500-series-switches/white_paper_c11_603839.html.[12] SANS Institute. (2010). SANS Institute InfoSec Reading Room. “Pass-the-Hash Attacks: Tools and Mitigation.” Last accessed on 20 April 2015, url hash-attacks-tools-mitigation-33283.[13] McAfee, Inc. (2014‒2015). McAfee for Business. “GenericDropper!dyh!4929C723EA9D.” Last accessed on 1 April 2015, http:// www.mcafee.com/threat-intelligence/malware/default.aspx?id=570595.[14] Trend Micro Incorporated. (2015). Trend Micro Security News.“Targeted Attack Campaigns and Trends: 2014 Annual Report.” Last accessed on 14 April 2015, url security/news/cyber-attacks/targeted-attack-campaigns-and-trends- 2014-annual-report.Trend Micro Incorporated, a global leader in security software, strives to make the world safe for exchanging digital information. Our innovative solutions for consumers, businesses and governments provide layered content security to protect information on mobile devices, endpoints, gateways, servers and the cloud. All of our solutions are powered by cloud-based global threat intelligence, the Trend Micro™ Smart Protection Network™, and are supported by over 1,200 threat experts around the globe. For more information, visit www.trendmicro.com.© 2015 by Trend Micro, Incorporated. All rights reserved. Trend Micro and the Trend Micro t-ball logo are trademarks or registered trademarks of Trend Micro, Incorporated. All other product or company names may be trademarks or registered trademarks of their owners. 