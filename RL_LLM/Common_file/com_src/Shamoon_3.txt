5/23/2019Shamoon 3 Targets Oil and Gas OrganizationShamoon 3 Targets Oil and Gas Organizationunit42.paloaltonetworks.com/shamoon-3-targets-oil-gas-organizationBy Robert FalconeSummaryDecember 13, 2018On December 10, a new variant of the Disttrack malware was submitted to VirusTotal malware used in the Shamoon 2 attacks in 2016 and 2017 that we previously published here, here, and here. While we could not identify the impacted organization from the malware, today Saipem disclosed they were attacked. In previous attacks, we were able to determine the impacted organization based on the domain names and credentials used by the Disttrack tool to spread to other systems on the network. However, that functionality was missing from this sample. Unlike past Shamoon attacks, this particular Disttrack wiper would not overwrite ﬁles with an image. Instead it would overwrite the MBR, partitions, and ﬁles on the system with randomly generated data.According to a press release, Saipem conﬁrmed that they experienced a cyberattack that involved a variant of the Shamoon malware. The attack caused infrastructure and data availability issues, forcing the organization to carry out restoration activities. Saipem told Reuters that 300 systems on their network were crippled by the malware related to the 2012 Shamoon attacks. While we cannot deﬁnitively conﬁrm that Saipem was the impacted organization, the timing of this incident with the emergence of the Disttrack sample discussed in this blog is quite coincidental.DropperThe sample submitted to VirusTotal is a Disttrack dropper, which is responsible for installing a communications and wiper module to the system. The dropper is also responsible for spreading to other systems on the same local network, which it accomplishes by attempting to log into other systems on the network remotely using previously stolen usernames and passwords. Unfortunately, this particular sample does not contain any domains, usernames, or passwords to perform this spreading functionality, so this sample would only run on the system in which it was speciﬁcally executed.The dropper has a hardcoded kill time of ’12/7/17 23:51′; if the system date is after this date the dropper installs the wiper module and starts wiping ﬁles on the system. The dropper reads the ‘%WINDOWS%\inf\mdmnis5tQ1.pnf’ ﬁle to obtain a custom kill date that it will use instead of the hardcoded time. The communications module installed by the dropper writes to this ﬁle, which will be discussed in a later section. The dropper also decrypts a string ‘\inf\averbh_noav.pnf’ that is the other ﬁle that the communications module uses to write system information to and if the wiper was able to successfully wipe the system, but the dropper does not appear to use this ﬁle.The dropper has three resources, two of which contain embedded modules, speciﬁcally a communications module and a wiper module. The third resource contains an x64 variant of the dropper, which it will use if the architecture of the system is determined to be x64. The resources have a language set to ‘SUBLANG_ARABIC_YEMEN’ that was also found in the previous Disttrack samples used in Shamoon 2 attacks. The resource names are PIC, LNG, and MNU, which are slightly altered versions of the ICO, LANG, and MENU names found in previous samples.The dropper extracts modules from these resources by seeking a speciﬁc offset and reading a speciﬁc number of bytes as the length of the ciphertext. The dropper then decrypts the ciphertext by using an XOR cipher and a speciﬁc base64 encode string that is decoded and used as the key. Before accessing the ciphertext, the dropper subtracts 14 from the speciﬁed offset, which is the same as previous Disttrack samples delivered in Shamoon 2 attacks. Tables 1, 2, and 3 include the resources, the information used to extract them, and the resulting module.PICx64 variant of Dropper2q9BQGHGVktPVIMZ6Nx17Njp4B5mHgj51hbybNInRWsNIWniq6hOYvf5CksMXvPOyl/3dYKDn7ymSGlK0+l5KA8YC8dzkkAwmn0nbBO97Hgj‐ JKJyL9DoiYKsO2M+A44NgOI89FIsWjcex9oEWzOo6VvxJ69HBvg+L4FExlbd8ZfvGewxgPgl98lqVGj14y5OBFIHTdvfxnnq/cTR55TgQdVDFU‐ extTable 1 Resource containing the x64 variant of the Disttrack dropperRe‐ KeyMNUCommunications moduleU3JGgjNUDzWJEpOxzuwHjOijgav56cZatHh98dLbazGIBe7UMOcvdyCvU5/8mH1n7jUcMSIPFmqr7M671h5jradiKMn9M1sBdAmKSZUnXhz6FQKcvzkOee6EKEQurl 3 Targets Oil and Gas Organization8601-14 extTable 2 Resource containing the communications module in the Disttrack dropperLNGWiper modulecb5F91PLTu1hN8oPgG2a6AQiJkphsXAmWFarsUoYEFo/BNgxF8Rj/hdzHxW/k/fLCZboSJRLnr9OH578IJyiSSdvz3uUaNA/vycy7ZJa‐ Z8Vf36i0L8fF9GYY4/glZt570dbuT8N7N6DFqIltGLAt87fZnUH07RlfqtsVfITXGlhJtxu7bBgB46gH74Y+WNy16u9BS8mdh+S8jqToZrob7o4w‐ I2CUcoaf17mZ7P2SIVL+X5GVls6OrDA3/t50GX3t6wH4DTR7IHhoonQPA5rmKWxS6gcp extTable 3 Resource containing the wiper module within the Disttrack dropperThe dropper will install itself to the system (and remote systems if spreading was possible) by creating a service with the attributes listed in Table 4 pathMaintenaceSrvMaintenace Host ServiceThe Maintenace Host service is hosted in the LSA process. The service provides key process isolation to private keys and associated crypto‐ graphic operations as required by the Common Criteria. The service stores and uses long-lived keys in a secure process compl\x1dMaintenaceSrv32.exe or MaintenaceSrv64.exeTable 4 Service created by the Disttrack dropperThe dropper chooses a random name when installing the communication and wiper modules to the system. The communications module will have one of the following ﬁlenames with the ‘exe’ ﬁle extension:netnbdrve wpdmtp_ibv32url 3 Targets Oil and Gas Organizationmdmti_ibv32 printupg_ibv32 wiabr788The wiper module will have one of the following ﬁlenames with the ‘exe’ ﬁle extension:_wialx002 responsible for overwriting the data within the MBR, partitions, and ﬁles on the system. The wiper carries out this wiping using a legitimate hard disk driver called RawDisk by ElDos. The wiper contains the ElDos RawDisk driver in a resource named ‘e’ that it extracts by skipping to offset 1984 and reading 27792 bytes from that offset. It then decrypts the data using aa 247-byte key and saves it to ‘%WINDOWS%\system32\hdv_725x.sys’. The wiper then creates a service named ‘hdv_725x’ for this driver using the following command line command and runs it with “sc start hdv_725x”:sc create hdv_725x type= kernel start= demand binpath= %WINDOWS%\system32\hdv_725x.sysThis wiper was conﬁgured using the ‘R’ ﬂag, which generates a buffer of random bytes that it will use to overwrite the MBR, partitions and ﬁles. The sample supports two additional conﬁguration ﬂags as well, speciﬁcally ‘F’ and ‘E’ ﬂags that will either overwrite ﬁles using a ﬁle or encrypt its contents.The wiper could be conﬁgured to use a ﬁle to overwrite the ﬁles on the disk using the ‘F’ conﬁguration ﬂag, as we saw images used to overwrite ﬁles in previous Shamoon attacks. This ﬁle would be stored in a resource named ‘GRANT’, but this particular wiper is not conﬁgured to use a ﬁle for overwriting so the GRANT resource does not exist. If it were conﬁgured to use a ﬁle, this sample would extract the ﬁle using the information listed in Table 5.GRANTFile to overwrite within Wiper moduleheocXOK4rDmQg4LRﬁURI9wSOuSMwe0e69NfEpZLmyNixiUGYdEtpx/ZG3rMRN7GZlJ1/crQTz5Bf6W0xgkyYCwzD247FolCGA0EE5U/Oun5qlDd1u1CA+fee7cG71-14 extTable 5 Resource in wiper module that would contain ﬁle to use for overwriting dataThis sample is also capable of being conﬁgured to import an RSA key to encrypt the MBR, partitions, and ﬁles via conﬁguration ﬂag ‘E’. This sample was not conﬁgured to encrypt ﬁles, and the RSA key is empty in the wiper.After completing this wiping functionality, the sample will reboot the system using the following command line, which will render it unusable when the dropper will use the following two supporting ﬁles:%WINDOWS%\inf\mdmnis5tQ1.pnf – Used to set a wipe date for associated wiper module%WINDOWS%\inf\averbh_noav.pnf – Used to mark successful wipingThe communications module is responsible for reaching out to hardcoded URLs to communicate with the C2 server, but like previous Disttrack samples, this communication module does not contain functional C2 domains to use in the URLs. If it did, it would create a URL with a parameter named ‘selection’ followed by system information and the contents of the ‘averbh_noav.pnf’ ﬁle, as seen here:[C2 URL, empty]?selection=[system info and contents of averbh_noav.pnf]When communicating with the C2 URL, the communications module would use a User Agent of ‘Mozilla/13.0 (MSIE 7.0; Windows NT 6.0)’, which is the same as past Disttrack communication module samples. Table 6 below show the two commands the C2 could respond with that the communications module could handle.Com‐ mand ETDescriptionReads base64 encoded ﬁle from the C2 server, runs ‘del /f /a %TEMP%\Temp\reilopycb\*.exe’ to delete previously downloaded executables, runs ‘mkdir %TEMP%\Temp\reilopycb] > nul 2>&1’ to create a folder and saves the executbale to a ﬁle named ‘[tick count].exe’. The Trojan then runs the downloaded executable %TEMP%\Temp\reilopycb\[tick count].exe’ Opens the ‘\inf\mdmnis5tQ1.pnf’ ﬁle and writes a supplied date to the ﬁle. The ‘\inf\mdmnis5tQ1.pnf’ ﬁle is used by another associated module to this communications module that is responsible for wiping the system.Table 6 Commands available within the communication module’s command handlerConclusionThe Disttrack sample uploaded to VirusTotal is a variant of the samples used in the Shamoon 2 attacks in 2016 and 2017. The tool does not have the capability to spread to other systems on the local network. Instead it would have to be loaded onto and executed on the system that the actors intend to wipe. The wipe date of ’12/7/2017′ does not seem timely. However, this older date is still effective as the Disttrack dropper will install and run the wiper module as long as the system date is after the wipe date. Unlike past Shamoon attacks, this particular Disttrack wiper would not overwrite ﬁles with an image. Instead, it would overwrite the MBR, partitions and ﬁles on the system with random data. While we can’t conﬁrm this sample was used in the Saipem attack, it is likely at least related to it.Palo Alto Networks customers are protected from this threat:WildFire detects all samples associated with this attack with malicious verdicts 