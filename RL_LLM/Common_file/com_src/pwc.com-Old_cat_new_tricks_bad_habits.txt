www.pwc.com /gx/en/issues/cybersecurity/cyber-threat-intelligence/old-cat-new-tricks.html Old cat, new tricks, bad habitsAn analysis of Charming Kitten’s new tools and OPSEC errorsCopy link Link copied to clipboardBy Krystle Reid Executive summaryYellow Garuda (similar to Charming Kitten, PHOSPHORUS, UNC788) is a threat actor likely to have been active since at least 2012. It is possibly one of the most active and persistent Iran-based threat actors over the last decade and is known primarily for spoofing log-in pages of legitimate webmail services to collect credentials from its targets. The threat actor also has a history of operational security (OPSEC) errors resulting in disclosure of its tools, techniques and procedures (TTPs), including the addition of Android malware to its expanding toolset.OPSEC mistakes associated with Yellow Garuda operations in late 2021 resulted in the discovery of new tool used to enumerate data from targeted Telegram accounts. We also identified an alias tied to early Iran-based operations and a surveillance report likely written by a Yellow Garuda operator. Additionally, PwC analysts have observed the threat actor’s use of macro-enabled template files as recently as March 2022, a new TTP not previously associated with Yellow Garuda. Telegram ‘grabber’ tool1/14Through our regular scanning for Yellow Garuda infrastructure, PwC analysts identified an open directory located at 138.201.145[.]183 containing several compressed archives associated with late 2021 Yellow Garuda activity.Each of the RAR archives contained a copy of a tool named NewTelegram.LocalGrabber.Sqlite.UI.Win.exe, together with the tool’s component parts, and exfiltrated victim data. In total there were seven sets of victim data on the server, six of which were outputs of the Telegram ‘grabber’ tool, and one of which was almost certainly the result of data exfiltrated by mobile malware. Although it is unclear what malware was used, we note that the type of data captured is in line with the capabilities of PINEFLOWER, an Android malware previously attributed to Yellow Garuda1.These archives had filenames referencing Solar Hijri calendar dates indicating that the activity took place between 7th September and 11th October 2021, when converted to the Gregorian calendar. The activity suggests domestic targeting as all victim mobile numbers contained the Iranian country code and Farsi was the main language seen in victim databases (as part of Telegram group names or in exfiltrated messages). From the data exfiltrated, it was also apparent that some of victims were associates of each other, where two pairs of victims were contacts of another victim on Telegram. We also observed that two of the victims likely had links to the Iranian music industry.Figure 1 - Contents of 138.201.145[.]1832/14The Telegram grabber tool is written in C++ and uses the open source Telegram Database Library (TDLib), a cross-platform Telegram client typically used to create custom apps for the platform2. It has been designed to exfiltrate information from a victim’s Telegram account. This includes messages and associated media, group memberships and contact data.SHA-256 NewTelegram.LocalGrabber.Sqlite.UI.Win.exe Win32 EXE 5,423,104 bytes 2062-01-30 02:30:48In order to access the victim’s account, the threat actor needs to enter a login code which is issued by Telegram as part of its authentication process. The code is sent either to the victim’s Telegram account, or via SMS to the victim’s phone3. This means that the threat actor needs to have access to a victim’s active Telegram session, either via a phone or desktop, or otherwise be able to access their SMS messages, for example via mobile malware. As can be seen in Figure 2, the victim’s phone number is required upon opening the tool in order to send the authentication code.Figure 2 – GUI to enter victim’s phone numberIf the victim has enabled two-step verification, an additional password is needed. Where this is unknown, it can be reset using a recovery email if one has been previously setup. The tool has options to view the password hint and send an access code via the victim’s recovery email address, which the threat actor would need to access in order to proceed. The existence of this option indicates that the threat actor, at least in some cases, is likely to have access to the victim’s email account. This aligns with Yellow Garuda’s known tactics, which include extensive credential harvesting via dedicated phishing sites.Once authenticated, the operator is presented with multiple options to choose the type of data to download. This includes the ability to select a date range for the download of the different types of Telegram chat messages. For groups, the tool attempts to grab details on the participants as well as whether or not the victim is an administrator. The tool is also able to download data relating to the victim’s profile and their contacts, including their names, phone numbers, usernames and profile pictures.3/14Figure 3 – Metadata accessed for each contactThe exfiltrated data is stored within a SQLite database and also in JSON format. For attachments sent or received through chats, there are options to choose specific file formats to download. These pertain to common video, audio, document, binary and compressed file extensions. In addition to being able to exfiltrate data, the threat actor also has the ability to delete messages from the victim’s account.We found 15 additional samples of the tool on an online multi-antivirus scanner which share the same filename (NewTelegram.LocalGrabber.Sqlite.UI.Win.exe) and TypeLib ID (7bb2c20c-740e-498b-8dd6- 9c2ff8ad9572) as the sample we analysed. The TypeLib ID is a unique GUID created by Visual Studio when a new project is created4, thus indicating that all of the samples originated from the same project. The additional samples were all uploaded within a 31 day window between January and February 2021 and contained similar functionality to the one we analysed. The main difference was the presence of a web request function that appeared to be used in a testing capacity. Given the clustered times of submission and the presence of the web request test method, we assess it is likely these samples were submitted by the threat actor itself in a testing capacity. Insights into Yellow Garuda’s operationsThe following Microsoft Word document was found in the directory corresponding to one of the victims whose data was highly likely exfiltrated via mobile malware and not through the Telegram ‘grabber’ tool.4/14Its filename translates to ‘01Report’ and its contents detail the status of the surveillance on that victim.Filename Last modified user ll_invisible_ll Creation date 2021-10-11 06:48:00 Last modifed date 2021-10-12 12:54:00 File size13,736 bytesFigure 4 – Threat actor report (left) and translation from Farsi to English (right)The report gives us insight into the threat actor’s specific data collection objectives. It references the surveillance of audio and video conversations of the victim’s phone and confirms the victim’s name, national identity number, mobile number and phone model. It indicates the surveillance was completed on 11th October 2021 and is being sent for review by the ‘relevant expert’ on the orders of the manager of ‘2000’ and ‘2300’, numbers which could represent individual operators or departments within Yellow Garuda’s operations. The report ends with a warning that if the surveillance is detected, it will not be possible to re-access the phone.These numbers align with additional observations from the output log files of the Telegram ‘grabber’ tool which contained local file paths likely belonging to the threat actor. An example is as follows:5/14Figure 5 – Example of file path found in output log files. The date converts to 22nd September 2021 in the Gregorian calendarWe observed values of 1500, 2700 and 3500 being used as part of the local directory structure. This indicates that at least three operators or teams may have contributed to the Telegram ‘grabber’ activity observed and a further two separate operators or teams worked on the victim referenced in the report.A previously leaked organisational chart associated with Iran’s Islamic Revolutionary Guard Corps (IRGC) shows individual departments with similar numerical referencing (Figure 6)5. From the English translation in Table 1, we can see that several of the observed values are present, overlapping with departments related to cyber, security and counterintelligence. Although we are unable to independently verify the validity of this chart, the overlap in naming convention, and our understanding that Yellow Garuda is likely associated with the IRGC6, aligns with our assessment that these are operator/team names.The author name of the threat actor report, “ll_invisible_ll” is fairly unique and gives us insight into a potential individual operator. This alias was also in use between 2010 and 2016 on the Ashiyane forum, a now defunct Iranian hacking forum originally started by the Ashiyane Digital Security Team. The Ashiyane Digital Security Team has previously been linked to IRGC activity7 and several of its members appeared in a US Department of Justice (DOJ) indictment for distributed denial of service (DDoS) attacks against organisations in the US financial sector and other US-based companies between 2011 and 20138.6/14Figure 6 – Diagram purportedly showing IRGC-related departments and leads (Farsi language) [9]Name Head of the Intelligence Unit of the IRGC, Hossein Taeb The Head of Department, General Yar Ali Sabzi Deputy of Readiness and Support Deputy of HR and Recruitment Deputy of Plan, Program and Budget, General Gholipour Deputy of Military IntelligenceNumber 5007/14Deputy of Psychological Operations, Haj Abdullah Mushfeq Special cases Deputy of Equipping, General Sadeghian Deputy of Information Protection, Izadi Deputy of Inspector, General Karimi Deputy of Information Collection Thematic Deputy of Counterintelligence, General Taha Deputy of Arrest and Surveillance Operation, Detention Center, General Qajavand Legal Deputy, Dr. Mahdavi Deputy of Civil Engineering (Structure and Building) Representative of the Supreme Leader, Haj Qasimi and Mr. Elahi Deputy of Cyber, Hamid Naeem Deputy of Security (Counter-Terrorism and Fight against Armed Groups), General Nouhi Deputy of Crimes Centre of Documents600 N/ATable 1 – English translation of Figure 6 showing IRGC-related departments and leads; numbers overlapping with those observed in our analysis have been highlighted in bold Macro-enabled Word document templatesBetween January and March 2022, we observed Yellow Garuda using Microsoft Word document droppers which use remote template injection to obtain and execute a malicious macro. This is the first time we have observed the threat actor deploying macros or using remote template injection as part of its attack sequence.SHA-256 related to Turkey, US shipping ports and Iran’s relationship to the Taliban and as such, we assess they were likely used to target a variety of unrelated entities. Many of these lures, used material sourced from legitimate English-language websites, including news and media sites. It is not unusual for threat actors to make use of current affairs as a means to catch the attention of potential victims and the themes are not necessarily indicative of specific targeting.8/14Figure 7 – Example of lure contentThe initial Microsoft Word document (DOCX) is hosted on a third party service such as Dropbox or Amazon Web Services (AWS). Yellow Garuda is known to extensively employ social engineering as part of its attacks, therefore it is highly likely phishing was used to coerce a potential victim to download and open the document.Once opened, a form of remote template injection takes place where the document reaches out to a URL to download a file with a DOTM extension (a macro-enabled template file). The URL is specified within the relationship component word/_rels/settings.xml.rels of the initial document as indicated by the ‘Target’ value in Figure 8. The documents we analysed reached out to files hosted on either Microsoft OneDrive or on dedicated threat actor-controlled infrastructure, as can be seen below.Figure 8 – URL visible in word/_rels/settings.xml.relsWe were able to access several examples of this second stage macro-enabled template file. These differed in functionality and form, however they all maintained persistence by replacing the victim’s default Microsoft Word template, meaning that the malicious template (and macro) will open whenever Microsoft Word is opened by the victim.SHA-256 found in open source on a GitHub repository12. In other cases13, the template files were password protected meaning that the victim is required to specify the password in order for the attack sequence to proceed. This would need to be passed over to the victim via a phishing email or some other form of social engineering. The template files also contained RC4-encrypted strings (both within the macro and lure document) for which the decryption key needed to be obtained as the response to a HTTP GET request to an Amazon S3 bucket. These steps were likely designed to thwart analysis attempts if the password cannot be obtained to open the document, or the infrastructure hosting the decryption key is no longer active.Files dropped by the macros shared similar filenames to recent Yellow Garuda activity observed by Check Point14. The PowerShell backdoor known as CharmPower was observed to read data from a file called ni.txt, located in %AppData%, whose contents are sent to the command and control server along with basic information about the victim’s machine. This aligns with our observations that ni.txt is used to house a hardcoded identifier and could indicate that a version of CharmPower is deployed at a later stage of the attack sequence. ConclusionOver the past year, we have seen Yellow Garuda continue to add tools to its arsenal. In its use of macro- enabled template files, we can see that the threat actor has made efforts to stage various parts of the infection chain remotely, disrupting analysis efforts where these are not accessible. The threat actor has also continued to make OPSEC mistakes exposing its tools and targeting through open servers. The Telegram ‘grabber’ tool we observed appears to be a tool that the threat actor has had access to since at least January 2021, and used against domestic targets to obtain specific access to Telegram messages and contacts alongside mobile malware.The threat actor’s operational report has given us further insight into its analysis process, indicating that there is an internal structure to its operations denoted by numerical call signs. It also highlights the alias of an individual which has previously been linked to Iran-based activity over several years.MITRE ATT&CKMore detailed information on each of the techniques used in this blog, along with mitigations, can be found on the following MITRE pages:Valid Accounts - url Authentication Interception - url Files or Information - url Information Discovery - url Network Configuration Discovery - url Staged - url Over Web Service - url Infrastructure: Web Services - url Infrastructure: Domains - url Spearphishing Link - url of CompromiseTelegram ‘grabber’ tool:TypeIndicator NewTelegram.LocalGrabber.Sqlite.UI.Win.exe 138.201.145[.]183Macro-enabled template activity:MD5 official-updates[.]info office-updates[.]info 51.38.87[.]253Type IPv4 address12/14hxxp://official-updates[.]info/office/Default.dotm hxxps://dl[.]dropboxusercontent[.]com/s/psmt483ybusajvy/Turkey.docx?dl=0 hxxps://u1ndk6f4nf[.]execute-api[.]us-east- 1[.]amazonaws[.]com/page/EdPEtAGapngkNtLLFCee hxxps://u1ndk6f4nf[.]execute-api[.]us-east- 1[.]amazonaws[.]com/page/zhUezQeFqaDRmxWaHfVz hxxps://s3[.]amazonaws[.]com/2v63r9egi46/mvhg5dhdbsolshpq hxxps://s3[.]amazonaws[.]com/2v63r9egi46/hgn8fdsf512fsc5 hxxps://drive[.]google[.]com/uc? export=download&id=13_PT71n8Ujl2lSTcQcyFJ4TNetI- wvDf&dID=1645099370036&linkName=Download%20File hxxp://office-updates[.]info/2022/Details.dotm hxxp://office-updates[.]info/static/admin/storage/Arabic.dotm hxxp://office-updates[.]info/static/admin/storage/Details.dotm URL[1] ‘UNC788: IRAN’S DECADE OF CREDENTIAL HARVESTING AND SURVEILLANCE OPERATIONS’, VB2021 localhost, url (October 2021)[2] Telegram, ‘Telegram Database Library’, url Telegram, ‘FAQ’, url#login-and-sms[4] ‘Using .NET GUIDs to help hunt for malware’, Virus Bulletin, url guids-help-hunt-malware/ (25th June 2015)[5] ‘BLACK BOX|هﺎﯿﺳ ﻪﺒﻌﺟ’, Telegram, url (26th February 2019)[6] ‘BadBlood: TA453 Targets US and Israeli Medical Research Personnel in Credential Phishing Campaigns’, Proofpoint, url (30th March 2021)[7] ‘Decision 2011/235/CFSP’, European Union, url url (11th January 2022)14/14 