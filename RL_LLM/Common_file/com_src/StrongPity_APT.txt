WHITEPAPERSecurity StrongPity APT - Revealing Trojanized Tools, Working Hours and InfrastructureContents Overview 3Key Findings: 3Infrastructure 3Download Servers 3Trojanized installers 4The download server 5Command and Control Servers 6First layer 6Second layer 6Components and Communication Protocol 8 Victims 9Mitre Matrix TTPs 10Appendix 11Author: Radu Tudorica – Security Researcher, Cyber Threat Intelligence Lab Co-authors: Cristina Vatamanu - Senior Team Lead, Cyber Threat Intelligence Lab Alexandru Maximciuc - Team Lead, Cyber Threat Intelligence LabOverviewKey Findings:StrongPity, also known as Promethium, is a threat group that is assumed to have been active since at least 2012. Information about this actor was first publicly reported in October 2016 with details on attacks against users in Belgium and Italy. Later, in 2018, the attackers shifted their focus on another geographical region, compromising Turkish telecommunication companies to target hundreds of users in Turkey and Syria.It is believed that the attacks attributed to StrongPity are government-sponsored and are used for population surveillance and intelligence exfiltration. More so, it is believed that these attacks are used as support for the geo-political conflicts in the region. The known preferred infection vector used by the StrongPity group is a watering hole technique, delivering malicious versions of legitimate installers to certain targets.By closely monitoring this threat, Bitdefender has managed to investigate it from several angles. Besides the technical setups of command and control servers, our researchers managed to get an insight into the victims’ profile.Most of the targets are located in two regions in Turkey: in Istanbul and the area close to the Syrian border.The data we have gathered in the investigation into this threat actor suggests that the attacker is interested especially in the Kurdish community, placing this threat in the geo-political context of the constant conflicts between Turkey and the Kurdish community.• Watering hole tactic that selectively targets victimsin Turkey and Syria using pre-defined IP list• 3-tiered C&C infrastructure for covering tracks andthwarting forensic investigation• Use of fully-working Trojanized popular tools,compiled during working hoursInfrastructureDuring the time we closely monitored this threat actor and investigated different points from their infrastructure, we were able to distinguish two types of servers, used to fulfill two main roles:• Servers that will serve the poisoned installer used inthe initial compromise (referred from this point on as Download Servers)• Servers used for exfiltrating information and for interacting with the victim through commands (referred from this point on as Command and Control Servers)Some particularities for each of these types will be detailed below.Download ServersAs mentioned before, one of the preferred infection mechanisms is a watering hole technique. In this type of attack, the threat actor will make use of certain websites that the victim often visits. For what was observed in the wild, StrongPity actors were able to tamper some localized software aggregates and sharers.Usually, website visitors, when trying to download a certain installer, are redirected to a dedicated download server, as a result of a rewritten request to the legitimate server. If a user is of interest to the threat actor (his/her IP address is within one of the ranges it targets), the server will return the tampered version of that installer. Otherwise, the user will receive the original version of it.The servers where the targeted users are redirected are referred as the download servers.3Bitdefender Whitepaper StrongPity APT - Revealing Trojanized Tools, Working Hours and InfrastructureTrojanized installersThe malicious installers, which are served to the targeted victims, are quite interesting. The actor uses a custom bundler/dropper, digitally signed (with a self-signed certificate), that embodies the malicious components and the original, legit software product. But these initial droppers are very different, even if they are generated immediately one from another. The encryption key for the components changes from one installer to other, although they tend to have the same key length for each campaign.During our investigation, we were able to gather several samples of these tampered installers. The affected applications fall into several categories, such as application for compression like 7-zip and WinRAR archiver, security software such as McAfee Security Scan Plus, file recovery application - Recuva, application for remote connection such as TeamViewer, chat application such as WhatsApp or different tools and utilities like Piriform CCleaner, CleverFiles Disk Drill, DAEMON Tools Lite, Glary Utilities, or RAR Password Unlocker, covering a wide range of needs.Each initial dropper has a compile time, the exact date the tampered installer was created. When we investigated this aspect, we observed that all the files we managed to retrieve were compiled from Monday to Friday, a normal work week. Another interesting aspect is that the time interval for these timestamps is around 9 hours, which is a workday norm. If we were to place this norm in a 9 to 6 working schedule the time zone would be UTC+2.4The above observation strengthens the idea that this threat is sponsored, and we are dealing with an organized developer team paid to work for this “project”.The download serverWhile monitoring the threat actor activity, we were able to investigate several points from the infrastructure.The download servers had some interesting particularities.The actor has taken some security measures in order to ensure that only the “right” connections are accepted.They use a helper script (self-named “Debian Stretch Hardening Script”) with the following help message:usage: $0 options Debian Stretch Hardening Script OPTIONS: -u Admin User -p SSH Port -k SSH Public Key (example : “ssh-rsa AAA ”) -d Domain Name -n Knock Ports (example : 10001,10002,10003,10004) --helpHelpThe script, among other actions, updates all the packages, creates the “admin user” on the system (and computes the password for it, based on the Knock ports and SSH port), configures nginx and configures knockd service and the firewall. Due to an error in the script, the password is always the same. This does not represent a problem because the SSH daemon is configured to only allow public key authentication.In one instance, the actor used a sequence of four Knock Ports when calling the script.Interestingly, there seems to be a specific IP from Israel that is denied any connection to the download server, an IP address which seems to belong to an important science university.Reviewing the software logic, we identified 2 directories with malicious binary files and 3 PHP scripts:1. configuration.php – contains the locations of those 2 directories and a list named $targets (which should contain alist of IP ranges, but it is empty) and a mapping from 32 hex-digits to filename (which does not represent the md5 hash of the file, but uniquely identifies it- referenced from now on as file-id). • •read.php – contains two functions: checkUserIP() which checks if an IP address is contained in the $targets list2. serveFile() – serve an installer file to the client 3. inject.php – the main logic. It Includes the other 2 php files, validates that the IP of the connecting client is amongthe targets list defined in configuration.php, checks the file-id and serves the chosen file.According to the logic of the scripts, one of the directories should contain the original installers and the other the tampered ones. If the IP address of the victim is in the $targets list, a trojanized installer would be delivered, otherwise a legitimate one would be served. In the case of the nodes we investigated, both directories contained the exact same files and the $targets list was empty, meaning that any valid connection would get the malicious installer.In the wild, we have seen the requests for the first layer of the following pattern:5Bitdefender Whitepaper StrongPity APT - Revealing Trojanized Tools, Working Hours and Infrastructureurl server>/<8 character folder>/<the 32 hex-digits that identify the file> But, in the nodes that we have analyzed, a valid URL would have the form:url server>/<8 character folder>/<the inject.php file>?params=<the 32 hex digits that identifies the file>. This discrepancy points to either the nodes being out of use, or, the known URL scheme being changed.Any other requests are redirected to url and Control ServersOnce the malicious installer is downloaded and executed, the backdoor is installed. The backdoor will communicate with a command and control server, embedded into its binary, for document exfiltration and for retrieving commands to be executed, depending on the importance of the victim. From an OPSEC point of view, the actor takes different actions in order to hide and anonymize its traces. The C2 network uses a set of proxy servers to hide the terminal node/nodes in the infrastructure. At the moment of writing, we have identified at least three layers in this infrastructure.First layerThe first layer is made up of IPs to which the malware will try to connect. Each of these IPs has a unique domain associated to it that is embedded in the binary. These are in fact proxies to other machines.The nodes we have seen use the PHP curl bindings to forward the request to the next server in the chain they know (one script for file exfiltration and one script for retrieving commands). If a node is compromised, one could not have details about the entire infrastructure, knowing only about the nodes before it and the node it submits data to.The first layer does some basic validation and forwards the traffic to and from another server, which usually is located in a different country, at a different provider. The communication between the first layer and its upstream is HTTPS (the certificate is not verified) on an unusual TCP port for this protocol – 1402.As for the software stack, nginx and php are used and configured to respond with 404 to all incorrect requests (either non-existing files, for which nginx serves the 404 response or for incorrect parameters to the PHP scripts, which falls into the php script’s responsibility to serve the 404 code).Second layerThe second layer is composed of the IP addresses that the first layer forwards data to. These IPs do not seem to have any domains linked to them and have multiple first layer IPs pointing to them. Other writeups mention the PHP scripts goN9Z2In7mYQmN92dzX11CQL.php (for file upload) and p5Pss34GvX21pxO0bz25vLqU.php (for getting the commands). These PHP files still exist in the whole infrastructure, but they now reside on the 2nd layer proxy, with the 1st layer/public facing script being named info. phpor phpinfo.php (for file uploads) and ini.php or parse_ini_file.php (for the commands). The table below illustrates the names of these PHP scripts our researchers retrieved during the investigation on each layer from the infrastructure:61st layer2nd layer 25vLqU.phpinfo.php Both the first and second layers have the SSH daemon configured to listen on a high port (bigger than 1024). By avoiding the use of the default port for a certain protocol, the threat actors are trying to ”stay under the radar” from common Internet scanners and search engines like Shodan or Censys.Z3@Pp6!8nb7T5pUP_=wAsr- r2tKTZdf4=gp.php3rd layer WNpRAq-yeVPQ@.phpFunctionality file uploadGet commandsAs far as our researchers were able to investigate, the threat actors use a VPN service for connecting and administrating the servers , usually from secureconnect.me or torguardvpnaccess.com.The figure below summarizes the communication between the proxy layers after an infection was performed:In terms of infrastructure, we were able to map 47 servers with different functionalities. It does not seem that the threat actor prefers a particular hosting provider or region to set up the infrastructure, but most of them are in Europe.7Bitdefender Whitepaper StrongPity APT - Revealing Trojanized Tools, Working Hours and InfrastructureComponents and Communication ProtocolOnce the tampered installer is downloaded and executed, it will drop 4 files: the Legit Setup, the Launcher and Persistence component, the Exfiltration and Command Execution component and the File Searcher component.The first executed file is the original installer, which will be prompted to the user so that they would not suspect anything. All malicious actions are performed in the background.All of these 4 components are encrypted in the resource section of the initial dropper. Each resource has an 8-byte header that tells the dropper the size of the executable and the component type.A summary of the installation process is illustrated in the figure below:After the Launcher component is dropped into the %SYSTEM% folder, it is executed by calling the function responsible for creating a new service. The name of the service is a common one, either replacing a non-vital system service (Print Spooler) or having a name that does not raise any suspicions (Registry Maintenance Server). The service will be used as a persistence mechanism and will execute the Launcher component.The dropper starts the service and will drop the rest of the executables.The Launcher component executes the Exfiltration and Command Execution component, usually placed in the same system folder, and waits for an uninstall event.The Exfiltration component is responsible for running the File Searcher component and for exfiltrating the files to the C&C server through a POST request. It regularly asks the C&C server for download and execution commands or an uninstall command. The last one, if received, will be sent as an event to the Launcher component. The get_command is sent as POST request with an argument called name that contains a tag. This tag is used as a form of authentication and is influenced by the compilation time of the file. In our tests, the servers always seem to respond with a 404 if asked for a command.The File Searcher component loops through every drive and looks for files with certain extensions. The malicious binary has an extension list embedded (usually identifying different types of documents). If a file with an extension from that list is found, it will be copied into a temporary zip archive. After completing adding the files to the archive, it will split it8into hidden .sft encrypted files. The .sft files are read by the Exfiltration component, sent to the C&C server and deleted from the disk.After the exfiltration process is completed, the Exfiltration component will wait for further commands as described above.As mentioned earlier, the files that will be exfiltrated are first copied into a zip file. This zip file will be encrypted into multiple .sft files as follows:• The File Searcher component will read 2048 bytes from the zip file • For each byte it will apply a xor operation between the least significant 4 bits and the most significant 4 bits and itwill write the result in the .sft file• The first two steps are repeated a maximum of 53 times • • For each zip file, the first .sft file will have a N prepended as a first character, the rest of the .sft files which completeIf the zip file still has unprocessed data, a new .sft file will be createdan archive will have an O prepended.VictimsWhile screening the victims it was obvious that this threat is an extremely targeted one. The majority of victims are concentrated in the area of Turkey and Syria.Zooming in, we were able to observe that most of the targets are located near the border between Turkey and Syria, as well as in Istanbul, enforcing the idea that this threat might be involved in the geo-political conflict between Turkey and the Kurdish community.9Bitdefender Whitepaper StrongPity APT - Revealing Trojanized Tools, Working Hours and InfrastructureMitre Matrix TTPsls 2/23/18 14:45 2/23/18 14:45 2/23/18 14:45 2/23/18 14:45 2/23/18 14:45 2/23/18 14:45 2/23/18 14:45 3/27/18 7:45 3/27/18 7:47 3/27/18 7:48 3/27/18 7:52 3/27/18 7:55 3/27/18 7:56 3/27/18 8:21 4/9/18 12:41 4/9/18 12:41 4/9/18 12:41 4/9/18 12:42 4/9/18 12:44 4/9/18 12:46 4/9/18 12:46 5/15/18 13:58 5/15/18 13:58 5/15/18 13:58 5/15/18 13:59 5/15/18 13:59 5/15/18 13:59 5/15/18 13:59 5/15/18 13:59 5/15/18 13:59 5/15/18 14:00 5/15/18 14:00 5/15/18 14:00 5/15/18 14:00 5/15/18 14:02 5/15/18 14:03 5/15/18 14:03 5/15/18 14:04 5/15/18 14:04 5/15/18 14:04 5/15/18 14:04 5/15/18 14:04 5/15/18 14:04 5/15/18 14:08 5/15/18 14:10 5/15/18 14:10 5/15/18 14:13 5/15/18 14:14 5/15/18 14:14 5/15/18 14:14 5/15/18 14:21 5/15/18 14:21 5/15/18 14:37 5/15/18 14:37 5/15/18 14:40 5/15/18 14:41 5/15/18 14:41 5/15/18 14:41 5/15/18 14:41 5/15/18 14:41 5/15/18 14:45Hash StrongPity APT - Revealing Trojanized Tools, Working Hours and InfrastructureCompile time 5/15/18 14:45 5/15/18 14:49 5/15/18 14:49 5/15/18 14:50 5/15/18 14:50 5/15/18 14:50 5/15/18 14:50 5/15/18 14:50 7/16/18 15:02 7/16/18 15:02 7/16/18 15:02 7/16/18 15:05 7/16/18 15:05 7/16/18 15:07 7/16/18 15:07 7/16/18 15:07 7/16/18 15:07 7/16/18 15:22 7/16/18 15:22 7/16/18 15:23 7/16/18 15:23 7/16/18 15:23 7/16/18 15:23 7/16/18 15:25 7/16/18 15:26 7/16/18 15:27 7/16/18 15:28 7/16/18 15:28 7/16/18 15:28 7/16/18 15:29 7/16/18 15:29 7/16/18 15:33 7/16/18 15:41 7/16/18 15:41 7/16/18 15:41 7/16/18 15:41 7/16/18 15:41 7/16/18 15:43 7/16/18 15:43 7/16/18 15:43 7/16/18 15:46 7/16/18 15:48 7/16/18 15:48 7/16/18 15:54 7/16/18 15:55 7/16/18 15:59 7/16/18 16:13 10/22/18 9:08 10/22/18 9:08 10/22/18 9:08 10/22/18 9:09 10/22/18 9:14 10/22/18 9:17 10/22/18 9:17 10/22/18 9:20 10/22/18 9:20 10/22/18 9:22 10/22/18 9:22 12/17/18 15:44 12/17/18 15:44 12/17/18 15:44 12/17/18 15:44 12/17/18 15:46 12/17/18 15:46 12/17/18 15:46 12/17/18 15:47 12/17/18 15:47 12/17/18 15:51 12/17/18 15:51 12/17/18 15:51 12/17/18 16:09 12/17/18 16:09 12/17/18 16:18 12/17/18 16:18 12/17/18 16:18 2/4/19 10:15 2/4/19 10:15 2/4/19 10:15 2/4/19 10:15 2/4/19 10:17 2/4/19 10:17 2/4/19 10:17 2/4/19 10:18 2/4/19 10:18 2/4/19 10:19 2/4/19 10:19 2/4/19 10:21 2/4/19 10:21 2/4/19 10:21 2/4/19 10:21 2/4/19 10:21 2/4/19 10:21 2/4/19 10:21 2/4/19 10:21 2/4/19 10:21 2/4/19 10:26 2/4/19 10:26 2/4/19 10:26 2/4/19 10:42 2/4/19 10:42 2/4/19 10:42 2/4/19 10:43 2/4/19 10:43 2/4/19 10:45 2/4/19 10:45 2/4/19 10:47 2/4/19 10:49 2/4/19 10:49 2/4/19 10:50 2/4/19 10:50 2/4/19 10:50 2/4/19 10:50 2/4/19 10:50 2/4/19 10:54 2/4/19 10:54 2/4/19 10:54 2/4/19 10:54 2/4/19 11:22 2/4/19 11:22 2/4/19 11:26 2/4/19 11:26 5/21/19 13:55 5/21/19 13:55 5/21/19 13:56 5/21/19 13:56 5/21/19 13:56 5/21/19 13:58 5/21/19 13:58 5/21/19 14:00 5/21/19 14:02 5/21/19 14:02 5/21/19 14:02Hash StrongPity APT - Revealing Trojanized Tools, Working Hours and InfrastructureCompile time 5/21/19 14:02 5/21/19 14:02 5/21/19 14:06 5/21/19 14:06 5/21/19 14:23 5/21/19 14:24 5/21/19 14:24 5/21/19 14:24 5/21/19 14:26 5/21/19 14:26 5/21/19 14:26 5/21/19 14:31 5/21/19 14:31 5/21/19 14:32 5/21/19 14:32 5/21/19 14:35 5/21/19 14:35 5/21/19 14:35 5/21/19 14:38 9/18/19 9:51 9/27/19 11:52 10/1/19 13:40 10/1/19 13:41 10/1/19 13:41 10/1/19 13:41 10/1/19 13:43 10/1/19 13:44 10/1/19 13:45 10/1/19 13:46 10/1/19 13:46 10/1/19 13:46 10/1/19 13:47 10/1/19 13:47 10/1/19 13:47 10/1/19 13:48 10/1/19 13:48 10/1/19 13:49 10/1/19 13:49 10/1/19 13:50 10/1/19 13:51 10/1/19 13:52 10/1/19 13:52 10/1/19 13:53 10/1/19 13:53 10/1/19 13:54 10/1/19 13:55 10/1/19 13:56 10/1/19 13:56 10/1/19 13:56 10/1/19 13:57 10/1/19 13:57 10/1/19 13:57 10/1/19 13:57 10/1/19 13:58 10/1/19 13:59 10/1/19 14:00 10/1/19 14:01 10/1/19 14:02 10/1/19 14:02 10/1/19 14:02 10/1/19 14:02 10/1/19 14:03 10/1/19 14:03 10/1/19 14:03 10/1/19 14:03 10/1/19 14:04 10/1/19 14:05 10/1/19 14:05 10/1/19 14:05 10/1/19 14:05 10/1/19 14:06 10/1/19 14:06 10/1/19 14:06 10/1/19 14:07 10/1/19 14:07 10/1/19 14:09 10/1/19 14:10 10/1/19 14:10 10/1/19 14:10 10/1/19 14:11 10/1/19 14:11 10/1/19 14:11 10/1/19 14:11 10/10/19 10:41 10/10/19 10:48 10/10/19 10:52 10/10/19 10:55 10/10/19 11:20 11/4/19 13:57 11/4/19 14:00 11/4/19 14:10 11/4/19 14:22 11/4/19 14:28 11/4/19 14:41 11/4/19 15:04 11/4/19 15:12 11/4/19 15:19 11/28/19 8:22 11/28/19 8:22 12/12/19 7:31 12/12/19 7:31 12/12/19 7:38 12/12/19 8:31 12/12/19 8:47 12/12/19 8:54 12/12/19 9:42 12/12/19 9:42 12/12/19 9:43 12/12/19 9:49 12/12/19 10:06 12/12/19 10:15 12/12/19 10:24 1/23/20 9:50 1/23/20 10:04 1/23/20 11:24Hash v16_kt32p5_252657306615Why BitdefenderProudly Serving Our Customers Bitdefender provides solutions and services for small business and medium enterprises, service providers and technology integrators. We take pride in the trust that enterprises such as Mentor, Honeywell, Yamaha, Speedway, Esurance or Safe Systems place in us.Dedicated To Our +20.000 Worldwide Partners A channel-exclusive vendor, Bitdefender is proud to share success with tens of thousands of resellers and distributors worldwide.CRN 5-Star Partner, 4th Year in a Row. Recognized on CRN’s Security 100 List. CRN Cloud Partner, 2nd year in a RowLeader in Forrester’s inaugural Wave™ for Cloud Workload SecurityNSS Labs “Recommended” Rating in the NSS Labs AEP Group TestSC Media Industry Innovator Award for Hypervisor Introspection, 2nd Year in a RowGartner® Representative Vendor of Cloud-Workload Protection PlatformsMore MSP-integrated solutions than any other security vendor3 Bitdefender Partner Programs - to enable all our partners – resellers, service providers and hybrid partners – to focus on selling Bitdefender solutions that match their own specializationsTrusted Security Authority Bitdefender is a proud technology alliance partner to major virtualization vendors, directly contributing to the development of secure ecosystems with VMware, Nutanix, Citrix, Linux Foundation, Microsoft, AWS, and Pivotal.Through its leading forensics team, Bitdefender is also actively engaged in countering international cybercrime together with major law enforcement agencies such as FBI and Europol, in initiatives such as NoMoreRansom and TechAccord, as well as the takedown of black markets such as Hansa. Starting in 2019, Bitdefender is also a proudly appointed CVE Numbering Authority in MITRE Partnership.RECOGNIZED BY LEADING ANALYSTS AND INDEPENDENT TESTING ORGANIZATIONSTECHNOLOGY ALLIANCESN 