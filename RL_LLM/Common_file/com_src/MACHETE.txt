ESET Research White papers // July 2019MACHETE under attackHow spies managed to steal gigabytes of confidential data over the course of a yearTABLE OF CONTENTS 1.Introduction . . . . . . . . . . . . . . . . . . . 42. Delivery method . . . . . . . . . . . . . . . . . 43. Timeline of Machete’s latest version . . . . . . . . . . 54. Targets . . . . . . . . . . . . . . . . . . . . .65. Malware operators. . . . . . . . . . . . . . . . . 76. Technical analysis . . . . . . . . . . . . . . . . . 8 6.1 Downloader component . . . . . . . . . . . . 8 6.2 Obfuscation . . . . . . . . . . . . . . . . 9 6.3 Backdoor components . . . . . . . . . . . . . 10 6.4 Domain names . . . . . . . . . . . . . . . 277. Conclusion. . . . . . . . . . . . . . . . . . . 288. References . . . . . . . . . . . . . . . . . . 299.IoCs . . . . . . . . . . . . . . . . . . . . . 30LIST OF TABLES Table 1 Table 2Tasks scheduled for the execution of components 22 Domain names and related IP addresses 27LIST OF FIGURES Figure 1 Decoy (PDF file) in one of the Machete downloaders (blurred) 5 Figure 2 Countries with Machete victims in 2019 7 Figure 3 Example of a Spanish word in Machete’s code 7 Figure 4 Components of Machete 8 Figure 5 Configuration of a Machete downloader 8 Figure 6 Downloader code 9 Figure 7 Machete’s extra obfuscation 10 Figure 8 Example of Machete’s first layer of obfuscation 10 Figure 9 Executable py2exe components of Machete 11 Figure 10 Version check in GoogleCrash.exe 11 Figure 11 Code to encrypt/decrypt config 12 Figure 12 Main code of Chrome.exe 13 Figure 13 Code to create file listings 14 Figure 14 Code to access clipboard 14 Figure 15 File extensions to copy from removable drives 15 Figure 16 File extensions for physical exfiltration 16 Figure 17 Code on Hack Forums 16 Figure 18 Keys in a Spanish distribution 17 Figure 19 Code for geolocation 18 Figure 20 Code to upload files in Winde 19 Figure 21 Code to download a new configuration 19 Figure 22 Code to update file listings 19 Figure 23 Code to download and execute other binaries 20 Figure 24 Folders on the FTP server 20 Figure 25 Code for HTTP exfiltration 21 Figure 26 Configuration for self-extraction of python27 exe 22 Figure 27 Code for copying files 23 Figure 28 Archive names for different browsers 23 Figure 29 Code to obtain clipboard data 24 Figure 30 Code to obtain information about wireless networks 24 Figure 31 Downloads from C&C server 25 Figure 32 Code to move newest files 26 Figure 33 Part of encryption code 26 Figure 34 Code for sending files to the C&C server 27 Figure 35 Files spread in phishing emails 284EXECUTIVE SUMMARY Machete is a cyberespionage toolset developed by a Spanish-speaking group that has been operating since at least 2010. This group is very active and continues to develop new features for its malware, and implement infrastructure changes in 2019. Their long run of attacks, focused in Latin American countries, has allowed them to collect intelligence and refine their tactics over the years. ESET researchers have detected an ongoing, highly targeted campaign, with a majority of the targets being military organizations.Key points in this white paper:•In 2019, ESET has seen more than 50 computers compromised by Machete. Approximately 75% of them belonged to military forces of various Latin American countries, with more than half of them in the Venezuelan military.• The group behind Machete uses effective spearphishing techniques. They know their targets, howto blend into regular communications, and which documents are of the most value to steal. Not only does Machete exfiltrate common office suite documents, but also specialized file types used by geo- graphic information systems (GIS). The group is interested in files that describe navigation routes and positioning using military grids.• Machete has evolved from what was seen in earlier attacks. The main backdoor is still Python-based,but enriched with several new features such as a more resilient C&C communication mechanism, the use of Mozilla Location Service to geolocate compromised computers, and the possibility to exfiltrate data to removable drives when there is physical access to targets.• The group is very active. ESET has seen cases where stolen documents dated on one particular day werebundled with malware and used on the same day as lures to compromise new victims.For any inquiries, or to submit samples related to this white paper, contact us at: threatintel@eset comINTRODUCTION1. Many events occurred in the first half of 2019 that have put Venezuela in the spotlight. From the uprising of the opposition against President Nicolás Maduro to plots in the military forces, the situation in Venezuela has been open to international scrutiny. There is, however, an ongoing case of cyberespionage against the Venezuelan military that has managed to stay under the radar.First described by Kaspersky in 2014 [1] and later, by Cylance in 2017 [2], Machete is a piece of malware found to be targeting high profile individuals and organizations in Latin American countries. In 2018 Machete reappeared with new code and new features. As of June 2019, ESET has seen over 50 victims being actively spied upon by Machete, with more than half of them being computers belonging to the Venezuelan military forces. Several GBs of confidential documents and private information have been exfiltrated to a server controlled by the attackers.Machete has Latin American targets and has been developed by a Spanish-speaking group, presumably from a LATAM country. They are active and constantly working on very effective spearphishing campaigns. In some cases, they trick new victims by sending real documents that had been stolen on the very same day. They seem to have specialized knowledge about military operations, as they are focused on stealing specific files such as those that describe navigation routes. This white paper presents a technical analysis of the malware, as well as data related to these targeted attacks.2. DELIVERY METHOD Machete relies on spearphishing to compromise its targets. In other words, very specific emails are sent directly to the victims, and they change from target to target. These emails contain a link to download (or an attachment with) a compressed file with the malware and a document that serves as decoy.5Figure 1 is a typical PDF file displayed to a potential victim before compromise. To trick unsuspecting targets, Machete operators use real documents they have previously stolen; Figure 1 is a classified military document that is dated May 21st, 2019, the same day the related .zip file was first sent to targets.Figure 1 // Decoy (PDF file) in one of the Machete downloaders (blurred)The kind of documents used as decoys are sent and received legitimately several times a day by targets. For example, Radiogramas are documents used for communication in the military forces. Attackers take advantage of that, along with their knowledge of military jargon and etiquette, to craft very convincing phishing emails.3. TIMELINE OF MACHETE’S LATEST VERSION In order to get a general idea of Machete’s capabilities to steal documents and spy on its targets, we’ll describe its main features as they appeared, in chronological order.April 2018 The first time the new version was seen. It features:• Coded in Python • Code is obfuscated to try to thwart analysis • First stage downloader fetches the actual malware • Accesses the clipboard • Communicates with an FTP server • AES encrypts and exfiltrates documents • Detects newly inserted drives and copies files • Updates configuration or malware binaries • Executes other binaries • Retrieves specific files from the system • Logs are generated in EnglishSome of these early versions cannot have their code or configuration updated from the remote server. However, the binaries seen since late April do have these capabilities.August 2018 An extra layer of obfuscation was added, using zlib compression and base64 encoding. It managed to evade detection by most security products.6November 2018 Two new features were added:• Geolocation of victims and information about nearby Wi-Fi networks • Retrieves user profile data from Chrome and Firefox browsersFebruary 2019 Physical exfiltration to removable drives was added, but both features added in November 2018 were removed from the code. Also, logs were changed to Spanish.May 2019 On May 5th, 2019, subdomains used by Machete to communicate with the remote server were taken down. New samples with new features started to emerge on May 16th.New features:• Data are sent over HTTP if FTP connection fails • AES encryption algorithm was dropped and replaced by base64 encoding • Logs (of keys and clipboard contents) are not sent until they are larger than 10 KB • List of file extensions that are exfiltrated was reduced • There is no obfuscation after first layer of base64/zlib compression • There is no downloaderJune 2019 • Communication is over HTTP only, with a main and a fallback server • Machete components are Python scripts; py2exe binaries were removed from this version • Documents are AES encrypted and base64 encoded before being sent • Now retrieves user data from more browsers • Only Microsoft Office documents, JPEG images, .pdf documents and archives are exfiltrated • Code was rewritten to perform the same tasks (keylogging, taking screenshots, etc.) but usingdifferent libraries4. TARGETS Machete is a highly targeted backdoor that has managed to stay under the radar for years. Emails with malicious attachments are only sent in small numbers. Operators behind Machete apparently already have information about individuals or organizations of interest to them in Latin America, how to reach them, and how best to trick them into getting compromised. Real documents are used as decoys, so it is not rare that victims never realize they were compromised and are even compromised again after Machete C&C servers change.Since the end of March up until the end of May 2019, ESET observed that there were more than 50 victim- ized computers actively communicating with the C&C server. This would amount to gigabytes of data being uploaded every week. By analyzing filenames and metadata of exfiltrated documents, it was possible to determine that more than half of the compromised computers were in the Venezuelan military forces. This would include several brigades or divisions across Venezuela.Other compromised computers were related to education, police, and foreign affairs sectors. This extends to other countries in Latin America, with the Ecuadorean military being another organization highly targeted by Machete. These countries are shown in Figure 2.7(cid:28)% Nicaragua(cid:31)(cid:30)% Ecuador(cid:27)% Colombia(cid:27)(cid:26)% VenezuelaFigure 2 // Countries with Machete victims in 20195. MALWARE OPERATORS Machete is malware that has been developed and is actively maintained by a Spanish-speaking group. This has been affirmed by other researchers for previous versions of Machete; these reasons, in conjunction with those we describe below, lead us to agree with this attribution.First of all, there are some words in Spanish present within the code of the malware. Variable names are mostly random but the operators forgot to rename some of them. Examples include: datos (data), canal (channel), senal (signal), and unidad (unit, drive). Another example is shown in Figure 3.Figure 3 // Example of a Spanish word in Machete’s code8Also, as was previously mentioned, logs with keystrokes and clipboard data are generated in Spanish. Initially they were in English, perhaps indicating copied code, but were later translated, for example to indicate which window the data is coming from.The presence of code for physical exfiltration of documents may indicate that Machete operators could have a presence in one of the targeted countries, although we cannot be certain.6. TECHNICAL ANALYSIS Between 2014 and 2017 inclusive, the malware was distributed in NSIS-packed files. These would extract and execute several py2exe components of Machete; py2exe [3] is a tool that converts Python scripts into Windows executables. These executables don’t require a Python installation to run, but can be quite large, as they need to include all Python libraries used by the script and the Python virtual machine. For example, py2exe would convert the classic one-liner “Hello, world” script into a 4 MB executable.This new version of Machete, first seen in April 2018, uses a downloader as a first stage, which installs the backdoor components of Machete on a compromised system.PDFWordAnotherself(cid:27)extracting ﬁle with Encrypted URLEXESelf(cid:27)extracting ﬁle Encrypted ConﬁgSelf(cid:27)extracting ﬁlewith Decoy documentpy(cid:29)ExeDownloader componentWWWInternetEXE[ ]EXEpy(cid:29)ExeBackdoor componentsFigure 4 // Components of MacheteIn Figure 4 we can see that the downloader comes as a self-extracting file (made with 7z SFX Builder [4]). It opens a PDF or Microsoft Office file that serves as a decoy and then runs the downloader executable. The downloader is a RAR SFX that contains the actual downloader binary (a py2exe component) and a configuration file with the downloader’s target URL as an encrypted string.All download URLs we have seen are either Dropbox or Google Docs. The files at these URLs have all been self-extracting (RAR SFX) archives containing encrypted configuration and malicious py2exe components.6.1 Downloader component An example of a configuration file for a 7z self-extracting downloader is shown in Figure 5.Figure 5 // Configuration of a Machete downloader9The .exe file inside is a RAR SFX that is very similar in structure to the final Machete payload itself. It contains a py2exe executable and a configuration file with the URL from which to download Machete. The config file is named mswe and it is the base64-encoded text of an AES-encrypted string. The flow of execution for the downloader can be summarized as follows:• The working directory for the downloader will be: %APPDATA%\GooDown • A scheduled task (ChromeDow) is created to execute the downloader every three to six minutes • The download URL is read and decrypted (AES) from the mswe config file • Machete is downloaded • Downloaded data are decrypted (AES) and renamed as Security.exe • Machete is executed • The task for the downloader is deletedFor each binary the decryption key is the same for both URL and payload, but the key varies across binaries. In contrast, decryption keys used in the Machete payload itself have remained the same across all binaries up until June 2019, when they changed.Part of the code is shown in Figure 6.Figure 6 // Downloader codeLater downloaders added version check features, similar to what we’ll describe in the GoogleCrash exe: scheduling and persistence section below. In these cases, version information is read from a file bsw.as, included in the downloader. Some names were also changed: for example, the task was renamed to AdobeR, and downloaded payload renamed to ders.exe.6.2 Obfuscation Since August 2018, all the main Machete backdoor components (which will be described in the next section) have been delivered with an extra layer of obfuscation. The executable py2exe files now contain a block of zlib-compressed, base64-encoded text which, after being decoded, corresponds to the same code that was seen before. This obfuscation is produced using pyminifier [5] with the -gzip parameter. Part of the obfuscated code is shown in Figure 7.10Figure 7 // Machete’s extra obfuscationAfter that obfuscation is removed, there is code with further obfuscation including random names for variables and lots of junk code. Once again, this was not developed by the Machete operators: pyobfuscate [6] is an old project that has been used in previous Machete versions as well. A sample of this obfuscated code is shown in Figure 8.Figure 8 // Example of Machete’s first layer of obfuscationIt must be noted that one of the Machete binaries had a chunk of commented code that is produced by NXcrypt [7]. However, in the end, it seems the Machete operators decided not to use NXcrypt after all.6.3 Backdoor components Machete’s dropper is a RAR SFX executable. Three py2exe components are dropped: GoogleCrash.exe, Chrome.exe and GoogleUpdate.exe. GoogleCrash.exe is executed first and launches the other two.11EXEPersistenceGoogleCrash.exeRuns every (cid:5)(cid:4) minutesInstalls other componentsEXESpy componentChrome.exeRuns indeﬁnitelyCopies and encryptsdocumentsjer.dllEncrypted ConﬁgEXECommunication GoogleUpdate.exeRuns every (cid:2)(cid:4) minutesSends stolen datato serverScreenshots, keylogs, etc.Receives updates from serverFigure 9 // Executable py2exe components of MacheteA single configuration file, jer.dll, is dropped, and it contains base64-encoded text that corresponds to AES-encrypted strings. A schema summarizing the components is shown in Figure 9.GoogleCrash.exe: scheduling and persistence This is the main component of the malware. It schedules execution of the other two components and creates Windows Task Scheduler tasks to achieve persistence.First, a version number is read from the configuration file jer.dll. Version numbers have 4 digits since this new distribution in 2018, although sometimes they also have ‘ 0’ at the end (for example, version number ‘1111 0’). If a victim’s PC was already compromised and the version number in the new configuration file is bigger than in the existing one (see Figure 10), the existing Machete installation (tasks, files, processes) is cleaned and the new version installed.Figure 10 // Version check in GoogleCrash.exeNext, the following tasks are created: Spy component runs every 3 minutes SCHTASKS /create /ST 00:00:01 /SC MINUTE /MO 03 /TR “C:\Users\%USERNAME%\AppData\ Roaming\Chrome\Google\Chrome.exe” /TN Chrome Communication runs every 10 minute SCHTASKS /create /ST 00:00:01 /SC MINUTE /MO 10 /TR “C:\Users\%USERNAME% \AppData\ Roaming\Chrome\Google\GoogleUpdate.exe” /TN GoogleCrash12Persistence component runs every 30 minutes SCHTASKS /create /ST 00:00:01 /SC MINUTE /MO 30 /TR “C:\Users\%USERNAME% \AppData\ Roaming\Gchrome\GoogleCrash.exe” /TN Googleupdate32 Then executables are copied to: %APPDATA%\Chrome\Google\ %APPDATA%\Gchrome\ Finally, a file is used to identify the victim. It is a text file; the MAC address and HOSTNAME are encrypted and then written to chrom.dll. The steps for encryption (see Figure 11) are: • Add padding if length < blocksize • Encrypt using AES with a hardcoded key • Prepend IV used to encrypt (first 16 bytes) • Encode in base64Figure 11 // Code to encrypt/decrypt config13Chrome.exe: spy component This component is responsible for recollection of data from the victim. Figure 12 contains the code for the main() routine. It runs indefinitely, performing operations based on timers.Figure 12 // Main code of Chrome.exeStolen data are stored in different subfolders, depending on what data type it is (screenshots, logs of keystrokes, etc.). Then the communication component takes the data and sends them to a remote server. This folder structure will be described later.Collecting screenshotsScreenshots are taken every five minutes, using ImageGrab from PIL [8] (Python Imaging Library). The filename is encoded with ROT13 (only for lowercase letters) and then the image is encrypted and moved to the Winde folder. Here is the naming convention: Dumped screenshot: ‘Cder-’ + strftime(‘%d-%m-%Y-%H-%M-%S’) Example: Cder-29-03-2019-10-30-00 Encrypted file: ‘Cqre-’ + strftime(‘%d-%m-%Y-%H-%M-%S’) + ‘.wcrt’ Example: Cqre-29-03-2019-10-30-00.wcrt The encryption used is AES and the code was copied from this page: url thegreenplace net/2010/06/25/ aes-encryption-of-files-in-python-with-pycryptoThe key is hardcoded and has not changed in any of the binaries we have analyzed, except for those that were released in mid-June 2019 (this will be discussed later). It is a 16-byte key, whereas the key used for configurations is 32 bytes long.Keeping a list of modified files, by year of modificationOne text file is created for every year, containing a listing of files that were last modified in that year. This process runs every 60 seconds, checking for files on every fixed and removable drive (only when the list doesn’t already exist for the current year). If the list was already created but there are newly modified files, the communication component can delete listings to get newer files, as will be described later.14Files in system folders, or those with unwanted extensions, are ignored, as can be seen in Figure 13.Figure 13 // Code to create file listingsApart from Microsoft Office documents and images, the list of extensions includes:• Backup files • Database files • Cryptographic keys (PGP) • Files for geographic information systems (topographic maps, navigation routes, etc.)It’s interesting to note the exclusion of the folder Archivos de Programa, which is Program Files in Spanish. The resulting listings will be saved to the Loc folder.Accessing the clipboardAccess to the clipboard is achieved by creating a window and hooking its WM_DRAWCLIPBOARD, WM_ CHANGECBCHAIN and WM_DESTROY messages. The code was inspired by this: url python org/pipermail/ python-list/2006-October/399603 htmlThe payload has been inserted into the OnDrawClipboard function, and is shown in Figure 14.Figure 14 // Code to access clipboard15The content of the clipboard, along with the window the operation came from, is saved in an HTML file named Hser, which will be stored under the same directory as screenshots. It is encrypted and copied the same way, with some differences in the naming convention: Log file: Hser Encrypted file: strftime(‘%d-%m-%Y-%H-%M-%S-’) + ‘Hfre’ + ‘.ugz’ Example: 29-03-2019-10-30-00-Hfre.ugzDetecting newly inserted removable drivesThis is achieved by creating a top-level window. The code was copied from here: url me uk/ python/win32_how_do_i/detect-device-insertion htmlCuriously, when the window is created, the name Device Change Demo is used, which hasn’t been modified by the Machete developers. The payload is located in the onDeviceChange function. When a removable drive has been inserted, malware executables located in the Gchrome folder (of extension .scr) are copied to the root folder of the newly inserted drive. Then every file in that drive that matches a desired extension is copied and encrypted to the Winde folder on the local drive. These extensions are shown in Figure 15.Figure 15 // File extensions to copy from removable drivesNaming convention (this time ROT13 for both lowercase and uppercase): Original file: Example: Imagen.jpg Encrypted file: ‘HFO-’ + rot13(original_file). Example: HFO-Vzntra.wct Note that ‘HFO’ comes from rot13(‘USB’).Physical exfiltrationThis feature is related to the one that was described previously. When the insertion of a removable drive is detected, the existence of a specific filename is checked in the root of that drive. If found, then files from every drive are copied (encrypted) onto the removable drive, in a hidden folder. That specific file is not created anywhere in the code of Machete and the filename may vary from one target to another. In other words, this is a way to exfiltrate data in cases where the attacker has physical access to a computer that was already compromised with Machete.A file usb.txt is created in the main directory where the malware is located. Only one line is written: the drive letter where data was copied. Figure 16 lists the extensions sought and, if found, copied. Note that the list differs to that of Figure 15: compressed files are ignored, as well as pdf files; now included are specific files that contain encrypted passwords.16Figure 16 // File extensions for physical exfiltrationRegarding encryption, it is the same AES routine used extensively in all of Machete’s components; naming conventions follow: Original file: Example: key3.db Encrypted file: strftime(‘%d-%m-%Y-%H-%M-%S-’) + rot13(original_file) Example: 29-03-2019-10-30-00-xrl3.qoKeyloggingData is saved to the same Hser file used to store clipboard information. The code was copied from Hack Forums: url net/showthread php?tid=4186437Figure 17 // Code on Hack Forums17One thing that was adapted for Spanish language keyboards is the keyids variable, shown in Figure 18.Figure 18 // Keys in a Spanish distributionGetting Chrome and Firefox user profile dataThis task is performed in just 4 lines of code by creating a compressed archive of the user’s data folder, both for Chrome and Firefox. The resulting zipped files are stored in the Winde folder. Original files are located in the following folders: Chrome: %LOCALAPPDATA%\Google\Chrome\User Data\Default Firefox: %APPDATA%\Mozilla\Firefox\Profiles The files created are FIREPERF.zip and CRHOMEPER.zip (there’s a typo for Chrome, but it was never corrected).Geolocation of victims and Wi-Fi networksInformation about available Wi-Fi networks is collected by running the following Windows commands:netsh wlan show networks mode=bssid netsh wlan show interfacesThe output from these commands is parsed and a dictionary object is created containing information about the Access Point’s MAC address and signal strength for every available Wi-Fi network. Here is an example:{ }'macAddress' : 'e2:ee:51:6f:cf:26', 'signalStrength' : '45''macAddress' : '2b:9f:d6:77:4a:64', 'signalStrength' : '70'This information is sent as a JSON object to the Mozilla Location Service’s API [9]. In short, this application provides geolocation coordinates when it’s given other sources of data such as Bluetooth beacons, cell towers or Wi-Fi access points.18The Machete operators copied the code to do this from Python Wi-Fi Positioning System [10]. However, that project uses Google’s Geolocation API, which requires a valid API key.Registering an API key might be a hassle (it requires a credit card), but Mozilla’s API is the same as Google’s, with the difference that it does not require a private API key. The string ‘test’ can be used as API key, which is exactly what Machete uses. They copied the code (and got the idea) from this blog: url nl/blog/html/2014/07/04/tinkering_with_mozilla_location_services htmlMozilla’s API returns geolocation information from where latitude and longitude coordinates are taken to build a Google Maps URL. An extract of this part of the code in Machete can be seen in Figure 19.Figure 19 // Code for geolocationThe advantage of using Mozilla Location Service is that it permits geolocation without an actual GPS and can be more accurate than other methods. For example, an IP address can be used to obtain an approxi- mate location, but it is not so accurate. On the other hand, if there is available data for the area, Mozilla Location Service can provide information such as in which building the target is located.The URL and full output from netsh commands are written in the Winde folder to a text file with a name generated as follows: Filename: ‘GEO-’ + strftime(‘%d-%m-%Y-%H-%M-%S-’) + ‘.txt’ Example: GEO-12-04-2019-14-02-58.txtGoogleUpdate.exe: communication module This component is responsible for communicating with the remote server. The configuration to set the connection is read from the jer.dll file: domain name, username and password. The principal means of communication for Machete is via FTP, although HTTP communication was implemented as a fallback in 2019.Another line read from the configuration is a folder name on the server that identifies the campaign. Victim info is retrieved from the chrom.dll file and a folder on the server is created as /[folder_name]/MACaddr-HOSTNAME.Decryption is the inverse process to the one described for encryption of data in chrom.dll file (see section GoogleCrash exe: scheduling and persistence).Then, the main functionality of this component is to upload encrypted files located in the Winde folder to different subdirectories on the C&C server. Figure 20 shows how the folder is processed to upload documents.19Figure 20 // Code to upload files in WindeFile listingsThe listing of files generated by the Chrome.exe component (stored in the Loc folder) is read and those files are encrypted (temporarily to the Winde folder) and uploaded to the C&C server. All of this is done by this component and not the spy component, although that would make more sense.Encryption is the usual AES routine and for naming, only ROT13 on the filename is performed. Once a file is uploaded, it is deleted from the Winde folder, as well as the corresponding line in the list of files.Receiving updatesNot only is confidential information exfiltrated to the server, but Machete operators can, by leaving specific files on the server, update configurations, malware files, listings of files, or execute other binaries. Therefore, they can customize the malware behavior if they want to retrieve more specific data.If a file jer.dll exists on the server when GoogleUpdate.exe runs, then the local config file jer.dll gets overwritten by this file. After being used, it gets deleted from the server. The code is shown in Figure 21.Figure 21 // Code to download a new configurationIf a file bers.dll exists, then it replaces the list of files for current year, located in the Loc folder. This way, the Machete operators can retrieve specific files from a compromised system.Figure 22 // Code to update file listings20There can also be executable files on the server. They will be copied to the %APPDATA% folder on the compromised computer and will be executed from there, as seen in Figure 23.Figure 23 // Code to download and execute other binariesFinally, there can be .scr executables with updated components (.asae extension on the server), which will be copied to the Ansrome folder on a compromised PC. However, they are not executed. If a file bsera.txt is in the same folder as the executables, the GoogleUpdate.exe component will proceed to delete all files from the Ansrome folder.FTP foldersFor every victim there will be folders on the FTP server, which are shown in Figure 24.Figure 24 // Folders on the FTP serverHere’s a summary:• Dfse: stores .htm files with clipboard data and keylogs • Dbse: stores screenshots • Dqwo: stores encrypted documents from local and removable drives • Dvas: folder where operators can leave files to change configuration • Doer: folder where operators can leave updated Machete executables • Djuy: stores file listings (not encrypted) • Dbow: stores zipped files with profile data from installed web browsers. Files are not encryptedor encoded and they can be quite large (300 MB for example)• Dwis: stores .txt files (not encrypted) with wireless adapters, visible wireless networks and geolocationHTTP communicationSince May 16th, 2019, new Machete binaries have emerged. After we had domain names related to the FTP server taken down, Machete’s operators had to come up with a new plan to make the malware more reliable and maintain control of their victims.21Information is still being sent to an FTP server but, if for some reason the connection fails, then the informa- tion is sent over HTTP. The HTTP server is the same as the FTP server (same IP address), but the domain name used is different (more details in the section Domain names below).For HTTP communication, proxy settings are retrieved and files in the Winde folder are sent if they are no bigger than 8 MB. If more than 5 files could not be successfully sent without errors, then the transfer is stopped. Both size and error-checking are new features first seen in May 2019.Documents are sent by calling urlopen() [11] with the following parameters in the query string of the URL: • namepc: MAC address and hostname of the victim. • nadir: folder name on the server that identifies the campaign. • menrut0: type of file. It is one of “PXDfse”, “PXDbse”, “PXDwis”, “PXDbow” or “PXDqwo”. • menfile0: filename (which has already been transformed by applying ROT13, depending on the type of file). • mens0: contents of the file (base64 data, as encryption was dropped for this version).For file listings in the Loc folder, documents are encoded in base64 and sent in the same manner. If five or more files generated errors when sending, then an alternative transfer method is executed. First, processes running on the system are inspected, looking for web browsers: Firefox, Chrome, Internet Explorer, Microsoft Edge and Opera. If any of those is running, then only five files under 1 MB will be sent. Files bigger than 1 MB will be deleted from the Winde folder. The information will be sent as a query string with the same parameters described above, but once for all five documents. As can be seen in Figure 25, now there will be parameters menrut0, menrut1, etc.Figure 25 // Code for HTTP exfiltrationThen a file google.html is written to disk and opened with the default web browser (which the Machete operators must have assumed would be open if a process for a web browser was found to be running). This will cause information to be sent to the C&C server via a http POST request.22New components In June 2019 Machete started being delivered with several changes to its structure, while keeping essentially the same functionalities. Curiously enough, Machete seems to have been rewritten to use different libraries since this update, perhaps with the intent to evade detection.This version’s malicious tasks are divided into six components, which are no longer py2exe executables. Python scripts for malicious components, an original executable for Python 2.7, and all libraries used are packed into a self-extracting file called python27.exe. This binary is distributed along with a decoy docu- ment, as we’ve seen before. Figure 26 shows the configuration for self-extraction of the payload.Figure 26 // Configuration for self-extraction of python27.exeA folder C:\Python2.7 is created, holding malicious scripts and Python libraries in the DLLs subdirectory. The first component to be executed is _hashlbi.pyw, which is similar to GoogleCrash.exe, but with different code.Before describing the components, it is worth mentioning that a component may perform tasks that are unrelated. This means that, in the future, Machete operators could swap parts of code between components, rename them, etc. trying to avoid detections._hashlbi.pyw: persistenceThis component sets up malware folders and schedules tasks to run the other components. Folders and files are created under C:\Python2.7 with the same name as the ones in a common Python installation. They are bogus and have no contents.The following Windows Task Scheduler tasks are created. Note that there isn’t a task for this component itself.Table 1Tasks scheduled for the execution of componentsTask namesComponent runFrequencyGoogleExplorer, AdobcUpdate, SystemUpolate and InstallationUpdates_clypes.pywat 9 am, 1 pm, 6 pm, 9 pmInternetExplorerchromeUpdate WindowsUpdateOneDriveUpdate_bsdbd.pyw_elementree.pyw _mssi.pyw_multiproccessing.pywevery 5 minutesevery 15 minutes every 15 minutesevery 10 minutesThis component also copies Microsoft Office files, .pdf, .jpg/.jpeg and .rar/.zip files from every drive to %LOCALAPPDATA%\Microsoft\Dropbox\Crashpad and creates directories with names based on the SHA-256 hash of those files, in C:\Python2.7\DLLs\hhd. Part of the code is shown in Figure 27.23Figure 27 // Code for copying filesThe hash is calculated using 3 MB chunks and its only purpose is keeping track of what files have already been copied._clypes.pyw: browser dataThis component checks running processes (every three or four hours) looking for web browsers. It makes a .zip file with profile data from each of these browsers if they are not currently running: Chrome, Firefox, Opera and Internet Explorer. Filenames are different for every browser – see Figure 28 for details – but they all include the UTC time instead of local time, which is new for Machete. These files are saved in %LOCALAPPDATA%\Microsoft\Dropbox\avatar_cache\.Figure 28 // Archive names for different browsersIt also has the same code as the other component to copy files and generate folders with hashes._bsdbd.pyw: screenshots, clipboard, removable drivesTo perform its tasks this component uses different libraries than the ones we described before. To access the clipboard the ctypes library is used and the contents are saved to a file wwancgf_.html in the avatar_cache folder.24Figure 29 // Code to obtain clipboard dataScreenshots are also saved in this folder. They are taken with shot() function from mss library [12]. Dumped screenshot: ‘shopt-’ + utcnow().strftime(‘%Y-%m-%d-%H_%M_%S.%f’) + ‘.png’ Example: shopt-2019-06-20-22_37_16.176.png The code for copying files and hashing is again present, but this time it has been modified to copy only files from removable devices. Copied files will have ‘usb-’ prepended. Part of the code has been taken again from Tim Golden’s site: url me uk/python/win32_how_do_i/find-drive-types html_elementree.pyw: geolocation and updates from the serverThis component performs geolocation with code similar to that described previously but with some added information.A file gt.txt is created in the avatar_cache folder; a Google Maps URL with the location of the victimized computer and the output of the systeminfo Windows command are appended. The inclusion of that command is a new feature and it shows installed security patches, among other information.Another file is created as utc_time + ‘-gtn txt’. It contains the same information as the other file, but adds all nearby wireless networks and information about the WLAN to which the computer is connected (including the passphrase to connect). Part of the code is shown in Figure 30.Figure 30 // Code to obtain information about wireless networks25The second part of this component extracts the C&C server from the file C:\Python2.7\DLLs\date.dll (configuration file, base64-encoded) and downloads and executes binaries or scripts from there.Figure 31 // Downloads from C&C serverThe code in Figure 31 shows that a exe or vbe file will be downloaded (from the PSLte or PSLtv folders respectively) and executed (not shown in the snippet) if the operators have placed some files there for that specific target. There is also code to download a new configuration file and replace the one in use: a file date.html is retrieved from the PSLte directory on the server. A folder QuitReports is used to store downloaded files on the victimized computer._mssi.pyw: keyloggingThe code is the same as before, but everything is saved to the file vpr.html in the avatar_cache folder._multiproccessing.pyw: communicationTwo C&C servers are read from the date.dll configuration file: one will be the primary server and the other one the fallback server. Every victimized computer will have a folder on the server with the following format: folder_campaign/MACaddr-HOSTNAME. As of this writing, we have seen ‘02’, ‘03’ and ‘04’ for folder_campaign.Files to be exfiltrated are moved to other folders on a compromised computer before being encrypted and sent to the server. All documents, which were stored in the Crashpad folder, are moved to the CrashReports folder. Logs, screenshots and browser data are moved from avatar_cache to the events folder. If there are any files larger than 120 MB, they are deleted.Not every document is sent to the server. The latest code of Machete does not keep listings with modified files. Instead, as seen in the code snippet in Figure 32, the date of modification is retrieved and only the 20 newest documents are copied from CrashReports to the events folder to be exfiltrated.26Figure 32 // Code to move newest filesEncryption is AES and a 64-byte key is used: a SHA-256 digest of a 40-byte string. Part of this code is shown in Figure 33. After that, files are base64 encoded and ROT13 is applied to the filenames.Figure 33 // Part of encryption codeBefore they are actually sent, files are copied one last time, from events to the instance_db folder. Then, files are sent over HTTP via a POST request, similar to what was described in the HTTP communication section. The folder names have changed, as shown in Figure 34.27Figure 34 // Code for sending files to the C&C serverIf for some reason the server could not be contacted, then the fallback server is used to exfiltrate documents in the same manner. If after this there are still files in the folder that could not be sent, a file handle to the binary stream is passed in the POST request instead of the contents of the file itself. This is done for both the main and fallback servers, meaning that these files will be mirrored on both servers.6.4 Domain names Initially, we saw three domain names being used in Machete’s configuration files. They all pointed to the same IP address during 2019, but a passive DNS query showed two other IP addresses active during 2018. Table 2 shows information about these domain names.Table 2Domain names and related IP addressesDate first seenDate last seen2019 05 13 2018 10 01 2018 08 20 2018 09 20 2018 07 152018 08 152019 05 13 2019 04 25 2018 12 16 2018 09 20 2018 07 152018 08 20Domain namemcsi.gotdns[.]ch mcsi.gotdns[.]ch mcsi.gotdns[.]ch mcsi.gotdns[.]ch djcaps.gotdns[.]chtokeiss.ddns[.]netIP address0.0.0[.]0 142.44.236[.]215 199.79.63[.]188 109.61.164[.]33 199.79.63[.]188109.61.164[.]3328Those three subdomains were reported to the dynamic DNS service No-IP (which provisions the second-level moved to an FTP server on a different IP address (158.69.9[.]209), and a new No-IP subdomain was found in configuration files, adtiomtardecessd zapto[ ]org. To prevent losing their victims if that domain name is taken down, Machete operators developed new code to send stolen data over HTTP, with a domain name specific to that purpose. That domain, artyomt[ ]com, was registered on May 10th, 2019 but there is not much more information available, so it’s less likely to be taken down.As was mentioned before, Machete operators stopped using downloaders since their update in May 2019. Phishing emails would contain a link to download a zipped file from lawyersofficial mipropia[ ]com (free hosting). Some files and their timestamps can be seen in Figure 35.Figure 35 // Files spread in phishing emailsIn June 2019 Machete operators stopped using FTP communication and started to use HTTP for both the main and fallback C&C servers. The domain name tobabean[ ]expert points to the IP address 142.44.236[.]215, which has been used before by Machete. The other server is u929489355 hostingerapp[ ]com and the related IP address is 156.67.222[.]88 at the time of this writing.7. CONCLUSION Latin America is usually overlooked when it comes to persistent threats and groups targeting the region. There have been, however, several attacks resonating in the news in the past few years, such as those targeting banks in Mexico [13] and Chile [14]. The group behind Machete has managed to continue operating even after researchers have published technical descriptions and indicators of compromise for this malware. By introducing small changes to their code and infrastructure, the group has bypassed several security products. It is the targeted organizations, though, who have failed in raising awareness and applying security policies so that employees don’t fall for these attacks in the first place.298. REFERENCES 1 GReAT, “El Machete”, Kaspersky Labs, 20 August 2014. [Online]. Available:url com/el-machete/66108/2 The Cylance Threat Research Team, “El Machete’s Malware Attacks Cut Through LATAM”, Cylance, 22 March2017. [Online]. Available: url cylance com/en_us/home/el-machete-malware-attacks-cut-through-latam html3 py2exe: url py2exe org/47z SFX Builder: url net/projects/s-zipsfxbuilder/5 pyminifier: url com/liftoff/pyminifier6 pyobfuscate: url com/astrand/pyobfuscate7 NXcrypt: url com/Hadi999/NXcrypt8ImageGrab module: url readthedocs io/en/3 0 x/reference/ImageGrab html9 Mozilla Location Service: url services mozilla com/10 Python Wi-Fi Positioning System: url com/deviance/Python-Wi-Fi-Positioning-System11 urlopen() function from urllib2: url python org/2/library/urllib2 html#urllib2 urlopen12 Python MSS: url readthedocs io/1314Lily Haw Newman, “How Hackers Pulled Off a $20 Million Mexican Bank Heist”, Wired, 15 March 2019. [Online]. Available: url wired com/story/mexico-bank-hack/Jeremy Kirk, “Banco de Chile Loses $10 Million in SWIFT-Related Attack”, BankInfoSecurity, 13 June 2018. [Online]. Available: url bankinfosecurity com/banco-de-chile-loses-10-million-in-swift-related-attack-a-1107530IOCS9. GoogleUpdate.exeSHA-1048C40EB606DA3DEF08C9F6997C1948AFBBC959B Detected by ESET as Python/Machete.BSHA-1 F05BC018C90B560DC4932758956ADFFBC10588CEESET Detection NamePython/Machete.F Python/Machete.F Python/Machete.D Python/Machete.F Python/Machete.A Python/Machete.AGoogleCrash.exeSHA-1 A97CF05AD7F3102BDE45E4B4947ED435EFEA1968ESET Detection Name Python/Machete.C Python/Machete.E Python/Machete.A Python/Machete.E Python/Machete.ERAR/7z SFX: config + payloadSHA-1 chrome.sfx.exe ChrOme_UpdAte.sfx.exe chrome.sfx.exe ders.exe chrome.sfx.exe python27.exe chrome_Up.sfx.exe Chrome_Update.sfx.exeObservations3150C23690C23EE070AD3A20FCED7311BFDF098833 chrome.sfx.exe ders.exe Python_27.exe9E52E1C015B97D4FB2CAC888F8FC69D729AF78F5finaser.aesA48A71B9D1C00A683397F97C02E0DBB3F4606863 Python.27.exe Python.27.exe Security.exepayload pushed by operators (no config file)7z SFX: decoy + downloaderSHA-1 Programa Formacion en Contratacion Publica.scr Mapa_monitoreo_WRF_ind02052018.scrRAR SFX: URL config + downloaderSHA-1 4Down.sfx.exe 04Down.exe Down.sfx.exeDownloader Detected by ESET as Python/Machete.ASHA-1 Down.exe32RAR/7z SFX: decoy + payload (no downloader)SHA-10468D3776435E527DBA52B9DA61D38C076DDA09A10EB152039CB0A379DAAB272151BC1BAA8C6D4DB FORMATO UNICO DE RENDIMIENTO OPERATIVO GNB 11JUNIO2019 CZGNB-13 xlsx.scr Radiograma 004026_pdf.scr RDGMA 1101 001 jpg.scr 20190611101428 pdf.scr FORMATO DE NOVEDADES PARA DC PERSONAL xls.scr RAD OFL0120_jpg.scr INSTRUCCIONES DEL JSO 08JUN19 docx.scr REPORTE OPERACIONAL 10JUN19 pdf.scr BOLETA DE PERMISO NELSON GUERERE docx.scr JUNIO_27_PROPUESTA_CLARO_RENOVACION.scr 20190611101331 pdf.scr Asimilacion.scr_hashlbi.pywSHA-1 B1ADF4B46350FB801CE54DA9C93A4EF79674F3F5ESET Detection Name Python/Machete.G Python/Machete.G Python/Machete.G_bsdbd.pywSHA-1 D4CF22F3DB78BDC1CEB55431857D88166CE677D4ESET Detection Name Python/Machete.G Python/Machete.G Python/Machete.G33_clypes.pywSHA-1 A07E38DF9887EA7811369CD72C57FD6D44523CD6ESET Detection Name Python/Machete.G Python/Machete.G Python/Machete.G_elementree.pywSHA-1 CF2DC40926D8747AEC572DFD711BBFD766AADB10ESET Detection Name Python/Machete.G Python/Machete.G Python/Machete.G Python/Machete.G_mssi.pywSHA-1 DE639618B550DBE9071E999AAA5B4FC81F63A5A6ESET Detection Name Python/Machete.G Python/Machete.G Python/Machete.G_multiproccessing.pywSHA-1 E1BC4EC7F82FA06924DC4B43FBBB485D8C86D9CDESET Detection Name Python/Machete.G Python/Machete.G Python/Machete.G Python/Machete.G Python/Machete.G Python/Machete.GServer domain names• tobabean[.]expert • koliast[.]com • u929489355.hostingerapp[.]com • u154611594.hostingerapp[.]com • 6e24a5fb.ngrok[.]io • f9527d03.ngrok[.]io • adtiomtardecessd.zapto[.]org • mcsi.gotdns[.]ch • djcaps.gotdns[.]ch • tokeiss.ddns[.]net • ceofanb18.mipropia[.]comlawyersofficial.mipropia[.]com34Server IPs• 185.224.137[.]63 • 156.67.222[.]88 • 158.69.9[.]209 • 142.44.236[.]215 • 199.79.63[.]188 • 109.61.164[.]33MITRE ATT&CK techniquesTacticIDNameInitial AccessExecutionPersistenceT1192Spearphishing LinkT1193Spearphishing AttachmentT1204User ExecutionT1053Scheduled TaskT1158Hidden Files and DirectoriesT1053Scheduled TaskT1027Obfuscated Files or InformationDefense EvasionT1045Software PackingCredential AccessDiscoveryT1036MasqueradingT1145Private KeysT1081Credentials in FilesT1049T1120T1083System Network File and Directory DiscoveryT1057Process DiscoveryT1217T1010Browser Bookmark Emails contain a link to download a compressed file from an external server.Emails contain a zipped file with malicious contents.Tries to get users to open links or attachments that will execute the first component of Machete. Other components of Machete are executed by Windows Task Scheduler.Malware files and folders are hidden for persistence.All of the components are scheduled to ensure persistence.Python scripts are obfuscated.Machete payload is delivered as self-extracting files. Machete downloaders are UPX packed. File and task names try to impersonate Google Chrome, Java, Dropbox, Adobe Reader and Python executables. A compromised system is scanned looking for key and certificate file extensions. Machete exfiltrates files with stored credentials for several browsers.Netsh command is used to list all nearby Wi-Fi networks.Newly inserted devices are detected by listening for the WM_DEVICECHANGE window message.File listings are produced for files to be exfiltrated.In the latest version, running processes are enumerated searching for browsers. Browser data such as bookmarks is gathered for several browsers. Window names are reported along with keylogger information.35CollectionCommand and T1074T1043Clipboard DataData from Local System Data from Removable Data StagedCommonly Used PortT1008Fallback ChannelsT1105Remote File CopyT1071Standard Application Layer ProtocolT1020Automated ExfiltrationT1002Data CompressedT1022Data EncryptedT1041T1052T1029Exfiltration Over Command and Control Channel Exfiltration Over Physical Medium Scheduled TransferClipboard data is stolen by creating an overlapped window that will listen to keyboard events. File system is searched for files of interest.Files are copied from newly inserted drives.Machete logs keystrokes from the victim’s machine. Machete captures screenshots. Files and logs are stored in a temporary folder, encrypted. Standard FTP and HTTP ports are used for communications. Machete uses HTTP to exfiltrate documents if FTP is unavailable. Machete can download additional files for execution on the victim’s machine.FTP and HTTP are used for Command & Control.All collected files are exfiltrated automatically to remote servers. Machete compresses browser’s profile data as .zip files prior to exfiltrating it. Collected data is encrypted with AES before transmitting it. In some versions of the malware, it is encoded with base64 (but not encrypted).Data is exfiltrated over the same channel used for C&C.Data from all drives in a compromised system is copied to a removable drive if there is a special file in that drive. Data is sent to the C&C server every 10 minutes. 