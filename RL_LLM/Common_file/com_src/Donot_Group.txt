4/12/2019360360威胁情报中心ti.360.net/blog/articles/donot-group-is-targeting-pakistani-businessman-working-in-china-enBackground Recently, 360 Threat Intelligence Center is investigating one email phishing attack which is targeting one Pakistani businessman who is working in China. First attack of this campaign took place in May 2018. Attackers have taken over of target machines over months. TTP of this targeting attack will be introduced, as well as remediation advice.We identiﬁed this APT group coded as ‘APT-C-35’ in 2017, who is mainly targeting Pakistan and other South Asian countries for cyber espionage[1]. Arbor also published APT research on this group, and named it ‘Donot’[2]. The group attacked government agencies, aiming for classiﬁed intelligence. At least 4 attack campaigns against Pakistan have been observed by us since 2017. Spear phishing emails with vulnerable Ofﬁce documents or malicious macros are sent to victims. Two unique malware frameworks, EHDevel and yty, are developed by attackers. In the latest attack, Donot group is targeting Pakistani businessman working in China. Fishing Attack The process of attacking target is as following:Malware Analysisurl Dropper - Excel Macros Attackers lure victim to open decoy Excel ﬁle with malicious macro which is sent as attachment in a phishing email. While macro code is running, ofﬁce_update.exe is dropped at C:\micro and run. The decoy Excel document pretends to be pricing list of one BMW car, which is easy to have trust of the victim:360威胁情报中心Downloader - ofﬁce_update. exeﬁlename MD5ofﬁce_update.exe url BAT ﬁle is mainly to modify registry for persistence, and create a directory with hidden property, etc. It can also download wlidsvcc.exe from url then save it in %USERPROFILE%\BackConﬁg\BackUp directory:After that, Ofﬁce_updata.exe will remove itself from system.Plugin - Downloader - wlidsvcc.exeFilename wlidsvcc.exe and svchots.exe. Mutex "wlidsvcc" is created to ensure that only one instance runs in system:Then, it determines if the current process path is %USERPROFILE%BackConﬁg\BackUp\wlidsvcc.exe:If the path meets condition, wlidsvcc.exe communicates with C2 (bigdata.akamaihub.stream) by POST, which is to retrieve remote commandsIf C2 sends ‘no’ command, wlidsvcc.exe will retry to contact C2 after sleeping for 90 seconds:If ‘cmdline’ command is received, wlidsvcc.exe runs plug-in %USERPROFILE%\BackConﬁg\BackUp\wuaupdt.exe, and then listens for follow-up commands:url威胁情报中心If commands are neither ‘no’ nor ‘cmdline’, wlidsvcc.exe downloads url to C:\Users\%s\BackConﬁg\BigData, then puts itself into waiting mode:Plugin executor - wuaupdt.exeFilename Wuaupdt.exe execute other plugins if commands are issued by attackers. The analysis of all backdoor plugins is shown in the following section.Execute C2 commands:Backdoor - Plugins wuaupdt.exe will execute corresponding plug-ins according to the commands issued by attackers. All plugins’ details are as following. Keylogger - Kylgr.exeFilename MD5 PDB pathKylgr.exe c:\users\user\documents\visualstudio2010\Projects\newkeylogger\Release\new keylogger.pdburl威胁情报中心This plugin is a keylogger. It ﬁrstly creates a ﬁle inc3++.txt in current directory and check whether a keylogging ﬁle exists in %USERPROFILE%\Printers\Neighbourhood directory. If yes, it saves log ﬁle name and its last modiﬁcation time to inc3++.txt:If keylogging ﬁle is found in %USERPROFILE%\Printers\Neighbourhood, the log ﬁle is moved to directory %USERPROFILE%\Printers\Neighbourhood\Spools:A new keylogging ﬁle is created in %USERPROFILE%\Printers\Neighbourhood, with ﬁlename ‘username_year_month_day(hour_minute_second)’. Then, it monitors activities of mouse and keyboard constantly.url威胁情报中心If window name is obtained, the name and pressed keys are logged:File - listing - svchots.exeFilename MD5svchots.exe test.txt ﬁle in the current directory, and they are copied to %USERPROFILE%\Printers\Spools directory, with appending ‘txt’ as new extension name:Systeminfo – spsvc.exeFilename Spsvc.exe creates several CMD processes for information collection. Information is saved to a ﬁle located in directory %USERPROFILE%\Printers\Spools:url威胁情报中心Uploader – lssm.exeFilename Md5Lssm.exe %USERPROFILE%Printers\Spools directory, to C2 bigdata.akamaihub.streamurl威胁情报中心Uploader – lssmp.exeFilename MD5 Digital signature COMODO CA Limitedlssmp.exe Some other decoy documents and plugins are found to have connections with the ﬁles in this attack. CSD_Promotion_Scheme_2018. XLSFilename CSD_Promotion_Scheme_2018. XLS MD5 disclamation pop up, warning user that this ﬁle has risky macros:url威胁情报中心The main function of malicious macro code is to drop skypet.exe in the directory %APPDATA%, and to drop skype.bat in the directory C:\Skype. skypet.bat is executed after that:Same pricing list of a BMW car is content of the Excel ﬁle:url威胁情报中心Skyep.bat Skyep.bat creates 3 directories %USERPROFILE%Printers\Spools, %USERPROFILE%BackConﬁg\BackUp and %USERPROFILE%BackConﬁg\BigData , and then sets these folder properties to hidden:The BAT ﬁle also gets the computer name, and save it into %USERPROFILE%\BackConﬁg\Backup\pcap.txt:And it creates multiple registry entries for persistence. Then, it starts skyep.exe and deletes itself:Skyep.exeFile‐ C:\Users\spartan\Documents\Visual Studio 2010\Projects\downloader new 22 jun use\downloader\Release\downloader.pdbSkyep.exe, disguising as a voice software Skype, downloads csrsses.exe from url (it is still alive) to the \BackConﬁg\BackUp\ for running:url威胁情报中心Csrsses.exeThe ﬁle name Csrsses.exe. from \\BackConﬁg\\BackUp\\pcap.txtThe computer name is then processed to a string: "orderme/computer name - random number". It contacts C2 databig.akamaihub.stream for commands:url威胁情报中心It check value of Content-Type to determine next operation. If the value is "application", it downloads ﬁle from C2 to \\BackConﬁg\\BigData\\ directory:If the value is "cmdline", \\BackConﬁg\\BigData\\wuaupdt.exe is executed:If command is"batcmd", \\BackConﬁg\\BigData\\test.bat is started:Attribution -- Donot (APT-C-35)url威胁情报中心By analyzing the macro code, plugins, domain name /IP correlation in the attack, we conﬁrm that Donot APT Group (APT-C-35) is behind the attack. Similarity of Macro Code ASERT disclosed one macro sample linking to DONOT APT Group in March 2018[2]. That macro sample is very similar to the sample in this attack: a decoy picture is pop up after macro runs.Similarity of Plug-ins Similar to previous Donot samples, new sample downloads plugins from C2. It is also packed by UPX and is written in Go language. Furthermore, it has similar code logic as previous oneswuaupdt.exe in this attack appears in previous Donot attack[1], and C2 addresses are same to previous ones. Conclusionurl威胁情报中心From the attack activity captured this time, it is obvious that Donot APT group is still keen on Pakistan as primary target of attack, and even expands scope of attack to include Pakistani staffs and institutions in China. There is a sign that the Donot group has never stopped its attacks and another cyber espionage attack could be launched soon.360 Threat Intelligence Center suggests enterprises to improve employees' security awareness by provide them sufﬁcient security training, especially anti-phishing training. Situational awareness, asset management, and threat intelligence can prevent such attacks signiﬁcantly. For 360 ESG customers, detection to Donot group and related IOCs are supported by products integrated with threat intelligence, including 360 Threat Intelligence Platform, SkyEye Advance Threat Detection System, 360 NGSOC. databig.akamaihub.stream bigdata.akamaihub.stream unique.fontsupdate.com PDB path C:\Users\spartan\Documents\Visual Studio 2010\Projects\downloader new 22 jun use\downloader\Release\downloader.pdb C:\users\user\documents\visualstudio2010\Projects\newkeylogger\Release\new keylogger.pdbReference1. url威胁情报中心2. url 