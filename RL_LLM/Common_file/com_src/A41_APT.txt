APT10: Tracking down the stealth activity of the A41APT campaignSuguru Ishimaru / Yusuke Niwa / Charles Li / Motohiko Sato / Hajime Yanagishita2020/02/25 GReAT Ideas Green tea editionPresenter / CoauthorCharles Li Team T5 Chief Analyst of TeamT5Hajime Yanagishita Macnica Networks Security ResearcherYusuke Niwa ITOCHU Corporation. ITCCERT Cyber Security ResearcherMotohiko Sato ITOCHU Corporation. ITCCERT Sr. Cyber Security ResearcherSuguru Ishimaru Kaspersky GReAT Malware Researcher2Agenda1. Campaign Overview2. Malware Analysis3. Characteristics of Intrusion4. Threat Actor’s Infrastructure5. Consideration of Threat Actor’s Attribution6. Summary3１．A41APT Campaign OverviewA41APT Campaign OverviewPeriod of Activity: March 2019 to January 2021Target: Japan (Japanese companies including overseas branches)Infection Vector: SSL-VPN abuse (Could not observed spear-phishing)Implants: DESLoader, SodaMaster, P8RAT and FYAntiLoader etc.Characteristics: Very tough to detect attacker’s intrusionWe call this threat campaign A41APT from the hostname feature “DESKTOP-A41UVJV” that is continuously used during the initial intrusion.5Public info【緊急レポート】Microsoft社のデジタル署名ファイルを 悪用する「SigLoader」による標的型攻撃を確認 [1]Japan-Linked Organizations Targeted in Long-Running and Sophisticated Attack Campaign[2]@Int2e_’s tweet[3]Attacks Exploiting Vulnerabilities in Pulse Connect Secure[4]6２．Malware Analysis２． Malware Analysis1.DESLoader1.Payloads of DESLoader• SodaMaster • P8RAT • FYAntiLoader ⇒ .NET Loader(ConfuserEx v1.0.0) ⇒ xRAT82-1．DESLoaderAka. SigLoader, Ecipekac, HEAVYHAND Unique multi-layer loader for payloadspolicytool.exeLegitimate EXE Use 4 files in the same directory DLL Side-Loading DLLs contains encrypted shellcode ofLayer II and IV loader. Layer II, III, IV loaders and payload arevac.dllfileless implants.Layer I loader for side-loadingjli.dllDLL contains encrypted shellcode: Layer II loaderDLL contains encrypted shellcode: Layer IV loaderpcasvc.dll9Example of DESLoader's payload loading flowside-loadingloaddecryptreflective dll injectionfileless implantspolicytool.exe Legitimate EXEjli.dllLayer Ivac.dllloadshellcode1 Layer IIembedded DLL1Layer IIIdecryptreflective dll injectionpcasvc.dllshellcode2Layer IVembedded DLL2PayloadLayer I: junk codes are found using OutputDebugStringA(), _time64(), rand(), srand() for anti-reversingJunk code10jli.dll: Layer I LoaderMultiple algorithms (XOR, DES, AES and RSA) are implemented, and the order of using them is configured. It read encrypted data in vac.dll from the end of data till configured size and decrypt.loaddecryptjli.dllLayer Ivac.dllMZPESection table + Section 1 … NEmbedded dataDefined crypto algorithmsshellcode1 Layer II skipped 1. XORkey = 0x9F skipped 2. AES (CBC mode)key = 83H4uREKfFClDH8ziYTH8xsBYa32p3wl IV = 83H4uREKfFClDH8z skipped 11shellcode1: Layer II LoaderLayer II Loader checks magic_bytes "ecipekac"(or “9F 8F 7F 6F” or “BF AF BF AF”). Then, it reconstructs and loads each part of the embedded DLL1 in the correct order of PE format for reflective DLL injection.reflective dll injectionshellcode1 Layer IIshellcodeecipekac Size of buf Size of codeSection table 0x00c050x39a1d0x39b250x000000x000E00x001E80x010000xXXXXXembedded DLL1Layer IIIMZ PESection tableSection 1Section N12embedded PE1: Layer III LoaderLayer III Loader is similar to Layer I Loader. The sequence of algorithms is in the reverse order compared to the layer I Loader. The hardcoded keys are also different respectively.loaddecrypt1.AES key = K4jcj02QSLWp8lK9gMK9h7W0L9iB2eEW, IV = K4jcj02QSLWp8lK9shellcode2Layer IVembedded DLL1Layer IIIDefined crypto algorithmspcasvc.dllMZPESection table + Section 1 … NEmbedded data2.XOR key = 0x5E13shellcode2: Layer IV LoaderThree different types of shellcode were confirmed as Layer IV loader:1.​Similar to Layer II shellcode for P8RAT and FYAnti loader2. Cobalt strike’s stager shellcodereflective dll injection3. Shellcode dedicated for SodaMastershellcode2Layer IVembedded DLL2Payloadoffsetdatadescription0x00090 90 90 90 90 90 90 90magic bytes for Identification, this is used for comparision before data processing0x0080x11600Size of encrypted data, only this value (size) is observedshellcode2 Layer IV for SodaMaster contains data structure0x00C0x01CA9 5B 7B 84 9C CB CF E8 B6 79 F1 9F 05 B6 2B FEC7 36 7E 93 D3 07 1E 86 23 75 10 49 C8 AD 01 9F [skipped]16 bytes RC4 key (each sample has different key)Encrypted SodaMaster payload with RC414DESLoader TimeLineThe timeline of DESLoader based on compilation time. Also shown filename and its payloads. (+Cobalt Strike’s stager)jli.dllWTSAPI32.DLLNETAPI32.DLLSECUR32.dllDBUS-1-3.DLLVMTOOLS.DLLSodaMasterjli.dllvmtools.dlljli.dllJLI.dlljli.dllLIBEAY32.DLLsbiedll.dllCobalt Strike’s stagerdbus-1-3.dllSBIEDLL.DLLDBUS-1-3.DLLGLIB-2.0.DLLP8RATuxtheme.dlljli.dllkbb.dllkbb.dllvmtools.dllsbiedll.dllJLI.DLLjli.dllvmtools.dll jli.dllFYAntiCCFIPC64.DLLOct 2019Dec 2019May 2020Jun 2020Jul 2020Sep 2020Oct 2020Dec 2020152-2．Payloads of DESLoader1. FYAntiLoader⇒ .NET Loader(ConfuserEx v1.0.0) ⇒ xRAT16SodaMasterAka. DelfsCake, dfls, DARKTOWN One of DESLoader's payloads Fileless RAT(x64/x86) Command identifiers are d, f, l and s Check VM environment from the followingregistry value HKCR\Applications\VMwareHostOpen.exe17SodaMaster Mutex value = reverse order ofCRC32 calculated from hardcoded base64 string + 12 bytes Initial C2 communication data isencrypted with RSA. The RSA key is hardcoded base64key_blob and data contains randomly generated RC4 key Further communication data isencrypted with RC4base64(RSA key) + 12bytes dataEncrypted using RSA keyCRC320x8d01ca9fMutex = 9FCA018DUser RC4keyRC4 encryptionSodaMasterC2 server18P8RATAka. GreetCake, HEAVYPOT One of DESLoader's payloads x64 fileless RAT 10 backdoor commands. Main feature looks command 301: Execution of secondary PEbased payload downloaded into memory P8RAT checks VMware and VirtualBoxvboxservice.exevmtools.exe19P8RAT backdoor commandsDescription2020-03-302020-08-262020-12-14Compilation time of P8RATClosing socketCreating a thread for executing/loading of a downloaded PENo functionalitySending randomly generated dataExecuting/loading downloaded PE/shellcodeSetting value of “Set Online Time”, and the string of the setting value was removed from the P8RAT which was built on 2020-08-26.EnableEnableEnableEnableEnableEnableEnableEnableEnableEnableRemovedRemovedEnableEnableRemovedRemovedEnableEnableSetting value of “Set Reconnect TimeOut”, and the string of the setting value was removed from the P8RAT which was built on 2020-08-26.EnableEnableEnableSetting value of “Set Reconnect times”, and the string of the setting value was removed from the P8RAT which was built on 2020-08-26.EnableEnableEnableSetting value of “Set Sleep time”, and the string of the setting value was removed from the P8RAT which was built on 2020- 08-26.EnableEnableEnableCreating thread for executing downloaded shellcode was implemented from P8RAT which was built on 2020-12-14.Not implementedNot implementedEnable20cmd300301302303304305306307308309FYAntiLoaderAka. DILLJUICE stage2 One of DESLoader's payloads Fileless type multi-layer loader module Provocative Export function name Loads .NET Loader using CppHostCLR Contains .NET Loader packedwith ConfuserEx v1.0.0 Finally, Payload is xRAT (QuasarRAT)21Example of FYAntiLoader's payload loading flowside-loadingloaddecryptreflectivedll injectionfileless implantsFYAntiusoclient.exeLegitimate EXECCFIPC64.dllLayer Imsftedit.prf.cooloadshellcode1 Layer IIembedded DLL1Layer IIIdecryptreflective dll injectionCppHostCLRloaddecryptmsdtcuiu.adi.wdbshellcode2Layer IVembedded DLL2.NET loaderweb_lowtrust.config.uninstallxRATFYAntiLooking for specific directory and search file with condition, then read file and decrypt payload22xRAT (payload of FYAntiLoader)VERSION Environment.SpecialFolder.ApplicationData Quasar Client Startup none23Obfuscated configuration data decrypts using base64 + AES CFB mode３．Characteristics of IntrusionIntrusion method in A41APT campaignInitial IntrusionInternal Recon.Lateral MovementPersistence ofmalwareC2CommunicationTrace RemovalPenetration via SSL-VPN using vulnerabilities or stolen credentialsPerform a port scan to search for open RDP or SMB port. Then, connect to RDP with an administrator account.Persistence by scheduled task registration to execute the legitimate PECommunicate with C2 server via DESLoader’s payload or PowerShell remotingDelete the event log after communication with C2 is finished.Scheduled task registrationEvent log deletionServer ・In MemoryDESLoaderPayloadORAD ServerCredential DumpingLaptopLegitimate PEPowerShellC2 Server25*We have also observed cases where traces have been removed from other compromised servers as well.Characteristics of Compromise1.Initial intrusion using SSL-VPN products2. Network scanning and credential theft3. PowerShell remoting to remove event logs4. Persistence of malware by scheduled task26３-１． Initial intrusion via SSL-VPN (e.g. session hijacking)•••In October 2019, an attacker used the hostname DESKTOP-A41UVJV to hijack sessions to enter the internal network via SSL-VPN product, Pulse Secure.JPCERT also reported a similar attack targeting SSL-VPN [4].In some cases, attackers used credentials that they had stolen in the past intrusion.27３-2． Network scanning and credential theftNetwork scanning and RDPCredential theft▪ After the intrusion by SSL-VPN, performinternal network scanning to find open port RDP (3389/TCP) and SMB (445/TCP).▪ Use an administrator account to deploy RDPto servers with free RDP.▪ Run csvde.exe, a CSV export command linetool provided by Microsoft.▪ Execute AdFind provided by joeware.▪ Dump of SYSTEM/SECURITY/SAM hive, etc.e.g. server types that are frequentlycompromised by RDPAD serverFile serverAnti Virus management serverBackup serverPrint serverFAX serverurl url pro/windows-server-2012-r2-and-2012/cc732101(v=ws.11)28３-3． PowerShell remoting to delete event logs• Event log: the end of a PowerShellremoting session• Windows PowerShell.evtxEID: 403• The "C2 address" and the "*.nls filename" are changed, but the rest is the same⇒ probably common tools execution29３-４．Persistence of malware by scheduled task▪ Registered a task scheduler that executes a legitimate executable file that loads DESLoaderevery 15 minutes.▪It is unlikely that the same scheduled task name is created on the compromised hosts.30e.g. Improperly registered scheduled tasks observed in the pastScheduled Tasks\Microsoft\Windows\Sysmain\HybridDriveCachePrepopulate\Microsoft\Windows\Shell\FamilySafetyMonitor\Microsoft\Windows\NetworkAccessProtection\NAPStatus UI\Microsoft\Windows\SideShow\AutoWake\Microsoft\Windows\SystemRestore\SR\Microsoft\Windows\Shell\FamilySafetyUpload\Microsoft\Windows\File Classification Infrastructure\Property Definition Sync\Microsoft\Windows\UpdateOrchestrator\Refresh Settings\Microsoft\Windows\WindowsUpdate\AUSessionConnect\Microsoft\Windows\Shell\WindowsParentalControls\Microsoft\Windows\UpdateOrchestrator\Schedule Retry Scan\Microsoft\Windows\LanguageComponentsInstaller\ReconcileLanguageResources\Microsoft\Windows\Setup\EOSNotify\Microsoft\Windows\SkyDrive\Idle Sync Maintenance TaskPE nameHybridDrive.exewpcmon.exeNAPStatus.exeAutoWake.exesrtasks.exeFamilySafety.exeDefinitionSync.exeusoclient.exeAUSession.exeParentalControls.exeusoclient.exeDiagPackage.exeEOSNotify.exeIdleSync.exe31４．Threat Actor’s InfrastructureThreat Actor’s Infrastructure1. The hostname used for the intrusion via SSL-VPN2. Characteristics of the C2 infrastructure33Hostname used for the initial intrusion via SSL-VPN▪ Tendency to use distinctive hostnames and attempt intrusionswhile changing IP addresses✔Host names used in breaches observed in the pastHostnameObservation TimeDESKTOP-A41UVJV2019/10 - 2020/01dellemc_N1548P2020/04 - 2020/05DESKTOP-LHC2KTF2020/12DESKTOP-O2KM1VL2019/10, 2020/12DESKTOP-V24F9JL2020/12▪ Tendency to use an IP for intrusion that is different from the C2 server’s IP34Characteristics of the C2 infrastructure▪ For C2, there is a tendency to use IP addresses and not to use domains.▪ From the observed C2 IP addresses, there is little bias toward country and AS, and weobserved that there is a tendency not to reuse IP addresses repeatedly.35５．Consideration of Threat Actor’s AttributionConsiderations for attribution of A41APT1. Relevance to APT102. Relevance to BlackTech37１．Relevance to APT10▪ Two ways linked to APT10: ▪ Confirmed the existence of an early version ofSodaMaster (x86) in March 2019, which was involved in an attack against Turkey and attributed to APT10 (mentioned [5]) xRAT observed in A41APT campaign has common TTPs with BlackBerry Cylance reports in 2019 was confirmed [6].▪ShellCodeloadCommon TTPs - F**kYouAnti export - Look for payloads under“C:\Windows\Microsoft.Net”Common TTPsRun dll payloadSodaMasterxRAT/QuasarRATconnectMenuPass/QuasarRATBackdoor ReportRun Shellcode payloadrare-coisns[.]comAttributeAPT10*Compared to SodaMaster in 2020, only two commands are supported.Used in attackAttackTurkish Victim38２．Relevance to BlackTechSodaMasterTSCookie▪Identified common features between SodaMaster and TSCookie [7].▪ The same information is collected from the compromised host in the – Current process ID▪ Observed existence of two malware,SodaMaster and TSCookie, on multiple compromised hosts39６．SummaryWrap up：A41APT Campaign▪Intrusion via SSL-VPNADVERSARY▪ Heavy usage of RDP for lateralmovement (mainly servers)▪ Abusing DLL-Sideloading▪ Remove tracesCAPABILITIES▪ Targeting Japanese companiesincluding overseas branches▪ Wide range of industries such asmanufacturingVICTIMS▪ Strong association with APT10▪ Potential relevance to BlackTechINFRASTRUCTURE▪ Heavy usage of IP addresses for C2(no domain usage)▪ Less reuse of IP addresses for C2▪IP for an initial intrusion and C2 IP are different.41Wrap up： TTPs ~MITRE ATT&CK Mapping~TacticsInitial AccessExecutionTechniquesExternal Remote Services (T1133) : Intrusion via SSL-VPN using vulnerabilities or stolen credentialsCommand and Scripting Interpreter: PowerShell (T1059.001) Base64 obfuscated PowerShell commands (delete event log) Windows Management Instrumentation (T1047) : WMIC collects services for security productsPersistenceScheduled Task/Job: Scheduled Task (T1053.005) :Privilege EscalationHijack Execution Flow: DLL Search Order Hijacking (T1574.001)Defense EvasionCredential AccessDiscoveryDeobfuscate/Decode Files or information (T1140) Indicator Removal on Host: Clear Windows Event Logs (T1070.001) Hijack Execution Flow: DLL Search Order Hijacking (T1574.001)OS Credential Dumping: Security Account Manager (T1003.002) OS Credential Dumping: NTDS (T1003.003)Account Discovery: Domain Account (T1087.002) Domain Trust Discovery (T1482) Software Discovery: Security Software Discovery (T1518.001)Lateral MovementRemote Services: Remote Desktop Protocol (T1021.001)CollectionArchive Collected Data: Archive via Utility (T1560.001) : Compression by WinRARCommand and ControlApplication Layer Protocol: Web Protocols (T1071.001) Data Encoding: Non-Standard Encoding (T1132.002)42Wrap up： Features of this campaign✔ Targeting the kryptonite of EDR/FSA detection• Malware is written on the disk by the attacker's manual operation via SSL-VPN instead of malware-originated intrusion from Spear phishing email (legitimate file, loader, encrypted file)•Intrusion from group affiliates, including overseas companies• Malware is mostly placed on servers, and the number of compromised servers are very small.• Most of the malware detected in the same period have different C2 addresses, so there is little tendencyto use the same samples.✔ After the intrusion, some rough operations were seen.• Heavy usage of network discovery using RDP• Common traces deletion method of event logs• Recorded attacker's hostname in event log43Examples of countermeasures against this campaignSSL-VPNGovernance（Overseas/affilates）Implementation of MFA• • Patch adaptation operation • MonitoringEnd UserAdditional threat visibility• •Network Monitor by NTA Strengthen security measures for servers Hunting stealthy attack by using EDR/FSA Leverage Yara rule to detect loader or payload on memory•• •Framework for sharing information (Incident, Threat Intel and security situation ) Apply same security level Apply same level of detection in each intrusion methodAdditional MonitoringAudit authentication attemp of administrator account (success/failure) Monitor deletion of Windows event log Monitor login from host that is not in list of organization asset Monitor SSL-VPN log for suspicious login from unknown host ( e.g. hostname is not in organization asset )Strengthen Monitoring for AuthenticationVendor (SOC)• Talk with end user to know white-list ( username, hostname, IP address and date/time ) ofauthentication and give proactive alert to end user44Examples of countermeasures against this campaign (Based on intrusion method)Initial IntrusionInternal Recon.Lateral MovementPersistence ofmalwareC2 CommunicationTrace Removal- Implementation of MFA - Patch adaptation operation - Monitor suspicious logins from overseas- NW monitoring by NTA - Strengthen security measures for servers (EDR/FSA etc.) - Monitoring of administrator - Suspicious login monitoring from hosts outside of asset management- Monitor the creation of suspicious scheduled task events.- Payload detection by Yara - C2 identification and blocking by malware analysis- Monitor for traces of suspicious event log deletions.- Identify and block C2 by traces of suspicious PowerShell remoting in event logsScheduled task registrationEvent log deletionPatch applicationoperationMFAMonitoringServer ・In MemoryEvent log monitoringDESLoaderpayloadsORAD serverLaptopLegitimate PEMonitoringMonitoringPowerShellPayloads detectionby YaraC245At the end  A41APT campaign is very stealthy and difficult to detect, but it is not undetectable. The compromised target has shifted from endpoint to server, and the intrusion route has alsoshifted from spear phishing to abusing SSL-VPN. Security measures need to be reviewed inyour organization to respond to change in attack method. By refining daily security operations and thoroughly reviewing the security holes in eachorganization's environment, it may be possible to detect and protect attacks from even smallanomalies.46Reference1. 【緊急レポート】Microsoft社のデジタル署名ファイルを悪用する「SigLoader」による標的型攻撃を確認url Organizations Targeted in Long-Running and Sophisticated Attack Campaign url Attacks Exploiting Vulnerabilities in Pulse Connect Secureurl APT10 THREAT ANALYSIS REPORT (ADEO IT Consulting Services)url Spotlight: MenuPass/QuasarRAT Backdoor SodaMasterAny Questions? 