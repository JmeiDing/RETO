THREAT ANALYSISHOGFISH REDLEAVES CAMPAIGN HOGFISH (APT10) targets Japan with RedLeaves implants in “new battle”Copyright © 2018 Accenture Security. All rights reserved.1HOGFISH REDLEAVES CAMPAIGNiDefense analysts have identified recent campaigns attributed to APT10, also known as HOGFISH and Stone Panda. This report provides a technical overview of the bespoke RedLeaves implants leveraged by the actor in their “new battle” campaign.iDefense is providing information about this reported campaign to the general iDefense customer base so that customers are aware of the modus operandi of a highly active threat group that is targeting institutions for espionage purposes, especially in Japan.More specifically, this threat analysis is intended for security operations center (SOC) analysts and engineers. Intelligence analysts may also want to read this report. Additionally, management and executive leadership may want to use this information.SOC analysts and engineers can use this threat analysis detailed information pertaining to the workings of a malware family and indicators of compromise (IoCs) to contain or mitigate the discussed threat through monitoring or blocking. SOC analysts can use the information provided in the Analysis and Mitigation sections of this IA to conduct hunting activities on systems that may have already been compromised.Analysts and security engineers can use the IoCs by adding them to hunting lists on Endpoint Detection and Response (EDR) solutions as well as network- and host-based blacklists to detect and deny malware implantation and command-and-control (C2) communication. Intelligence analysts may want to use the information provided in this IA to better inform their own analyses. The provided information can also help inform ongoing intelligence analyses and forensic investigations, particularly for compromise discovery, damage assessment, and attribution.Management and executive leadership may use this information to assess the risks associated with the threat described herein to make operational and policy decisions accordingly.Knowledge of the tactics, techniques, and procedures (TTPs) used by the operators behind this campaign helps to better inform detection and response to attacks by this threat group.Copyright © 2018 Accenture Security. All rights reserved.2HOGFISH REDLEAVES CAMPAIGNHOGFISH (APT10) TARGETS JAPAN WITH REDLEAVES IMPLANTS IN NEW BATTLEREDLEAVES ANALYSISThe sample that iDefense analyzed for this report is a Word document with Japanese filename, 2018年度（平成30年度）税制改正について.doc, which translates to English as “About the 2018 fiscal year (Heisei 30) tax system revision.doc”. This document has the asking the victim to “Enable content” (see Exhibit 1). On the next page, however, iDefense identified what appears to be a base64-encoded string.Exhibit 1: Dropper DocumentThe macro shown in Exhibit 2 will then perform the following sequence of actions:• Drop the embedded base64-encoded content into a new file,ZsHUvtNctKYbgPj.txt, in the %temp% folderCopyright © 2018 Accenture Security. All rights reserved.3HOGFISH REDLEAVES CAMPAIGN• Decode this new file by leveraging “certutil”, a legitimate Windows program; thebase64 encoded data decodes to a Microsoft Corp. Cabinet file, which is saved as consequently delete the earlier created filesExhibit 2: VBA MacroAs mentioned earlier, this malware creates two new binaries: AYRUNSC.exe and PTL.AYM. AYRUNSC.exe is a legitimate and digitally signed binary created by ESTsoft Corp. and pertains to ALYac, Korean anti-virus software. PTL.AYM is in fact another binary implant 2 days before launching the described campaign.This DLL is a clone of a legitimate DLL, also by ALYac, and corresponds to the anti-virus software’s Utility Module. However, rather than the original DLL, it only has two imports as the authors have implemented a simple, single-byte XOR obfuscation (using key 0x40) to obfuscate other imports and strings. For example, XOR decoding the binary reveals the following two interesting strings:• %ProgramFiles%\Internet Explorer\iexplore.exe•\GppiTEMms.lnkCopyright © 2018 Accenture Security. All rights reserved.4HOGFISH REDLEAVES CAMPAIGNAs opposed to the original DLL by ALYac, which typically has 15 exports, the analyzed sample has the following 20 exports:• ChangeScriptName• FreeList• GetFileName• GetFilePath• GetFilePath2• GetFilePathNew• GetFilePathNew2• GetFolderPath• GetFolderPath2• GetFolderPathNew• GetFolderPathNew2• GetPathVariable• GetPathVariableList• GetSIDList•Initialize•Initialize_IjDEJK• Lock• NbhgHUxiGf• UnInitialize•rGBKikBeJObSwSjYThree exported functions clearly stood out: Initialize_IjDEJK, NbhgHUxiGf, and rGBKikBeJObSwSjY. These are, however, all dummy exports to throw off analysts or perhaps even taunt researchers, and more specifically perhaps to taunt the Japan Computer Emergency Response Team Coordination Center (JPCERT/CC).For example, when executing the DLL file by calling the NbhgHUxiGf export function, the victim would be prompted with a Windows message box with "jpcert-1”, as can be shown in Exhibit 3 and 4.Exhibit 3: Windows message box creationCopyright © 2018 Accenture Security. All rights reserved.5HOGFISH REDLEAVES CAMPAIGNExhibit 4: Windows message box with the message “jpcert-1”All other functions are either empty or also filled with calls to MessageBoxA(), which is unusual for DLL loading implants. However, one export function, GetFolderPathNew2, is responsible for loading the RedLeaves DLL implant by performing process hollowing in iexplore.exe, Microsoft Corp.’s default browser. The initial process, AYRUNSC.exe, is unable to work correctly and will therefore exit.For persistence, RedLeaves will add a shortcut “.lnk” file in the user’s Startup folder, which points to `AYRUNSC.exe’, as shown in Exhibit 5.Copyright © 2018 Accenture Security. All rights reserved.6HOGFISH REDLEAVES CAMPAIGNExhibit 5: GppiTEMms.lnk in Startup FolderOnce running, the RedLeaves implant will then attempt to communicate with the following C2 domains, using HTTP, but connects to the C2 server on port 443:•firefoxcomt.arkouowi[.]com• update.arkouowi[.]comThe configuration settings for the RedLeaves implant can be extracted from memory and contains the following information:• Campaign ID: 2018-1-8-NewBattle• Mutex: jH10689DS• Key: babybearThe string “2018-1-8-NewBattle” refers to the campaign ID set up by the actor and may allude the actor starting a “new battle” (campaigns). The malware will create a unique version of the aforementioned mutex on the victim machine in order to avoid running the implant twice.Copyright © 2018 Accenture Security. All rights reserved.7HOGFISH REDLEAVES CAMPAIGNAs mentioned before, RedLeaves will attempt to communicate over HTTP, using POST requests with a hardcoded User-Agent:POST /M6Xz5MOS/index.php HTTP/1.1Connection: Keep-AliveAccept: */*User-Agent: Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; WOW64; Trident/4.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; .NET4.0C; .NET4.0E)Network traffic is encrypted with RC4 using the key “babybear”.The RedLeaves implant has at least the following abilities:• Take screenshots• Gather browser usernames and passwords• Gather extended system information• Send, receive, and execute commands from the C2 serverFurther analysis also reveals that the RedLeaves implant described corresponds to the actor’s “Lavender” version of the malware family.For example, the strings “LAVENDERX” and “LAVENDERengin” (which are dynamically taunting messages (see Exhibit 6 and 7):Copyright © 2018 Accenture Security. All rights reserved.9HOGFISH REDLEAVES CAMPAIGNExhibit 6: Message box with a taunting messageExhibit 7: Message box with another taunting messageC2 INFRASTRUCTUREC2 infrastructure enumeration reveals overlap between the three samples that iDefense analyzed, as Exhibit 8 illustrates.Copyright © 2018 Accenture Security. All rights reserved.10HOGFISH REDLEAVES CAMPAIGNExhibit 8: Maltego Graph Showing Campaigns OverlapMITIGATIONTo effectively defend against the threats described in this report, iDefense recommends blocking access to the following C2 domains and IP addresses:•firefoxcomt.arkouowi[.]com• update.arkouowi[.]com•friendlysupport.giize[.]com• algorithm.ddnsgeek[.]com•149.36.63[.]65• 83.136.106[.]108Copyright © 2018 Accenture Security. All rights reserved.11HOGFISH REDLEAVES CAMPAIGNHashes (SHA-256): Related hashes (SHA-256): look out for anomalous data:• %temp%\AYRUNSC.exe• %temp%\PTL.AYM• %appdata%\Microsoft\Windows\Start Menu\Programs\Startup\GppiTEMms.lnk• %appdata%\Microsoft\Windows\Start Menu\Programs\Startup\EaahLDRej.lnk• %appdata%\Microsoft\Windows\Start Menu\Programs\Startup\BnorTEPkh.lnk• A mutex named jH10689DS, 2N6541mb, or rV6880B9.CONTACT USJoshua Ray joshua.a.ray@accenture.comBart Parys bart.parys@accenture.comCopyright © 2018 Accenture Security. All rights reserved.12ABOUT ACCENTUREAccenture is a leading global professional services company, providing a broad range of services and solutions in strategy, consulting, digital, technology and operations. Combining unmatched experience and specialized skills across more than 40 industries and all business functions— underpinned by the world’s largest delivery network—Accenture works at the intersection of business and technology to help clients improve their performance and create sustainable value for their stakeholders. With approximately 425,000 people serving clients in more than 120 countries, Accenture drives innovation to improve the way the world works and lives. Visit us at www.accenture.comABOUT ACCENTURE SECURITYAccenture Security helps organizations build resilience from the inside out, so they can confidently focus on innovation and growth. Leveraging its global network of cybersecurity labs, deep industry understanding across client value chains and services that span the security lifecycle, Accenture protects organization’s valuable assets, end-to-end. With services that include strategy and risk management, cyber defense, digital identity, application security and managed security, Accenture enables businesses around the world to defend against known sophisticated threats, and the unknown. Follow us @AccentureSecure on Twitter or visit the Accenture Security blog.LEGAL NOTICE & DISCLAIMER: Given the inherent nature of threat intelligence, the content contained in this alert is based on information gathered and understood at the time of its creation. It is subject to change. ACCENTURE PROVIDES THE INFORMATION ON AN “AS-IS” BASIS WITHOUT REPRESENTATION OR WARRANTY AND ACCEPTS NO LIABILITY FOR ANY ACTION OR FAILURE TO ACT TAKEN IN RESPONSE TO THE INFORMATION CONTAINED OR REFERENCED IN THIS ALERT.© 2018 Accenture. All rights reserved. Accenture, the Accenture logo, iDefense and other trademarks, service marks, and designs are registered or unregistered trademarks of Accenture and its subsidiaries in the United States and in foreign countries. All trademarks are properties of their respective owners. All materials are intended for the original recipient only. The reproduction and distribution of this material is forbidden without express written permission from iDefense. The opinions, statements, and assessments in this report are solely those of the individual author(s) and do not constitute legal advice, nor do they necessarily reflect the views of Accenture, its subsidiaries, or affiliates. 