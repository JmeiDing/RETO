ThreatIntelligenceWinnti APT group docks in Sri Lanka fornew campaignTLP: CLEARSeptember 2022updated: 10/18/22Table of ContentsOverview•The attack• First stage - DBoxAgent•Ofcpic.dll - DBoxAgent analysis• Second stage - SerialVlogger•libcef.dll - SeriallVlogger analysis• Third stage - VLOG.IPDB•Fourth stage - KEYPLUG•Attribution•Sri Lanka and China - A little bit of history•Sri Lanka and China - Current situation• Conclusion•Indicators of Compromise (IOCs)•34561212151718181921223OverviewThis blog post was authored by Roberto Santos, Hossein Jazi and Jérôme SeguraIn early August, the Malwarebytes Threat Intelligence team identified a new attack targetinggovernment entities in Sri Lanka. The threat actors used multiple layers of protection andtechniques to make analysis harder and hide their final payload.However, based on tactic, techniques and procedures (TTPs) as well as code similarities webelieve that this attack falls under the Winnti umbrella. Winnti is a Chinese state-sponsoredeffort of different threat actors that have conducted cyber espionage and financially motivatedoperations since 2012.This new campaign started on August 4th and has been active since at least the middle ofAugust. Interestingly during the same time, the Chinese vessel Yuan Wang 5 (which tracksrocket and spacecraft launches for China), arrived and docked at the naval port of Hambantotalocated in Sri Lanka. Neighboring India views the vessel as a risk to its national security and theUS Department of Defense believes it is operated by China's People's Liberation Army StrategicSupport Force (PLA-SSF division). All this situation happened during a very difficult time forLankans. We will briefly analyze this situation at the end of the report.We identified several payloads being dropped in this campaign, including a backdoor that wasnew to us that we call DBoxAgent due to its use of Dropbox as a command and control server.Victimology analysis helped us to confirm our assumption of the Winnti threat group behindthis attack with the KeyPlug malware used as final payload.In this blog post we will review the chain of events and go through the different layers ofprotection that make this attack stealthy and show that Winnti continues to be active andexpand its reach in the South Asia region.We shared our initial findings with Dropbox who immediately took action to stop this maliciousactivity. We would like to thank the Dropbox threat intelligence team for their response.Winnti APT group docks in Sri Lanka for new campaign - © Malwarebytes4The attackSri Lanka has been going through a number of crises during the past year including massprotests while the country's economy is collapsing. Indeed, the United Nation relayed a callfrom humanitarian agencies that Sri Lanka's economic crisis requires immediate globalattention .Interestingly, the attack we observed is being distributed via an ISO image masquerading as adocument containing information about economic assistance ( economic assistance.iso )hosted on Google Drive. Metadata from VirusTotal indicates that this particular file was first andsubsequently uploaded from Sri Lanka (country code LK). We were also able to further confirmthat victims were in the (UTC+05:30) time zone, and more specifically in Sri Jayawardenepurawhich is the country's administrative capital.An overview of the attack can be seen in the next image, revealing the use of Dropbox ascommand and control server to help distribute several payloads, including the KeyPlugmalware. Sandbox analysis of the sample can be found here .KillchainWinnti APT group docks in Sri Lanka for new campaign - © Malwarebytes5First stage - DBoxAgentAs stated, attackers used the ongoing situation in Sri Lanka to lure victims. The initial ISO filethat victims have executed was named economic assistance.iso. This ISO file contained 3 files:- A LNK file showing a folder icon that is a shortcut for the following command: C: \Windows\System32\cmd.exe /c des.exe- An executable named des.exe- A DLL file named ofcpipc.dllContent for economic assistance.isoIt would be easy for an unexperienced user to think that the LNK file is a folder. Instead, afterclicking on the shortcut, des.exe is executed. This binary appears legitimate as it has 0detection in VirusTotal and is part of by Trend Micro AV.Winnti APT group docks in Sri Lanka for new campaign - © Malwarebytes6des.exe signature infoOfcpic.dll - DBoxAgent analysisHowever, ofcpipc.dll does have some detections and is the one containing malicious code.des.exe is a legitimate executable used to perform DLL SIDELOADING in order to executeofcpipc.dll . This maliciously crafted DLL mimics the original DLL, containing all original exportsand an additional one, named OIPC_InitPlus :Winnti APT group docks in Sri Lanka for new campaign - © Malwarebytes7Extra import in Ofcpic.dllLooking at DLL_Main, what we have in here are basic checks and initialization. The malwareexpects to be executed in a very specific way; it will skip execution when launched directlyusing rundll (to avoid being detected by some sandboxes) and also it expects to be located inthe %PUBLIC% folder.DLL skip execution generated by rundllMoving forward to the main functionality, when all the required conditions are satisfied a buffercontained in its data section will be decoded and allocated to a new memory region. Thisallocated memory will contain shellcode that implements the malicious functionality.The most common way to execute shellcode is directly using a jmp or a call instruction to thepointer. Instead, attackers placed a hook in the __security_init_cookie() function (a well knownfunction in executables compiled with Visual Studio), part of des.exe . Remember that des.exewas the original signed executable. This is important, as using this technique may be notdetected by many AV vendors.Winnti APT group docks in Sri Lanka for new campaign - © Malwarebytes8The following diagram shows how the injection is performed:DBoxAgent memory layout during injection process, step by stepThe shellcode is a backdoor that gives the ability for attackers to control the victim's machine.We named this new backdoor DBoxAgent as it uses Dropbox as C&C. This way, attackers areable to circumvent network protection tools, as all communications are sent and receivedthrough Dropbox API.They usedthefollowing authentication:Bearer_ah6koSKE8UAAAAAAAAAAXV5lH_zm1T-xVCTqyhty3cq8U7kTb9E4y2XMPDdasKV .Winnti APT group docks in Sri Lanka for new campaign - © Malwarebytes9Inside Dropbox, attackers created a folder tree. In a nutshell, DboxAgent will be uploadingstolen data to Dropbox and downloading code to execute, using polling. Dropbox foldercreated by the attackers could be something like that:Attacker's view of files contained in DropboxWinnti APT group docks in Sri Lanka for new campaign - © Malwarebytes10Every folder under users represents a victim. The names were generated by using aconcatenation of ethernet adapters MAC addresses found in their machines:Attackers have used ETHERNET MAC Addresses to identify victimsHere is a description for those files and folders that could be found at attackers Dropboxgenerated account:info.txtThis file is created when the victim runs the malware, and contains the output generated by thecommand systeminfo .down (folder)Here, attackers will place files that will be dropped to the victim's machine. The malware willlook for a special file called DownConfig.txt that contains the filename to download.Winnti APT group docks in Sri Lanka for new campaign - © Malwarebytes11Code responsible of fetching and dropping files to victims computersWe have found 3 different files (payloads) in here named jcef_helper.exe , libcef.dll andvlog.ipdb .upload (folder)Used for recovering files from victims' computers. There is a special file calledUploadConfig.txt , where attackers place the names of the files to steal from victims.shell (folder)Used to send and receive commands via CmdConfig.txt . Files with random numbers are theoutput generated by these commands. All communications are performed using the DropboxAPI via the (encrypted) HTTPS protocol. However, attackers adde an extra security layer. Allfiles, commands and outputs are stored and sent using custom encoding. Note that these tinyencoders are common signatures in Winnti attacks:Algorithm used to protect files (DBoxAgent)Winnti APT group docks in Sri Lanka for new campaign - © Malwarebytes12Second stage - SerialVloggerBy using DBoxAgent, attackers had already full control of their victim's machine. They were ableto steal information and also to deploy additional pieces of malware. In that regard, onlyselected victims received this second stage that used jcef_helper.exe , libcef.dll and vlog.ipdbfiles.Jcef_helper is not malicious and, as with des.exe , it was used just as a means to executelibcef.dll . This jcef_helper is the legitimate Java Chromium Embedded Framework helper,signed by JetBrains .Jcef_helper.exe signature infolibcef.dll - SeriallVlogger analysisIn that case, the DLL was packed with VMProtect. As in the first stage, the same procedure isfollowed to execute this malicious DLL. Functionality in fact is pretty similar to the first bytesseen in DBoxAgent, where a buffer was decoded and then executed using a hook placed in theaddress for __security_init_cookie() . However, it has some interesting points to dig in.Winnti APT group docks in Sri Lanka for new campaign - © Malwarebytes13First of these peculiarities is that SerialVlogger won't inject anything contained in any bufferinside it. Instead, SerialBlogger will look for a special file named vlog.ipdb (remember thatvlog.ipdb was one of the files dropped along).SerialVloger code extract, showing how it will open vlog.ipdb and terminate execution when notfoundAs it can be seen, execution will not continue in case vlog.ipdb does not exist. After that, themalware will use GetVolumeInformationA to query properties about C:. Specifically, theSerialNumber of the drive is what attackers are interested in. They will use this serial number asa key to decrypt vlog.ipdb , using the following algorithm.Winnti APT group docks in Sri Lanka for new campaign - © Malwarebytes14Similar algorithms have been found as part of past attacks attributed to Winnti:Algorithm used to unprotect vlog.ipdb fileThat means that every victim will have its own different copy of the vlog.ipdb file. Attempts torun vlog.ipdb files in a different machine will result in a crash. Attackers have made a prettygood in disguising these files, as vlog.ipdb files have an entropy close to 8. The decodingalgorithm can be seen as follows in a Python implementation:Algorithm used to unprotect vlog.ipdb file, in PythonA quick note about the algorithm: part1 is not produced using the key or the buffer. After a fewrounds it will tend to 7. Part1 will just add an extra rotation to the leading bytes (at the end, thisdoes not affect the randomness). We don't know why attackers decided to go that way, butprobably they wanted to add an extra protection layer to first bytes, as in first roundscomplexity is a little higher. So, discarding this part1 as complexity source, the algorithm ispretty simple. It consists of multiplying the key with the iteration value, and simply xoring thenwith the encoded buffer.Finally, this file will decrypt vlog.ipdb contents and will place a hook in __security_init_cookie() ,so the vlog.ipdb content will be executed later instead of the original jcef_helper.exe file.Winnti APT group docks in Sri Lanka for new campaign - © Malwarebytes15Third stage - VLOG.IPDBVlog.ipdb is a tiny DLL loader, capable of running a DLL that is encrypted inside the shellcodeitself. To do so, it will first locate its own address by using the well known call - pop scheme,shown in the next image:Vlog.ipdb will first fetch RIP valueAfter that, it will locate the DLL inside it using its relative offset. This time, attackers went morestandard and encrypted the DLL using regular RC4:RC4 decryption algorithmWinnti APT group docks in Sri Lanka for new campaign - © Malwarebytes16The RC4 key is contained inside the vlog.ipdb shellcode. This key was found in our samplexored with the value 0x63. The used key was ytveX05lCYreUzo4 :RC4 key was protected by a simple xorThis loader will use some Windows APIs by first fetching the kernell32.dll location (using thePEB) and then fetching the required libraries using its name. Malicious shellcode uses hashalgorithms or CRCs in order to hide these required function names to avoid triggering alarms.The malware hashes all function names (bruteforce style) and when one matches that meansthe required function has been found.The used hash algorithm has clear similarities with other known algorithms and was used oncebefore, in an old malware called Nuclear Bot (NukeBot) described here . It turns out that thesource code was leaked at some point, so attackers could have developed this one inspired bythe old Nuclear Bot.NuclearBot hashing algorithm (source netscout.com) and vlog.ipdb's are identicalCaptionWinnti APT group docks in Sri Lanka for new campaign - © Malwarebytes17Fourth stage - KEYPLUGAfter all these steps, attackers managed to inject shellcode that was encrypted in a file calledvlog.ipdb . Every vlog.ipdb had a different hash (as these were encrypted using different serialnumbers). However, after decoding them, we found that the injected file was the same for allvictims.Interestingly, vlog.ipdb was found protected twice, one protection due to DBoxAgent and onedue to SerialVloger and is a backdoor that matches the KEYPLUG family. This report alsodescribes some of the functionality carried out by KEYPLUG at the end of it. The followingconfiguration was used:WSS://162 [.]159.200.0/24;162[.]159.36.0/24;172[.]67.192.0/24;104[.]27.96.0/24:443| WSS://162[.]159.200.0/24;162[.]159.36.0/24;172[.]67.192.0/24;104[.]27.96.0/24:443|360|5|1|dash[.]lcmbk.com:443The backdoor relies on the websocket protocol to carry out its activities:Keyplug (Windows version) code fragment, establishing communication using websocketsBy using this backdoor, attackers were able to fully control victims' machines. We can see why attackers protected that final stage. Keyplug is a very complete and complex backdoor with 4 different modes (HTTP, TCP, UDP and Websockets). This sample is truly an advanced piece of malware, so we may cover it in a future report. Attribution This whole attack has Winnti signatures fingerprints all over it. The most significant one probably is the use of KeyPlug malware, which is exclusively used by this group, and most likely developed by them. We have seen multiple custom encoding algorithms (as the one described in DBoxAgent or the one found in SerialVlogger) that are also a team signature. The usage of VMProtect in some of the intermediate files is a known TTP for Winnti. Finally, victimology also matches with the group's usual targets. It is true that attacks in Sri Lanka haven't been documented yet, but China's interests in this island is not something new. Next lines will cover these possible interests. Sri Lanka and China - A little bit of history Sri Lankan recent history is defined by its long civil war. This war was almost 30 years long and ended in 2009 . The main reasons were disputes between Tamils (with the LTTE group Liberation Tigers of Tamil Eelam) and the Sinhalese, which represented the majority of the population and the government. In 2005, Mahinda Rajapaksa won the national elections, and during his mandate LTTE was defeated. That increased the popularity of Rajapaksa's clan and many of its family members where later included in political institutions . However, it is believed that Rajapaksa brought a secret ally that supported their victory. An interesting article Riding with the Devils: China’s Role in the Cambodian and Sri Lankan Conflicts talks about Rajapaksa's victory  China became the most important military ally and aid provider [...] According to Stockholm International Peace Research Institute (SIPRI) data, China has exported arms worth US$638 million to Sri Lanka [...] China clearly turned out to be the main provider of weapons for Sri Lanka[...] . We can see that China's interests in Sri Lanka began decades ago. After the war, China kept showing interests in the country. Rajapaksa leveraged that interest to finance numerous projects, like the Lotus Tower ($113 million), the Rajapaksa International Airport ($250 million) or the Hambantota International Port ($1.5 Billion). All of these were financed by China or Chinese companies. Moreover, Sri Lanka started to build a dangerous debt. In the case of Hambantota, CMPort (China Merchants Port) ended up obtaining a 99 year lease in 2017, as Sri Lanka couldn't afford the cost. Even though the use of the port was intended for commercial purposes, we can see how this agreement already triggered some alarms. For instance, Anjelina Patrick, Research Associate at the National Maritime Foundation (NMF) wrote [...] internal security of the port will be controlled only by the Chinese company, thus providing a loophole to Chinese employ the military for the internal security role. Therefore, the Lankan government has indicated that [...] it would neither affect the sovereignty of the country nor lead to any inimical military presence . She also expressed concerns about the Chinese debt trap. This debt trap has even been claimed by individuals like Richard Moore , the head of Britain's foreign intelligence agency (MI6): China lends money to other countries, which end up having to cede control of key assets if they can't meet their debt repayments [...] One example often cited by critics of China is Sri Lanka, which years ago embarked on a massive port project in Hambantota with Chinese investment Sri Lanka and China - Current situation Sri Lanka's financial problems became worse over time. Corruption, COVID-19, terrorism, debts and wrong financial decisions ended up in a bankrupt country. Gotabaya Rajapaksa (Mahinda Rajapaksa's brother and president at the time) finally left the country in July 2022. At the time of writing, the country faces an inflation of around 80%, and a debt near 120%. The population is experiencing serious troubles as basic needs are often not met and foreign aid to get out that situation is needed. We have seen how China has demonstrated interest about the island, and played an important role in its fate. Sri Lanka's location in South Asia is strategic for China as it has open access to the Indian Ocean and is close to India. Looking at this cyberattack, it happened in mid August just when the Yuan Wang 5 Chinese ship docked at Hambantota's port. Conclusion Winnti remains active and its arsenal keeps growing as one of the most sophisticated groups nowadays. We have never seen Winnti use Dropbox as C&C before but it seems that using these cloud services for malicious purposes has become more popular among actors. Some may think that China is taking advantage of Sri Lanka's weaknesses and that the PLA could have in mind military activities at Hambantota. China's military expansion is something that has already happened. Back in 2017, we saw how they opened the PLA Djibouti base , a naval base located in the horn of Africa (Djibouti also has a big debt owed to China ). China's version is that the ship  was conducting scientific research in accordance with international law . On the other hand, US Defense Department says the ship is under the command of the People's Liberation Army (PLA)[...] and in particular, under Strategic Support Force (SSF) a theater command-level organization established to centralize the PLA's strategic space, cyber, electronic, information, communications, and psychological warfare missions and capabilities More information here and here . Of course, we cannot state that both events (cyberattack and ship arrival) are related but we just point out how both happened at the same time along with China's existing interests in Sri Lanka. Western countries have also made some moves. Geopolitically, it would be a poor decision to leave Sri Lanka with China as the only alternative. The Indian and Sri Lanka governments have been in talks about debt restructuring and it is expected that the IMF will approve a $3 billion loan to the country in December.  Once we identified this campaign, we reached out to Dropbox and they immediately disable the account that was used as a C&C server. Malwarebytes customers are protected against this attack; the new backdoor we found is detected as Trojan.DBoxAgent.