"article": "5/15/2020 APT Group Planted Backdoors Targeting High Profile Networks in Central Asia - Avast Threat Labs APT Group Planted Backdoors Targeting High Profile Networks in Central Asia. May 14, 2020. Last fall, APT malware intrusions targeting high-profile companies in Central Asia caught our attention. A few months later, we began working together with fellow malware analysts from ESET to analyze samples used by the group to spy on a telecommunications company, a gas company, and a governmental institution in Central Asia. An APT group, which we believe could possibly be from China, planted backdoors to gain long-term access to corporate networks. Based on our analysis, we suspect the group was also behind attacks active in Mongolia, Russia, and Belarus. The group behind the attack frequently recompiled their custom tools to avoid AV detection, which, in addition to the backdoors, included Mimikatz and Gh0st RAT. This has led to a large number of samples, with binaries often protected by VM Protect, making analysis more difficult. The backdoors gave the actors the ability to manipulate and delete files, take screenshots, manipulate processes, and services, as well as execute console commands, remove itself, and more. Further, some commands may have instructed the backdoors to exfiltrate data to a C&C server. Infected devices could also be commanded by a C&C server to act as a proxy or listen on a specific port on every network interface. The group also used tools such as Gh0st RAT and Management Instrumentation to move laterally within infiltrated networks. Figure 1: Timeline of events related to the tracking of Microcin, and Avast notifying the targeted company Avast and Eset antivirus engines blocked the samples used by the APT group prior to it attracting our attention, as our antivirus engines detections are automated. Attribution & Clusterization The samples we analyzed contain links to malware samples and campaigns, such as Microcin, BYEBY, and Vicious Panda, previously described by Kaspersky, Palo Alto Networks, and Check Point, respectively. The backdoors we found are custom tools that have not previously been analyzed, as far as we know. The majority of the C&C servers are registered to Choopa, LLC, a hosting platform that has been used by cybercriminals in the past. A GoDaddy registrar was also seen early in the campaign, these servers were removed early on. We suspect the APT group behind these attacks is from China. Gh0st RAT, one of the tools used, has been known to be used by Chinese APT groups in the past. Similarities in the code used in the Vicious Panda campaign, (TTPS, especially the use of the RTF Weaponizer in the infection vector), which is also thought to have come from China, and the code we analyzed, also lead us to believe the group might be from China. The targeted companies and institutions, as well as the professional coding point to an APT group. Toolset Backdoors Throughout our analysis, we stumbled upon the following backdoors. Details on these backdoors C&C server. Technical details (pcaudit.bat) pcaudit.bat is a batch file that is used to invoke the svchost.exe in order to load the DLL file for a given service specified in the registry. This batch file is responsible for the backdoor persistence. The contents of the pcaudit.bat script can be found below: Figure 2: The batch file that is responsible for the backdoor persistence Technical details (sqllauncher.dll, logon.dll) Both DLLs, sqllauncher.dll and logon.dll, are primarily used as backdoors. These are installed as services by the aforementioned batch file. They both create a log file under the path: %COMMON_DOCUMENT%\\WZ9JuN00.tmp aggregating errors during the backdoor runtime. Each entry contains an error code, an error message, and a timestamp formatted as. If the infected device can connect to the C&C server, the malware attempts to determine whether the traffic is routed through a proxy. This information may be retrieved either from %WINDOWS%\\debug\\netlogon.cfg or from the TCP table. After successfully connecting to the C&C server, a secure communication channel (Schannel) is established and telemetry (OS version, username) is sent to the C&C server. The following commands are issued by the C&C WELCOMLIST DSTARTCUPLOADDOWNLOEXECUT Send malware version to the C&C Send all used drive letters to the C&C Start remote shell Execute and send data to C&C Write %data% into via Create Process API. Technical details (logsupport.dll) Similarly to the previous DLLs, the logsupport.dll is primarily used as a backdoor, but uses a different C&C server than the other backdoors. Its corresponding log file is located at %TEMP%\\rar%[A-Z0-9]{4}%.tmp. The structure of the log file is also the same. The main difference is that the log file is encrypted by a XOR cipher with a hardcoded key. Figure 3: Log file is decrypted by a XOR cipher with a hardcoded key This backdoor checks whether the malware is running in a virtualized environment. Additionally, the DLL fingerprints the infected device (NETBIOS name, IP address, username, OS version, MAC address and RAM usage, OEM code page, token information, number of CPU cores, is64bit), and sends this information to the C&C server. The communication with the C&C server is encrypted by a simple stream cipher. If the malware fails to establish an encrypted channel, it checks whether a proxy is being used, using different methods than the previous two DLLs. It tries to connect to url and retrieve information about a possible proxy from the connection, and it also checks the value of ProxyServer in the Windows registry key:HKLM\\Software\\Microsft\\Windows\\CurrentVersion\\Internet Settings. Based on what we saw in the code, the backdoor is also capable of accepting various commands from the C&C server. These commands allow the backdoor to manipulate files (move, read, delete, check existence), manipulate processes (create, terminate, retrieve parent, and process ID) and Windows services (start, stop, check), execute console commands, remove itself, and more. Some of these commands (read/check file, check services, check processes) also send data back to C&C. The infected device can also be commanded by C&C to act as a proxy or listen on a specific port on every network interface. Interestingly, the backdoor has a set of commands specifically targeting files with .tu and .tut file extension. These commands may similarly check for their existence, send their content back to the C&C, and modify their content (append or rewrite by data given by the C&C server). started in 2007. It is a robust tool that exploits various Windows authentication schemes and dumps credential-related data from a Windows Local Security Account database. For these reasons it is often misused by a wide spectrum of APT actors such as the Lazarus Group or Telebots. The Mimikatz version used in this campaign has a two-stage installation mechanism (installer.exe installing Yokel64.exe and mktz64.dll), and contains a PDB string. Calling a mktz64.dll exported function Mktz Dumpby Injection inside our testing virtual machine yields the following output. Afterwards, the data described in the filename is extracted and used to establish a remote console to a computer identified by the retrieved name. Afterwards, Windows Management Instrumentation (WMI) is leveraged to set a strict proxy security, leading to the encryption of arguments of each remote procedure call, and allowing the server to access local resources. Then WMI is used again to retrieve the Win32_Process class which in turn is used to create a process with given parameters. At the end, it terminates itself. Gh0st RAT is commonly assumed that its source code is widely available. Its presence is often indicated by a file named rastls.dll, using an export DLL name svchost.dll and containing a string Gh0st. A string uwqixgze} is used as a placeholder for the C&C domain. Figure 4: Gh0st RAT malware Code Similarities While analyzing one of the files, we noticed that it has several correlations to the Microcin sample from 2017, the BYEBY sample from 2017, and Vicious Panda: The COVID campaign from 2020. Figure 5 below provides a comparison of the decryption loop used to decrypt the main configuration data of the first backdoor. Figure 5: Part of code used to decipher the main configuration data SHA256 Name of file irmon.dll. Avast reported its findings to the local CERT team and reached out to the telecommunications company. We have not heard back from either organization. Avast has recently protected users in Central Asia from further attacks using the samples we analyzed. This, along with tying elements of the samples we discovered back to attacks carried out on other countries, makes me assume the group is still active.I would like to thank Peter Kalnai from ESET for working with me on the analysis, and Adolf Steda from Avast for helping me with this research, as well as Alexey Shulmin from Kaspersky for his support.
"summary": "The document describes an advanced persistent threat (APT) campaign targeting high-profile companies in Central Asia that was analyzed by Avast and ESET. The attackers planted backdoors to gain long-term access to corporate networks. The threat actors frequently recompiled their custom malware tools to avoid detection. The tools included backdoors, Mimikatz, and Gh0st RAT. Many samples were protected by VMProtect obfuscation. The backdoors gave the attackers capabilities to manipulate files, take screenshots, manipulate processes and services, execute commands, proxy network traffic, exfiltrate data, and more. Lateral movement within compromised networks was achieved using Mimikatz credential theft and Windows Management Instrumentation (WMI). Attribution points to an APT group possibly from China, based on code similarities with past campaigns like Vicious Panda, the use of Gh0st RAT, and the professional coding techniques. Most command and control servers were registered with Choopa LLC hosting. Avast and ESET detected and blocked the malware before this campaign was fully analyzed. The threat actors are suspected to still be active, as similar attacks were seen targeting Central Asia recently. "
        
